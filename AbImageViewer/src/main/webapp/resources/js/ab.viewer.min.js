function AbColorPicker(t){if(t||(t={}),this.viewStyle=t.viewStyle||"window",this.token=t.token||null,this.selector=t.selector||"#picker",this.e=$(this.selector),this.epicker=this.e.find(".ui-color-picker"),this.esample=this.e.find(".sample-boxes"),this.euser=this.e.find(".user-boxes"),this.pickingArea=null,this.picker=null,this.hueArea=null,this.huePicker=null,this.alphaArea=null,this.alphaMask=null,this.alphaPicker=null,this.previewColor=null,this.userBoxIndex=-1,this.color={type:"RGB",h:0,s:0,l:0,v:0,r:0,g:0,b:0,a:1,locka:!1,bka:1,set:function(){if(1==arguments.length&&"string"==typeof arguments[0]){var t=AbCss.color(arguments[0]);t&&(4==t.length?(this.locka!==!1&&(this.bka=t[3]),this.rgb(t[0],t[1],t[2],this.locka===!1?t[3]:this.locka)):this.rgb(t[0],t[1],t[2],1))}else switch(arguments[0]){case"HSL":this.hsl(arguments[1],arguments[2],arguments[3]);break;case"HSV":this.hsv(arguments[1],arguments[2],arguments[3]);break;case"RGB":5==arguments.length?(this.locka!==!1&&(this.bka=arguments[4]),this.rgb(arguments[1],arguments[2],arguments[3],this.locka===!1?arguments[4]:this.locka)):this.rgb(arguments[1],arguments[2],arguments[3])}},hsl:function(){return arguments.length&&(this.type="HSL",this.h=arguments[0],this.s=arguments[1],this.l=arguments[2],this.from("HSL")),{h:this.h,s:this.s,l:this.l}},hsv:function(){return arguments.length&&(this.type="HSV",this.h=arguments[0],this.s=arguments[1],this.v=arguments[2],this.from("HSV")),{h:this.h,s:this.s,v:this.v}},rgb:function(){return arguments.length&&(this.type="RGB",this.r=arguments[0],this.g=arguments[1],this.b=arguments[2],arguments.length>=4?(this.locka!==!1&&(this.bka=arguments[3]),this.a=this.locka===!1?arguments[3]:this.locka):this.a=1,this.from("RGB")),{r:this.r,g:this.g,b:this.b,a:this.a}},from:function(t){var e=null,i=null;switch(t){case"HSL":i=AbColor.hsv2rgb(this.h,this.s/100,this.l/100),e=AbColor.rgb2hsv(i[0],i[1],i[2]),this.v=this.round(100*e[2]),this.r=this.round(i[0]),this.g=this.round(i[1]),this.b=this.round(i[2]);break;case"HSV":i=AbColor.hsv2rgb(this.h,this.s/100,this.v/100),e=AbColor.rgb2hsl(i[0],i[1],i[2]),this.l=this.round(100*e[2]),this.r=this.round(i[0]),this.g=this.round(i[1]),this.b=this.round(i[2]);break;case"RGB":e=AbColor.rgb2hsl(this.r,this.g,this.b),this.l=this.round(100*e[2]),e=AbColor.rgb2hsv(this.r,this.g,this.b),this.h=this.round(e[0]),this.s=this.round(100*e[1]),this.v=this.round(100*e[2])}},round:function(t){return Math.round(t)},hex:function(){var t=this.rgb();return AbCss.hex(t.r,t.g,t.b)},color:function(){var t=this.rgb();return this.a|!1?AbCss.hex(t.r,t.g,t.b):"rgba("+t.r+", "+t.g+", "+t.b+","+this.a+")"}},this.createPickingArea(),this.createHueArea(),this.topics={},this.newInputComponent("H","hue",this.inputChangeHue.bind(this)),this.newInputComponent("S","saturation",this.inputChangeSaturation.bind(this)),this.newInputComponent("V","value",this.inputChangeValue.bind(this)),this.createAlphaArea(),this.newInputComponent("R","red",this.inputChangeRed.bind(this)),this.newInputComponent("G","green",this.inputChangeGreen.bind(this)),this.newInputComponent("B","blue",this.inputChangeBlue.bind(this)),this.createPreviewBox(),this.newInputComponent("투명도","alpha",this.inputChangeAlpha.bind(this)),this.newInputComponent("hexa","hexa",this.inputChangeHexa.bind(this)),this.generateColorBoxes(),this.attachControlPanelEvents(),this.observers=[],t.color){if("string"==typeof t.color)this.setColor(t.color);else if("string"==typeof t.color.type&&$.isArray(t.color.value)){var e=[t.color.type];Array.prototype.push.apply(e,t.color.value),this.setColor.apply(this,e)}}else this.setColor()}function AbGridPager(t){t||(t={});var e=t.template||{},i=t.style||{};this.prefix="",this.$totalCount=0,this.$count=0,this.$index=0,this.$desc=!0,this.$lineCount=15,this.$pageCount=10,this.$page=0,this.$totalPage=0,this.$prevPage=0,this.$nextPage=0,this.$startPage=0,this.$endPage=0,this.$block=0,this.$totalBlock=0,this.$prevBlock=0,this.$nextBlock=0,this.$startBlock=0,this.$endBlock=0;var s=this;this.$pagerFunction=arguments.length>0&&"function"==typeof arguments[0]?arguments[0]:function(t){return"javascript:"+s.prefix+"page("+t+")"},this.$symbolPrevBlock=e.hasOwnProperty("symbolPrevBlock")?e.symbolPrevBlock:'<img align="absmiddle" src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4KPHN2ZyBzdHlsZT0iZW5hYmxlLWJhY2tncm91bmQ6bmV3IDAgMCAzMiAzMjsiIHdpZHRoPSIxNnB4IiBoZWlnaHQ9IjE2cHgiIHZpZXdCb3g9IjAgMCAzMiAzMiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZyBpZD0iX3gzNF9fYXVkaW9fcGxheSIgdHJhbnNmb3JtPSJtYXRyaXgoLTEuMDE5Nzk1LCAwLCAwLCAxLCAzMi4zNDMxODIsIC0wLjA1NDk0NSkiIGZpbGw9IiNGRkZGRkYiPgogICAgPHBhdGggZD0iTTkuODM5LDE3Ljg0MnYtMy42ODhWNi4zOThjMC0wLjU1MSwwLjMzLTEuMDQ3LDAuODQtMS4yNThjMC41MDgtMC4yMTEsMS4wOTQtMC4wOTQsMS40ODIsMC4yOTVsOS42MDIsOS42MDIgICBjMC4yNTYsMC4yNTUsMC4zOTgsMC42MDIsMC4zOTgsMC45NjJjMCwwLjM2MS0wLjE0MywwLjcwOC0wLjM5OCwwLjk2M2wtOS42MDIsOS42MDNjLTAuMjYsMC4yNi0wLjYwOCwwLjM5OC0wLjk2MiwwLjM5OCAgIGMtMC4xNzUsMC0wLjM1My0wLjAzMy0wLjUyMS0wLjEwNGMtMC41MS0wLjIxMS0wLjg0LTAuNzA3LTAuODQtMS4yNThWMTcuODQyeiIvPgogIDwvZz4KPC9zdmc+"/>',this.$symbolNextBlock=e.hasOwnProperty("symbolNextBlock")?e.symbolNextBlock:'<img align="absmiddle" src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiA/PjwhRE9DVFlQRSBzdmcgIFBVQkxJQyAnLS8vVzNDLy9EVEQgU1ZHIDEuMS8vRU4nICAnaHR0cDovL3d3dy53My5vcmcvR3JhcGhpY3MvU1ZHLzEuMS9EVEQvc3ZnMTEuZHRkJz48c3ZnIGhlaWdodD0iMTZweCIgc3R5bGU9ImVuYWJsZS1iYWNrZ3JvdW5kOm5ldyAwIDAgMzIgMzI7IiB2ZXJzaW9uPSIxLjEiIHZpZXdCb3g9IjAgMCAzMiAzMiIgd2lkdGg9IjE2cHgiIHhtbDpzcGFjZT0icHJlc2VydmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiPjxnIGlkPSJfeDM0X19hdWRpb19wbGF5IiBmaWxsPSIjRkZGRkZGIj48cGF0aCBkPSJNOS44MzksMTcuODQydi0zLjY4OFY2LjM5OGMwLTAuNTUxLDAuMzMtMS4wNDcsMC44NC0xLjI1OGMwLjUwOC0wLjIxMSwxLjA5NC0wLjA5NCwxLjQ4MiwwLjI5NWw5LjYwMiw5LjYwMiAgIGMwLjI1NiwwLjI1NSwwLjM5OCwwLjYwMiwwLjM5OCwwLjk2MmMwLDAuMzYxLTAuMTQzLDAuNzA4LTAuMzk4LDAuOTYzbC05LjYwMiw5LjYwM2MtMC4yNiwwLjI2LTAuNjA4LDAuMzk4LTAuOTYyLDAuMzk4ICAgYy0wLjE3NSwwLTAuMzUzLTAuMDMzLTAuNTIxLTAuMTA0Yy0wLjUxLTAuMjExLTAuODQtMC43MDctMC44NC0xLjI1OFYxNy44NDJ6Ii8+PC9nPjwvc3ZnPg=="/>',this.$symbolFirstBlock=e.hasOwnProperty("symbolFirstBlock")?e.symbolFirstBlock:'<img align="absmiddle" src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiA/PjwhRE9DVFlQRSBzdmcgIFBVQkxJQyAnLS8vVzNDLy9EVEQgU1ZHIDEuMS8vRU4nICAnaHR0cDovL3d3dy53My5vcmcvR3JhcGhpY3MvU1ZHLzEuMS9EVEQvc3ZnMTEuZHRkJz48c3ZnIGhlaWdodD0iMTZweCIgc3R5bGU9ImVuYWJsZS1iYWNrZ3JvdW5kOm5ldyAwIDAgMzIgMzI7IiB2ZXJzaW9uPSIxLjEiIHZpZXdCb3g9IjAgMCAzMiAzMiIgd2lkdGg9IjE2cHgiIHhtbDpzcGFjZT0icHJlc2VydmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiPjxnIGlkPSJfeDM0X19hdWRpb19zdGVwX2JhY2siIGZpbGw9IiNGRkZGRkYiPjxwYXRoIGQ9Ik0yMS4zMjEsNS4xNDFjLTAuNTA4LTAuMjExLTEuMDk0LTAuMDk0LTEuNDgyLDAuMjk1bC05LjUsOS41VjUuMDM4YzAtMC4yNzYtMC4yMjQtMC41LTAuNS0wLjVIOC40NjcgICBjLTAuMjc2LDAtMC41LDAuMjI0LTAuNSwwLjV2MjEuOTI1YzAsMC4yNzYsMC4yMjQsMC41LDAuNSwwLjVoMS4zNzJjMC4yNzYsMCwwLjUtMC4yMjQsMC41LTAuNXYtOS44OThsOS41LDkuNSAgIGMwLjI2LDAuMjYsMC42MDgsMC4zOTgsMC45NjIsMC4zOThjMC4xNzUsMCwwLjM1My0wLjAzMywwLjUyMS0wLjEwNGMwLjUxLTAuMjExLDAuODQtMC43MDcsMC44NC0xLjI1OHYtNy43NnYtMy42ODdWNi4zOTkgICBDMjIuMTYxLDUuODQ4LDIxLjgzMSw1LjM1MiwyMS4zMjEsNS4xNDF6Ii8+PC9nPjwvc3ZnPg=="/>',this.$symbolLastBlock=e.hasOwnProperty("symbolLastBlock")?e.symbolLastBlock:'<img align="absmiddle" src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiA/PjwhRE9DVFlQRSBzdmcgIFBVQkxJQyAnLS8vVzNDLy9EVEQgU1ZHIDEuMS8vRU4nICAnaHR0cDovL3d3dy53My5vcmcvR3JhcGhpY3MvU1ZHLzEuMS9EVEQvc3ZnMTEuZHRkJz48c3ZnIGhlaWdodD0iMTZweCIgc3R5bGU9ImVuYWJsZS1iYWNrZ3JvdW5kOm5ldyAwIDAgMzIgMzI7IiB2ZXJzaW9uPSIxLjEiIHZpZXdCb3g9IjAgMCAzMiAzMiIgd2lkdGg9IjE2cHgiIHhtbDpzcGFjZT0icHJlc2VydmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiPjxnIGlkPSJfeDM0X19hdWRpb19zdGVwX2ZvcndhcmQiIGZpbGw9IiNGRkZGRkYiPjxwYXRoIGQ9Ik05Ljc0Miw1LjE0MWMwLjUwOC0wLjIxMSwxLjA5NC0wLjA5NCwxLjQ4MiwwLjI5NWw5LjUsOS41VjUuMDM3YzAtMC4yNzYsMC4yMjUtMC41LDAuNS0wLjVoMS4zNzMgICBjMC4yNzUsMCwwLjUsMC4yMjQsMC41LDAuNXYyMS45MjZjMCwwLjI3Ni0wLjIyNSwwLjUtMC41LDAuNWgtMS4zNzNjLTAuMjc1LDAtMC41LTAuMjI0LTAuNS0wLjV2LTkuODk4bC05LjUsOS41ICAgYy0wLjI2LDAuMjYtMC42MDcsMC4zOTgtMC45NjEsMC4zOThjLTAuMTc2LDAtMC4zNTQtMC4wMzMtMC41MjEtMC4xMDRjLTAuNTEtMC4yMTEtMC44NC0wLjcwNy0wLjg0LTEuMjU4di03Ljc2di0zLjY4OFY2LjM5OCAgIEM4LjkwMiw1Ljg0OCw5LjIzMiw1LjM1Miw5Ljc0Miw1LjE0MXoiLz48L2c+PC9zdmc+"/>',this.$styleBlock=i.hasOwnProperty("styleBlock")?i.styleBlock:"pageBlock",this.$styleCurrentPage=i.hasOwnProperty("styleCurrentPage")?i.styleCurrentPage:"curpage",this.$stylePage=i.hasOwnProperty("stylePage")?i.stylePage:"page",this.$blockTemplate=e.hasOwnProperty("blockTemplate")?e.blockTemplate:'<a class="{:style:}" href="{:pagenav:}">{:symbol:}</a>',this.$cpageTemplate=e.hasOwnProperty("cpageTemplate")?e.cpageTemplate:'<div class="{:style:}">{:page:}</div>',this.$pageTemplate=e.hasOwnProperty("pageTemplate")?e.pageTemplate:'<a class="{:style:}" href="{:pagenav:}">{:page:}</a>',this.$pageGapTemplate=e.hasOwnProperty("pageGapTemplate")?e.pageGapTemplate:"&nbsp;",this.$navTemplate=e.hasOwnProperty("navTemplate")?e.navTemplate:"{:first:}&nbsp;{:prev:}&nbsp;{:pages:}&nbsp;{:next:}&nbsp;{:last:}"}function AbShapeSerializer(){this.prop={}}function AbShapeStyler(t){t||(t={}),this.selector=t.selector||"#abstyler",this.e=$(this.selector),this.locked=!1,this.shape=null,this.styleDesc=null,this.observers=[],this.colorPicker=t.colorPicker&&t.colorPicker instanceof AbColorPicker?t.colorPicker:new AbColorPicker({selector:t.colorPickerSelector}),this.colorPicker.observe(this),this.hasHandler=function(t){var e=$(this.colorPicker.token);e.has(t.target).length||this.colorPicker.has(t.target)||this.colorPicker.close()}.bind(this)}function AbBoxEditIndicator(t){t||(t={}),this.target=t.target||null;var e=t.controls||{};this.controls={angle:e.angle||!0,angleDistance:e.angleDistance||30,leftTop:e.leftTop||!0,top:e.top||!0,rightTop:e.rightTop||!0,left:e.left||!0,right:e.right||!0,leftBottom:e.leftBottom||!0,bottom:e.bottom||!0,rightBottom:e.rightBottom||!0};var i=e.style||{},s=i.default||{},n=i.focus||{},r=s.control||{},a=r.stroke||{},o=n.control||{},h=o.stroke||{};this.style={default:{control:{stroke:{color:h.color||"rgba(127,172,209,1)",width:h.width||1},color:o.color||"rgba(201,228,252,1)",size:o.size||10},color:n.color||"rgba(95,212,251,1)",width:n.width||1},focus:{control:{stroke:{color:a.color||"rgba(70,130,180,1)",width:a.width||1},color:r.color||"rgba(153,204,255,1)",size:r.size||10},color:s.color||"rgba(0,191,255,1)",width:s.width||1}}}function AbLineEditIndicator(t){t||(t={}),this.target=t.target||null;var e=t.controls||{};this.controls={angle:e.angle||!0,angleDistance:e.angleDistance||30,left:e.left||!0,right:e.right||!0};var i=e.style||{},s=i.default||{},n=i.focus||{},r=s.control||{},a=r.stroke||{},o=n.control||{},h=o.stroke||{};this.selectionStyle="path",this.style={default:{control:{stroke:{color:h.color||"rgba(127,172,209,1)",width:h.width||1},color:o.color||"rgba(201,228,252,1)",size:o.size||10},color:n.color||"rgba(95,212,251,1)",width:n.width||1},focus:{control:{stroke:{color:a.color||"rgba(70,130,180,1)",width:a.width||1},color:r.color||"rgba(153,204,255,1)",size:r.size||10},color:s.color||"rgba(0,191,255,1)",width:s.width||1}}}function AbShapeImage(t){t||(t={});var e=t.source||{},i=e.render||{},s=t.style||{};s.stroke||{};if(!e.data)throw new Error("[VECTOR-IMAGE] data is null or empty");if(!e.width||!e.height)throw new Error("[VECTOR-IMAGE] size(width, height) is not setted");if(this.name=t.name||"image",this.type="annotation",this.shapeType="image",this.shapeStyle="box",this.token=null,this.selected=!1,this.focused=!1,this.indicator=AbCommon.isDefined(AbBoxEditIndicator)?new AbBoxEditIndicator({target:this}):null,this.angle=t.angle||0,this.source={data:e.data||"",width:e.width,height:e.height,render:{width:i.width||e.width,height:i.height||e.height}},AbCommon.allNumbers(t.x,t.y,t.width,t.height))this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height;else{var n=AbGraphics.box.rect(t.x1,t.y1,t.x2,t.y2);this.x=n.x,this.y=n.y,this.width=n.width,this.height=n.height}this.style={},this.$image=null}function AbShapeRectangle(t){t||(t={});var e=t.style||{},i=e.stroke||{};if(this.name="rectangle",this.type="annotation",this.shapeType="shape",this.shapeStyle="box",this.token=null,this.selected=!1,this.focused=!1,this.indicator=AbCommon.isDefined(AbBoxEditIndicator)?new AbBoxEditIndicator({target:this}):null,this.angle=t.angle||0,AbCommon.allNumbers(t.x,t.y,t.width,t.height))this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height;else{var s=AbGraphics.box.rect(t.x1,t.y1,t.x2,t.y2);this.x=s.x,this.y=s.y,this.width=s.width,this.height=s.height}this.style={stroke:{width:AbCommon.isNumber(i.width)?i.width:1,color:i.color||"#41719C"},color:AbCommon.isDefined(e.color)?e.color:"rgba(91,155,213,0.8)"}}function AbShapeTextBox(t){t||(t={});var e=t.style||{},i=e.stroke||{},s=e.text||{},n=t.textPadding||{left:2,top:2,right:2,bottom:2};if(this.name="textbox",this.type="annotation",this.shapeType="shape",this.shapeStyle="box",this.token=null,this.selected=!1,this.focused=!1,this.indicator=AbCommon.isDefined(AbBoxEditIndicator)?new AbBoxEditIndicator({target:this}):null,this.text=t.text||"",this.textWidth=0,this.textHeight=0,this.textEditMode=!1,this.textPadding={left:n.left,top:n.top,right:n.right,bottom:n.bottom,horiz:function(){return this.left+this.right},vert:function(){return this.top+this.bottom}},this.angle=t.angle||0,AbCommon.allNumbers(t.x,t.y,t.width,t.height))this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height;else{var r=AbGraphics.box.rect(t.x1,t.y1,t.x2,t.y2);this.x=r.x,this.y=r.y,this.width=r.width,this.height=r.height}this.style={stroke:{width:i.width||1,color:i.color||"#5B522B"},text:{size:s.size||"16px",font:s.font||"tahoma",italic:s.italic||!1,bold:s.bold||!1,cancel:s.cancel||!1,under:s.under||!1,color:s.color||"black",lineHeight:s.lineHeight||1.25,align:this.textAlign(s.align,"left")},color:e.color||"rgba(254,238,176,1)"}}function AbShapeEllipse(t){t||(t={});var e=t.style||{},i=e.stroke||{};if(this.name="ellipse",this.type="annotation",this.shapeType="shape",this.shapeStyle="box",this.token=null,this.selected=!1,this.focused=!1,this.indicator=AbCommon.isDefined(AbBoxEditIndicator)?new AbBoxEditIndicator({target:this}):null,this.angle=t.angle||0,AbCommon.allNumbers(t.x,t.y,t.width,t.height))this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height;else{var s=AbGraphics.box.rect(t.x1,t.y1,t.x2,t.y2);this.x=s.x,this.y=s.y,this.width=s.width,this.height=s.height}this.style={stroke:{width:AbCommon.isNumber(i.width)?i.width:1,color:i.color||"#41719C"},color:AbCommon.isDefined(e.color)?e.color:"rgba(91,155,213,0.8)"},this.points=[],this.prepare()}function AbShapeLine(t){t||(t={});var e=t.style||{};e.head||{},e.tail||{};this.name="line",this.type="annotation",this.shapeType="shape",this.shapeStyle="line",this.token=null,this.selected=!1,this.focused=!1,this.indicator=AbCommon.isDefined(AbLineEditIndicator)?new AbLineEditIndicator({target:this}):null,AbCommon.allNumbers(t.x,t.y,t.width,t.height)?(this.x1=t.x,this.y1=t.y,this.x2=t.x+t.width,this.y2=t.y+t.height):(this.x1=t.x1,this.y1=t.y1,this.x2=t.x2,this.y2=t.y2),this.angle=0;var i=e.width||1;this.style={width:i,color:e.color||"#FF0000",dots:AbGraphics.canvas.dashStyle(e.dots,"solid")},this.prepare()}function AbShapeArrow(t){t||(t={});var e=t.style||{},i=e.head||{},s=e.tail||{};this.name="arrow",this.type="annotation",this.shapeType="shape",this.shapeStyle="line",this.token=null,this.selected=!1,this.focused=!1,this.indicator=AbCommon.isDefined(AbLineEditIndicator)?new AbLineEditIndicator({target:this}):null,AbCommon.allNumbers(t.x,t.y,t.width,t.height)?(this.x1=t.x,this.y1=t.y,this.x2=t.x+t.width,this.y2=t.y+t.height):(this.x1=t.x1,this.y1=t.y1,this.x2=t.x2,this.y2=t.y2),this.angle=0,this.style={width:e.width||1,color:e.color||"#FF0000",dots:AbGraphics.canvas.dashStyle(e.dots,"solid"),head:{size:i.size||14,style:this.arrowStyle(i.style,"triangle")},tail:{size:s.size||14,style:this.arrowStyle(s.style,"none")}},this.prepare()}function AbShapePen(t){t||(t={});var e=t.style||{};if(this.name="pen",this.type="annotation",this.shapeType="shape",this.shapeStyle="box",this.token=null,this.selected=!1,this.focused=!1,this.indicator=AbCommon.isDefined(AbBoxEditIndicator)?new AbBoxEditIndicator({target:this}):null,this.angle=t.angle||0,AbCommon.allNumbers(t.x,t.y,t.width,t.height))this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height;else{var i=AbGraphics.box.rect(t.x1,t.y1,t.x2,t.y2);this.x=i.x,this.y=i.y,this.width=i.width,this.height=i.height}this.style={width:e.width||1,color:e.color||"rgb(41,0,139)"},this.creationSize="auto",this.collectPoints=!0,this.points=$.isArray(t.points)?t.points:[],this.minPointX=this.minPointY=this.maxPointX=this.maxPointY=0,this.prepare()}function AbShapeStamp(t){t||(t={});var e=t.style||{};e.stroke||{};this.name="stamp",this.type="annotation",this.shapeType="shape",this.shapeStyle="box",this.token=null;var i={left:6,top:6,right:6,bottom:6};if(this.selected=!1,this.focused=!1,this.indicator=AbCommon.isDefined(AbBoxEditIndicator)?new AbBoxEditIndicator({target:this}):null,this.angle=t.angle||0,this.textPadding={left:i.left,top:i.top,right:i.right,bottom:i.bottom,horiz:function(){return this.left+this.right},vert:function(){return this.top+this.bottom}},AbCommon.allNumbers(t.x,t.y,t.width,t.height))this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height;else{var s=AbGraphics.box.rect(t.x1,t.y1,t.x2,t.y2);this.x=s.x,this.y=s.y,this.width=s.width,this.height=s.height}this.extra={borderWidth:6,fontWeight:700,lineHeight:1.13,fontSizeFraction:.222,font:"Times New Roman",fontSize:40},this.style={color:AbCommon.isDefined(e.color)?e.color:"rgba(255,0,0,1)",text:AbCommon.isString(e.text)?e.text:"APPROVE"}}function AbShapeHighlightPen(t){t||(t={});var e=t.style||{};if(this.name="highlightpen",this.type="annotation",this.shapeType="shape",this.shapeStyle="box",this.token=null,this.selected=!1,this.focused=!1,this.indicator=AbCommon.isDefined(AbBoxEditIndicator)?new AbBoxEditIndicator({target:this}):null,this.angle=t.angle||0,AbCommon.allNumbers(t.x,t.y,t.width,t.height))this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height;else{var i=AbGraphics.box.rect(t.x1,t.y1,t.x2,t.y2);this.x=i.x,this.y=i.y,this.width=i.width,this.height=i.height}this.style={width:e.width||5,height:e.height||20,alpha:e.alpha||.65,color:e.color||"rgb(255,255,0)"},this.creationSize="auto",this.collectPoints=!0,this.points=$.isArray(t.points)?t.points:[],this.path=[],this.minPointX=this.minPointY=this.maxPointX=this.maxPointY=0,this.prepare()}function AbPage(t){t||(t={});var e=t.scale||{};this.loader=t.loader,this.uid=t.uid||AbCommon.uuid(),this.status=t.hasOwnProperty("status")?t.status:AbPage.prototype.LOADED,this.error=null,this.angle=t.angle||0,this.x=t.x||0,this.y=t.y||0,this.width=t.width||0,this.height=t.height||0,this.fitTo="in",this.scale={x:!e.x||e.x<=0?1:e.x,y:!e.y||e.y<=0?1:e.y},this.source=t.source||null,this.shapes=[]}function AbPageCollection(){this.source=[],this.map={}}function AbClipboard(){this.datas=[]}function AbHistoryAddShapeState(){this.type="shape",this.cmd="add",this.pageIndex=-1,this.shapes=[],this.start=0}function AbHistoryUpdateShapeState(){this.type="shape",this.cmd="update",this.pageIndex=-1,this.props=null,this.editPoint=null,this.un=[],this.re=[]}function AbHistoryRemoveShapeState(){this.type="shape",this.cmd="remove",this.pageIndex=-1,this.shapes=[]}function AbHistoryRemoveAllShapeState(){this.type="shape",this.cmd="all",this.pages=[],this.numAllShapes=0}function AbHistoryRemoveRangeShapeState(){this.type="shape",this.cmd="range",this.pageShapes=[],this.pages=[],this.numShapes=0}function AbHistoryZIndexShapeState(){this.type="shape",this.cmd="zindex",this.pageIndex=-1,this.moveCmd=null,this.direction=0,this.un=[],this.re=[]}function AbHistoryAddPageState(){this.type="page",this.cmd="add",this.pageIndex=-1,this.pages=[],this.start=0}function AbHistoryUpdatePageState(){this.type="page",this.cmd="update",this.pageIndex=-1,this.props=null,this.un=null,this.unToken=null,this.re=null,this.reToken=null,this.setter=null}function AbHistoryRemovePageState(){this.type="page",this.cmd="remove",this.pageIndex=-1,this.pages=[]}function AbHistory(t){t||(t={}),this.queue=[],this.queueSize=t.queueSize||100,this.index=-1,this.temp=null,this.locked=!1,this.enabled=!0}function AbImage(t){t||(t={}),this.width=t.width||0,this.height=t.height||0,this.info=t.info||null;var e=AbCommon.isString(t.image)?t.image:null,i=!AbCommon.isString(t.image)&&t.image?t.image:null;this.imgInfo={loaded:AbCommon.isSetted(i),url:e,element:i},e=AbCommon.isString(t.thumbnail)?t.thumbnail:null,i=!AbCommon.isString(t.thumbnail)&&t.thumbnail?t.thumbnail:null,this.thumbInfo={loaded:AbCommon.isSetted(i),url:e,element:i,originElement:i}}function AbThumbnailGenerator(t){t||(t={});var e=t.limit&&t.limit.width&&t.limit.height;this.limit={width:e?t.limit.width:AbThumbnailGenerator.prototype.MAX_WIDTH,height:e?t.limit.height:AbThumbnailGenerator.prototype.MAX_HEIGHT};var i=t.width&&t.height;this.source={width:i?t.width:this.limit.width,height:i?t.height:this.limit.height},this.ratio=1,this.calcRatio();var s=$('<canvas width="'+this.source.width+'" height="'+this.source.height+'"/>');this.context=s.get(0).getContext("2d")}function AbViewerEngineObservers(t){t||(t={}),this.engine=t.engine||null,this.listeners={},this.all=[]}function AbViewerEngineAnimateStates(t){t||(t={}),this.engine=t.engine||this,this.$states={},this.$animated=!1,this.$stack=[],this.$engine=!1}function AbViewerEngineSelection(t){t||(t={}),this.engine=t.engine||null,this.mode=null,this.target=null,this.edit=null,this.editTarget=null,this.clickTarget=null,this.direction=0,this.style={stroke:{width:1,color:"#99CCFF"},color:"rgba(202,229,255,0.27)"},this.start={x:0,y:0},this.end={x:0,y:0},this.prev={x:0,y:0},this.canvas={start:{x:0,y:0},end:{x:0,y:0},prev:{x:0,y:0}}}function AbViewerEngineTextBox(t){t||(t={}),this.engine=t.engine||this,this.e=null}function AbViewerEngine(t){t||(t={});var e=t.margin||{left:10,top:10,right:10,bottom:10},i=t.style||{};this.selector=t.selector,this.selector||(this.selector="#engine"),this.selectedShapes=[],this.focusedShape=null,this.$config=t.config||{},this.style={color:i.hasOwnProperty("color")?i.color:null},this.enableNotifySelectPage=!AbCommon.isBool(t.notifySelectPage)||t.notifySelectPage,this.waterMark=t.waterMark&&t.waterMark instanceof AbWaterMark?t.waterMark:null,this.waterMark&&this.waterMark.observe(this),this.status="ready",this.enabled=!0,this.engineMode="edit",this.runtime=!1,this.enableAnimate=!0,this.showingShapes=!0,this.showingShapeTypeMap={},this.margin={left:e.left,top:e.top,right:e.right,bottom:e.bottom,horiz:function(){return this.left+this.right},vert:function(){return this.top+this.bottom}},this.cancelAnyClick=!0,this.observers=new AbViewerEngineObservers({engine:this}),this.animateStates=new AbViewerEngineAnimateStates({engine:this}),this.pages=t.pages||new AbPageCollection,this.currentPageIndex=-1,this.currentPage=null,this.clipboard=t.clipboard||new AbClipboard,this.history=t.history||{lock:function(){},unlock:function(){},canUndo:function(){},canRedo:function(){},begin:function(){},end:function(){},cancel:function(){},undo:function(){},redo:function(){},clear:function(){}},this.selection=new AbViewerEngineSelection({engine:this}),this.panel=$(this.selector),this.viewContext=null,this.context=null,this.textbox=new AbViewerEngineTextBox({engine:this}),this.listening=!1,this.mouseTriggered=!1}function AbToolbar(t){t||(t={}),this.selector=t.selector||"#tb-main,#tb-left,#rb-right,#tb-thumb-popup-left",this.e=$(this.selector),this.observers=[],this.groupObservers=[],this.topics={},this.topicTypes={},this.topicGroups={},this.imageHoverTopics=[],this.clickHandler=function(t){var e=$(t.currentTarget),i="disabled"===e.attr("tb-enabled");if(!i){var s=e.attr("tb-topic"),n=e.attr("tb-type"),r="checked"===e.attr("tb-status");if("radio"==n&&r){var a=(e.attr("tb-user-lock")||"").split(",");if($.inArray("uncheck",a)>=0)return}this.click(s,!r)}}.bind(this),this.changeHandler=function(t){var e=$(t.currentTarget),i=e.attr("tb-topic");this.change(i,e.val(),e)}.bind(this),this.inputChangeHandler=function(t){var e=$(t.currentTarget),i=e.attr("tb-topic"),s=e.val();return $.isNumeric(s)?void this.change(i,e.val(),e):(e.blur(),AbMsgBox.error("숫자를 입력하세요"),void(e.attr("tb-origin-value")&&e.val(e.attr("tb-origin-value"))))}.bind(this),this.keydownHandler=function(t){t.stopPropagation(),t.stopImmediatePropagation()}.bind(this),this.keyupHandler=function(t){if(13==t.keyCode){var e=$(t.currentTarget),i=e.attr("tb-topic"),s=e.val();if(!$.isNumeric(s))return e.blur(),AbMsgBox.error("숫자를 입력하세요"),void(e.attr("tb-origin-value")&&e.val(e.attr("tb-origin-value")));this.change(i,e.val())}}.bind(this),this.mouseoverHandler=function(t){var e=$(t.currentTarget);this.mouseOver(e)}.bind(this),this.mouseoutHandler=function(t){var e=$(t.currentTarget);this.mouseOut(e)}.bind(this),this.prepare()}function AbImageListView(t){t||(t={});var e=t.selecting||{};this.name=t.name||"list",this.selector=t.selector||"#thumbnails",this.e=$(this.selector),this.listContainer=this.e.find('.adv-list [lt-topic="container"]'),this.eCheckAll=this.e.find('.head [lt-topic="all"]'),this.eViewSize=this.e.find('.head [lt-topic="viewsize"]'),this.ePagingArea=this.e.find(".foot .paginate"),this.bookmark=!!t.hasOwnProperty("bookmark")&&t.bookmark,this.selecting={method:AbCommon.isString(e.method)?e.method.split(/\|/g):AbCommon.isSetted(e.method)&&$.isArray(e.method)?e.method:["click"],auto:!AbCommon.isBool(e.auto)||e.auto},this.token=t.token,this.map={},this.children=[],this.renderedMap={},this.renderedChecks=[],this.renderedChildren=[],this.pager=this.createPager(),this.pager.pageCount(!t.pageCount||t.pageCount<1?4:t.pageCount),this.templateSelector=t.templateSelector||"#list-template",this.template=$(this.templateSelector),this.observers=[],this.viewSize=this.eViewSize.val(),this.viewSize>0&&this.pager.lineCount(this.viewSize),this.selectedIndex=-1,this.pages=t.pages,this.clickHandler=function(t){var e=$(t.currentTarget),i=$(t.target),s=$.inArray("click",this.selecting.method)>=0,n=e.attr("lt-status"),r=e.attr("lt-uid");if(this.notifyObservers("click",{uid:r,status:n}),e.hasClass("selected")||i.hasClass("no")||i.hasClass("display")||i.hasClass("text")||i.hasClass("checkmark")||i.hasClass("info")||t.target&&"input"==t.target.tagName.toLowerCase()){if("error"==n&&i.hasClass("content")){var a=e.index()+this.startIndex();e.attr("lt-status","loading"),this.notifyObservers("request.load",{index:a,page:this.pages.get(a)})}}else if("loaded"==n)s&&this.notifyObservers("select",r);else if("error"==n)if(i.hasClass("content")){var a=e.index()+this.startIndex();e.attr("lt-status","loading"),s?this.notifyObservers("request.load",{index:a,page:this.pages.get(a)}):this.notifyObservers("request.load")}else s&&this.notifyObservers("select",r)}.bind(this),this.dblClickHandler=function(t){var e=$(t.currentTarget),i=$(t.target),s=$.inArray("dblclick",this.selecting.method)>=0;if(s){var n=e.attr("lt-status"),r=e.attr("lt-uid");if("loaded"==n)this.notifyObservers("dblclick",r);else if("error"==n)if(i.hasClass("content")){var a=e.index()+this.startIndex();e.attr("lt-status","loading"),this.notifyObservers("request.load",{index:a,page:this.pages.get(a)})}else this.notifyObservers("dblclick",r)}}.bind(this),this.checkBookmarkHandler=function(t){var e=$(t.currentTarget),i=e.parents('[lt-topic="cover"]'),s=i.attr("lt-uid"),n=e.is(":checked");n?this.notifyObservers("bookmark.add",s):this.notifyObservers("bookmark.remove",s),t.preventDefault()}.bind(this),this.checkInfoHandler=function(t){var e=$(t.currentTarget),i=e.parents('[lt-topic="cover"]'),s=i.attr("lt-uid");this.notifyObservers("info",s)}.bind(this),this.eCheckAll.click(function(t){var e=$(t.currentTarget);this.toggleAll(e.is(":checked"))}.bind(this)),this.eViewSize.change(function(t){var e=$(t.currentTarget);this.changeView(e.val())}.bind(this)),this.ePagingArea.click(function(t){var e=($(t.currentTarget),$(t.target)),i=e.attr("lt-page");i&&(i=parseInt(i),this.paging(i))}.bind(this))}function AbImageViewer$$doPrint(){setTimeout(function(){var t=$("#print-loading");t.hide();var e=$("#print-frame"),i=AbCommon.contentDocument(e);if(!i||i.execCommand("print")===!1){var s=AbCommon.contentWindow(e);s&&s.print()}},100)}function AbImageViewer$$endPrint(t){var e=function(){var t=arguments.callee.id,e=AbImageViewer.prototype.URLS.PRINT.REMOVE;t&&AbCommon.ajax({url:e,data:{id:t}})};e.id=t,setTimeout(e,500)}function AbImageViewer(t){t||(t={});var e=t.style||{};this.$config=t.config||{},this.$permission=t.permission,this.margin=t.margin||null,this.observers=[],this.listeners={},AbViewerEngine.prototype.SHAPE_TABLE["masking.rectangle"]||(AbViewerEngine.prototype.SHAPE_TABLE["masking.rectangle"]=this.createMaskingShape("rectangle")),AbViewerEngine.prototype.SHAPE_TABLE["masking.ellipse"]||(AbViewerEngine.prototype.SHAPE_TABLE["masking.ellipse"]=this.createMaskingShape("ellipse")),this.history=new AbHistory,this.listType="pages",this.$showListViewPopup=!1,this.animatingEngine=!AbCommon.isBool(t.animate)||t.animate,this.enableNotifySelectPage=!AbCommon.isBool(t.notifySelectPage)||t.notifySelectPage,this._requestParam=null,this.listPopupStyle=e.listPopup||"default",this.defaultMode="view",t.mode?this.defaultMode=t.mode:t.config&&t.config.mode&&(this.defaultMode=t.config.mode),this.thumbnailGenerator=new AbThumbnailGenerator,this.images=new AbPageCollection,this.bookmarks=new AbPageCollection,this.imageListView=null,this.bookmarkListViewView=null,this.listView=null,this.styler=null,this.toolbar=null,this.colorPicker=null,this.stylerWindow=null,this.stylerWindowSelector=t.stylerWindowSelector||"#abstylewindow",this.waterMark=t.waterMark&&t.waterMark instanceof AbWaterMark?t.waterMark:new AbWaterMark,this.waterMark.observe(this),this.engine=new AbViewerEngine({config:this.$config,pages:this.images,history:this.history,margin:this.margin,waterMark:this.waterMark,notifySelectPage:this.enableNotifySelectPage})}function AbWaterMark(t){t||(t={});var e=t.style||{},i=e,s=(i.stroke||{},e.text||{});this.$source=null,this.$status="ready",this.$type="text",this.$position=t.position||"center middle",this.$angle=t.angle||0,this.$alpha=t.alpha||.1,this.$ratio=AbCommon.isNumber(t.ratio)?t.ratio:AbWaterMark.prototype.DEFAULT_RATIO,this.$margin=t.margin||{left:0,top:0,right:0,bottom:0},this.$style={text:{size:s.size||"64px",font:s.font||"tahoma",italic:s.italic||!1,bold:s.bold||!1,color:s.color||"black",lineHeight:s.lineHeight||1.25}},this.observers=[]}var AbRotate={CW:1,CCW:-1,DEG_90:1,DEG_180:2,DEG_270:3,DEG_360:0},AbIcons={CHECKER:{data:"resources/icon/shape.checker.svg",width:24,height:24,render:{width:256,height:256}},CHECKER_256_PNG:{data:"resources/icon/shape.checker-256.png",width:256,height:256},CHECKER_RED:{data:"resources/icon/shape.checker.red.svg",width:24,height:24},CHECKER_PNG:{data:"resources/icon/shape.checker.png",width:64,height:64}},Easing={get:function(t){return"string"==typeof t?"get"==t||"gsap"==t||"has"==t?null:this[t]:t},has:function(t){return null!=this[t]&&"function"==typeof this[t]},gsap:function(t){return function(e,i,s,n){var r,a,o=e/n,h=t.length,l=Math.floor(h*o);return r=(o-l*(1/h))*h,a=t[l],i+s*(a.s+r*(2*(1-r)*(a.cp-a.s)+r*(a.e-a.s)))}},linear:function(t,e,i,s){return i*t/s+e},swing:function(t,e,i,s){var n=(t/=s)*t,r=n*t;return e+i*(2.2025*r*n+-5.6525*n*n+3.2*r+n+.25*t)},rolling:function(t,e,i,s){var n=(t/=s)*t,r=n*t;return e+i*(1.0475*r*n+-4.9425*n*n+7.395*r+-5.7*n+3.2*t)},easeInQuad:function(t,e,i,s){return i*(t/=s)*t+e},easeOutQuad:function(t,e,i,s){return-i*(t/=s)*(t-2)+e},easeInOutQuad:function(t,e,i,s){return(t/=s/2)<1?i/2*t*t+e:-i/2*(--t*(t-2)-1)+e},easeInCubic:function(t,e,i,s){
return i*(t/=s)*t*t+e},easeOutCubic:function(t,e,i,s){return i*((t=t/s-1)*t*t+1)+e},easeInOutCubic:function(t,e,i,s){return(t/=s/2)<1?i/2*t*t*t+e:i/2*((t-=2)*t*t+2)+e},easeInQuart:function(t,e,i,s){return i*(t/=s)*t*t*t+e},easeOutQuart:function(t,e,i,s){return-i*((t=t/s-1)*t*t*t-1)+e},easeInOutQuart:function(t,e,i,s){return(t/=s/2)<1?i/2*t*t*t*t+e:-i/2*((t-=2)*t*t*t-2)+e},easeInQuint:function(t,e,i,s){return i*(t/=s)*t*t*t*t+e},easeOutQuint:function(t,e,i,s){return i*((t=t/s-1)*t*t*t*t+1)+e},easeInOutQuint:function(t,e,i,s){return(t/=s/2)<1?i/2*t*t*t*t*t+e:i/2*((t-=2)*t*t*t*t+2)+e},easeInSine:function(t,e,i,s){return-i*Math.cos(t/s*(Math.PI/2))+i+e},easeOutSine:function(t,e,i,s){return i*Math.sin(t/s*(Math.PI/2))+e},easeInOutSine:function(t,e,i,s){return-i/2*(Math.cos(Math.PI*t/s)-1)+e},easeInExpo:function(t,e,i,s){return 0==t?e:i*Math.pow(2,10*(t/s-1))+e},easeOutExpo:function(t,e,i,s){return t==s?e+i:i*(-Math.pow(2,-10*t/s)+1)+e},easeInOutExpo:function(t,e,i,s){return 0==t?e:t==s?e+i:(t/=s/2)<1?i/2*Math.pow(2,10*(t-1))+e:i/2*(-Math.pow(2,-10*--t)+2)+e},easeInCirc:function(t,e,i,s){return-i*(Math.sqrt(1-(t/=s)*t)-1)+e},easeOutCirc:function(t,e,i,s){return i*Math.sqrt(1-(t=t/s-1)*t)+e},easeInOutCirc:function(t,e,i,s){return(t/=s/2)<1?-i/2*(Math.sqrt(1-t*t)-1)+e:i/2*(Math.sqrt(1-(t-=2)*t)+1)+e},easeInElastic:function(t,e,i,s){if(0==t)return e;if(1==(t/=s))return e+i;var n=.3*s,r=0,a=0;return!r||r<Math.abs(i)?(r=i,a=n/4):a=n/(2*Math.PI)*Math.asin(i/r),-(r*Math.pow(2,10*(t-=1))*Math.sin((t*s-a)*(2*Math.PI)/n))+e},easeOutElastic:function(t,e,i,s){if(0==t)return e;if(1==(t/=s))return e+i;var n=.3*s,r=0,a=0;return!r||r<Math.abs(i)?(r=i,a=n/4):a=n/(2*Math.PI)*Math.asin(i/r),r*Math.pow(2,-10*t)*Math.sin((t*s-a)*(2*Math.PI)/n)+i+e},easeInOutElastic:function(t,e,i,s){if(0==t)return e;if(2==(t/=s/2))return e+i;var n=s*(.3*1.5),r=0,a=0;return!r||r<Math.abs(i)?(r=i,a=n/4):a=n/(2*Math.PI)*Math.asin(i/r),t<1?-.5*(r*Math.pow(2,10*(t-=1))*Math.sin((t*s-a)*(2*Math.PI)/n))+e:r*Math.pow(2,-10*(t-=1))*Math.sin((t*s-a)*(2*Math.PI)/n)*.5+i+e},easeInBack:function(t,e,i,s){var n=1.70158;return i*(t/=s)*t*((n+1)*t-n)+e},easeOutBack:function(t,e,i,s){var n=1.70158;return i*((t=t/s-1)*t*((n+1)*t+n)+1)+e},easeInOutBack:function(t,e,i,s){var n=1.70158;return(t/=s/2)<1?i/2*(t*t*(((n*=1.525)+1)*t-n))+e:i/2*((t-=2)*t*(((n*=1.525)+1)*t+n)+2)+e},easeInBounce:function(t,e,i,s){return i-Easing.easeOutBounce(s-t,0,i,s)+e},easeOutBounce:function(t,e,i,s){return(t/=s)<1/2.75?i*(7.5625*t*t)+e:t<2/2.75?i*(7.5625*(t-=1.5/2.75)*t+.75)+e:t<2.5/2.75?i*(7.5625*(t-=2.25/2.75)*t+.9375)+e:i*(7.5625*(t-=2.625/2.75)*t+.984375)+e},easeInOutBounce:function(t,e,i,s){return t<s/2?.5*Easing.easeInBounce(2*t,0,i,s)+e:.5*Easing.easeOutBounce(2*t-s,0,i,s)+.5*i+e}},AbColor={HSV_MAX:255,rgb2hsv:function(t,e,i){t<0&&(t=0),e<0&&(e=0),i<0&&(i=0),t>255&&(t=255),e>255&&(e=255),i>255&&(i=255),t/=255,e/=255,i/=255;var n=Math.max(t,e,i),r=Math.min(t,e,i),a=n-r;return 0==a?h=0:n==t?h=(e-i)/a%6:n==e?h=(i-t)/a+2:h=(t-e)/a+4,h*=60,h<0&&(h+=360),v=n,0==v?s=0:s=a/v,[h,s,v]},hsv2rgb:function(t,e,i){t<0&&(t=0),e<0&&(e=0),i<0&&(i=0),t>=360&&(t=359),e>1&&(e=1),i>1&&(i=1);var s=i*e,n=t/60,a=s*(1-Math.abs(n%2-1));r=g=b=0,n>=0&&n<1?(r=s,g=a):n>=1&&n<2?(r=a,g=s):n>=2&&n<3?(g=s,b=a):n>=3&&n<4?(g=a,b=s):n>=4&&n<5?(r=a,b=s):(r=s,b=a);var o=i-s;return r+=o,g+=o,b+=o,r*=255,g*=255,b*=255,r=Math.round(r),g=Math.round(g),b=Math.round(b),[r,g,b]},rgb2hsl:function(t,e,i){t<0&&(t=0),e<0&&(e=0),i<0&&(i=0),t>255&&(t=255),e>255&&(e=255),i>255&&(i=255),t/=255,e/=255,i/=255;var s=Math.max(t,e,i),n=Math.min(t,e,i),r=s-n,a=0,o=0,h=(s+n)/2,l=1-Math.abs(2*h-1);return r&&(s===t&&(a=(e-i)/r),s===e&&(a=2+(i-t)/r),s===i&&(a=4+(t-e)/r),s&&(o=r/l)),a=60*a|0,a<0&&(a+=360),[a,o,h]},hsl2rgb:function(t,e,i){var s=e*(1-Math.abs(2*i-1)),n=t/60,r=s*(1-Math.abs(n%2-1)),a=i-s/2,o=255;return s=(s+a)*o|0,r=(r+a)*o|0,a=a*o|0,n>=0&&n<1?[s,r,a]:n>=1&&n<2?[r,s,a]:n>=2&&n<3?[a,s,r]:n>=3&&n<4?[a,r,s]:n>=4&&n<5?[r,a,s]:n>=5&&n<6?[s,a,r]:[0,0,0]}},AbCss={imageRendering:function(t,e){switch(e||(e="smooth"),e){case"pixel":t.css("-ms-interpolation-mode","nearest-neighbor"),t.css("image-rendering","pixelated");break;case"smooth":t.css("-ms-interpolation-mode","bicubic"),t.css("image-rendering","-webkit-optimize-contrast"),t.css("image-rendering","-webkit-crisp-edges"),t.css("image-rendering","-moz-crisp-edges"),t.css("image-rendering","-o-crisp-edges")}},hex:function(t,e,s){var n=65536*t+256*e+s;if(n=n.toString(16,6),len=n.length,len<6)for(i=0;i<6-len;i++)n="0"+n;return"#"+n.toUpperCase()},pixel:function(t){var e=$.trim(t),i=/[^0-9]+/g.exec(t),s="px";i&&(s=i[0]),e=parseFloat(e.replace(s,"")),defaultFontPixel=10;var n=AbGraphics.dpi(),r=e;switch(s.toLowerCase()){case"em":r=e/defaultFontPixel;break;case"%":r=100*e/defaultFontPixel;break;case"pt":r=e*n/96}return r},color:function(t){if(t=t.trim().toLowerCase(),"transparent"==t)return[0,0,0,0];t=this.COLOR_TABLE[t]||t;var e=t.match(/^#([0-9a-f]{3})$/i);if(e)return e=e[1],[17*parseInt(e.charAt(0),16),17*parseInt(e.charAt(1),16),17*parseInt(e.charAt(2),16),1];var i=t.match(/^#([0-9a-f]{6})$/i);if(i)return i=i[1],[parseInt(i.substr(0,2),16),parseInt(i.substr(2,2),16),parseInt(i.substr(4,2),16),1];var s=t.match(/^rgba\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+.*\d*)\s*\)$/i)||t.match(/^rgba\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)$/i);if(s)return[parseInt(s[1]),parseInt(s[2]),parseInt(s[3]),void 0===s[4]?1:parseFloat(s[4])];var n=t.match(/^rgb\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)$/i);return n?[parseInt(n[1]),parseInt(n[2]),parseInt(n[3]),1]:0==t.indexOf("hsl")||0==t.indexOf("hsla")?this.hsl2Rgb(t):void 0},hsl2rgb:function(t){"string"==typeof t&&(t=t.match(/(\d+(\.\d+)?)/g));var e,i,s,n,r,a=t[0]/360,o=t[1]/100,h=t[2]/100,l=void 0===t[3]?1:t[3];if(0==o)r=Math.round(255*h),n=[r,r,r,l];else{i=h<.5?h*(1+o):h+o-h*o,e=2*h-i,n=[0,0,0];for(var c=0;c<3;c++)s=a+1/3*-(c-1),s<0&&s++,s>1&&s--,r=6*s<1?e+6*(i-e)*s:2*s<1?i:3*s<2?e+(i-e)*(2/3-s)*6:e,n[c]=Math.round(255*r)}return n.push(l),n},COLOR_TABLE:{aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgreen:"#006400",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",gray:"#808080",green:"#008000",greenyellow:"#adff2f",honeydew:"#f0fff0",hotpink:"#ff69b4",indianred:"#cd5c5c",indigo:"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgray:"#d3d3d3",lightgreen:"#90ee90",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370db",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#db7093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd32"}},AbExifMetaReader={read:function(t){if(!t)return null;var e=0;for(var i in t)t.hasOwnProperty(i)&&e++;if(!e)return null;var s=null;if(t.GPSLatitude&&t.GPSLongitude){var n={versionID:t.GPSVersionID,latitudeRef:t.GPSLatitudeRef,latitude:t.GPSLatitude,longitudeRef:t.GPSLongitudeRef,longitude:t.GPSLongitude,altitudeRef:t.GPSAltitudeRef,altitude:t.GPSAltitude},r=this.dmsNumberArray(n.latitude),a=this.dmsNumberArray(n.longitude),o=this.gpsValue(n.altitude),h={latRef:n.latitudeRef,lat:r,lngRef:n.longitudeRef,lng:a,altRef:n.altitudeRef,alt:o},e=0;for(var i in h)h.hasOwnProperty(i)&&h[i]&&h[i]&&e++;e>0&&(s=h)}var l={make:t.Make,model:t.Model,software:t.Software,datetime:this.ymdhis(t.DateTime),orientation:this.value(t.Orientation),xresolution:this.value(t.XResolution),yresolution:this.value(t.YResolution),resolutionUnit:this.value(t.ResolutionUnit),xdimension:this.value(t.PixelXDimension),ydimension:this.value(t.PixelYDimension),gps:s},e=0;for(var i in l)l.hasOwnProperty(i)&&l[i]&&e++;return e>0?l:null},ymdhis:function(t){return t?t.replace(/[\-\s:]/g,""):t},gpsText:function(t){if(!t||!$.isArray(t))return 0;var e=this.gpsValue(t[0]),i=this.gpsValue(t[1]),s=this.gpsValue(t[2]);return e+"° "+i+"' "+s+'"'},dmsNumberArray:function(t){return[this.gpsValue(t[0]),this.gpsValue(t[1]),this.gpsValue(t[2])]},dms2degree:function(t){if(!t||!$.isArray(t))return 0;var e=this.gpsValue(t[0]),i=this.gpsValue(t[1]),s=this.gpsValue(t[2]);return e+i/60+s/3600},toInt:function(t){var e=1e5*t,i=Math.round(e),s=i/1e5;return s},degree2dms:function(t){var e=parseInt(t),i=60*(t-e),s=parseInt(i),n=60*(i-s);return[e,this.toInt(s),this.toInt(n)]},gpsValue:function(t){if("undefined"==typeof t||null==t)return 0;if(AbCommon.isString(t)){var e=t.split("/");t=e.length>1?parseFloat(e[0])/parseFloat(e[1]):parseFloat(e[0])}else t instanceof Number&&(t=parseFloat(t));return t},value:function(t){return t instanceof Number&&(t=parseFloat(t)),t}},AbDurationTimer={data:{},start:function(t){"undefined"!=typeof t&&t||(t="def"),this.data[t]={start:new Date,end:null}},end:function(t,e){"undefined"!=typeof t&&t||(t="def"),"undefined"==typeof e&&(e=!0),this.data[t]?this.data[t].end=new Date:this.data[t]={start:null,end:new Date},e&&this.log(t)},log:function(t){"undefined"!=typeof t&&t||(t="def");var e="";if(this.data[t]){var i=this.data[t];if(i.start&&i.end){var s=i.end.getTime()-i.start.getTime();e=s+"ms "+s/1e3+"s"}else i.start||(e="start is null"),i.end||(e="end is null")}else e="not found";console.log("["+t+"] "+e)}},AbLoading={get:function(t){return t||(t={}),new AbLoadingController({selector:"#server-loading",text:t.text||"",html:t.html||""})}},AbLoadingController=function(t){t||(t={}),this.e=$(t.selector),this.etext=this.e.find('[pl-topic="text"]'),t.html?this.etext.html(t.html):t.text&&this.etext.text(t.text)};AbLoadingController.prototype={constructor:AbLoadingController,show:function(){this.e.show()},hide:function(){this.e.hide()}};var AbCommon={cookie:{get:function(t){var e=document.cookie.indexOf(t+"=");return e!=-1?(e+=t.length+1,end=document.cookie.indexOf(";",e),end==-1&&(end=document.cookie.length),unescape(document.cookie.substring(e,end))):null},setAlways:function(t,e){this.set(t,e,31536e3)},set:function(t,e,i,s){var n=new Date;if(null==i)document.cookie=t+"="+escape(e)+"; path=/;";else{switch(s){case"y":case"Y":n.setFullYear(n.getFullYear()+i);break;case"m":case"M":n.setMonth(n.getMonth()+i);break;case"h":case"H":n.setHours(n.getHours()+i);break;case"i":case"I":n.setMinutes(n.getMinutes()+i);break;case"s":case"S":n.setSeconds(n.getSeconds()+i);break;default:n.setDate(n.getDate()+i)}document.cookie=t+"="+e+"; path=/; expires="+n.toGMTString()+";"}},remove:function(t){var e=new Date;e.setDate(e.getDate()-1),document.cookie=t+"= ; expires="+e.toGMTString()+"; path=/"}},wheel:{PIXEL_STEP:100,LINE_HEIGHT:40,PAGE_HEIGHT:800,normalize:function(t){var e=0,i=0,s=0,n=0;return"detail"in t&&(i=t.detail),"wheelDelta"in t&&(i=-t.wheelDelta/120),"wheelDeltaY"in t&&(i=-t.wheelDeltaY/120),"wheelDeltaX"in t&&(e=-t.wheelDeltaX/120),"axis"in t&&t.axis===t.HORIZONTAL_AXIS&&(e=i,i=0),s=e*this.PIXEL_STEP,n=i*this.PIXEL_STEP,"deltaY"in t&&(n=t.deltaY),"deltaX"in t&&(s=t.deltaX),(s||n)&&t.deltaMode&&(1==t.deltaMode?(s*=this.LINE_HEIGHT,n*=this.LINE_HEIGHT):(s*=this.PAGE_HEIGHT,n*=this.PAGE_HEIGHT)),s&&!e&&(e=s<1?-1:1),n&&!i&&(i=n<1?-1:1),{spinX:e,spinY:i,pixelX:s,pixelY:n}}},getBrowser:function(){var t=navigator.userAgent.toLowerCase();return t.indexOf("trident")>0||t.indexOf("msie")>0?"ie":t.indexOf("opera")>0?"opera":t.indexOf("firefox")>0?"firefox":t.indexOf("chrome")>0?"chrome":t.indexOf("safari")>0?"safari":"unknown"},ieVersion:function(){var t=navigator.userAgent.toLowerCase(),e=null;if("Microsoft Internet Explorer"==navigator.appName)e="msie";else if(t.search("trident")>-1)e="trident/.*rv:";else{if(!(t.search("edge/")>-1))return-1;e="edge/"}var i=new RegExp(e+"([0-9]{1,})(\\.{0,}[0-9]{0,1})");return null!=i.exec(t)?parseFloat(RegExp.$1+RegExp.$2):-1},requestAnimFrame:function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame},cancelAnimFrame:function(){return window.cancelAnimationFrame||window.mozCancelAnimationFrame},tween:function(t){function e(i){null==n&&(n=i);var o=Easing.get(t.easing),h=i-n,l=o(h,0,t.end-t.start,t.duration);isNaN(l)&&(l=0),l=t.start+l;var c=!1;c&&(l=t.end),t.proc.call(r||t.proc,l,t,null!=a?l-a:0),a=l,h<t.duration?s(e):"function"==typeof t.ended&&t.ended.call(r||t.ended,t)}if(t||(t={}),"function"==typeof t.proc){var i=!0;AbCommon.isSetted(t.start)||(t.start=0),AbCommon.isSetted(t.end)||(t.end=t.start+100),AbCommon.isSetted(t.easing)||(t.easing="swing"),AbCommon.isSetted(t.duration)||(t.duration=300),AbCommon.isSetted(t.animating)&&(i=t.animating);var s=this.requestAnimFrame();"function"!=typeof s&&(t.animating=!1);var n=(this.runtime,null),r=t.caller,a=null;"function"==typeof t.starting&&t.starting.call(r||t.starting,t),i===!0?s(e):(t.proc.call(r||t.proc,t.end,t),"function"==typeof t.ended&&t.ended.call(r||t.ended,t))}},uuid:function(){for(var t=[],e="0123456789abcde",i=0;i<36;i++)t[i]=e.substr(Math.floor(16*Math.random()),1);t[14]="4",t[19]=e.substr(3&t[19]|8,1),t[8]=t[13]=t[18]=t[23]="-";var s=t.join("");return s},flag:function(t,e){return(t&e)==e},isSetted:function(t){return"undefined"!=typeof t&&null!=t},isDefined:function(t){return"undefined"!=typeof t},isFunction:function(t){return"function"==typeof t},isString:function(t){return"string"==typeof t},isNumber:function(t){return"number"==typeof t},isBool:function(t){return"boolean"==typeof t},escape:function(t){return t?t.replace(/&/gi,"&amp;").replace(/&/gi,"&nbsp;").replace(/</gi,"&lt;").replace(/>/gi,"&gt;").replace(/'/g,"&#039;").replace(/"/g,"&quot;"):t},ENABLE_WEB_WORKER:!0,supportWebWorker:function(){return null!=window.Worker&&void 0!=window.Worker&&AbCommon.ENABLE_WEB_WORKER},contentWindow:function(t){return t.length?t.get(0).contentWindow:null},contentDocument:function(t){if(!t.length)return null;var e=t.get(0);return e.contentWindow?e.contentWindow.document:e.contentDocument?e.contentDocument.document?e.contentDocument.document:e.contentDocument:null},allNumbers:function(){for(var t=arguments.length,e=0;e<t;e++)if(!this.isNumber(arguments[e]))return!1;return!0},scrolledParents:function(t){for(t=t.parent();t&&t.length;){var e=t.get(0),i=e.offsetWidth<e.scrollWidth&&e.scrollLeft,s=e.offsetHeight<e.scrollHeight&&e.scrollTop;if(i||s)return{x:e.scrollLeft,y:e.scrollTop};t=t.parent()}return{x:0,y:0}},BYTE_UNITS:["Bytes","KB","MB","GB","TB","PB"],byteScope:function(t,e){AbCommon.isNumber(e)||(e=1);var i=this.BYTE_UNITS;if(0==t)return t+" "+i[0];var s=Math.floor(Math.log(t)/Math.log(1024)),n=parseInt(s);s=t/Math.pow(1024,n);for(var r=1,a=0;a<e;a++)r*=10;return s=Math.round(s*r)/r,s+" "+i[n]},promiseAll:function(t,e,i){var s=0,n=0,r=0;if(AbCommon.isNumber(i))s=i;else{i||(i={});var a=i.term||{};s=a.resolve||0,n=a.progree||0,r=a.promise||0}return $.isArray(t)||(t=[t]),new Promise(function(i,r){var a=t.length,o=0;if(0==a)return void setTimeout(i.bind(null),s);for(var h=0;h<a;h++){var l=function(){var t=arguments.callee.promise;t.then(function(){o++,o>=a?(e&&setTimeout(function(){e(o,a)},n),setTimeout(i.bind(null),s)):e&&setTimeout(function(){e(o,a)},n)}).catch(function(t){r(t)})};l.promise=t[h],setTimeout(l,0)}})},sequencePromiseAll:function(t,e,i){var s=0,n=0,r=0,a=0;if(AbCommon.isNumber(i))s=i;else{i||(i={});var o=i.term||{};s=o.resolve||0,n=o.progree||0,r=o.promise||0,a=o.exec||0}return $.isArray(t)||(t=[t]),new Promise(function(i,r){var o=t.length,h=0;if(0==o)return void setTimeout(i.bind(null),s);var l=function(){var c=t[h];c.then(function(){h++,h>=o?(e&&setTimeout(function(){e(h,o)},n),setTimeout(i.bind(null),s)):(e&&setTimeout(function(){e(h,o)},n),setTimeout(l,a))}).catch(function(t){r(t)})};setTimeout(l,a)})},isHistoryState:function(t){return t&&t.type&&t.cmd&&"function"==typeof t.begin&&"function"==typeof t.end&&"function"==typeof t.undo&&"function"==typeof t.redo&&"function"==typeof t.dispose},indexArrayOf:function(t,e,i){2==arguments.length&&(i=!1);for(var s=t.length,n=e.slice(0),r=[],a=-1,o=0;o<s;o++)(a=$.inArray(t[o],n))>=0&&(i?r.push({index:o,source:n[a]}):r.push(o),n.splice(a,1));return r},disposeShapes:function(t){for(var e=t.length,i=0;i<e;i++)"function"==typeof t[i].dispose&&t[i].dispose();t.splice(0,t.length)},isFileData:function(t){return t&&(t instanceof File||t.hasOwnProperty("name")&&t.hasOwnProperty("type")&&t.hasOwnProperty("size"))},isShape:function(t){return t&&t.shapeStyle&&"function"==typeof t.move&&"function"==typeof t.styleDesc&&"function"==typeof t.setAngle&&"function"==typeof t.center&&"function"==typeof t.padding&&"function"==typeof t.rect&&"function"==typeof t.box&&"function"==typeof t.contains&&"function"==typeof t.editable&&"function"==typeof t.editPos&&"function"==typeof t.resize&&"function"==typeof t.measure&&"function"==typeof t.notify&&"function"==typeof t.serialize&&"function"==typeof t.prepare&&"function"==typeof t.reset&&"function"==typeof t.draw},isStrokeShape:function(t){return t&&t.shapeStyle&&"function"==typeof t.addPoint&&"function"==typeof t.endPoint},hasShapeStyle:function(t){var e=t?t.styleDesc():null;return e&&e.descs&&e.descs.length>0},needPreloading:function(t){return t&&"function"==typeof t.preload},wannaCollectPoints:function(t){return this.isStrokeShape(t)&&t.hasOwnProperty("collectPoints")&&t.collectPoints===!0},isSupportInlineEditShape:function(t){return t&&t.shapeStyle&&"function"==typeof t.inlineEdit&&"function"==typeof t.testInlineEdit},hasCreationStyleShape:function(t){return t&&t.shapeStyle&&"function"==typeof t.creationStyle},supportCreationDraw:function(t){return t&&t.shapeStyle&&"function"==typeof t.creationDraw},supportRestoreMinimumSize:function(t){return t&&t.shapeStyle&&"function"==typeof t.restoreMinimumSize},supportResizable:function(t){return t&&t.shapeStyle&&"function"==typeof t.resizable},hasValidLineDistance:function(t){return t&&t.shapeStyle&&"function"==typeof t.validLineDistance},hasMinimum:function(t){return t&&t.shapeStyle&&"function"==typeof t.minimum},hasCreationMinimum:function(t){return t&&t.shapeStyle&&"function"==typeof t.creationMinimum},hasClass:function(t){return t.constructor&&t.constructor.name&&"object"!=t.constructor.name.toLowerCase()},getBounds:function(t){return t.getBoundingClientRect?t.getBoundingClientRect():{left:0,top:0,right:0,bottom:0,width:0,height:0}},cloneShape:function(t){function e(s,n,r){$.isArray(r)||(r=[]);var a=null;AbCommon.isFunction(t.adviceClone)&&(a=t.adviceClone());for(var o in n)if(n.hasOwnProperty(o)&&$.inArray(o,r)<0){var h=n[o];if(a){if(a.moveProps&&$.inArray(o,a.moveProps)>=0){s[o]=h,delete n[o];continue}if(a.customProps&&$.inArray(o,a.customProps)>=0){s[o]=a.custom(o,h);continue}}if(AbCommon.isSetted(h))if($.isArray(h))s[o]=h.slice(0);else if(AbCommon.isString(h)||AbCommon.isNumber(h)||AbCommon.isBool(h))s[o]=h;else if(AbCommon.isFunction(h))s[o]=h.bind(s);else{var l=!0;AbCommon.hasClass(h)&&(l=h.$$CLONE===!0),l?(s[o]=AbCommon.createObject(h),h.$$CHAIN?(e(s[o],h,[h.$$CHAIN]),h.$$CHAIN&&(s[o][h.$$CHAIN]=i)):e(s[o],h)):s[o]=h}else s[o]=null}}var i=AbCommon.createObject(t);return e(i,t),i},clone:function(t){function e(t,i){for(var s in i)if(i.hasOwnProperty(s)){var n=i[s];if(AbCommon.isSetted(n))if($.isArray(n))t[s]=n.slice(0);else if(AbCommon.isString(n)||AbCommon.isNumber(n)||AbCommon.isBool(n))t[s]=n;else if(AbCommon.isFunction(n))t[s]=n.bind(t);else{var r=!0;AbCommon.hasClass(n)&&(r=n.$$CLONE===!0),r?(t[s]=AbCommon.createObject(n),e(t[s],n)):t[s]=n}else t[s]=null}}var i=AbCommon.createObject(t);return e(i,t),i},deepClone:function(t){function e(t,i){for(var s in i)if(i.hasOwnProperty(s)){var n=i[s];AbCommon.isSetted(n)?$.isArray(n)?t[s]=n.slice(0):AbCommon.isString(n)||AbCommon.isNumber(n)||AbCommon.isBool(n)?t[s]=n:AbCommon.isFunction(n)?t[s]=n.bind(t):(t[s]=AbCommon.createObject(n),e(t[s],n)):t[s]=null}}var i=AbCommon.createObject(t);return e(i,t),i},equals:function(t,e){function i(t){if("function"==typeof Object.keys)return Object.keys(t);var e=[];for(var i in t)e.push(i);return e}function s(t){return null===t||void 0===t}function n(t){return"[object Arguments]"==Object.prototype.toString.call(t)}function r(t,e){if(s(t)||s(e))return!1;if(t.prototype!==e.prototype)return!1;if(n(t))return!!n(e)&&(t=Array.prototype.slice.call(t),e=Array.prototype.slice.call(e),AbCommon.equals(t,e));var r,a,o=null,h=null;try{o=i(t),h=i(e)}catch(t){return!1}if(o.length!=h.length)return!1;for(o.sort(),h.sort(),a=o.length-1;a>=0;a--)if(o[a]!=h[a])return!1;for(a=o.length-1;a>=0;a--)if(r=o[a],!AbCommon.equals(t[r],e[r]))return!1;return!0}return t===e||(t instanceof Date&&e instanceof Date?t.getTime()===e.getTime():"object"!=typeof t&&"object"!=typeof e?t==e:r(t,e))},copyArray:function(t,e,i){var s=t.length;arguments.length<2&&(e=0),arguments.length<3&&(i=s);for(var n=[],r=e;r<i;r++)n.push(t[r]);return n},createObject:function(t){try{return Object.create(t)}catch(e){return t.constructor?t.constructor():{}}},copyProp:function(t,e,i){for(var s in t)if(t.hasOwnProperty(s)&&(!i||$.inArray(s,i)>=0)){var n=t[s];AbCommon.isSetted(n)?$.isArray(n)?e[s]=n.slice(0):AbCommon.isString(n)||AbCommon.isNumber(n)||AbCommon.isBool(n)?e[s]=n:(e[s]=this.createObject(n),this.copyProp(n,e[s])):e[s]=null}return e},shapeProp:function(t,e){function i(t,e,s,n){n?n+=".":n="";for(var r in e)if(e.hasOwnProperty(r)){var a=e[r],o=!AbCommon.isSetted(a),h=$.isArray(a),l=AbCommon.isString(a)||AbCommon.isNumber(a)||AbCommon.isBool(a);(o||h||l)&&AbCommon.isFunction(t.cloneProperty)&&t.cloneProperty(n+r,a),o?s[r]=null:h?s[r]=a.slice(0):l?s[r]=a:(AbCommon.isSetted(s[r])||(s[r]=this.createObject(a)),i(t,a,s[r],n+r))}}return i(t,e,t),t},engineScale:function(t){return t&&t.engine&&t.engine.currentPage?{x:t.engine.currentPage.scale.x,y:t.engine.currentPage.scale.y}:{x:1,y:1}},xmlHeader:function(){return'<?xml version="1.0" encoding="UTF-8"?>'},removeXmlHeader:function(t){return t.replace(/^\s*<\?(.*)\?>\s*/g,"")},deserializeShapeXmlNode:function(t,e){if(t&&t.length)for(var i=t.children(),s=i.length,n=0;n<s;n++){var r=$(i.get(n)),a=r.get(0).tagName;if("group"===r.attr("ptype"))e[a]={},this.deserializeShapeXmlNode(r,e[a]);else{var o=null;if("true"!=r.attr("nul")){var h=r.attr("type");o=r.text(),"json"==h?o=JSON.parse(o):"number"==h?o=parseFloat(o):"boolean"==h&&(o="true"==o)}e[a]=o}}},deserializeShape:function(t){if(!t)return null;var e=$($.parseXML(t)),i={};return this.deserializeShapeXmlNode(e.find("shape"),i),i},xmlString:function(t){return"undefined"!=typeof XMLSerializer?(new XMLSerializer).serializeToString(t):t.xml},parsePageShapes:function(t){if(!t)return null;var e=$($.parseXML(t)),i=e.find("shape");return{body:e,shapes:i}},deserializePageShapes:function(t){if(!t)return null;for(var e=$($.parseXML(t)),i=[],s=e.find("shape"),n=s.length,r=0;r<n;r++){var a=$(s.get(r)),o={};this.deserializeShapeXmlNode(a,o),i.push(o)}return i},isDataUrl:function(t){return t&&AbCommon.isString(t)&&0==t.indexOf("data:")},isBlobUrl:function(t){return t&&AbCommon.isString(t)&&0==t.indexOf("blob:")},dataUrlContent:function(t){return t.substr(t.indexOf(",")+1)},createImage:function(){var t=new Image;return AbCommon.ieVersion()!=-1&&(t.crossOrigin="Anonymous"),t},loadImage:function(t){return new Promise(function(e,i){var s=AbCommon.createImage();s.onload=function(t){setTimeout(e.bind(null,this),0)},s.onerror=function(t){setTimeout(i.bind(null,new Error("It is not an image file")),0)},s.src=t})},loadImageAsDataURL:function(t){return new Promise(function(e,i){if(AbCommon.isDataUrl(t))e(t);else{var s=new FileReader;s.onload=function(t){e(t.target.result)};var n=AbCommon.xmlHttpRequest({path:t,responseType:"blob",load:function(t,e){s.readAsDataURL(e.response)},error:function(t,e){i(t)}});n.send()}})},loadImageExt:function(t,e){e||(e={});var i=AbCommon.getBrowser(),s="ie"===i,n="firefox"===i,r=s||n,a=AbCommon.isDataUrl(t),o=r&&!a&&t.toLowerCase().lastIndexOf(".svg")==t.length-4;if(o)AbCommon.ajax({type:"GET",url:t,data:null,dataType:"text",timeout:1e6,success:function(t){try{var i=$($.parseXML(t)),s=i.find("svg").get(0),n=$(s);AbCommon.isNumber(e.width)&&n.attr("width",e.width),AbCommon.isNumber(e.height)&&n.attr("height",e.height);var r=n.attr("width"),a=n.attr("height");try{r=parseInt(r)}catch(t){r=null}try{a=parseInt(a)}catch(t){a=null}isNaN(r)&&(r=null),isNaN(a)&&(a=null);var o=i.get(0),h=AbCommon.xmlString(o);console.log(h),AbVendor.renderSVG(h,r,a,function(t,i){var s=AbGraphics.canvas.toImage(t,"png"),n=AbCommon.createImage();n.onerror=function(t){AbCommon.isFunction(e.error)&&e.error(t)}.bind(this),n.onload=function(){AbCommon.isFunction(e.success)&&e.success(n)}.bind(this),n.src=s})}catch(t){AbCommon.isFunction(e.error)&&e.error(t)}}.bind(this),error:function(t,i,s){AbCommon.isFunction(e.error)&&e.error(new Error("SVG load error: "+i))}.bind(this)});else{var h=AbCommon.createImage();h.onerror=function(t){AbCommon.isFunction(e.error)&&e.error(t)}.bind(this),h.onload=function(){AbCommon.isFunction(e.success)&&e.success(h)}.bind(this),h.src=t}},ajax:function(t){if(t&&t.url&&""!=t.url.replace(/\s/g,"")){t.type?t.type=t.type.toUpperCase():t.type="POST",t.dataType?t.dataType=t.dataType.toLowerCase():t.dataType="json",(!t.timeout||t.timeout<=0)&&(t.timeout=1e6),AbCommon.isDefined(t.loading)||(t.loading=!0);var e="boolean"==typeof t.logAll&&t.logAll,i="boolean"==typeof t.logSuccess&&t.logSuccess,s="boolean"!=typeof t.logFail||t.logFail,n="boolean"!=typeof t.async||t.async,r=t.url;t.useResponseType===!0&&(r+=r.indexOf("?")>=0?"&":"?",r+="responseType="+t.dataType);var a=t.delayExec||0;AbCommon.isFunction(t.loadFunc)&&t.loadFunc.call(t.caller||t.loadFunc,!0),$.ajax({type:t.type,url:r,data:t.data,async:n,dataType:t.dataType,timeout:t.timeout,success:function(r){AbCommon.isFunction(t.loadFunc)&&t.loadFunc.call(t.caller||t.loadFunc,!1);var o=function(){var t=arguments.callee.result,e=arguments.callee.options,i=arguments.callee.logAll,s=arguments.callee.logSuccess;arguments.callee.logFail;if(i||s){var n=e.title?e.title+"에 실패했습니다\n":"",r=n+" 전송 성공";console.log(r)}e.success&&"function"==typeof e.success&&e.success.call(e.caller?e.caller:e.success,t)};o.result=r,o.options=t,o.logAll=e,o.logSuccess=i,o.logFail=s,n&&a>=0?setTimeout(o,a):o()},error:function(r,o,h){AbCommon.isFunction(t.loadFunc)&&t.loadFunc.call(t.caller||t.loadFunc,!1);var l=function(){var t=arguments.callee.xhr,e=arguments.callee.ts,i=arguments.callee.et,s=arguments.callee.options,n=arguments.callee.logAll,r=(arguments.callee.logSuccess,arguments.callee.logFail),o=AbCommon.remoteErrorProcess(s,t,e,i,n||r);if(s.error&&"function"==typeof s.error&&s.error.call(s.caller?s.caller:s.error,t,e,i),AbCommon.isFunction(o.retfunc)){var h=function(){var t=arguments.callee.callback;t.call(arguments.callee.owner||t)};h.owner=s.caller,h.callback=o.retfunc,setTimeout(h,a)}};l.xhr=r,l.ts=o,l.et=h,l.options=t,l.logAll=e,l.logSuccess=i,l.logFail=s,n&&a>=0?setTimeout(l,a):l()}})}},ajaxSubmit:function(t,e){if(e&&e.url&&""!=e.url.replace(/\s/g,"")){e.type?e.type=e.type.toUpperCase():e.type="POST",e.dataType?e.dataType=e.dataType.toLowerCase():e.dataType="json",(!e.timeout||e.timeout<=0)&&(e.timeout=1e6),AbCommon.isDefined(e.loading)||(e.loading=!0);var i=!(!e.logAll||"boolean"!=typeof e.logAll)&&e.logAll,s=!(!e.logSuccess||"boolean"!=typeof e.logSuccess)&&e.logSuccess,n=!e.logFail||"boolean"!=typeof e.logFail||e.logFail,r=e.url;e.useResponseType===!0&&(r+=r.indexOf("?")>=0?"&":"?",r+="responseType="+e.dataType);var a=e.delayExec||100;AbCommon.isFunction(e.loadFunc)&&e.loadFunc.call(e.caller||e.loadFunc,!0);var o="string"==typeof t?$(t):t;o.ajaxSubmit({url:r,type:e.type,data:e.data,dataType:e.dataType,timeout:e.timeout,beforeSubmit:function(t,i,s){return!e.beforeSubmit||"function"!=typeof e.beforeSubmit||e.beforeSubmit.call(e.caller?e.caller:e.beforeSubmit,t,i,s)},success:function(t,r,o,h){AbCommon.isFunction(e.loadFunc)&&e.loadFunc.call(e.caller||e.loadFunc,!1);var l=function(){var t=arguments.callee.responseText,e=arguments.callee.statusText,i=arguments.callee.xhr,s=arguments.callee.$form,n=arguments.callee.options,r=arguments.callee.logAll,a=arguments.callee.logSuccess;arguments.callee.logFail;if(r||a){var o=n.title?n.title+"에 실패했습니다\n":"",h=o+" 전송 성공";console.log(h)}n.success&&"function"==typeof n.success&&n.success.call(n.caller?n.caller:n.success,t,e,i,s)};l.responseText=t,l.statusText=r,l.xhr=o,l.$form=h,l.options=e,l.logAll=i,l.logSuccess=s,l.logFail=n,setTimeout(l,a)},error:function(t,r,o,h){AbCommon.isFunction(e.loadFunc)&&e.loadFunc.call(e.caller||e.loadFunc,!1);var l=function(){var t=arguments.callee.xhr,e=arguments.callee.ts,i=arguments.callee.et,s=arguments.callee.form,n=arguments.callee.options,r=arguments.callee.logAll,o=(arguments.callee.logSuccess,arguments.callee.logFail),h=AbCommon.remoteErrorProcess(n,t,e,i,r||o);if(n.error&&"function"==typeof n.error&&n.error.call(n.caller?n.caller:n.error,h,s),AbCommon.isFunction(h.retfunc)){var l=function(){var t=arguments.callee.callback;t.call(arguments.callee.owner||t)};l.owner=n.caller,l.callback=h.retfunc,setTimeout(l,a)}};l.xhr=t,l.ts=r,l.et=o,l.form=h,l.options=e,l.logAll=i,l.logSuccess=s,l.logFail=n,setTimeout(l,a)}})}},toStringAjaxFail:function(t,e,i){return t?AbCommon.toStringXmlHttpRequest(t):"Status: "+e},toStringXmlHttpRequest:function(t){if(t){var e="";if(t.responseJSON){var i=t.responseJSON.Message||t.responseJSON.message,s=t.responseJSON.ExceptionType||t.responseJSON.exceptionType,n=t.responseJSON.ExceptionMessage||t.responseJSON.exceptionMessage;e+=s&&n?i+" ["+s+"]: "+n:s?i+" ["+s+"]":n?i+" [Exception]: "+n:i}else t.responseText&&(e+=t.responseText);return e.length&&(e+="\n\n"),e+="Status: "+t.status,t.statusText&&(e+=" ("+t.statusText+")"),e}return""+t},readxhr:function(t){var e=AbCommon.isDefined(t.responseJSON)?t.responseJSON:null;if(e){var i={status:null,exception:null,errorCode:null,messageType:null,message:null,stackTrace:null,token:null};return AbCommon.isDefined(t.status)&&(i.status=t.status),AbCommon.isDefined(e.Name)&&(i.exception=e.Name),AbCommon.isDefined(e.ErrorCode)&&(i.errorCode=e.ErrorCode),
AbCommon.isDefined(e.MessageType)&&(i.messageType=e.MessageType),AbCommon.isDefined(e.Message)&&(i.message=e.Message),AbCommon.isDefined(e.StackTrace)&&(i.stackTrace=e.StackTrace),AbCommon.isDefined(e.Token)&&(i.token=e.Token),i}return null},readRemoteError:function(t,e,i){var s=AbCommon.readxhr(t);return s||(s={}),s.textStatus=e,s.errorThrown=i,s},remoteErrorProcess:function(t,e,i,s,n){var r=AbCommon.readRemoteError(e),a=!1,o=null,h=null,l=null,c=null,u=null;if(AbCommon.isFunction(t.confirm)?o=t.confirm.call(t.caller||t.confirm,r):t.skips&&(AbCommon.isFunction(t.skips.errorcode)?(h=t.skips.errorcode,l=r.errorCode):AbCommon.isFunction(t.skips.status)?(h=t.skips.status,l=r.status):t.skips.type&&AbCommon.isFunction(t.skips.type[r.messageType])?o=t.skips.type[r.messageType]:t.skips.token&&AbCommon.isFunction(t.skips.token[r.token])?o=t.skips.token[r.token]:t.skips.exception&&AbCommon.isFunction(t.skips.exception[r.exception])&&(o=t.skips.exception[r.exception]),h&&(o=h.call(t.caller||h,l))),h=null,l=null,o===!1?a=!0:AbCommon.isFunction(o)&&(a=!0,c=o),!a){t.msgs&&(AbCommon.isFunction(t.msgs)?(h=t.msgs,l=r):AbCommon.isFunction(t.msgs.errorcode)?(h=t.msgs.errorcode,l=r.errorCode):AbCommon.isFunction(t.msgs.status)?(h=t.msgs.status,l=r.status):t.msgs.type&&t.msgs.type[r.messageType]?u=t.msgs.type[r.messageType]:t.msgs.token&&t.msgs.token[r.token]?u=t.msgs.token[r.token]:t.msgs.exception&&t.msgs.exception[r.exception]&&(u=t.msgs.exception[r.exception]),h&&(u=h.call(t.caller||h,l))),null==u&&(u=AbCommon.toStringAjaxFail(e,i,s));var d=t.title?t.title+"에 실패했습니다\n":"";u||(u=""),u=d+u,u&&!t.nomsg&&(n&&console.log(u),AbCommon.isFunction(t.msgFunc)?t.msgFunc.call(t.caller||t.msgFunc,u):AbMsgBox.error(u))}return{message:u,retfunc:c}},xmlHttpRequest:function(t){t||(t={});var e=new XMLHttpRequest,i="boolean"!=typeof t.async||t.async;return t.path&&e.open(t.type||"GET",t.path,i),e.mozResponseType=e.responseType=t.responseType||"arraybuffer",t.progress&&(e.onprogress=t.progress),t.load&&(e.onload=function(i){200==this.status||0===this.status?AbCommon.isFunction(t.load)&&t.load.call(t,i,e):AbCommon.isFunction(t.error)&&t.error.call(t,new Error("Could not load"),e)}),t.error&&(e.onerror=function(i){AbCommon.isFunction(t.error)&&t.error.call(t,i,e)}),e},xhrArrayBufferResponse:function(t){return t.mozResponseArrayBuffer||t.mozResponse||t.responseArrayBuffer||t.response},arrayBufferToBase64:function(t){var e=new Uint8Array(t),i=String.fromCharCode.apply(null,e);return btoa(i)},arrayBufferToDataUrl:function(t,e){var i=this.arrayBufferToBase64(t);return"data:"+e+";base64,"+i},formController:function(t,e){AbCommon.isString(e)&&(e=e.split(/,/g));for(var i=["partials","partial","content"],s=0;s<i.length;s++)$.inArray(i[s],e)<0&&e.push(i[s]);for(var n='<form enctype="multipart/form-data">',r=e.length,a=0,o=[],s=0;s<r;s++){var h=e[s];h&&(h=$.trim(h),o.push(h),n+='<input type="hidden" name="'+h+'"/>',a++)}n+="</form>";var l=$(t),c=$(n);l.append(c);var u={forms:l,form:c,_fields:o,reset:function(){this.partial.val(""),this.partials.val(""),this.content.val("")},record:function(t,e,i){this.partial.val(t),this.partials.val(e),this.content.val(i)},dispose:function(){this.form.remove()},toString:function(t,e){$.isArray(e)||(e=e.split(/,/g)),t||(t="");for(var i=this._fields.length,s=[],n=0;n<i;n++){var r=this._fields[n];$.isArray(e)&&$.inArray(r,e)>=0||s.push("["+r+"]="+this[r].val())}return s.join(t)}};r=o.length;for(var s=0;s<r;s++){var h=o[s];u[h]=c.find('[name="'+h+'"]')}return u},submitPartialContent:function(t){if(t||(t={}),AbCommon.isNumber(t.delay)||(t.delay=10),AbCommon.isNumber(t.splitSize)||(t.splitSize=30720),!t.url)throw new Error("[PARTIAL-SUBMIT] URL is null or empty!!!");if(!t.content)throw new Error("[PARTIAL-SUBMIT] CONTENT is null or empty!!!");if(!t.formController)throw new Error("[PARTIAL-SUBMIT] FORM Controller is null or empty!!!");var e=(t.splitSize,t.formController);if(t.content){for(var i=[],s=0,n=t.content.length;s<n;){var r=null;r=s+t.splitSize<n?{index:s,length:t.splitSize}:{index:s,length:n-s},i.push(r),s+=t.splitSize}if(i.length){var a=0,o=i.length,h=function(){var s=i[a];e.record(a,o,t.content.substr(s.index,s.length)),AbCommon.ajaxSubmit(e.form,{url:t.url,logFail:!0,nomsg:!0,success:function(e,i,s,n){a+1>=o?AbCommon.isFunction(t.success)&&t.success(e,i,s,n):(a++,setTimeout(h,t.delay))},error:function(e,i){AbCommon.isFunction(t.error)&&t.error(e,i)}})};setTimeout(h,0)}}}},AbGraphics={dpi:function(){return 72},cursor:function(t,e){if(e||(e=0),e>=0&&e<=22||e>=338&&e<=360||e>=158&&e<=202)switch(t){case"A":return"crosshair";case"LT":return"nwse-resize";case"CT":return"ns-resize";case"RT":return"nesw-resize";case"LC":return"ew-resize";case"RC":return"ew-resize";case"LB":return"nesw-resize";case"CB":return"ns-resize";case"RB":return"nwse-resize"}else if(e>=23&&e<=67||e>=203&&e<=247)switch(t){case"A":return"crosshair";case"LT":return"ns-resize";case"CT":return"nesw-resize";case"RT":return"ew-resize";case"LC":return"nwse-resize";case"RC":return"nwse-resize";case"LB":return"ew-resize";case"CB":return"nesw-resize";case"RB":return"ns-resize"}else if(e>=68&&e<=112||e>=248&&e<=292)switch(t){case"A":return"crosshair";case"LT":return"nesw-resize";case"CT":return"ew-resize";case"RT":return"nwse-resize";case"LC":return"ns-resize";case"RC":return"ns-resize";case"LB":return"nwse-resize";case"CB":return"ew-resize";case"RB":return"nesw-resize"}else if(e>=113&&e<=157||e>=293&&e<=337)switch(t){case"A":return"crosshair";case"LT":return"ew-resize";case"CT":return"nwse-resize";case"RT":return"ns-resize";case"LC":return"nesw-resize";case"RC":return"nesw-resize";case"LB":return"ns-resize";case"CB":return"nwse-resize";case"RB":return"ew-resize"}return"default"},distance:function(t,e,i,s){return Math.sqrt(Math.pow(t-i,2)+Math.pow(e-s,2))},rect:function(t,e,i,s){var n=Math.min(t,i),r=Math.min(e,s),a=Math.max(t,i),o=Math.max(e,s);return{x1:n,y1:r,x2:a,y2:o}},size:{maximum:function(){return 2==arguments.length?{width:Math.max(arguments[0].width,arguments[1].width),height:Math.max(arguments[0].height,arguments[1].height)}:3==arguments.length?{width:Math.max(arguments[0],arguments[2].width),height:Math.max(arguments[1],arguments[2].height)}:{width:Math.max(arguments[0],arguments[2]),height:Math.max(arguments[1],arguments[3])}},minimum:function(){return 2==arguments.length?{width:Math.min(arguments[0].width,arguments[1].width),height:Math.min(arguments[0].height,arguments[1].height)}:3==arguments.length?{width:Math.min(arguments[0],arguments[2].width),height:Math.min(arguments[1],arguments[2].height)}:{width:Math.min(arguments[0],arguments[2]),height:Math.min(arguments[1],arguments[3])}}},curve:{KAPPA:.5522848,path:function(t,e,i,s,n,r,a,o,h){function l(t){return Math.pow(1-t,3)}function c(t){return t*Math.pow(1-t,2)*3}function u(t){return(1-t)*Math.pow(t,2)*3}function d(t){return Math.pow(t,3)}function p(t,e,i,s,n,r,a,o,h){return{x:t*l(h)+i*c(h)+n*u(h)+a*d(h),y:e*l(h)+s*c(h)+r*u(h)+o*d(h)}}function g(t,e,i,s,n,r,a,o,h){}function f(t){return t?t<0?-1:1:0}function m(t,e,i,s,n,r,a,o,h,l,c){var u=g(e,i,s,n,r,a,o,h,l),d=g(e,i,s,n,r,a,o,h,c),b=Math.abs(Math.abs(u)-Math.abs(d)),y=c-l,v=l+y/2;y>.05&&(f(u)!==f(d)||b>.2)?(m(t,e,i,s,n,r,a,o,h,l,v),m(t,e,i,s,n,r,a,o,h,v,c)):t.push(p(e,i,s,n,r,a,o,h,l))}for(var b=.1;b<=1;b+=.1)m(t,e,i,s,n,r,a,o,h,b-.1,b);t.push({x:o,y:h})}},box:{rect:function(t,e,i,s){t||(t=0),e||(e=0),i||(i=0),s||(s=0);var n=Math.min(t,i),r=Math.min(e,s),a=Math.max(t,i),o=Math.max(e,s);return{x:n,y:r,width:a-n,height:o-r}},inflate:function(t,e,i,s){var n=0,r=0,a=0,o=0;if(5==arguments.length){var h=arguments[4];"number"==typeof h?n=r=a=o=h:h.width||h.height?(n=a=h.width,r=o=h.height):(r=h.top,a=h.right,o=h.bottom,n=h.left)}else 6==arguments.length?(n=a=arguments[4],r=o=arguments[5]):8==arguments.length&&(r=arguments[4],a=arguments[5],o=arguments[6],n=arguments[7]);return{x:t-n,y:e-r,width:i+(n+a),height:s+(r+o)}},expand:function(t,e,i,s,n,r){return arguments.length<=5&&(r=n),{x:t-n,y:e-r,width:i+(n<<1),height:s+(r<<1)}},zoom:function(t,e,i,s){var n=i/t,r=s/e;return{ratio:n>r?r:n,ratioX:n,ratioY:r}},limit:function(t,e,i,s){var n=i<t,r=s<e;if(n||r){var a=i/t,o=s/e,h=a>o?o:a;return{width:parseInt(t*h),height:parseInt(e*h),ratio:h,direct:a>o?"Y":"X",ratioX:a,ratioY:o}}return null}},oppositeRedimStatus:function(t){switch(null==t&&(t="LT"),t){case"LT":return"RB";case"CT":return"CB";case"RT":return"LB";case"LC":return"RC";case"CC":return"CC";case"RC":return"LC";case"LB":return"RT";case"CB":return"CT";case"RB":return"LT"}return t},intersects:{lines:function(t,e,i,s,n,r,a,o){var h,l,c,u,d,p={x:null,y:null,onLine1:!1,onLine2:!1};return h=(o-r)*(i-t)-(a-n)*(s-e),0==h?p:(l=e-r,c=t-n,u=(a-n)*l-(o-r)*c,d=(i-t)*l-(s-e)*c,l=u/h,c=d/h,p.x=t+l*(i-t),p.y=e+l*(s-e),l>0&&l<1&&(p.onLine1=!0),c>0&&c<1&&(p.onLine2=!0),p)}},contains:{line:function(t,e,i,s,n,r,a){return this.lineCircle(t,e,i,s,n,r,a)},line2:function(t,e,i,s,n,r){var a=AbGraphics.distance(n,r,t,e)+AbGraphics.distance(n,r,i,s),o=AbGraphics.distance(i,s,t,e);return Math.abs(o-a)},lineCircle:function(t,e,i,s,n,r,a){var o=this.linePoint(t,e,i,s,n,r),h=i-t,l=s-e,c=Math.pow(t+o.p.x-n,2)+Math.pow(e+o.p.y-r,2),u=Math.pow(t+o.p.x-t,2)+Math.pow(e+o.p.y-e,2),d=h*h+l*l,p=o.p.x*h+o.p.y*l,g=Math.pow(n-t,2)+Math.pow(r-e,2),f=Math.pow(n-i,2)+Math.pow(r-s,2);return c<=a*a&&u<=d&&p>=0||g<=a||f<=a},linePoint:function(t,e,i,s,n,r){var a=n-t,o=r-e,h=i-t,l=s-e,c=(a*h+o*l)/(h*h+l*l)*h,u=(a*h+o*l)/(h*h+l*l)*l,d=a-c,p=o-u;return{x:d,y:p,p:{x:c,y:u}}},lineMDistance:function(t,e,i,s,n,r){var a=n-t,o=r-e,h=i-t,l=s-e,c=(a*h+o*l)/(h*h+l*l)*h,u=(a*h+o*l)/(h*h+l*l)*l,d=a-c,p=o-u;return AbGraphics.distance(t,e,d+t,p+e)},rect:function(t,e,i,s,n,r,a,o){return 8==arguments.length?t<=n&&dx2<=i&&e<=r&&dy2<=s:t<=n&&n<i&&e<=r&&r<s},box:function(t,e,i,s,n,r,a,o){return 8==arguments.length?t<=n&&n+a<=t+i&&e<=r&&r+o<=e+s:t<=n&&n<t+i&&e<=r&&r<e+s},polygon:function(t,e,i){var s=t.length;if(0==s)return!1;if(1==s&&t[0].x==e&&t[0].y==i)return!0;if(2==s)return this.line(t[0].x,t[0].y,t[1].x,t[1].y,e,i,1);for(var n=0,r=0,a=t[0],o=null,h=1;h<=s;h++)o=t[h%s],i>Math.min(a.y,o.y)&&i<=Math.max(a.y,o.y)&&e<=Math.max(a.x,o.x)&&a.y!=o.y&&(r=(i-a.y)*(o.x-a.x)/(o.y-a.y)+a.x,(a.x==o.x||e<=r)&&n++),a=o;return n%2!=0},polygonScale:function(t,e,i,s,n){s||(s=1),n||(n=1);var r=t.length;if(0==r)return!1;if(1==r&&t[0].x*s==e&&t[0].y*n==i)return!0;if(2==r)return this.line(t[0].x*s,t[0].y*n,t[1].x*s,t[1].y*n,e,i,1);for(var a=0,o=0,h=null,l=null,c=null,u=t[0].x*s,d=t[0].y*n,p=1;p<=r;p++){var h=t[p%r];l=h.x*s,c=h.y*n,i>Math.min(d,c)&&i<=Math.max(d,c)&&e<=Math.max(u,l)&&d!=c&&(o=(i-d)*(l-u)/(c-d)+u,(u==l||e<=o)&&a++),u=l,d=c}return a%2!=0}},angle:{RAD90:1.5707963267948966,deg2rad:function(t){return Math.PI/180*t},rad2deg:function(t){return 180*t/Math.PI},increase:function(t,e){return t=(t+e)%360,t<0&&(t=360+t),t},radian:function(t,e,i,s){return Math.atan2(i-t,s-e)},radian90:function(t,e,i,s){return this.RAD90-Math.atan2(i-t,s-e)},get:function(t,e,i,s){var n=Math.atan2(i-t,s-e),r=180-180*n/Math.PI%360;return r<0&&(r=360+r),r},direction:function(t){return{x:-Math.sin(Math.PI/180*t),y:Math.cos(Math.PI/180*t)}},point:function(t,e,i,s,n){var r=Math.PI/180*t;return AbGraphics.rotate.point(r,e,i,s,n)},rect:function(t,e,i,s,n,r,a){var o=Math.PI/180*t;return AbGraphics.rotate.rect(o,e,i,s,n,r,a)},halfBounds:function(t,e,i,s,n){var r=Math.PI/180*t;return AbGraphics.rotate.halfBounds(r,e,i,s,n)},bounds:function(t,e,i,s,n){var r=Math.PI/180*t;return AbGraphics.rotate.bounds(r,e,i,s,n)},corners:function(t,e,i,s,n,r,a){var o=Math.PI/180*t;return AbGraphics.rotate.corners(o,e,i,s,n,r,a)},correctDisplayCoordinate:function(t,e,i,s){var n=Math.PI/180*t;return AbGraphics.rotate.correctDisplayCoordinate(n,e,i,s)},toShapeAngle:function(t){var e=(t-90)%360;return e<0&&(e=360+e),e},fromShapeAngle:function(t){return(t+90)%360}},rotate:{point:function(t,e,i,s,n){var r=Math.cos(t),a=Math.sin(t);return{x:(s-e)*r-(n-i)*a+e,y:(s-e)*a+(n-i)*r+i}},rect:function(t,e,i,s,n,r,a){var o=this.point(t,e,i,s,n),h=this.point(t,e,i,r,a);return{x1:o.x,y1:o.y,x2:h.x,y2:h.y}},halfBounds:function(t,e,i,s,n){var r=s,a=-n,o=s,h=n,l=Math.cos(t),c=Math.sin(t),u=r*l-a*c,d=r*c+a*l,p=o*l-h*c,g=o*c+h*l,f=Math.max(Math.abs(u),Math.abs(p)),m=Math.max(Math.abs(d),Math.abs(g));return{x:f,y:m}},bounds:function(t,e,i,s,n){var r=s>>1,a=n>>1,o=r,h=-a,l=r,c=a,u=Math.cos(t),d=Math.sin(t),p=o*u-h*d,g=o*d+h*u,f=l*u-c*d,m=l*d+c*u,b=Math.max(Math.abs(p),Math.abs(f)),y=Math.max(Math.abs(g),Math.abs(m));return o=r-b,h=a-y,l=r+b,c=a+y,{x:e+o,y:i+h,width:l-o,height:c-h}},corners:function(t,e,i,s,n,r,a){for(var o=[this.point(t,e,i,s,n),this.point(t,e,i,r,n),this.point(t,e,i,r,a),this.point(t,e,i,s,a)],h=null,l=null,c=null,u=null,d=null,p=null,g=null,f=null,m=0;m<o.length;m++){var b=o[m];0==m?(h=u=b.x,l=u=b.y,d=p=g=f=b):(h>b.x&&(h=b.x),c<b.x&&(c=b.x),l>b.y&&(l=b.y),u<b.y&&(u=b.y),d.x>b.x&&(d=b),g.x<b.x&&(g=b),p.y>b.y&&(p=b),f.y<b.y&&(f=b))}return{leftTop:o[0],rightTop:o[1],rightBottom:o[2],leftBottom:o[3],left:d,top:p,right:g,bottom:f,min:{x:h,y:l},max:{x:c,y:u}}},HALF_PI:Math.PI/2,correctDisplayCoordinate:function(t,e,i,s){AbCommon.isBool(s)||(s=!0);var n=AbGraphics.rotate.corners(t,0,0,0,0,e,i),r=0,a=0;return t>=0&&t<this.HALF_PI?r=n.leftBottom.x-n.leftTop.x:t>=this.HALF_PI&&t<Math.PI?(r=n.rightBottom.x-n.leftTop.x,a=n.leftBottom.y-n.leftTop.y):t>=Math.PI&&t<Math.PI+this.HALF_PI?(r=n.rightTop.x-n.leftTop.x,a=n.rightBottom.y-n.leftTop.y):t>=Math.PI+this.HALF_PI&&(a=n.rightTop.y-n.leftTop.y),s?AbGraphics.rotate.point(-t,0,0,r,a):{x:r,y:a}},pointByDistance:function(t,e){return{x:e*Math.cos(t),y:e*Math.sin(t)}}},canvas:{IMAGE_QUALITY:void 0,imageSmoothing:function(t,e){return t.imageSmoothingEnabled=e,t.mozImageSmoothingEnabled=e,t.webkitImageSmoothingEnabled=e,t.msImageSmoothingEnabled=e,t.imageSmoothingQuality="high",t},createContext:function(t,e){var i=null;i=AbCommon.isNumber(t)&&AbCommon.isNumber(e)?$('<canvas width="'+t+'" height="'+e+'"/>'):$("<canvas/>");var s=i.get(0).getContext("2d");return s},toImage:function(t,e){switch(e){case"jpg":case"jpeg":e="image/jpeg";break;default:e="image/png"}return AbCommon.isSetted(this.IMAGE_QUALITY)?t.canvas.toDataURL(e,this.IMAGE_QUALITY):t.canvas.toDataURL(e)},toBlob:function(t,e){return AbCommon.isSetted(e)||(e="image/png"),new Promise(function(i,s){var n=function(t){i(t)};if(t.canvas.toBlob)try{t.canvas.toBlob(n,e)}catch(t){s(t)}else s(new Error("Not support toBlob"))})},renderImage:function(t,e){var i=this.createContext(t.width,t.height);return i.drawImage(t,0,0,t.width,t.height,0,0,t.width,t.height),this.toImage(i,e)},DASH_SIZ:8,DOT_SIZ:2,SPACE_SIZ:4,noAnti:function(t){return Math.round(t)-.5},noAntiPos:function(t){return t.x=AbGraphics.canvas.noAnti(t.x),t.y=AbGraphics.canvas.noAnti(t.y),t},dashStyle:function(t,e){if(!t)return e;switch(t){case"solid":case"dash":case"dot":case"dash-dot":case"dash-dot-dot":return t}return e},makeDash:function(t){var e=[];if(!t)return e;for(var i=t.toLowerCase().split("-"),s=i.length,n=0;n<s;n++){var r=0;switch(i[n]){case"dash":r=this.DASH_SIZ;break;case"dot":r=this.DOT_SIZ}r>0&&(e.push(r),e.push(this.SPACE_SIZ))}return e},measureText:function(t,e,i,s){var n=i.$measureElement1,r=i.$measureElement2;n||(n=$("<div/>"),n.css({position:"absolute",padding:"0",margin:"0",top:-1e4,left:-1e4,zIndex:-1,visibility:"hidden"}),i.$measureElement1=n),r||(r=$("<div/>"),r.css({position:"absolute",padding:"0",margin:"0",top:-1e4,left:-1e4,zIndex:-1,visibility:"hidden"}),i.$measureElement2=r),n.css("font",t.font),e&&n.css("line-height",100*e+"%"),n.text(s),r.css("font",t.font),r.text(s);var a=$(document.body);a.append(n),a.append(r);var o=n.length?n.get(0):null,h=o?{width:o.offsetWidth,height:o.offsetHeight}:{width:0,height:0};o=r.length?r.get(0):null;var l=o?{width:o.offsetWidth,height:o.offsetHeight}:{width:0,height:0};return n.detach(),r.detach(),{width:h.width,height:h.height,contentWidth:l.width,contentHeight:l.height}}},image:{bilinear:function(t,e,i){function s(t,e,i){return 4*(t+i*e)}function n(t,e,i,s,n,r){var a=1-n,o=1-r;return t*a*o+e*n*o+i*a*r+s*n*r}var r,a,o,h,l,c,u,d,p,g,f,m,b,y,v,x,w,A,k;for(r=0;r<e.height;++r)for(o=r/i,h=Math.floor(o),l=Math.ceil(o)>t.height-1?t.height-1:Math.ceil(o),a=0;a<e.width;++a)c=a/i,u=Math.floor(c),d=Math.ceil(c)>t.width-1?t.width-1:Math.ceil(c),p=s(a,r,e.width),g=s(u,h,t.width),f=s(d,h,t.width),m=s(u,l,t.width),b=s(d,l,t.width),y=c-u,v=o-h,x=n(t.data[g],t.data[f],t.data[m],t.data[b],y,v),e.data[p]=x,w=n(t.data[g+1],t.data[f+1],t.data[m+1],t.data[b+1],y,v),e.data[p+1]=w,A=n(t.data[g+2],t.data[f+2],t.data[m+2],t.data[b+2],y,v),e.data[p+2]=A,k=n(t.data[g+3],t.data[f+3],t.data[m+3],t.data[b+3],y,v),e.data[p+3]=k},bicubic:function(t,e,i){function s(t,e,i){return 4*(t+i*e)}function n(t,e,i,s,n){return.5*(s-e+(2*e-5*i+4*s-n+(3*(i-s)+n-e)*t)*t)*t+i}function r(t,e,i){var s,r,a,o;return s=n(t,i[0][0],i[1][0],i[2][0],i[3][0]),r=n(t,i[0][1],i[1][1],i[2][1],i[3][1]),a=n(t,i[0][2],i[1][2],i[2][2],i[3][2]),o=n(t,i[0][3],i[1][3],i[2][3],i[3][3]),n(e,s,r,a,o)}var a,o,h,l,c,u,d,p,g,f,m,b,y,v,x,w,A,k;for(a=0;a<e.height;++a)for(iyv=a/i,iy0=Math.floor(iyv),u=0,iy0<1?u=-1:iy0>t.height-3&&(u=iy0-(t.height-3)),o=0;o<e.width;++o)ixv=o/i,ix0=Math.floor(ixv),c=0,ix0<1?c=-1:ix0>t.width-3&&(c=ix0-(t.width-3)),p=4*(iy0*t.width+ix0),d=u<0?p:4*((iy0-1)*t.width+ix0),g=u>1?p:4*((iy0+1)*t.width+ix0),f=u>0?g:4*((iy0+2)*t.width+ix0),b=0,m=c<0?b:-4,y=c>1?b:4,v=c>0?y:8,x=[[t.data[d+m],t.data[p+m],t.data[g+m],t.data[f+m]],[t.data[d+b],t.data[p+b],t.data[g+b],t.data[f+b]],[t.data[d+y],t.data[p+y],t.data[g+y],t.data[f+y]],[t.data[d+v],t.data[p+v],t.data[g+v],t.data[f+v]]],d++,p++,g++,f++,w=[[t.data[d+m],t.data[p+m],t.data[g+m],t.data[f+m]],[t.data[d+b],t.data[p+b],t.data[g+b],t.data[f+b]],[t.data[d+y],t.data[p+y],t.data[g+y],t.data[f+y]],[t.data[d+v],t.data[p+v],t.data[g+v],t.data[f+v]]],d++,p++,g++,f++,A=[[t.data[d+m],t.data[p+m],t.data[g+m],t.data[f+m]],[t.data[d+b],t.data[p+b],t.data[g+b],t.data[f+b]],[t.data[d+y],t.data[p+y],t.data[g+y],t.data[f+y]],[t.data[d+v],t.data[p+v],t.data[g+v],t.data[f+v]]],d++,p++,g++,f++,k=[[t.data[d+m],t.data[p+m],t.data[g+m],t.data[f+m]],[t.data[d+b],t.data[p+b],t.data[g+b],t.data[f+b]],[t.data[d+y],t.data[p+y],t.data[g+y],t.data[f+y]],[t.data[d+v],t.data[p+v],t.data[g+v],t.data[f+v]]],h=ixv-ix0,l=iyv-iy0,idxD=s(o,a,e.width),e.data[idxD]=r(h,l,x),e.data[idxD+1]=r(h,l,w),e.data[idxD+2]=r(h,l,A),e.data[idxD+3]=r(h,l,k)},hermite:function(t,e,i,s){var n=t.width,r=t.height;e=Math.round(e),i=Math.round(i);for(var a=n/e,o=r/i,h=Math.ceil(a/2),l=Math.ceil(o/2),c=t.getContext("2d"),u=c.getImageData(0,0,n,r),d=c.createImageData(e,i),p=u.data,g=d.data,f=0;f<i;f++)for(var m=0;m<e;m++){for(var b=4*(m+f*e),y=0,v=0,x=0,w=0,A=0,k=0,C=0,P=(f+.5)*o,S=Math.floor(f*o),I=Math.ceil((f+1)*o),T=S;T<I;T++)for(var M=Math.abs(P-(T+.5))/l,$=(m+.5)*a,E=M*M,z=Math.floor(m*a),O=Math.ceil((m+1)*a),L=z;L<O;L++){var G=Math.abs($-(L+.5))/h,B=Math.sqrt(E+G*G);if(!(B>=1)){y=2*B*B*B-3*B*B+1;var R=4*(L+T*n);C+=y*p[R+3],x+=y,p[R+3]<255&&(y=y*p[R+3]/250),w+=y*p[R],A+=y*p[R+1],k+=y*p[R+2],v+=y}}g[b]=w/v,g[b+1]=A/v,g[b+2]=k/v,g[b+3]=C/x}s===!0?(t.width=e,t.height=i):c.clearRect(0,0,n,r),c.putImageData(d,0,0)}}};AbColorPicker.prototype={constructor:AbColorPicker,COLORS:{white:"#FFFFFF",silver:"#c0c0c0",gray:"#808080",black:"#000000",red:"#ff0000",maroon:"#800000",yellow:"#ffff00",olive:"#808000",lime:"#00ff00",green:"#008000",aqua:"#00ffff",teal:"#008080",blue:"#0000ff",navy:"#000080",pink:"#ffc0cb",fuchsia:"#ff00ff",purple:"#800080",mediumpurple:"#9370db"},NUMS_USER_BOX:14,observe:function(t){this.observers.push(t)},stopObserve:function(t){this.observers.remove(t)},notifyObservers:function(t,e){setTimeout(function(){for(var i=this.observers.length,s=0;s<i;s++){var n=this.observers[s];"function"==typeof n?n(this,t,e,this.token):"function"==typeof n.notify&&n.notify(this,t,e,this.token)}}.bind(this),0)},has:function(t){return this.e.has(t).length>0},opened:function(){return"visible"==this.e.css("visibility")},boundBox:function(){return AbCommon.getBounds(this.e.get(0))},size:function(){return{width:this.e.width(),height:this.e.height()}},open:function(t,e,i){"window"===this.viewStyle&&("number"!=typeof i&&(i=100),this.e.css({left:t,top:e,zIndex:i,visibility:"visible"}),this.notifyObservers("open"))},close:function(){"window"===this.viewStyle&&this.opened()&&(this.e.css({zIndex:-1,visibility:"hidden"}),this.notifyObservers("close"))},confirm:function(t){if(t)return this.notifyObservers("color",null),void this.close();var e=this.color.color(),i=this.cmd("color",this.euser);if(i.length){for(var s=null,n=null,r=null,a=i.length,o=0;o<a;o++){if(s=i.get(o),n=$(s),r=n.attr("color"),!r)return n.attr("color",e),n=n.children(),n.css("background-color",e),this.notifyObservers("color",e),void this.close();if(r==e)return this.notifyObservers("color",e),void this.close()}this.userBoxIndex++,this.userBoxIndex>=this.NUMS_USER_BOX&&(this.userBoxIndex=0),s=i.get(this.userBoxIndex),n=$(s),n.attr("color",e),n=n.children(),n.css("background-color",e),this.notifyObservers("color",e),this.close()}},lockAlpha:function(){if(arguments.length&&("boolean"==typeof arguments[0]||"number"==typeof arguments[0]&&arguments[0]>=0&&arguments[0]<=1)){this.color.locka=arguments[0],this.color.locka!==!1?(this.color.bka=this.color.a,this.color.a=this.color.locka):this.color.a=this.color.bka,this.updateAlphaPicker(),this.notify("alpha",this.color.a);var t=this.topics.alpha;t&&t.attr("readonly",this.color.locka!==!1)}return this.color.locka},enabledNotset:!0,enableNotset:function(){return arguments.length&&(this.enabledNotset=arguments[0],this.enabledNotset?this.cmd("notset").show():this.cmd("notset").hide()),this.enabledNotset},cmd:function(t,e){return e||(e=this.e),e.find('[cmd="'+t+'"]')},attachControlPanelEvents:function(){this.cmd("ok").click(this,function(t){t.data.confirm()}),this.cmd("cancel").click(this,function(t){t.data.close()}),this.cmd("notset").click(this,function(t){t.data.confirm(!0)})},generateColorBoxes:function(){if(this.esample.length)for(var t in this.COLORS){var e=this.COLORS[t],i=$('<div class="box" cmd="color"/>');i.attr("color",e),i.css("background-color",e),this.esample.append(i)}if(this.euser.length)for(var s=0;s<this.NUMS_USER_BOX;s++){var i=$('<div class="box" cmd="color"/>'),n=$("<div/>");i.append(n),this.euser.append(i)}this.cmd("color").click(this,function(t){var e=$(this).attr("color");e&&t.data.setColor(e)})},setMouseTracking:function(t,e){t.mousedown({self:this,e:t,callback:e},function(t){t.data.callback(t),$(document).bind("mousemove",{self:t.data.self,e:t.data.e},t.data.callback)}),$(document).mouseup({self:this,e:t,callback:e},function(t){$(document).unbind("mousemove",t.data.callback)})},createPickingArea:function(){var t=$("<div/>"),e=$("<div/>");t.addClass("picking-area"),e.addClass("picker"),this.pickingArea=t,this.picker=e,this.setMouseTracking(t,this.updateColor.bind(this)),t.append(e),this.epicker.append(t)},createHueArea:function(){var t=$("<div/>"),e=$("<div/>");t.addClass("hue"),e.addClass("slider-picker"),this.hueArea=t,this.huePicker=e,this.setMouseTracking(t,this.updateHueSlider.bind(this)),t.append(e),this.epicker.append(t)},createAlphaArea:function(){var t=$("<div/>"),e=$("<div/>"),i=$("<div/>");t.addClass("alpha"),e.addClass("alpha-mask"),i.addClass("slider-picker"),this.alphaArea=t,this.alphaMask=e,this.alphaPicker=i,this.setMouseTracking(t,this.updateAlphaSlider.bind(this)),t.append(e),e.append(i),this.epicker.append(t)},createPreviewBox:function(){var t=$("<div/>"),e=$("<div/>");t.addClass("preview"),e.addClass("preview-color"),this.previewColor=e,t.append(e),this.epicker.append(t)},newInputComponent:function(t,e,i){var s=$("<div/>"),n=$('<input type="text"/>'),r=$("<span/>");return s.addClass("input"),s.attr("data-topic",e),r.text(t),r.addClass("name"),s.append(r),s.append(n),this.epicker.append(s),n.change(this,i),n.click(this,function(t){this.select()}),this.topics[e]=n,s},notify:function(t,e){this.topics[t]&&this.topics[t].val(e)},updateColor:function(t){var e=this.pickingArea.offset(),i=t.pageX-e.left,s=t.pageY-e.top,n=5,r=this.pickingArea.width();i>r&&(i=r),s>r&&(s=r),i<0&&(i=0),s<0&&(s=0);var a=100-100*s/r|0,o=100*i/r|0;this.color.hsv(this.color.h,o,a),this.picker.css("left",i-n),this.picker.css("top",s-n),this.updateAlphaGradient(),this.updatePreviewColor(),this.notify("value",a),this.notify("saturation",o),this.notify("red",this.color.r),this.notify("green",this.color.g),this.notify("blue",this.color.b),this.notify("hexa",this.color.hex())},updateHueSlider:function(t){var e=this.hueArea.offset(),i=t.pageX-e.left,s=this.hueArea.width();i<0&&(i=0),i>s&&(i=s);var n=359*i/s|0;this.updateSliderPosition(this.huePicker,i),this.setHue(n)},updateAlphaSlider:function(t){if(this.color.locka===!1){var e=this.alphaArea.offset(),i=t.pageX-e.left,s=this.alphaArea.width();i<0&&(i=0),i>s&&(i=s),this.color.a=(i/s).toFixed(2),this.updateSliderPosition(this.alphaPicker,i),this.updatePreviewColor(),this.notify("alpha",this.color.a)}},updatePickerBackground:function(){var t=AbColor.hsv2rgb(this.color.h,1,1);this.pickingArea.css("background-color",AbCss.hex(t[0],t[1],t[2]))},updateAlphaGradient:function(){this.alphaMask.css("background-color",this.color.hex())},updatePreviewColor:function(){var t=this.color.color();this.previewColor.css("background-color",t)},setHue:function(t){"number"!=typeof t||isNaN(t)===!0||t<0||t>359||(this.color.h=t,this.color.from("HSV"),this.updatePickerBackground(),this.updateAlphaGradient(),this.updatePreviewColor(),this.notify("red",this.color.r),this.notify("green",this.color.g),this.notify("blue",this.color.b),this.notify("hexa",this.color.hex()),this.notify("hue",this.color.h))},updateSLV:function(){this.updatePickerPosition(),this.updateAlphaGradient(),this.updatePreviewColor(),this.notify("red",this.color.r),this.notify("green",this.color.g),this.notify("blue",this.color.b),this.notify("hexa",this.color.hex())},updatePickerPosition:function(){var t=this.pickingArea.width(),e=0,i=5;e=this.color.v;var s=this.color.s*t/100|0,n=t-e*t/100|0;this.picker.css("left",s-i),this.picker.css("top",n-i)},updateSliderPosition:function(t,e){t.css("left",Math.max(e-3,-2))},updateHuePicker:function(){var t=this.hueArea.width(),e=1,i=this.color.h*t/360|0;this.huePicker.css("left",i-e)},updateAlphaPicker:function(){var t=this.alphaArea.width(),e=1,i=this.color.a*t|0;this.alphaPicker.css("left",i-e),this.updatePreviewColor()},getColor:function(){return this.color.color()},setColor:function(){arguments.length&&this.color.set.apply(this.color,arguments),this.updateHuePicker(),this.updatePickerPosition(),this.updatePickerBackground(),this.updateAlphaPicker(),this.updateAlphaGradient(),this.updatePreviewColor(),this.notify("red",this.color.r),this.notify("green",this.color.g),this.notify("blue",this.color.b),this.notify("hue",this.color.h),this.notify("saturation",this.color.s),this.notify("value",this.color.v),this.notify("alpha",this.color.a),this.notify("hexa",this.color.hex())},isValidRGBValue:function(t){return"number"==typeof t&&isNaN(t)===!1&&t>=0&&t<=255},isValidHueValue:function(t){return"number"==typeof t&&isNaN(t)===!1&&t>=0&&t<=359},isValidPercentValue:function(t){return"number"==typeof t&&isNaN(t)===!1&&t>=0&&t<=100},inputChangeHue:function(t){var e=parseInt(t.target.value);return this.isValidHueValue(e)?(this.setHue(e),void this.updateHuePicker()):void(t.target.value=this.color.h)},inputChangeSaturation:function(t){var e=parseInt(t.target.value);return this.isValidPercentValue(e)?(this.color.s=e,this.color.from("HSV"),void this.updateSLV()):void(t.target.value=this.color.s)},inputChangeValue:function(t){var e=parseInt(t.target.value);return this.isValidPercentValue(e)?(this.color.v=e,this.color.from("HSV"),void this.updateSLV()):void(t.target.value=this.color.v)},inputChangeRed:function(t){var e=parseInt(t.target.value);return this.isValidPercentValue(e)?(this.color.r=e,this.color.from("RGB"),void this.setColor()):void(t.target.value=this.color.r)},inputChangeGreen:function(t){var e=parseInt(t.target.value);return this.isValidPercentValue(e)?(this.color.g=e,this.color.from("RGB"),void this.setColor()):void(t.target.value=this.color.g)},inputChangeBlue:function(t){var e=parseInt(t.target.value);return this.isValidPercentValue(e)?(this.color.b=e,this.color.from("RGB"),void this.setColor()):void(t.target.value=this.color.b)},inputChangeAlpha:function(t){if(this.color.locka!==!1)return void(t.target.value=this.color.a);var e=parseFloat(t.target.value);"number"==typeof e&&isNaN(e)===!1&&e>=0&&e<=1&&(this.color.a=e.toFixed(2)),t.target.value=this.color.a,this.updateAlphaPicker()},inputChangeHexa:function(t){var e=t.target.value,i=AbCss.color(e);i?(4==i.length?this.color.rgb(i[0],i[1],i[2],i[3]):this.color.rgb(i[0],i[1],i[2],1),this.setColor()):t.target.value=this.color.hex()}},AbGridPager.prototype.page=function(){if(!(arguments.length>0))return this.$page;var t=parseInt(arguments[0]);isNaN(t)&&(t=0),t>=1?this.$page=t:this.$page=1},AbGridPager.prototype.totalCount=function(){if(!(arguments.length>0))return this.$totalCount;var t=parseInt(arguments[0]);isNaN(t)&&(t=0),t<=0?this.$totalCount=0:this.$totalCount=t,this.$totalCount<1&&(this.$page=1)},AbGridPager.prototype.count=function(){return this.$count},AbGridPager.prototype.index=function(){return this.$index},AbGridPager.prototype.desc=function(){return arguments.length>0?void(this.$desc=1==arguments[0]):this.$desc},AbGridPager.prototype.lineCount=function(){if(!(arguments.length>0))return this.$lineCount;var t=parseInt(arguments[0]);isNaN(t)&&(t=0),t<1?this.$lineCount=1:this.$lineCount=t},AbGridPager.prototype.pageCount=function(){if(!(arguments.length>0))return this.$pageCount;var t=parseInt(arguments[0]);isNaN(t)&&(t=0),t<1?this.$pageCount=1:this.$pageCount=t},AbGridPager.prototype.totalPage=function(){return this.$totalPage},AbGridPager.prototype.prevPage=function(){return this.$prevPage},AbGridPager.prototype.nextPage=function(){return this.$nextPage},AbGridPager.prototype.startPage=function(){return this.$startPage},AbGridPager.prototype.endPage=function(){return this.$endPage},AbGridPager.prototype.block=function(){return this.$block},AbGridPager.prototype.totalBlock=function(){return this.$totalBlock},AbGridPager.prototype.prevBlock=function(){return this.$prevBlock},AbGridPager.prototype.nextBlock=function(){return this.$nextBlock},AbGridPager.prototype.startBlock=function(){return this.$startBlock},AbGridPager.prototype.endBlock=function(){return this.$endBlock},AbGridPager.prototype.startRow=function(){return this.$page>0?(this.$page-1)*this.$lineCount:0},AbGridPager.prototype.pageFromIndex=function(t){return this.$totalCount>0?parseInt(t/this.$lineCount)+1:0},AbGridPager.prototype.pager=function(){return arguments.length>0?void("function"==typeof arguments[0]&&(this.$pagerFunction=arguments[0])):this.$pagerFunction},AbGridPager.prototype.symbolPrevBlock=function(){return arguments.length>0?void(this.$symbolPrevBlock=arguments[0]):this.$symbolPrevBlock},AbGridPager.prototype.symbolNextBlock=function(){return arguments.length>0?void(this.$symbolNextBlock=arguments[0]):this.$symbolNextBlock},AbGridPager.prototype.symbolFirstBlock=function(){return arguments.length>0?void(this.$symbolFirstBlock=arguments[0]):this.$symbolFirstBlock},AbGridPager.prototype.symbolLastBlock=function(){return arguments.length>0?void(this.$symbolLastBlock=arguments[0]):this.$symbolLastBlock},AbGridPager.prototype.styleBlock=function(){return arguments.length>0?void(this.$styleBlock=arguments[0]):this.$styleBlock},AbGridPager.prototype.styleCurrentPage=function(){return arguments.length>0?void(this.$styleCurrentPage=arguments[0]):this.$styleCurrentPage},AbGridPager.prototype.stylePage=function(){return arguments.length>0?void(this.$stylePage=arguments[0]):this.$stylePage},AbGridPager.prototype.templateBlock=function(){return arguments.length>0?void(this.$blockTemplate=arguments[0]):this.$blockTemplate},AbGridPager.prototype.templateCurrentPage=function(){
return arguments.length>0?void(this.$cpageTemplate=arguments[0]):this.$cpageTemplate},AbGridPager.prototype.templatePage=function(){return arguments.length>0?void(this.$pageTemplate=arguments[0]):this.$pageTemplate},AbGridPager.prototype.templatePageGap=function(){return arguments.length>0?void(this.$pageGapTemplate=arguments[0]):this.$pageGapTemplate},AbGridPager.prototype.templateNavigate=function(){return arguments.length>0?void(this.$navTemplate=arguments[0]):this.$navTemplate},AbGridPager.prototype.prepare=function(){if(this.$totalCount<=0)return 0;this.$totalCount>0&&this.$lineCount>0?this.$totalPage=Math.floor((this.$totalCount-1)/this.$lineCount)+1:this.$totalPage=0;var t=this.$page;return this.$totalCount>0&&t<1&&(t=1),t>this.$totalPage&&(this.$page=t=this.$totalPage),this.$desc?this.$count=this.$totalCount-(t-1)*this.$lineCount:this.$count=(t-1)*this.$lineCount+1,this.$count},AbGridPager.prototype.reset=function(){this.$index=0},AbGridPager.prototype.next=function(){return this.$desc?this.$count--:this.$count++,this.$index++,this.$count},AbGridPager.prototype.hasNext=function(){return this.$index<this.$lineCount},AbGridPager.prototype.calculate=function(){this.$page<1&&(this.$page=1),this.$totalBlock=Math.ceil(this.$totalPage/this.$pageCount),this.$block=Math.ceil(this.$page/this.$pageCount),this.$startBlock=(this.$block-1)*this.$pageCount,this.$endBlock=this.$block*this.$pageCount,this.$page>1?this.$prevPage=this.$page-1:this.$prevPage=0,this.$page<this.$totalPage?this.$nextPage=this.$page+1:this.$nextPage=0,this.$block>1?this.$prevBlock=this.$startBlock:this.$prevBlock=0,this.$block<this.$totalBlock?this.$nextBlock=this.$endBlock+1:this.$nextBlock=0,this.$startPage=this.$startBlock+1,this.$endPage=this.$startBlock+this.$pageCount,this.$endPage>this.$totalPage&&(this.$endPage=this.$totalPage)},AbGridPager.prototype.generate=function(){return arguments.length&&"function"==typeof arguments[0]?this.generateEach(arguments[0]):this.generateHtml()},AbGridPager.prototype.generateHtml=function(){var t="",e="",i="",s="",n="";if(this.$totalCount){this.$block>1&&this.$totalBlock&&(t=this.$blockTemplate.replace("{:pagenav:}",this.$pagerFunction(1)).replace("{:style:}",this.$styleBlock).replace("{:symbol:}",this.$symbolFirstBlock)),this.$totalBlock&&this.$block<this.$totalBlock&&(e=this.$blockTemplate.replace("{:pagenav:}",this.$pagerFunction(this.$totalPage)).replace("{:style:}",this.$styleBlock).replace("{:symbol:}",this.$symbolLastBlock)),this.$prevBlock&&(i=this.$blockTemplate.replace("{:pagenav:}",this.$pagerFunction(this.$prevBlock)).replace("{:style:}",this.$styleBlock).replace("{:symbol:}",this.$symbolPrevBlock));for(var r=this.$startPage,a=0;r<=this.$endPage;r++,a++)a>0&&(n+=this.$pageGapTemplate),n+=r==this.$page?this.$cpageTemplate.replace("{:style:}",this.$styleCurrentPage).replace("{:page:}",r):this.$pageTemplate.replace("{:pagenav:}",this.$pagerFunction(r)).replace("{:style:}",this.$stylePage).replace("{:page:}",r);this.$nextBlock&&(s=this.$blockTemplate.replace("{:pagenav:}",this.$pagerFunction(this.$nextBlock)).replace("{:style:}",this.$styleBlock).replace("{:symbol:}",this.$symbolNextBlock))}return this.$navTemplate.replace("{:first:}",t).replace("{:prev:}",i).replace("{:pages:}",n).replace("{:next:}",s).replace("{:last:}",e)},AbGridPager.prototype.generateEach=function(t){var e="",i="",s="",n="",r="";if(this.$totalCount){this.$block>1&&this.$totalBlock&&(e=t("block.first",1)),this.$totalBlock&&this.$block<this.$totalBlock&&(i=t("block.last",this.$totalPage)),this.$prevBlock&&(s=t("block.prev",this.$prevBlock));for(var a=this.$startPage,o=0;a<=this.$endPage;a++,o++)o>0&&(r+=this.$pageGapTemplate),r+=a==this.$page?t("page.current",a):t("page",a);this.$nextBlock&&(n=t("block.next",this.$nextBlock))}return t("navigation",{total:this.$totalCount,html:{first:e,prev:s,pages:r,next:n,last:i}})};var AbMsgBox={show:function(t,e,i){return this.showIt({title:e,text:t,buttons:i||{ok:"확인"}})},info:function(t,e,i){return this.showIt({css:"info",title:e,text:t,buttons:i||{ok:"확인"}})},error:function(t,e,i){return this.showIt({css:"error",title:e,text:t,buttons:i||{ok:"확인"}})},warning:function(t,e,i){return this.showIt({css:"warn",title:e,text:t,buttons:i||{ok:"확인"}})},success:function(t,e,i){return this.showIt({css:"success",title:e,text:t,buttons:i||{ok:"확인"}})},confirm:function(t,e,i){return this.showIt({css:i,title:e,text:t,buttons:{ok:"   예   ",cancel:"아니오"}})},showHtml:function(t,e,i){return this.showIt({titleHtml:e,textHtml:t,buttons:i||{ok:"확인"}})},infoHtml:function(t,e,i){return this.showIt({css:"info",titleHtml:e,textHtml:t,buttons:i||{ok:"확인"}})},errorHtml:function(t,e,i){return this.showIt({css:"error",titleHtml:e,textHtml:t,buttons:i||{ok:"확인"}})},warningHtml:function(t,e,i){return this.showIt({css:"warn",titleHtml:e,textHtml:t,buttons:i||{ok:"확인"}})},successHtml:function(t,e,i){return this.showIt({css:"success",titleHtml:e,textHtml:t,buttons:i||{ok:"확인"}})},confirmHtml:function(t,e,i){return this.showIt({css:i,titleHtml:e,textHtml:t,buttons:{ok:"   예   ",cancel:"아니오"}})},showIt:function(t){return t||(t={}),new Promise(function(e,i){var s=$('<div class="modal modal-ready error"/>');$(document.body).append(s);var n=$('<div class="body"/>'),r=$('<span class="close" mb-topic="cancel">&times;</span>');n.append(r);var a=function(t){var i=arguments.callee.owner,s=$(this);i.find("[mb-topic]").unbind("click",a);var n=s.attr("mb-topic");i.removeClass("modal-show");var r=function(){var t=arguments.callee.owner;t.remove()};r.owner=i,setTimeout(r,300),e(n)};if(a.owner=s,t.css&&n.addClass(t.css),t.title||t.titleHtml){var o=$("<header/>"),h=$("<h2/>");o.append(h),t.titleHtml?h.html(t.titleHtml):h.text(t.title),n.append(o)}var l=$("<div/>");if((t.text||t.textHtml)&&(t.textHtml?l.html(t.textHtml):l.text(t.text)),n.append(l),r.bind("click",a),t.buttons){var c=$("<footer/>"),u=t.buttons,d=0;for(var p in u){var g=$('<input type="button"/>');g.attr("mb-topic",p),g.val(u[p]),g.bind("click",a),c.append(g),d++}d>0&&n.append(c)}s.append(n),setTimeout(function(){s.addClass("modal-show")},100)})},open:function(t){return t||(t={}),t.selector||(t.selector="#img-info"),new Promise(function(i,s){e=$(t.selector);var n=e.find(".body>header"),r=e.find(".body>div");e.find(".body>footer"),e.find(".body .close");if(e.addClass("modal-ready"),t.title||t.titleHtml){var a=n.children("h2");a.length||(a=$("<h2/>"),n.append(a)),n.show(),t.titleHtml?a.html(t.titleHtml):a.text(t.title)}else n.hide();t.text||t.textHtml?t.textHtml?r.html(t.textHtml):r.text(t.text):r.text("");var o=function(t){var e=arguments.callee.owner,s=$(this);e.find("[mb-topic]").unbind("click",o);var n=s.attr("mb-topic");e.removeClass("modal-show");var r=function(){var t=arguments.callee.owner;t.removeClass("modal-ready")};r.owner=e,setTimeout(r,300),i(n)};o.owner=e,e.find("[mb-topic]").bind("click",o),setTimeout(function(){e.addClass("modal-show")},100)})}},AbVendor={save:function(t,e){saveAs(t,e)},exif:function(t,e,i){if("image"!==t&&"file"!==t&&"blob"!==t&&"filereader"!==t)throw new Error("[EXIF] Not support data");EXIF.getData(e,function(){var t=EXIF.getAllTags(this);i(t,this)})},renderSVG:function(t,e,i,s){var n=AbGraphics.canvas.createContext(e,i);canvg(n.canvas,t,{log:!0,renderCallback:function(t){s(n,t)}})}};AbShapeSerializer.prototype={constructor:AbShapeSerializer,GROUP_PREFIX:"g-",PROP_PREFIX:"p-",addGroup:function(){var t=null,e=null;if(2==arguments.length)t=arguments[0],e=arguments[1];else{if(1!=arguments.length)return;e=arguments[0]}var i={};return t?t[this.GROUP_PREFIX+e]=i:this.prop[this.GROUP_PREFIX+e]=i,i},add:function(){var t=null,e=null,i=null;if(3==arguments.length)t=arguments[0],e=arguments[1],i=arguments[2];else{if(2!=arguments.length)return;e=arguments[0],i=arguments[1]}t?t[this.PROP_PREFIX+e]=i:this.prop[this.PROP_PREFIX+e]=i},escape:function(t){return t.replace(/&/gi,"&amp;").replace(/&/gi,"&nbsp;").replace(/</gi,"&lt;").replace(/>/gi,"&gt;").replace(/'/g,"&#039;").replace(/"/g,"&quot;")},outputValue:function(t,e,i){var s=!1,n=!AbCommon.isSetted(i),r=null;n?i="":(r=typeof i,"string"==r?i.length>100&&(s=!0):"number"!=r&&"boolean"!=r&&(r="json",i=JSON.stringify(i),s=!0)),t.put("<"+e),n&&t.put(' nul="true"'),r&&t.put(' type="'+r+'"'),t.put(">"),s&&t.put("<![CDATA["),"string"==r?t.put(this.escape(i)):t.put(i),s&&t.put("]]>"),t.put("</"+e+">")},output:function(t,e){for(var i in e){var s=0==i.indexOf(this.PROP_PREFIX),n=0==i.indexOf(this.GROUP_PREFIX);if(n){var r=i.substr(this.PROP_PREFIX.length);t.put("<"+r+' ptype="group">'),this.output(t,e[i]),t.put("</"+r+">")}else if(s){var r=i.substr(this.PROP_PREFIX.length);this.outputValue(t,r,e[i])}}},hasProp:function(t){for(var e in t)if(t.hasOwnProperty(e))return!0;return!1},serialize:function(){if(!this.hasProp(this.prop))return null;var t={text:"",put:function(t){this.text+=t}};return t.put("<shape>"),this.output(t,this.prop),t.put("</shape>"),t.text}},AbShapeStyler.prototype={constructor:AbShapeStyler,NOTSET:"없음",NOTSET_BKCOLOR:"white",observe:function(t){this.observers.push(t)},stopObserve:function(t){var e=this.observers.indexOf(t);e>=0&&this.observers.splice(e,1)},notifyObservers:function(t,e){for(var i=this.observers.length,s=0;s<i;s++){var n=this.observers[s];"function"==typeof n?n(this,t,e,this.shape):"function"==typeof n.styleNotify&&n.styleNotify(this,t,e,this.shape)}},getDefaultValues:function(t){switch(t){case"lineWidth":return[{text:"없음",value:0},1,2,3,4,5];case"fontSize":return[8,10,12,14,16,20,24,36,48,64];case"font":return[{text:"맑은 고딕",value:"Malgun Gothic"},{text:"굴림",value:"gulim"},{text:"돋움",value:"Dotum"},"Arial","Courier New","Times New Roman","Verdana","Helvetica","Tahoma"];case"textAlign":return[{text:"왼쪽",value:"left"},{text:"중앙",value:"center"},{text:"오른쪽",value:"right"},{text:"맞춤",value:"justify"}];case"arrow":return[{text:"없음",value:"none"},{text:"◀",value:"triangle"},{text:"◆",value:"diamond"},{text:"●",value:"circle"},{text:"&lt;",value:"bracket"}];case"dots":return[{text:"──",value:"solid"},{text:"─ ─",value:"dash"},{text:"- -",value:"dot"},{text:"─ -",value:"dash-dot"},{text:"─ - -",value:"dash-dot-dot"}]}return null},exec:function(t,e){e||(e=0),setTimeout(t.bind(this),e)},set:function(t){AbCommon.isShape(t)&&(this.clear(),this.shape=t,this.prepare())},clear:function(){this.styleDesc=null,this.shape=null,this.colorPicker.close(),this.e.empty()},prepare:function(){this.styleDesc=this.shape.styleDesc(),this.createTopics({e:this.e},this.styleDesc.descs,this.shape.style),this.e.find("select").change(function(t){var e=$(t.currentTarget),i=e.attr("abs-topic"),s=e.attr("abs-type"),n=e.attr("abs-unit"),r=this.typeValue(s,e.val());(r||this.emptyCheck(i))&&this.style(i,this.output(r,s,n))}.bind(this)),this.e.find('div[abs-kind="color"]').click(function(t){var e=t.currentTarget,i=$(e),s=this.getPoint(i);if(this.colorPicker.opened()&&this.colorPicker.token&&this.colorPicker.token==e)return void this.colorPicker.close();var n=(i.attr("abs-topic"),"false"==i.attr("abs-alpha")&&1),r="false"!=i.attr("abs-notset");this.colorPicker.lockAlpha(n),this.colorPicker.enableNotset(r);var a=i.attr("abs-color");a&&this.colorPicker.setColor(a);var o=$(document.body),h={width:i.width(),height:i.height()},l=this.colorPicker.size(),c={width:o.width(),height:o.height()};l.width+=40,l.height+=40;var u=s.x,d=s.y+h.height;u+l.width>c.width&&(u=c.width-l.width),d+l.height>c.height&&(d=c.height-l.height),this.colorPicker.token=e,this.colorPicker.open(u,d)}.bind(this)),this.e.find('input[type="checkbox"]').change(function(t){var e=$(t.currentTarget),i=e.attr("abs-topic"),s=e.is(":checked");(s||this.emptyCheck(i))&&this.style(i,s)}.bind(this)),this.e.find('input[type="text"]').keydown(function(t){13==t.keyCode&&$(this).trigger("change"),t.stopPropagation(),t.stopImmediatePropagation()}),this.e.find('input[type="text"]').change(function(t){var e=$(t.currentTarget),i=e.attr("abs-topic"),s=e.attr("abs-text"),n=e.attr("abs-type"),r=e.attr("abs-unit"),a=e.attr("abs-range-start"),o=e.attr("abs-range-end"),h=e.attr("abs-trim"),l=e.attr("abs-notempty"),c=e.val();if(c=this.typeValue(n,c),"true"===h&&(c=$.trim(c)),"true"===l&&!c)return c=this.style(i),e.val(this.input(c,n,r)),void this.alert(s+"을(를) 입력하세요");if(a||o){var u=this.typeValue(n,a),d=this.typeValue(n,o);if(a&&c<u)return c=this.style(i),e.val(this.input(c,n,r)),void this.exec(function(){this.alert("값은 "+u+"보다 커야 합니다")});if(o&&c>d)return c=this.style(i),e.val(this.input(c,n,r)),void this.exec(function(){this.alert("값은 "+d+"보다 작아야 합니다")})}(c||this.emptyCheck(i))&&this.style(i,this.output(c,n,r))}.bind(this))},notify:function(t,e,i,s){if(this.shape&&this.locked!==!0)switch(e){case"color":var n=$(s),r=n.find("div"),a=n.attr("abs-topic");if(i)n.attr("abs-color",i),r.css("background-color",i),r.text("");else if(n.attr("abs-color",""),r.css("background-color",this.NOTSET_BKCOLOR),r.text(this.NOTSET),!this.emptyCheck(a))return;this.style(a,i);break;case"open":$(document).on("click",this.hasHandler);break;case"close":$(document).off("click",this.hasHandler)}},emptyCheck:function(t){if(!$.isArray(this.styleDesc.select))return!0;if($.inArray(t,this.styleDesc.select)<0)return!0;for(var e=this.styleDesc.select.length,i=0;i<e;i++){var s=this.styleDesc.select[i];if(s!=t){var n=this.style(s);if(!n){var r=this.descObject(t),a=(this.descObject(s),"");switch(r.desc.style){case"color":a=r.text+" 색상을 선택해야 합니다";break;case"select":a=r.text+"(을)를 선택해야 합니다";break;case"check":a=r.text+"(을)를 선택해야 합니다";break;case"text":a=r.text+"(을)를 입력해야 합니다"}if(a)return this.update(),this.exec(function(){this.alert(a)}),!1;break}}}return!0},lock:function(){this.locked=!0},unlock:function(){this.locked=!1},alert:function(t){alert(t)},styleObject:function(t){for(var e=this.shape.style,i=t.split("."),s=0,n=i.length-1,r=i[i.length-1];s<n;)e=e[i[s]],s++;return{style:e,leapTopic:r}},descObject:function(t,e){arguments.length<=1&&(e=" ");for(var i=this.styleDesc.descs,s=t.split("."),n=0,r=s.length,a="";n<r;){for(var o=i.childs||i,h=o.length,l=null,c=0;c<h;c++)if(o[c].name==s[n]){l=o[c];break}if(!l)return null;i=l,0==n?a=i.text:a+=e+i.text,n++}return{text:a,desc:i}},style:function(t,e){if(!this.shape)return!1;var i=this.styleObject(t);return 2==arguments.length?i.style[i.leapTopic]!=e&&(this.notifyObservers(t,{changed:!1}),i.style[i.leapTopic]=e,this.notifyObservers(t,{changed:!0,value:e}),!0):i.style[i.leapTopic]},getPoint:function(t){var e=t.get(0),i=AbCommon.getBounds(e),s=AbCommon.scrolledParents(t);return{x:i.left-s.x,y:i.top-s.y}},createTopics:function(t,e,i){for(var s=e.length,n=0,r=!1,a=!1,o=!1,h=0;h<s;h++){var l=e[h],c=h+1<s?e[h+1]:null,u=t.topic?t.topic+"."+l.name:l.name,d=null;if(o=!1,$.isArray(l.childs))d=this.createGroup(u,l),0==this.createTopics({topic:u,e:d},l.childs,i[l.name])&&(d=null),a=!1;else{switch(l.style){case"check":a=!0;break;default:a=!1}if(c)switch(c.style){case"check":o=!0;break;default:o=!1}var p={beginSingle:!1,endSingle:!1};switch(a&&(r||(p.beginSingle=!0),o||(p.endSingle=!0)),l.style){case"color":d=this.createColor(u,l,i[l.name],p);break;case"select":d=this.createSelect(u,l,i[l.name],p);break;case"check":d=this.createCheck(u,l,i[l.name],p);break;case"text":d=this.createText(u,l,i[l.name],p)}}r=a,d&&(t.e.append(d),n++)}return n},inputElement:function(t){return this.e.find('[abs-topic="'+t+'"]')},createField:function(t,e,i){i||(i={}),AbCommon.isBool(i.textNode)||(i.textNode=!0);var s=i.fieldCss||"",n=$('<div class="abstyler-field '+s+'"/>');if(e.text&&i.textNode){var r=$('<div class="abstyler-field-text"/>');r.text(e.text),n.append(r)}return n},createGroup:function(t,e,i){var s=$('<fieldset class="abstyler-group" abs-kind="group"/>');s.attr("abs-topic",t);var n=$("<legend/>");return n.text(e.text),s.append(n),s},createColor:function(t,e,i,s){var n=this.createField(t,e),r=$('<div class="abstyler-input" abs-kind="color"/>');r.attr("abs-topic",t),r.attr("abs-color",i),AbCommon.isBool(e.alpha)&&r.attr("abs-alpha",e.alpha),AbCommon.isBool(e.notset)&&r.attr("abs-notset",e.notset);var a=$("<div/>");return i?a.css("background-color",i):(a.css("background-color",this.NOTSET_BKCOLOR),a.text(this.NOTSET)),r.append(a),n.append(r),n},updateColor:function(t,e,i,s){var n=this.inputElement(t);n.attr("abs-color",i);var r=n.children(":first");i?(r.css("background-color",i),r.text("")):(r.css("background-color",this.NOTSET_BKCOLOR),r.text(this.NOTSET))},createSelect:function(t,e,i,s){var n=this.createField(t,e),r=$('<div class="custom-select"/>'),a=$('<select class="abstyler-input" abs-kind="select"/>');if(a.attr("abs-topic",t),e.type&&a.attr("abs-type",e.type),e.unit&&a.attr("abs-unit",e.unit),e.values){var o=null;if(o=AbCommon.isString(e.values)?this.getDefaultValues(e.values):e.values,$.isArray(o)){for(var h=o.length,l=null,c="",u=0;u<h;u++)if(l=o[u],AbCommon.isString(l)){var d=this.output(l,e.type,e.unit);c+="<option ",i&&i.toLowerCase()===d.toLowerCase()&&(c+=' selected="selected" '),c+='value="'+AbCommon.escape(l+"")+'">'+l+"</option>"}else if(AbCommon.isBool(l)||AbCommon.isNumber(l)){var d=this.output(l,e.type,e.unit);c+="<option ",i&&i===d&&(c+=' selected="selected" '),c+='value="'+AbCommon.escape(l+"")+'">'+l+"</option>"}else if(l&&(AbCommon.isSetted(l.value)||AbCommon.isSetted(l.text))){var d=this.output(l.value,e.type,e.unit),p=AbCommon.isSetted(l.value);c+="<option ",p&&i===l.value&&(c+=' selected="selected" '),p&&(c+='value="'+AbCommon.escape(l.value)+'"'),c+=">"+l.text+"</option>"}a.append(c)}}return r.append(a),n.append(r),n},updateSelect:function(t,e,i,s){var n=this.inputElement(t);n.val(i)},createCheck:function(t,e,i,s){var n=["abstyler-single-field"],r=!(!s||s.beginSingle!==!0),a=!(!s||s.endSingle!==!0);r===!0?n.push("abstyler-begin-single-field"):a===!0?n.push("abstyler-end-single-field"):n.push("abstyler-next-single-field");var o=this.createField(t,e,{textNode:!1,fieldCss:n.join(" ")}),h=$("<label/>"),l=$('<input type="checkbox" class="abstyler-input" abs-kind="check"/>'),c=$('<div class="checkmark"/>');return l.attr("abs-topic",t),i&&l.attr("checked",!0),h.append(document.createTextNode(e.text)),h.append(l),h.append(c),o.append(h),o},updateCheck:function(t,e,i,s){var n=this.inputElement(t);n.attr("checked",!!i)},createText:function(t,e,i,s){var n=this.createField(t,e),r=$('<input type="text" class="abstyler-input" abs-kind="text"/>');if(r.attr("abs-topic",t),r.attr("abs-text",e.text),e.size&&(r.css("width","auto"),r.attr("size",e.size)),AbCommon.isBool(e.trim)&&r.attr("abs-trim",e.trim),AbCommon.isBool(e.notempty)&&r.attr("abs-notempty",e.notempty),e.range&&(AbCommon.isSetted(e.range.start)&&r.attr("abs-range-start",e.range.start),AbCommon.isSetted(e.range.end)&&r.attr("abs-range-end",e.range.end)),e.type&&r.attr("abs-type",e.type),e.unit&&r.attr("abs-unit",e.unit),e.number&&r.attr("abs-number",e.number),i&&r.val(this.input(i,e.type,e.unit)),n.append(r),e.unit){var a=$('<span class="abstyler-input-suffix"/>');a.text(e.unit),n.append(a)}return n},updateText:function(t,e,i,s){var n=this.inputElement(t),r=n.attr("abs-type"),a=n.attr("abs-unit");value=this.input(i,r,a),n.val(value)},typeValue:function(t,e){switch(t){case"number-unit":case"number":e=parseFloat(e);break;case"boolean":e="true"==e}return e},input:function(t,e,i){return"%"==i?100*parseFloat(t):"number"==e||"number-unit"==e?parseFloat(t):"boolean"==e?"true"==t:t},output:function(t,e,i){return"%"==i?parseFloat(t)/100:"number"==e?parseFloat(t):"boolean"==e?"true"==t:i?t+i:t},update:function(){this.updateTopics(null,this.styleDesc.descs,this.shape.style)},updateTopics:function(t,e,i){for(var s=e.length,n=0;n<s;n++){var r=e[n],a=t?t+"."+r.name:r.name;if($.isArray(r.childs))this.updateTopics(a,r.childs,i[r.name]);else{i[r.name];switch(r.style){case"color":this.updateColor(a,r,i[r.name]);break;case"select":this.updateSelect(a,r,i[r.name]);break;case"check":this.updateCheck(a,r,i[r.name]);break;case"text":this.updateText(a,r,i[r.name])}}}}};var AbShapeTool={beginRectDraw:function(t,e,i,s){var n=i?i.scale.x:1,r=i?i.scale.y:1;e.save();var a=t.box();a.x*=n,a.y*=r,a.width*=n,a.height*=r;var o=a.width>>1,h=a.height>>1;t.angle?(e.translate(a.x+o,a.y+h),e.rotate(AbGraphics.angle.deg2rad(t.angle)),e.translate(-o,-h)):e.translate(a.x,a.y)},endDraw:function(t,e){e.restore(),t.selected&&t.indicator.draw(e)}};AbBoxEditIndicator.prototype={constructor:AbBoxEditIndicator,$$CLONE:!0,$$CHAIN:"target",contains:function(t,e,i,s){var n=this.target.engine.currentPage,r=this.target.box(),a=this.target.padding()||{left:0,top:0,right:0,bottom:0};if(arguments.length>=4){var o=n.toCanvasBox(t,e,i,s);if(t=o.x,e=o.y,i=o.width,s=o.height,this.target.angle){r=AbGraphics.box.inflate(r.x,r.y,r.width,r.height,a),r=n.toCanvasBox(r);var h=AbGraphics.angle.bounds(this.target.angle,r.x,r.y,r.width,r.height);return AbGraphics.contains.box(t,e,i,s,h.x,h.y,h.width,h.height)}return r=AbGraphics.box.inflate(r.x,r.y,r.width,r.height,a),r=n.toCanvasBox(r),AbGraphics.contains.box(t,e,i,s,r.x,r.y,r.width,r.height)}r=AbGraphics.box.inflate(r.x,r.y,r.width,r.height,a),r=n.toCanvasBox(r);var o=n.toCanvas(t,e);if(t=o.x,e=o.y,this.target.angle){var l=r.x+(r.width>>1),c=r.y+(r.height>>1);o=AbGraphics.angle.point(-this.target.angle,l,c,t,e),t=o.x,e=o.y}return AbGraphics.contains.box(r.x,r.y,r.width,r.height,t,e)},containsSide:function(t,e,i,s){var n=this.target.engine.currentPage,r=this.target.box(),a=this.target.padding()||{left:0,top:0,right:0,bottom:0};if(arguments.length>=4){var o=n.toCanvasBox(t,e,i,s);if(t=o.x,e=o.y,i=o.width,s=o.height,this.target.angle){r=AbGraphics.box.inflate(r.x,r.y,r.width,r.height,a),r=n.toCanvasBox(r);var h=AbGraphics.angle.bounds(this.target.angle,r.x,r.y,r.width,r.height);return AbGraphics.contains.box(t,e,i,s,h.x,h.y,h.width,h.height)}return r=AbGraphics.box.inflate(r.x,r.y,r.width,r.height,a),r=n.toCanvasBox(r),AbGraphics.contains.box(t,e,i,s,r.x,r.y,r.width,r.height)}r=AbGraphics.box.inflate(r.x,r.y,r.width,r.height,a),r=n.toCanvasBox(r);var o=n.toCanvas(t,e);if(t=o.x,e=o.y,this.target.angle){var l=r.x+(r.width>>1),c=r.y+(r.height>>1),u=AbGraphics.angle.point(-this.target.angle,l,c,t,e);t=u.x,e=u.y}var d=AbCommon.hasValidLineDistance(this.target)?this.target.validLineDistance():1;return d<1&&(d=1),!!AbGraphics.contains.line(r.x,r.y,r.x+r.width,r.y,t,e,d)||(!!AbGraphics.contains.line(r.x+r.width,r.y,r.x+r.width,r.y+r.height,t,e,d)||(!!AbGraphics.contains.line(r.x,r.y+r.height,r.x+r.width,r.y+r.height,t,e,d)||!!AbGraphics.contains.line(r.x,r.y,r.x,r.y+r.height,t,e,d)))},editable:function(t,e,i){var s=this.target.engine.currentPage,n=this.target.box(),r=this.target.padding()||{left:0,top:0,right:0,bottom:0};n=AbGraphics.box.inflate(n.x,n.y,n.width,n.height,r),n=s.toCanvasBox(n.x,n.y,n.width,n.height);var a=n.width>>1,o=n.height>>1,h=n.x,l=n.y,c=n.width,u=n.height,d=n.x+a,p=n.y+o;if(this.target.angle){var g=s.toCanvas(t,e);g=AbGraphics.angle.point(-this.target.angle,d,p,g.x,g.y),t=g.x,e=g.y}else{var g=s.toCanvas(t,e);t=g.x,e=g.y}return this.controls.leftTop&&this.containsControl(h,l,t,e)?"LT":this.controls.top&&this.containsControl(h+a,l,t,e)?"CT":this.controls.rightTop&&this.containsControl(h+c,l,t,e)?"RT":this.controls.left&&this.containsControl(h,l+o,t,e)?"LC":this.controls.right&&this.containsControl(h+c,l+o,t,e)?"RC":this.controls.leftBottom&&this.containsControl(h,l+u,t,e)?"LB":this.controls.bottom&&this.containsControl(h+a,l+u,t,e)?"CB":this.controls.rightBottom&&this.containsControl(h+c,l+u,t,e)?"RB":this.controls.angle&&this.controls.angleDistance&&this.containsControl(h+a,l-this.controls.angleDistance,t,e)?"A":void 0},containsControl:function(t,e,i,s){var n=this.target.focused?this.style.focus:this.style.default,r=n.control.stroke.width,a=n.control.size,o=a>>1,h=AbGraphics.box.inflate(t-o,e-o,a,a,r);return AbGraphics.contains.box(h.x,h.y,h.width,h.height,i,s)},editPos:function(t){var e=this.target.engine.currentPage,i=this.target.box(),s=this.target.padding()||{left:0,top:0,right:0,bottom:0};i=AbGraphics.box.inflate(i.x,i.y,i.width,i.height,s),i=e.toCanvasBox(i);var n=i.width>>1,r=i.height>>1;switch(t){case"A":var a=AbCommon.engineScale(this.target);return{x:i.x+n,y:i.y-(this.controls.angle&&this.controls.angleDistance?this.controls.angleDistance/a.y:0)};case"LT":return{x:i.x,y:i.y};case"CT":return{x:i.x+n,y:i.y};case"RT":return{x:i.x+i.width,y:i.y};case"LC":return{x:i.x,y:i.y+r};case"RC":return{x:i.x+i.width,y:i.y+r};case"LB":return{x:i.x,y:i.y+i.height};case"CB":return{x:i.x+n,y:i.y+i.height};case"RB":return{x:i.x+i.width,y:i.y+i.height}}},resize:function(t,e,i){if(t){var s=this.target.engine.currentPage,n=this.target.box();n=s.toCanvasBox(n.x,n.y,n.width,n.height);var r=n.x+(n.width>>1),a=n.y+(n.height>>1),o=s.toCanvas(e,i);if(e=o.x,i=o.y,"A"==t){var h=AbGraphics.angle.get(r,a,e,i),l=h-this.target.angle;return this.target.setAngle(h),l}var c=n.x,u=n.y,d=n.x+n.width,p=n.y+n.height,g=(n.width>>1,n.height>>1,AbGraphics.angle.point(-this.target.angle,r,a,e,i));switch(e=g.x,i=g.y,t){case"LT":c=e,u=i;break;case"CT":u=i;break;case"RT":d=e,u=i;break;case"LC":c=e;break;case"RC":d=e;break;case"LB":c=e,p=i;break;case"CB":p=i;break;case"RB":d=e,p=i}var f=!0,m=d-c,b=p-u;if(AbCommon.supportResizable(this.target)){var y=this.target.resizable(m/s.scale.x,b/s.scale.y);y.width*=s.scale.x,y.height*=s.scale.y,f=y.result,m=y.width,b=y.height}else{var v=1,x=1;if(AbCommon.hasMinimum(this.target)){var w=this.target.minimum();v=w.width*s.scale.x,x=w.height*s.scale.y}var A=m<v,k=b<x;m=v,b=x,A&&k?f=!1:A?f="h":k&&(f="v")}if(f===!1)switch(t){case"LT":c=d-m,u=p-b;break;case"CT":d=c+m,u=p-b;break;case"RT":d=c+m,u=p-b;break;case"LC":c=d-m,p=u+b;break;case"RC":d=c+m,p=u+b;break;case"LB":c=d-m,p=u+b;break;case"CB":d=c+m,p=u+b;break;case"RB":d=c+m,p=u+b}else if("h"===f||"H"===f)switch(t){case"LT":c=d-m;break;case"CT":d=c+m;break;case"RT":d=c+m;break;case"LC":c=d-m;break;case"RC":d=c+m;break;case"LB":c=d-m;break;case"CB":d=c+m;break;case"RB":d=c+m}else if("v"===f||"V"===f)switch(t){case"LT":u=p-b;break;case"CT":u=p-b;break;case"RT":u=p-b;break;case"LC":p=u+b;break;case"RC":p=u+b;break;case"LB":p=u+b;break;case"CB":p=u+b;break;case"RB":p=u+b}var C=this.correct(t,c,u,d-c,p-u,n);return C=s.fromCanvasBox(C),this.target.box(C.x,C.y,C.width,C.height),g}},correct:function(){var t=0,e=0,i=0,s=0,n=0,r=0,a=null;if(3==arguments.length)a=arguments[0],t=arguments[1].x,e=arguments[1].y,i=arguments[1].width,s=arguments[1].height,n=arguments[2].width,r=arguments[2].height;else if(4==arguments.length)a=arguments[0],t=arguments[1].x,e=arguments[1].y,i=arguments[1].width,s=arguments[1].height,n=arguments[2],r=arguments[3];else if(6==arguments.length)a=arguments[0],t=arguments[1],e=arguments[2],i=arguments[3],s=arguments[4],n=arguments[5].width,r=arguments[5].height;else{if(7!=arguments.length)return null;a=arguments[0],t=arguments[1],e=arguments[2],i=arguments[3],s=arguments[4],n=arguments[5],r=arguments[6]}var o=n>>1,h=r>>1,l=i-n,c=s-r;switch(a){case"LT":o+=l,h+=c;break;case"RT":h+=c;break;case"CT":h+=c;break;case"LC":case"LB":o+=l}var u=AbGraphics.angle.point(this.target.angle,o,h,0,0),d=AbGraphics.angle.point(this.target.angle,i>>1,s>>1,0,0);return t-=d.x-u.x,e-=d.y-u.y,{x:t,y:e,width:i,height:s}},drawControl:function(t,e,i,s){s||(s="box");var n=this.target.focused?this.style.focus:this.style.default,r=n.control.size,a=r>>1;"circle"==s?(n.control.color&&(t.beginPath(),t.arc(e,i,a,0,360),t.fill(),t.closePath()),n.control.stroke.color&&n.control.stroke.width&&(t.beginPath(),t.arc(e,i,a,0,360),t.stroke(),t.closePath())):(n.control.color&&t.fillRect(e-a,i-a,r,r),n.control.stroke.color&&n.control.stroke.width&&t.strokeRect(e-a,i-a,r,r))},targetScaledBox:function(){var t=this.target.box(),e=AbCommon.engineScale(this.target);return t.x*=e.x,t.y*=e.y,t.width*=e.x,t.height*=e.y,t},draw:function(t){var e=this.targetScaledBox(),i=AbCommon.isFunction(this.target.drawPadding)?this.target.drawPadding():this.target.padding()||{left:0,top:0,right:0,bottom:0},s=(this.target.angle,this.target.focused?this.style.focus:this.style.default);t.save();var n=e.width>>1,r=e.height>>1;this.target.angle?(t.translate(e.x+n,e.y+r),t.rotate(AbGraphics.angle.deg2rad(this.target.angle)),t.translate(-(i.left+n),-(i.top+r))):t.translate(e.x-i.left,e.y-i.top),e=AbGraphics.box.inflate(e.x,e.y,e.width,e.height,i),n=e.width>>1,r=e.height>>1,t.strokeStyle=s.color,t.lineWidth=s.width,t.strokeRect(0,0,e.width,e.height),t.strokeStyle=s.control.stroke.color,t.lineWidth=s.control.stroke.width,t.fillStyle=s.control.color,this.controls.angle&&this.controls.angleDistance&&(this.controls.angleDistance&&(t.beginPath(),t.moveTo(n,0),t.lineTo(n,-this.controls.angleDistance),t.stroke()),this.drawControl(t,n,-this.controls.angleDistance,"circle")),this.controls.leftTop&&this.drawControl(t,0,0),this.controls.top&&this.drawControl(t,n,0),this.controls.rightTop&&this.drawControl(t,e.width,0),this.controls.left&&this.drawControl(t,0,r),this.controls.right&&this.drawControl(t,e.width,r),this.controls.leftBottom&&this.drawControl(t,0,e.height),this.controls.bottom&&this.drawControl(t,n,e.height),this.controls.rightBottom&&this.drawControl(t,e.width,e.height),t.restore()}},AbLineEditIndicator.prototype={constructor:AbLineEditIndicator,$$CLONE:!0,$$CHAIN:"target",corners:function(t){AbCommon.isBool(t)||(t=!0);var e=this.target.engine.currentPage,i=this.target.rect();if(i=e.toCanvasRect(i),t){var s=i.x2-i.x1>>1,n=i.y2-i.y1>>1,r=i.x1+s,a=i.y1+n;i.x1-=r,i.y1-=a,i.x2-=r,i.y2-=a}var o=this.target.padding()||{left:0,top:0,right:0,bottom:0},h=AbGraphics.angle.radian90(i.x1,i.y1,i.x2,i.y2),l=AbGraphics.distance(i.x1,i.y1,i.x2,i.y2),c=AbGraphics.rotate.point(-h,i.x1,i.y1,i.x2,i.y2),u=i.x1-o.left,d=i.y1-o.top,p=c.x+o.right,g=c.y+o.bottom,f=AbGraphics.rotate.point(h,i.x1,i.y1,u,d),m=AbGraphics.rotate.point(h,i.x1,i.y1,p,d),b=AbGraphics.rotate.point(h,i.x1,i.y1,p,g),y=AbGraphics.rotate.point(h,i.x1,i.y1,u,g),v=AbGraphics.rotate.pointByDistance(h,l/2),x={x:f.x+v.x,y:f.y+v.y},w=AbGraphics.angle.radian90(f.x,f.y,y.x,y.y);l=AbGraphics.distance(f.x,f.y,y.x,y.y),v=AbGraphics.rotate.pointByDistance(w,l/2);var A={x:f.x+v.x,y:f.y+v.y};l=AbGraphics.distance(m.x,m.y,b.x,b.y),v=AbGraphics.rotate.pointByDistance(w,l/2);var k={x:m.x+v.x,y:m.y+v.y},C=null;return this.controls.angle&&this.controls.angleDistance&&(v=AbGraphics.rotate.pointByDistance(h+3*AbGraphics.angle.RAD90,this.controls.angleDistance),C={x:x.x+v.x,y:x.y+v.y}),{rad:h,radWide:w,cx:i.x1,cy:i.y1,leftTop:f,rightTop:m,rightBottom:b,leftBottom:y,centerTop:x,left:A,right:k,anglePoint:C}},contains:function(t,e,i,s){return"box"===this.selectionStyle?this.containsBox.apply(this,arguments):this.containsLine.apply(this,arguments)},containsLine:function(t,e,i,s){var n=this.target.engine.currentPage,r=this.target.padding()||{left:0,top:0,right:0,bottom:0};if(arguments.length>=4){var a=n.toCanvasBox(t,e,i,s);t=a.x,e=a.y,i=a.width,s=a.height;var o=this.target.box();return o=AbGraphics.box.inflate(o.x,o.y,o.width,o.height,r),o=n.toCanvasBox(o),AbGraphics.contains.box(t,e,i,s,o.x,o.y,o.width,o.height)}var h=this.target.rect();h=n.toCanvasRect(h);var a=n.toCanvas(t,e);t=a.x,e=a.y;var l=AbCommon.hasValidLineDistance(this.target)?this.target.validLineDistance():r.top+r.bottom>>1;l<1&&(l=1);var c=AbGraphics.contains.line(h.x1,h.y1,h.x2,h.y2,t,e,l);return c},containsBox:function(t,e,i,s){var n=this.target.engine.currentPage;if(arguments.length>=4){var r=n.toCanvasBox(t,e,i,s);t=r.x,e=r.y,i=r.width,s=r.height;var a=this.target.box();return a=n.toCanvasBox(a),AbGraphics.contains.box(t,e,i,s,a.x,a.y,a.width,a.height)}var a=this.target.box();a=n.toCanvasBox(a);var r=n.toCanvas(t,e);return t=r.x,e=r.y,AbGraphics.contains.box(a.x,a.y,a.width,a.height,t,e)},editable:function(t,e){var i=this.target.engine.currentPage,s=this.corners(!1),n=i.toCanvas(t,e);return t=n.x,e=n.y,this.controls.left&&this.containsControl(s.left.x,s.left.y,t,e)?"LC":this.controls.right&&this.containsControl(s.right.x,s.right.y,t,e)?"RC":s.anglePoint&&this.containsControl(s.anglePoint.x,s.anglePoint.y,t,e)?"A":void 0},containsControl:function(t,e,i,s){
var n=this.target.focused?this.style.focus:this.style.default,r=n.control.stroke.width,a=n.control.size,o=a>>1,h=AbGraphics.box.inflate(t-o,e-o,a,a,r);return AbGraphics.contains.box(h.x,h.y,h.width,h.height,i,s)},editPos:function(t){var e=this.corners(!1);switch(t){case"A":var i=AbCommon.engineScale(this.target);return{x:e.anglePoint?e.anglePoint.x:0,y:e.anglePoint?e.anglePoint.y/i.y:0};case"LC":return{x:e.left.x,y:e.left.y};case"RC":return{x:e.right.x,y:e.right.y}}},resize:function(t,e,i){if(t){var s=this.target.engine.currentPage,n=this.target.box();n=s.toCanvasBox(n.x,n.y,n.width,n.height);var r=n.x+(n.width>>1),a=n.y+(n.height>>1),o=this.target.rect();o=s.toCanvasRect(o);var h=s.toCanvas(e,i);if(e=h.x,i=h.y,"A"==t){var l=AbGraphics.angle.get(r,a,e,i),c=l-this.target.angle;this.target.angle=l;var u=AbGraphics.angle.rect(c,r,a,o.x1,o.y1,o.x2,o.y2);return u=s.fromCanvasRect(u.x1,u.y1,u.x2,u.y2),this.target.rect(u.x1,u.y1,u.x2,u.y2),c}var d=o.x1,p=o.y1,g=o.x2,f=o.y2,m=AbGraphics.angle.point(-this.target.angle,r,a,e,i);switch(t){case"LC":d=e,p=i;break;case"RC":g=e,f=i}return o=s.fromCanvasRect(d,p,g,f),this.target.rect(o.x1,o.y1,o.x2,o.y2),m}},drawControl:function(t,e,i,s,n){s||(s="box");var r=this.target.focused?this.style.focus:this.style.default,a=r.control.size,o=a>>1;t.save(),t.translate(e,i),n&&t.rotate(n),"circle"==s?(r.control.color&&(t.beginPath(),t.arc(0,0,o,0,360),t.fill(),t.closePath()),r.control.stroke.color&&r.control.stroke.width&&(t.beginPath(),t.arc(0,0,o,0,360),t.stroke(),t.closePath())):(r.control.color&&t.fillRect(-o,-o,a,a),r.control.stroke.color&&r.control.stroke.width&&t.strokeRect(-o,-o,a,a)),t.restore()},targetScaledBox:function(){var t=this.target.box(),e=AbCommon.engineScale(this.target);return t.x*=e.x,t.y*=e.y,t.width*=e.x,t.height*=e.y,t},targetScaledRect:function(){var t=this.target.rect(),e=AbCommon.engineScale(this.target);return t.x1*=e.x,t.y1*=e.y,t.x2*=e.x,t.y2*=e.y,t},draw:function(t){"box"===this.selectionDrawStyle?this.drawBox(t):this.drawLine(t)},drawLine:function(t){t.save();var e=this.targetScaledRect(),i=(this.target.angle,e.x2-e.x1>>1),s=e.y2-e.y1>>1;t.translate(e.x1+i,e.y1+s);var n=this.corners(),r=this.target.focused?this.style.focus:this.style.default;t.strokeStyle=r.color,t.lineWidth=r.width,t.beginPath(),t.moveTo(n.leftTop.x,n.leftTop.y),t.lineTo(n.rightTop.x,n.rightTop.y),t.lineTo(n.rightBottom.x,n.rightBottom.y),t.lineTo(n.leftBottom.x,n.leftBottom.y),t.lineTo(n.leftTop.x,n.leftTop.y),t.stroke(),t.closePath(),t.strokeStyle=r.control.stroke.color,t.lineWidth=r.control.stroke.width,t.fillStyle=r.control.color,n.anglePoint&&(t.beginPath(),t.moveTo(n.centerTop.x,n.centerTop.y),t.lineTo(n.anglePoint.x,n.anglePoint.y),t.stroke(),this.drawControl(t,n.anglePoint.x,n.anglePoint.y,"circle")),this.controls.left&&this.drawControl(t,n.left.x,n.left.y,"box",n.radWide),this.controls.right&&this.drawControl(t,n.right.x,n.right.y,"box",n.radWide),t.restore()},drawBox:function(t){t.save();var e=this.targetScaledRect(),i=this.targetScaledBox(),s=this.target.padding()||{left:0,top:0,right:0,bottom:0},n=(this.target.angle,e.x2-e.x1>>1),r=e.y2-e.y1>>1;t.translate(e.x1+n,e.y1+r);var a=this.corners(),o=this.target.focused?this.style.focus:this.style.default;t.strokeStyle=o.color,t.lineWidth=o.width,i=AbGraphics.box.inflate(i.x,i.y,i.width,i.height,s),n=i.width>>1,r=i.height>>1,t.strokeRect(-n,-r,i.width,i.height),t.strokeStyle=o.control.stroke.color,t.lineWidth=o.control.stroke.width,t.fillStyle=o.control.color,a.anglePoint&&(t.beginPath(),t.moveTo(a.centerTop.x,a.centerTop.y),t.lineTo(a.anglePoint.x,a.anglePoint.y),t.stroke(),this.drawControl(t,a.anglePoint.x,a.anglePoint.y,"circle")),this.controls.left&&this.drawControl(t,a.left.x,a.left.y,"box",a.radWide),this.controls.right&&this.drawControl(t,a.right.x,a.right.y,"box",a.radWide),t.restore()}},AbShapeImage.prototype={constructor:AbShapeImage,adviceClone:function(){return{customProps:["$image"],custom:function(t,e){return $(e).clone().get(0)}}},preload:function(t){if(this.$image||!this.source.data)return void t("skip");var e=this.source.width,i=this.source.height;this.source.render&&AbCommon.isNumber(this.source.render.width)&&AbCommon.isNumber(this.source.render.height)&&(e=this.source.render.width,i=this.source.render.height),AbCommon.loadImageExt(this.source.data,{width:e,height:i,success:function(e){this.$image=e,t("ok")}.bind(this),error:function(e){console.log(e),this.$image="error",t("error",e)}.bind(this)}),this.$image="loading"},cloneProperty:function(t,e){"source.data"===t&&e!==this.source.data&&(this.$image=null)},styleDesc:function(){return{select:[],descs:[]}},prepare:function(){},reset:function(){},serialize:function(){var t=new AbShapeSerializer;t.add("name",this.name),t.add("type",this.type),t.add("shapeType",this.shapeType),t.add("shapeStyle",this.shapeStyle),t.add("token",this.token),t.add("angle",this.angle),t.add("x",Math.round(this.x)),t.add("y",Math.round(this.y)),t.add("width",Math.round(this.width)),t.add("height",Math.round(this.height));var e=t.addGroup("source");t.add(e,"data",this.source.data),t.add(e,"width",this.source.width),t.add(e,"height",this.source.height);var i=t.addGroup(e,"render");return t.add(i,"width",this.source.render.width),t.add(i,"height",this.source.render.height),t.serialize()},notify:function(t){},setAngle:function(t){this.angle=t},move:function(t,e,i){i===!0?(this.x+=t,this.y+=e):(this.x=t,this.y=e)},rect:function(){if(4!=arguments.length)return{x1:this.x,y1:this.y,x2:this.x+this.width,y2:this.y+this.height};var t=AbGraphics.box.rect(arguments[0],arguments[1],arguments[2],arguments[3]);this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height},box:function(){return 4!=arguments.length?{x:this.x,y:this.y,width:this.width,height:this.height}:(this.x=arguments[0],this.y=arguments[1],this.width=arguments[2],this.height=arguments[3],void 0)},center:function(){return{x:this.x+(this.width>>1),y:this.y+(this.height>>1)}},minimum:function(){return{width:10,height:10}},padding:function(){return{left:0,top:0,right:0,bottom:0}},contains:function(t,e,i,s){return this.indicator.contains.apply(this.indicator,arguments)},editable:function(t,e){return this.selected?this.indicator.editable(t,e):null},editPos:function(t){return this.indicator.editPos(t)},resize:function(t,e,i){return this.indicator.resize(t,e,i)},measure:function(){},validLineDistance:function(){return this.style.stroke&&this.style.stroke.width?this.style.stroke.width:1},draw:function(t,e,i){var s=e?e.scale.x:1,n=e?e.scale.y:1;if(AbShapeTool.beginRectDraw(this,t,e),this.$image&&"error"!==this.$image&&"loading"!==this.$image)try{t.drawImage(this.$image,0,0,this.width*s,this.height*n)}catch(t){console.log("[SHAPE-IMAGE] Drawing Error"),console.log(t)}AbShapeTool.endDraw(this,t)}},AbShapeRectangle.prototype={constructor:AbShapeRectangle,styleDesc:function(){return{select:["color","stroke.width"],descs:[{name:"color",text:"채우기색상",style:"color"},{name:"stroke",text:"선 스타일",childs:[{name:"width",text:"두께",style:"select",type:"number",values:"lineWidth"},{name:"color",text:"색상",style:"color",alpha:!1,notset:!1}]}]}},prepare:function(){},reset:function(){},serialize:function(){var t=new AbShapeSerializer;t.add("name",this.name),t.add("type",this.type),t.add("shapeType",this.shapeType),t.add("shapeStyle",this.shapeStyle),t.add("token",this.token),t.add("angle",this.angle),t.add("x",Math.round(this.x)),t.add("y",Math.round(this.y)),t.add("width",Math.round(this.width)),t.add("height",Math.round(this.height));var e=t.addGroup("style");if(t.add(e,"color",this.style.color),this.style.stroke){var i=t.addGroup(e,"stroke");t.add(i,"width",this.style.stroke.width),t.add(i,"color",this.style.stroke.color)}return t.serialize()},notify:function(t){},setAngle:function(t){this.angle=t},move:function(t,e,i){i===!0?(this.x+=t,this.y+=e):(this.x=t,this.y=e)},rect:function(){if(4!=arguments.length)return{x1:this.x,y1:this.y,x2:this.x+this.width,y2:this.y+this.height};var t=AbGraphics.box.rect(arguments[0],arguments[1],arguments[2],arguments[3]);this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height},box:function(){return 4!=arguments.length?{x:this.x,y:this.y,width:this.width,height:this.height}:(this.x=arguments[0],this.y=arguments[1],this.width=arguments[2],this.height=arguments[3],void 0)},center:function(){return{x:this.x+(this.width>>1),y:this.y+(this.height>>1)}},minimum:function(){return{width:10,height:10}},padding:function(){return{left:0,top:0,right:0,bottom:0}},contains:function(t,e,i,s){var n=this.engine.selectionStyle(this.name);return"box"===n?this.indicator.contains.apply(this.indicator,arguments):this.style.color?this.indicator.contains.apply(this.indicator,arguments):this.indicator.containsSide.apply(this.indicator,arguments)},editable:function(t,e){return this.selected?this.indicator.editable(t,e):null},editPos:function(t){return this.indicator.editPos(t)},resize:function(t,e,i){return this.indicator.resize(t,e,i)},measure:function(){},validLineDistance:function(){return this.style.stroke&&this.style.stroke.width?this.style.stroke.width:1},restoreMinimumSize:function(){var t=!1,e=0;return this.style.stroke&&(t=this.style.stroke&&this.style.stroke.width&&this.style.stroke.color,e=this.style.stroke.width),{width:t?e:0,height:t?e:0}},draw:function(t,e,i){var s=e?e.scale.x:1,n=e?e.scale.y:1,r=this.width*s,a=this.height*n;if(AbShapeTool.beginRectDraw(this,t,e),this.style.color&&(t.fillStyle=this.style.color,t.fillRect(0,0,r,a)),this.style.stroke&&this.style.stroke.width&&this.style.stroke.color){t.strokeStyle=this.style.stroke.color,t.lineWidth=this.style.stroke.width;var o=this.style.stroke.width,h=o/2;t.strokeRect(h,h,r-o,a-o)}AbShapeTool.endDraw(this,t)}},AbShapeTextBox.prototype={constructor:AbShapeTextBox,textAlign:function(t,e){if(!t)return e;switch(t){case"left":case"center":case"right":case"justify":return t}return e},styleDesc:function(){return{select:["color","stroke.width"],descs:[{name:"color",text:"채우기색상",style:"color",alpha:!1,notset:!1},{name:"stroke",text:"선 스타일",childs:[{name:"width",text:"두께",style:"select",type:"number",values:"lineWidth"},{name:"color",text:"색상",style:"color",alpha:!1,notset:!1}]},{name:"text",text:"글자 스타일",childs:[{name:"size",text:"크기",style:"text",type:"number-unit",unit:"px",range:{start:1}},{name:"font",text:"글자모양",style:"select",type:"string",values:"font"},{name:"italic",text:"기울림",style:"check"},{name:"bold",text:"굵게",style:"check"},{name:"under",text:"밑줄",style:"check"},{name:"cancel",text:"취소선",style:"check"},{name:"color",text:"색상",style:"color",alpha:!1,notset:!1},{name:"lineHeight",text:"글자높이",style:"text",type:"number",unit:"%",range:{start:10}},{name:"align",text:"정렬",style:"select",type:"string",values:"textAlign"}]}]}},prepare:function(){},reset:function(){this.text=""},serialize:function(){var t=new AbShapeSerializer;t.add("name",this.name),t.add("type",this.type),t.add("shapeType",this.shapeType),t.add("shapeStyle",this.shapeStyle),t.add("token",this.token),t.add("text",this.text),t.add("angle",this.angle),t.add("x",Math.round(this.x)),t.add("y",Math.round(this.y)),t.add("width",Math.round(this.width)),t.add("height",Math.round(this.height)),t.add("textPadding",this.textPadding);var e=t.addGroup("style");t.add(e,"color",this.style.color);var i=t.addGroup(e,"stroke");t.add(i,"width",this.style.stroke.width),t.add(i,"color",this.style.stroke.color);var s=t.addGroup(e,"text");return t.add(s,"size",this.style.text.size),t.add(s,"font",this.style.text.font),t.add(s,"italic",this.style.text.italic),t.add(s,"bold",this.style.text.bold),t.add(s,"under",this.style.text.under),t.add(s,"cancel",this.style.text.cancel),t.add(s,"color",this.style.text.color),t.add(s,"lineHeight",this.style.text.lineHeight),t.add(s,"align",this.style.text.align),t.serialize()},notify:function(t){if("created"==t){if(this.text="내용을 입력하세요",5==arguments.length){var e=(arguments[1],arguments[2],arguments[3]),i=arguments[4];this.move(e,i)}}else if("measured"==t){var s=this.getStrokeWidth()<<1,n=this.textWidth<<1,r=this.textHeight<<1;this.size(n+this.textPadding.horiz()+s,r+this.textPadding.vert()+s),this.measure()}else if("styled"==t){var s=this.getStrokeWidth()<<1;this.size(this.textWidth+this.textPadding.horiz()+s,this.textHeight+this.textPadding.vert()+s)}},creationStyle:function(){return"click"},setAngle:function(t){this.angle=t},move:function(t,e,i){i===!0?(this.x+=t,this.y+=e):(this.x=t,this.y=e)},rect:function(){if(4!=arguments.length)return{x1:this.x,y1:this.y,x2:this.x+this.width,y2:this.y+this.height};var t=AbGraphics.box.rect(arguments[0],arguments[1],arguments[2],arguments[3]);this.box(t.x,t.y,t.width,t.height)},box:function(){if(4!=arguments.length)return{x:this.x,y:this.y,width:this.width,height:this.height};var t=arguments[0],e=arguments[1],i=arguments[2],s=arguments[3],n=this.width==i&&this.height==s;this.x=t,this.y=e,this.width=i,this.height=s,n||this.measure()},center:function(){return{x:this.x+(this.width>>1),y:this.y+(this.height>>1)}},minimum:function(){return{width:50,height:50}},resizable:function(t,e){var i=this.getStrokeWidth()<<1,s=this.measureSize(null,t,this.text),n=AbGraphics.size.minimum(this.textWidth,this.textHeight,s),r=AbGraphics.size.maximum(n.width+this.textPadding.horiz()+i,n.height+this.textPadding.vert()+i,this.minimum()),a=r.width>t,o=r.height>e,h=!0;return a&&o?h=!1:a?h="h":o&&(h="v"),{result:h,width:r.width,height:r.height}},padding:function(){return{left:0,top:0,right:0,bottom:0}},contains:function(t,e,i,s){return this.indicator.contains.apply(this.indicator,arguments)},editable:function(t,e){return this.selected?this.indicator.editable.apply(this.indicator,arguments):null},editPos:function(t){return this.indicator.editPos.apply(this.indicator,arguments)},resize:function(t,e,i){return this.indicator.resize.apply(this.indicator,arguments)},measure:function(){return this.measureSize(null,this.width,this.text)},getStrokeWidth:function(){return this.style.stroke&&this.style.stroke.width&&this.style.stroke.color?this.style.stroke.width:0},size:function(t,e){if(arguments.length){var i=this.engine.currentPage,s=i.toCanvas(this.x,this.y),n={width:this.width*i.scale.x,height:this.height*i.scale.y},r={width:t*i.scale.x,height:e*i.scale.y},a=this.getStrokeWidth(),o=this.textPadding,h=(o.horiz()+(a<<1),o.vert()+(a<<1),this.indicator.correct("RB",s.x,s.y,r.width,r.height,n.width,n.height));return s=i.fromCanvas(h.x,h.y),this.x=s.x,this.y=s.y,this.width=h.width/i.scale.x,void(this.height=h.height/i.scale.y)}return{width:this.width,height:this.height}},measureSize:function(t,e,i){var t=null;if(null==t&&this.engine&&(t=this.engine.context),!t)return null;t.save(),this.setTextSyle(t);var s=this.textPadding,n=this.getStrokeWidth(),r=this.wrapMeasureText(t,i,{maxWidth:e-s.horiz()-(n<<1)});return t.restore(),r.changed=this.textWidth!=r.width&&this.textHeight!=r.height,this.textWidth=r.width,this.textHeight=r.height,r},testInlineEdit:function(t,e,i){if(this.angle){var s=this.center(),n=AbGraphics.angle.point(-this.angle,s.x,s.y,e,i);e=n.x,i=n.y}var r=this.getStrokeWidth(),a=this.textPadding,o=r<<1,h=a.horiz(),l=a.vert(),c={x:a.left+r,y:a.top+r,width:this.width-o-h,height:this.height-o-l},u=c.x,d=c.y,p=this.textWidth,g=this.textHeight;switch(this.text||(p=c.width,g=c.height),this.style.text.align){case"center":u=c.width-this.textWidth>>1;break;case"right":u=c.width-this.textWidth;break;case"justify":u=c.x,p=c.width}return AbGraphics.contains.box(this.x+u,this.y+d,p,g,e,i)},inlineEdit:function(t,e){var i=t.textbox;i.on("focusout",{engine:t,shape:this,textbox:i},function(t){var e=$(this),s=t.data.shape,n=e.val();if(i.off("focusout"),i.off("input"),s.text=n,s.measure(),s.width<s.textWidth||s.height<s.textHeight){var r=s.getStrokeWidth()<<1;s.size(s.textWidth+s.textPadding.horiz()+r,s.textHeight+s.textPadding.vert()+r)}s.textEditMode=!1,t.data.engine.history.end(t.data.engine),t.data.engine.render(!0,!0),setTimeout(function(){i.hide()},0)}),i.on("input",{engine:t,shape:this,textbox:i},function(t){var e=$(this),i=t.data.shape,s=null,n=null;this.scrollWidth>e.width()&&(s=this.scrollWidth),this.scrollHeight>e.height()&&(n=this.scrollHeight);var r=i.getStrokeWidth(),a=i.textPadding.left+r,o=i.textPadding.top+r,h=i.textPadding.horiz()+(r<<1),l=i.textPadding.vert()+(r<<1),c={x:(s?s:i.width-h)+h,y:(n?n:i.height-l)+l};if(null!=s&&null!=n){i.size(c.x,c.y);i.x+a,i.y+o;t.data.textbox.box(i.x+a,i.y+o,i.width-h,i.height-l),t.data.engine.render()}else if(null!=s){i.size(c.x,c.y);i.x+a,i.y+o;t.data.textbox.box(i.x+a,i.y+o,i.width-h,i.height-l),t.data.engine.render()}else if(null!=n){i.size(c.x,c.y);i.x+a,i.y+o;t.data.textbox.box(i.x+a,i.y+o,i.width-h,i.height-l),t.data.engine.render()}});var s=AbCss.pixel(this.style.text.size),n=AbCss.color(this.style.color);if(4==n.length&&n[3]<1){console.log("[RGB] "+n);var r=AbColor.rgb2hsv(n[0],n[1],n[2]);console.log("[RGB -> HSV] "+r),r[1]=n[3]*r[1],console.log("[MODIFIED HSV] "+r);var n=AbColor.hsv2rgb(r[0],r[1],r[2]);console.log("[HSV -> RGB] "+n)}if(i.attr("modified-size","false"),i.val(this.text),i.css({background:"rgb("+n[0]+","+n[1]+","+n[2]+")",color:this.style.text.color,fontFamily:this.style.text.font,fontSize:s+"px",lineHeight:100*this.style.text.lineHeight+"%",wordWrap:"break-word",wordBreak:"keep-all"}),this.style.text.italic&&i.css("font-style","italic"),this.style.text.bold&&i.css("font-weight","700"),this.style.text.under||this.style.text.cancel){var a=[];this.style.text.under&&a.push("underline"),this.style.text.cancel&&a.push("line-through"),i.css("text-decoration",a.join(" "))}if(this.style.text.align){var o=this.style.text.align;i.css("text-align",o)}var h=this.getStrokeWidth();t.history.begin("shape","update",t,["angle","x","y","width","height","textWidth","textHeight","text"]),this.textEditMode=!0,i.show(this.x+this.textPadding.left+h,this.y+this.textPadding.top+h,this.width-this.textPadding.horiz()-(h<<1),this.height-this.textPadding.vert()-(h<<1),this.angle)},measureText:function(t,e){return e&&(e=e.replace(/ /g,"&nbsp;")),AbGraphics.canvas.measureText(t,this.style.text.lineHeight,this,e)},analysis:function(t,e,i){i||(i={}),i.maxWidth&&(i.maxWidth=Math.round(i.maxWidth));for(var s=e.split("\n"),n=s.length,r=[],a=0,o=0,h=0;h<n;h++){for(var l=s[h],c=l.split(/\s{1}/g),u=c.length,d="",p=0,g=[],f=0,m=0;m<u;m++){var b=d+(p?" ":"")+c[m],y=t.measureText(b).width;if(p++,i.maxWidth&&y>i.maxWidth&&m>0){(0==a||a<f)&&(a=f);var v=this.measureText(t,d);o+=v.height,r.push({end:!1,text:d,words:g.splice(0,g.length),width:f,height:v.height,size:v}),d=c[m],g.push({word:c[m],width:t.measureText(c[m]).width})}else d=b,g.push({word:c[m],width:t.measureText(c[m]).width});f=y}if(p>0){var y=t.measureText(d).width;(0==a||a<y)&&(a=y);var v=this.measureText(t,d?d:" ");o+=v.height,r.push({end:!0,text:d,words:g.splice(0,g.length),width:y,height:v.height,size:v})}}return{width:a,height:o,lines:r}},wrapMeasureText:function(t,e,i){return this.analysis(t,e,i)},wrapText:function(t,e,i,s){s||(s={}),s.scaleX||(s.scaleX=1),s.align||(s.align="left"),s.maxWidth&&(s.maxWidth=Math.round(s.maxWidth));for(var n=this.analysis(t,e,s),r=n.lines.length,a=i.x,o=i.y,h=0,l=null,c=0,u=0,d=0,p=!1,g=0;g<r;g++){switch(l=n.lines[g],totanLen=0,p=!1,s.align){case"center":a=i.width-l.width>>1;break;case"right":a=i.width-l.width;break;case"justify":if(!l.end){p=!0,d=u=l.words.length,c=0;for(var f=0;f<u;f++)c+=l.words[f].width;for(var f=u-1;f>=0&&""===l.words[f].word;f--,d--)c-=l.words[f].width;break}default:a=i.x}h=l.height-l.size.contentHeight>>1;var m=l.width,b=l.size.contentHeight;if(p){m=i.x,a=m;for(var y=d>1?(i.width-c)/(d-1):0,f=0;f<d;f++)t.fillText(l.words[f].word,m,o+h),m+=l.words[f].width+y;m-=y}else t.fillText(l.text,a,o+h);s.under!==!0&&s.cancel!==!0||(t.lineWidth=1,t.beginPath(),s.cancel===!0&&(t.moveTo(a,o+h+(b>>1)),t.lineTo(a+m,o+h+(b>>1))),s.under===!0&&(t.moveTo(a,o+h+b),t.lineTo(a+m,o+h+b)),t.stroke(),t.closePath()),o+=l.height}},setTextSyle:function(t){var e=this.style.text,i=[],s="";e.italic&&i.push("italic"),e.bold&&i.push("700"),e.size&&(s+=e.size),s&&i.push(s),e.font&&i.push(e.font);var n=this.engine.currentPage.scale,r=i.join(" ");t.lineWidth=1,t.fillStyle=e.color,t.strokeStyle=e.color,t.font=r,t.scale(n.x,n.y),t.textBaseline="top"},draw:function(t,e,i){var s=e?e.scale.x:1,n=e?e.scale.y:1;AbShapeTool.beginRectDraw(this,t,e);var r=this.width*s,a=this.height*n;if(this.style.color&&(t.fillStyle=this.style.color,t.fillRect(0,0,r,a)),this.style.stroke.width&&this.style.stroke.color){t.strokeStyle=this.style.stroke.color,t.lineWidth=this.style.stroke.width;var o=this.style.stroke.width,h=o/2;t.strokeRect(h,h,r-o,a-o)}var l=this.getStrokeWidth(),c=this.textPadding,u=l<<1,d=c.horiz(),p=c.vert();this.setTextSyle(t);var g={x:c.left+l,y:c.top+l,width:this.width-u-d,height:this.height-u-p};this.textEditMode||this.wrapText(t,this.text,g,{maxWidth:this.width-d-u,align:this.style.text.align,under:this.style.text.under,cancel:this.style.text.cancel}),AbShapeTool.endDraw(this,t)}},AbShapeEllipse.prototype={constructor:AbShapeEllipse,styleDesc:function(){return{select:["color","stroke.width"],descs:[{name:"color",text:"채우기색상",style:"color"},{name:"stroke",text:"선 스타일",childs:[{name:"width",text:"두께",style:"select",type:"number",values:"lineWidth"},{name:"color",text:"색상",style:"color",alpha:!1,notset:!1}]}]}},prepare:function(){this.style.color?this.points.splice(0,this.points.length):this.path(this.points,this.width,this.height)},reset:function(){},serialize:function(){var t=new AbShapeSerializer;t.add("name",this.name),t.add("type",this.type),t.add("shapeType",this.shapeType),t.add("shapeStyle",this.shapeStyle),t.add("token",this.token),t.add("angle",this.angle),t.add("x",Math.round(this.x)),t.add("y",Math.round(this.y)),t.add("width",Math.round(this.width)),t.add("height",Math.round(this.height));var e=t.addGroup("style");if(t.add(e,"color",this.style.color),this.style.stroke){var i=t.addGroup(e,"stroke");t.add(i,"width",this.style.stroke.width),t.add(i,"color",this.style.stroke.color)}return t.serialize()},notify:function(t){"styled"==t&&this.prepare()},setAngle:function(t){this.angle=t},move:function(t,e,i){i===!0?(this.x+=t,this.y+=e):(this.x=t,this.y=e)},rect:function(){if(4!=arguments.length)return{x1:this.x,y1:this.y,x2:this.x+this.width,y2:this.y+this.height};var t=AbGraphics.box.rect(arguments[0],arguments[1],arguments[2],arguments[3]),e=t.width!=this.width||t.height!=this.height;this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,e&&this.prepare()},box:function(){if(4!=arguments.length)return{x:this.x,y:this.y,width:this.width,height:this.height};var t=arguments[2]!=this.width||arguments[3]!=this.height;this.x=arguments[0],this.y=arguments[1],this.width=arguments[2],this.height=arguments[3],t&&this.prepare()},center:function(){return{x:this.x+(this.width>>1),y:this.y+(this.height>>1)}},minimum:function(){return{width:10,height:10}},padding:function(){return{left:0,top:0,right:0,bottom:0}},contains:function(t,e,i,s){if(arguments.length<4){var n=this.engine.selectionStyle(this.name);return"box"===n?this.indicator.contains.apply(this.indicator,arguments):this.style.color?this.hitTest(t,e,i):this.hitTestSkeleton(t,e,i)}return this.indicator.contains.apply(this.indicator,arguments)},editable:function(t,e){return this.selected?this.indicator.editable(t,e):null},editPos:function(t){return this.indicator.editPos(t)},resize:function(t,e,i){return this.indicator.resize(t,e,i)},measure:function(){},hitTest:function(t,e,i){var s=this.engine.currentPage,n=this.box(),r=this.padding();n=AbGraphics.box.inflate(n.x,n.y,n.width,n.height,r),n=s.toCanvasBox(n);var a=s.toCanvas(t,e);t=a.x,e=a.y;var o=n.x+(n.width>>1),h=n.y+(n.height>>1);if(this.angle){var l=AbGraphics.angle.point(-this.angle,o,h,t,e);t=l.x,e=l.y}var c=o-t,u=h-e,l=c*c/(n.width*n.width)+u*u/(n.height*n.height);return l<=.25},hitTestSkeleton:function(t,e,i){var s=this.engine.currentPage,n=this.box(),r=this.padding();n=AbGraphics.box.inflate(n.x,n.y,n.width,n.height,r),n=s.toCanvasBox(n);var a=s.toCanvas(t,e);if(t=a.x,e=a.y,this.angle){var o=n.x+(n.width>>1),h=n.y+(n.height>>1),l=AbGraphics.angle.point(-this.angle,o,h,t,e);t=l.x,e=l.y}for(var c=s.scale.x,u=s.scale.y,d=this.points.length,p=1;p<d;p++){var g=n.x+this.points[p-1].x*c,f=n.y+this.points[p-1].y*u,m=n.x+this.points[p].x*c,b=n.y+this.points[p].y*u,y=AbGraphics.distance(g,f,m,b),v=AbGraphics.distance(g,f,t,e),x=AbGraphics.distance(t,e,m,b),l=Math.abs(y-(v+x));if(l<.3)return!0}return!1},path:function(t,e,i,s){var n=0,r=0,a=e/2*AbGraphics.curve.KAPPA,o=i/2*AbGraphics.curve.KAPPA,h=n+e,l=r+i,c=n+e/2,u=r+i/2;t.splice(0,t.length),AbGraphics.curve.path(t,n,u,n,u-o,c-a,r,c,r),AbGraphics.curve.path(t,c,r,c+a,r,h,u-o,h,u),AbGraphics.curve.path(t,h,u,h,u+o,c+a,l,c,l),AbGraphics.curve.path(t,c,l,c-a,l,n,u+o,n,u)},ellipse:function(t,e,i,s,n){var r=s/2*AbGraphics.curve.KAPPA,a=n/2*AbGraphics.curve.KAPPA,o=e+s,h=i+n,l=e+s/2,c=i+n/2;t.moveTo(e,c),t.bezierCurveTo(e,c-a,l-r,i,l,i),t.bezierCurveTo(l+r,i,o,c-a,o,c),t.bezierCurveTo(o,c+a,l+r,h,l,h),t.bezierCurveTo(l-r,h,e,c+a,e,c)},restoreMinimumSize:function(){var t=!1,e=0;return this.style.stroke&&(t=this.style.stroke&&this.style.stroke.width&&this.style.stroke.color,e=this.style.stroke.width),{width:t?e:0,height:t?e:0}},draw:function(t,e,i){var s=e?e.scale.x:1,n=e?e.scale.y:1,r=this.width*s,a=this.height*n;if(AbShapeTool.beginRectDraw(this,t,e),this.style.color&&(t.fillStyle=this.style.color,t.beginPath(),this.ellipse(t,0,0,r,a),t.fill(),t.closePath()),this.style.stroke&&this.style.stroke.width&&this.style.stroke.color){t.strokeStyle=this.style.stroke.color,t.lineWidth=this.style.stroke.width;var o=this.style.stroke.width,h=o/2;t.beginPath(),this.ellipse(t,h,h,r-o,a-o),t.stroke(),t.closePath()}AbShapeTool.endDraw(this,t)}},AbShapeLine.prototype={constructor:AbShapeLine,styleDesc:function(){return{descs:[{name:"width",text:"두께",style:"text",type:"number-unit",range:{start:1}},{name:"color",text:"색상",style:"color",notset:!1},{name:"dots",text:"무늬",style:"select",values:"dots"}]}},prepare:function(){var t=this.center();this.angle=AbGraphics.angle.toShapeAngle(AbGraphics.angle.get(t.x,t.y,this.x2,this.y2))},reset:function(){},serialize:function(){var t=new AbShapeSerializer;t.add("name",this.name),t.add("type",this.type),t.add("shapeType",this.shapeType),t.add("shapeStyle",this.shapeStyle),t.add("token",this.token),t.add("angle",this.angle),t.add("x1",Math.round(this.x1)),t.add("y1",Math.round(this.y1)),t.add("x2",Math.round(this.x2)),t.add("y2",Math.round(this.y2));var e=t.addGroup("style");return t.add(e,"color",this.style.color),t.add(e,"width",this.style.width),t.add(e,"dots",this.style.dots),t.serialize()},notify:function(t){},setAngle:function(t){var e=t-this.angle;this.angle=t;var i=this.center(),s=AbGraphics.angle.point(e,i.x,i.y,this.x1,this.y1);this.x1=s.x,this.y1=s.y,s=AbGraphics.angle.point(e,i.x,i.y,this.x2,this.y2),this.x2=s.x,this.y2=s.y},move:function(t,e,i){i||(t-=this.x1,e-=this.y1),this.x1+=t,this.y1+=e,this.x2+=t,this.y2+=e},rect:function(){if(4!=arguments.length)return{x1:this.x1,y1:this.y1,x2:this.x2,y2:this.y2};var t=arguments[0],e=arguments[1],i=arguments[2],s=arguments[3];this.x1=t,this.y1=e,this.x2=i,this.y2=s;var n=this.center();this.angle=AbGraphics.angle.toShapeAngle(AbGraphics.angle.get(n.x,n.y,this.x2,this.y2))},box:function(){if(4!=arguments.length)return AbGraphics.box.rect(this.x1,this.y1,this.x2,this.y2);var t=arguments[0],e=arguments[1],i=arguments[2],s=arguments[3];this.x1=t,this.y1=e,this.x2=this.x1+i,this.y2=this.y1+s;var n=this.center();this.angle=AbGraphics.angle.toShapeAngle(AbGraphics.angle.get(n.x,n.y,this.x2,this.y2))},center:function(){return{x:this.x1+(this.x2-this.x1)/2,y:this.y1+(this.y2-this.y1)/2}},padding:function(){var t=this.engine?this.engine.currentPage:null,e=t?t.scale.x:1,i=(t?t.scale.y:1,this.style.width/2*e);return{left:0,top:i,right:0,bottom:i}},contains:function(t,e,i,s){return this.indicator.contains.apply(this.indicator,arguments)},editable:function(t,e){return this.selected?this.indicator.editable(t,e):null},editPos:function(t){return this.indicator.editPos(t)},resize:function(t,e,i){return this.indicator.resize(t,e,i)},measure:function(){this.indicator.selectionStyle=this.engine.selectionStyle(this.name),this.indicator.selectionDrawStyle=this.engine.config("shape.selection.lineDrawStyle")},draw:function(t,e,i){var s=e?e.scale.x:1,n=e?e.scale.y:1;t.save();var r=this.x1*s,a=this.y1*n,o=this.x2*s,h=this.y2*n,l=this.style.width*s;l<1&&(l=1);var c=(AbGraphics.distance(r,a,o,h),o-r>>1),u=h-a>>1;t.translate(r+c,a+u);var d=r+c,p=a+u;AbGraphics.angle.radian90(r,a,o,h);if(t.fillStyle=this.style.color,t.strokeStyle=this.style.color,t.lineWidth=l,t.lineCap="butt",r-=d,a-=p,o-=d,h-=p,this.style.dots){var g=AbGraphics.canvas.makeDash(this.style.dots);if(g&&g.length)for(var f=g.length,m=0;m<f;m++)g[m]=g[m]*s;g.length&&t.setLineDash(g)}t.beginPath(),t.moveTo(Math.round(r),Math.round(a)),t.lineTo(Math.round(o),Math.round(h)),t.stroke(),t.closePath();var r,a,o,h;AbShapeTool.endDraw(this,t)}},AbShapeArrow.prototype={constructor:AbShapeArrow,BRACKET_SIZE:.4,arrowStyle:function(t,e){if(!t)return e;switch(t){case"triangle":case"diamond":case"circle":case"bracket":case"none":return t}return e},styleDesc:function(){return{descs:[{name:"width",text:"두께",style:"text",type:"number-unit",range:{start:1}},{name:"color",text:"색상",style:"color",notset:!1},{name:"dots",text:"무늬",style:"select",values:"dots"},{name:"head",text:"머리",childs:[{name:"size",text:"크기",style:"text",type:"number",range:{start:8,end:30}},{name:"style",text:"스타일",style:"select",values:"arrow"}]},{name:"tail",text:"꼬리",childs:[{name:"size",text:"크기",style:"text",type:"number",range:{start:8,end:30}},{name:"style",text:"스타일",style:"select",values:"arrow"}]}]}},prepare:function(){var t=this.center();this.angle=AbGraphics.angle.toShapeAngle(AbGraphics.angle.get(t.x,t.y,this.x2,this.y2))},reset:function(){},serialize:function(){var t=new AbShapeSerializer;t.add("name",this.name),t.add("type",this.type),t.add("shapeType",this.shapeType),t.add("shapeStyle",this.shapeStyle),t.add("token",this.token),t.add("angle",this.angle),t.add("x1",this.round(this.x1)),t.add("y1",this.round(this.y1)),t.add("x2",this.round(this.x2)),t.add("y2",this.round(this.y2));var e=t.addGroup("style");t.add(e,"color",this.style.color),t.add(e,"width",this.style.width),t.add(e,"dots",this.style.dots);var i=t.addGroup(e,"head");t.add(i,"size",this.style.head.size),t.add(i,"style",this.style.head.type);var s=t.addGroup(e,"tail");return t.add(s,"size",this.style.tail.size),t.add(s,"style",this.style.tail.style),t.serialize()},notify:function(t){},setAngle:function(t){var e=t-this.angle;this.angle=t;var i=this.center(),s=AbGraphics.angle.point(e,i.x,i.y,this.x1,this.y1);this.x1=s.x,this.y1=s.y,s=AbGraphics.angle.point(e,i.x,i.y,this.x2,this.y2),this.x2=s.x,this.y2=s.y},move:function(t,e,i){i||(t-=this.x1,e-=this.y1),this.x1+=t,this.y1+=e,this.x2+=t,this.y2+=e},rect:function(){if(4!=arguments.length)return{x1:this.x1,y1:this.y1,x2:this.x2,y2:this.y2};var t=arguments[0],e=arguments[1],i=arguments[2],s=arguments[3];this.x1=t,this.y1=e,this.x2=i,this.y2=s;var n=this.center();this.angle=AbGraphics.angle.toShapeAngle(AbGraphics.angle.get(n.x,n.y,this.x2,this.y2))},box:function(){if(4!=arguments.length)return AbGraphics.box.rect(this.x1,this.y1,this.x2,this.y2);var t=arguments[0],e=arguments[1],i=arguments[2],s=arguments[3];this.x1=t,this.y1=e,this.x2=this.x1+i,this.y2=this.y1+s;var n=this.center();this.angle=AbGraphics.angle.toShapeAngle(AbGraphics.angle.get(n.x,n.y,this.x2,this.y2))},center:function(){return{x:this.x1+(this.x2-this.x1)/2,y:this.y1+(this.y2-this.y1)/2}},restoreMinimumSize:function(){var t=this.controlSize()<<1;return{width:t,height:t}},padding:function(){var t=this.controlSize()/2;return{left:0,top:t,right:0,bottom:t}},contains:function(t,e,i,s){return this.indicator.contains.apply(this.indicator,arguments)},editable:function(t,e){return this.selected?this.indicator.editable(t,e):null;
},editPos:function(t){return this.indicator.editPos(t)},resize:function(t,e,i){return this.indicator.resize(t,e,i)},measure:function(){this.indicator.selectionStyle=this.engine.selectionStyle(this.name),this.indicator.selectionDrawStyle=this.engine.config("shape.selection.lineDrawStyle")},headSize:function(){return"none"!=this.style.head.type?this.style.head.size:0},tailSize:function(){return"none"!=this.style.tail.type?this.style.tail.size:0},controlSize:function(){var t=this.engine?this.engine.currentPage:null,e=t?t.scale.x:1,i=(t?t.scale.y:1,this.style.width),s=this.headSize();s&&(s+=i);var n=this.tailSize();return n&&(n+=i),Math.max(s,n)*e},round:function(t){return Math.round(t)},clipHeadArrow:function(t,e){var i=e.style,s=e.size?e.size/2:0,n=[];if("triangle"===i||"bracket"===i){var r=AbGraphics.rotate.point(e.rad,e.x,e.y,e.x-e.size,e.y-s),a=AbGraphics.rotate.point(e.rad,e.x,e.y,e.x,e.y),o=AbGraphics.rotate.point(e.rad,e.x,e.y,e.x-e.size,e.y+s),h=AbGraphics.intersects.lines(r.x,r.y,a.x,a.y,e.lineCorners.leftTop.x,e.lineCorners.leftTop.y,e.lineCorners.rightTop.x,e.lineCorners.rightTop.y),l=AbGraphics.intersects.lines(a.x,a.y,o.x,o.y,e.lineCorners.leftBottom.x,e.lineCorners.leftBottom.y,e.lineCorners.rightBottom.x,e.lineCorners.rightBottom.y);n.push(h),n.push(a),n.push(l)}else if("diamond"===i||"circle"===i){var r=AbGraphics.rotate.point(e.rad,e.lineCorners.rightTop.x,e.lineCorners.rightTop.y,e.lineCorners.rightTop.x-s,e.lineCorners.rightTop.y),a=AbGraphics.rotate.point(e.rad,e.lineCorners.rightBottom.x,e.lineCorners.rightBottom.y,e.lineCorners.rightBottom.x-s,e.lineCorners.rightBottom.y);n.push(r),n.push(a)}else n.push(e.lineCorners.rightTop),n.push(e.lineCorners.rightBottom);return n},clipTailArrow:function(t,e){var i=e.style,s=e.size?e.size/2:0,n=[];if("triangle"===i||"bracket"===i){var r=AbGraphics.rotate.point(e.rad,e.x,e.y,e.x+e.size,e.y-s),a=AbGraphics.rotate.point(e.rad,e.x,e.y,e.x,e.y),o=AbGraphics.rotate.point(e.rad,e.x,e.y,e.x+e.size,e.y+s),h=AbGraphics.intersects.lines(r.x,r.y,a.x,a.y,e.lineCorners.leftTop.x,e.lineCorners.leftTop.y,e.lineCorners.rightTop.x,e.lineCorners.rightTop.y),l=AbGraphics.intersects.lines(a.x,a.y,o.x,o.y,e.lineCorners.leftBottom.x,e.lineCorners.leftBottom.y,e.lineCorners.rightBottom.x,e.lineCorners.rightBottom.y);n.push(l),n.push(a),n.push(h)}else if("diamond"===i||"circle"===i){var r=AbGraphics.rotate.point(e.rad,e.lineCorners.leftTop.x,e.lineCorners.leftTop.y,e.lineCorners.leftTop.x+s,e.lineCorners.leftTop.y),a=AbGraphics.rotate.point(e.rad,e.lineCorners.leftBottom.x,e.lineCorners.leftBottom.y,e.lineCorners.leftBottom.x+s,e.lineCorners.leftBottom.y);n.push(a),n.push(r)}else n.push(e.lineCorners.leftBottom),n.push(e.lineCorners.leftTop);return n},drawHeadArrow:function(t,e){var i=e.style,s=e.size?e.size/2:0;if("triangle"===i){var n=AbGraphics.rotate.point(e.rad,e.x,e.y,e.x-e.size,e.y-s),r=AbGraphics.rotate.point(e.rad,e.x,e.y,e.x,e.y),a=AbGraphics.rotate.point(e.rad,e.x,e.y,e.x-e.size,e.y+s);return t.moveTo(this.round(e.x),this.round(e.y)),t.lineTo(this.round(n.x),this.round(n.y)),t.lineTo(this.round(r.x),this.round(r.y)),t.lineTo(this.round(a.x),this.round(a.y)),t.lineTo(this.round(n.x),this.round(n.y)),{full:AbGraphics.rotate.pointByDistance(e.rad,e.size),half:AbGraphics.rotate.pointByDistance(e.rad,s)}}if("diamond"===i){var n=AbGraphics.rotate.point(e.rad,e.x,e.y,e.x-e.size,e.y),r=AbGraphics.rotate.point(e.rad,e.x,e.y,e.x-s,e.y-s),a=AbGraphics.rotate.point(e.rad,e.x,e.y,e.x,e.y),o=AbGraphics.rotate.point(e.rad,e.x,e.y,e.x-s,e.y+s);return t.moveTo(this.round(n.x),this.round(n.y)),t.lineTo(this.round(r.x),this.round(r.y)),t.lineTo(this.round(a.x),this.round(a.y)),t.lineTo(this.round(o.x),this.round(o.y)),t.lineTo(this.round(n.x),this.round(n.y)),{full:AbGraphics.rotate.pointByDistance(e.rad,e.size),half:AbGraphics.rotate.pointByDistance(e.rad,s)}}if("circle"===i){var n=AbGraphics.rotate.point(e.rad,e.x,e.y,e.x-s,e.y);return t.moveTo(this.round(n.x+s),this.round(n.y)),t.arc(this.round(n.x),this.round(n.y),s,0,360),{full:AbGraphics.rotate.pointByDistance(e.rad,e.size),half:AbGraphics.rotate.pointByDistance(e.rad,s)}}if("bracket"===i){var n=AbGraphics.rotate.point(e.rad,e.x,e.y,e.x-e.size,e.y-s),r=AbGraphics.rotate.point(e.rad,e.x,e.y,e.x,e.y),a=AbGraphics.rotate.point(e.rad,e.x,e.y,e.x-e.size,e.y+s),o=AbGraphics.rotate.point(e.rad,e.x,e.y,e.x-e.size*AbShapeArrow.prototype.BRACKET_SIZE,e.y);return t.moveTo(this.round(e.x),this.round(e.y)),t.lineTo(this.round(n.x),this.round(n.y)),t.lineTo(this.round(r.x),this.round(r.y)),t.lineTo(this.round(a.x),this.round(a.y)),t.lineTo(this.round(o.x),this.round(o.y)),t.lineTo(this.round(n.x),this.round(n.y)),{full:AbGraphics.rotate.pointByDistance(e.rad,e.size),half:AbGraphics.rotate.pointByDistance(e.rad,e.size*AbShapeArrow.prototype.BRACKET_SIZE)}}return{clip:{x:0,y:0},full:{x:0,y:0},half:{x:0,y:0}}},drawTailArrow:function(t,e){var i=e.style,s=e.size?e.size/2:0;if("triangle"===i){var n=AbGraphics.rotate.point(e.rad,e.x,e.y,e.x+e.size,e.y-s),r=AbGraphics.rotate.point(e.rad,e.x,e.y,e.x,e.y),a=AbGraphics.rotate.point(e.rad,e.x,e.y,e.x+e.size,e.y+s);return t.moveTo(this.round(e.x),this.round(e.y)),t.lineTo(this.round(n.x),this.round(n.y)),t.lineTo(this.round(r.x),this.round(r.y)),t.lineTo(this.round(a.x),this.round(a.y)),t.lineTo(this.round(n.x),this.round(n.y)),{full:AbGraphics.rotate.pointByDistance(e.rad,e.size),half:AbGraphics.rotate.pointByDistance(e.rad,s)}}if("diamond"===i){var n=AbGraphics.rotate.point(e.rad,e.x,e.y,e.x+e.size,e.y),r=AbGraphics.rotate.point(e.rad,e.x,e.y,e.x+s,e.y-s),a=AbGraphics.rotate.point(e.rad,e.x,e.y,e.x,e.y),o=AbGraphics.rotate.point(e.rad,e.x,e.y,e.x+s,e.y+s);return t.moveTo(this.round(n.x),this.round(n.y)),t.lineTo(this.round(r.x),this.round(r.y)),t.lineTo(this.round(a.x),this.round(a.y)),t.lineTo(this.round(o.x),this.round(o.y)),t.lineTo(this.round(n.x),this.round(n.y)),{full:AbGraphics.rotate.pointByDistance(e.rad,e.size),half:AbGraphics.rotate.pointByDistance(e.rad,s)}}if("circle"===i){var n=AbGraphics.rotate.point(e.rad,e.x,e.y,e.x+s,e.y);return t.moveTo(this.round(n.x+s),this.round(n.y)),t.arc(this.round(n.x),this.round(n.y),s,0,360),{full:AbGraphics.rotate.pointByDistance(e.rad,e.size),half:AbGraphics.rotate.pointByDistance(e.rad,s)}}if("bracket"===i){var n=AbGraphics.rotate.point(e.rad,e.x,e.y,e.x+e.size,e.y-s),r=AbGraphics.rotate.point(e.rad,e.x,e.y,e.x,e.y),a=AbGraphics.rotate.point(e.rad,e.x,e.y,e.x+e.size,e.y+s),o=AbGraphics.rotate.point(e.rad,e.x,e.y,e.x+e.size*AbShapeArrow.prototype.BRACKET_SIZE,e.y);return t.moveTo(this.round(e.x),this.round(e.y)),t.lineTo(this.round(n.x),this.round(n.y)),t.lineTo(this.round(r.x),this.round(r.y)),t.lineTo(this.round(a.x),this.round(a.y)),t.lineTo(this.round(o.x),this.round(o.y)),t.lineTo(this.round(n.x),this.round(n.y)),{full:AbGraphics.rotate.pointByDistance(e.rad,e.size),half:AbGraphics.rotate.pointByDistance(e.rad,e.size*AbShapeArrow.prototype.BRACKET_SIZE)}}return{clip:{x:0,y:0},full:{x:0,y:0},half:{x:0,y:0}}},corners:function(t,e,i,s,n){var r={x1:t,y1:e,x2:i,y2:s},a=AbGraphics.angle.radian90(r.x1,r.y1,r.x2,r.y2),o=AbGraphics.distance(r.x1,r.y1,r.x2,r.y2),h=AbGraphics.rotate.point(-a,r.x1,r.y1,r.x2,r.y2),l=n/2;t=r.x1,e=r.y1-l,i=h.x,s=h.y+l;var c=AbGraphics.rotate.point(a,r.x1,r.y1,t,e),u=AbGraphics.rotate.point(a,r.x1,r.y1,i,e),d=AbGraphics.rotate.point(a,r.x1,r.y1,i,s),p=AbGraphics.rotate.point(a,r.x1,r.y1,t,s),g=AbGraphics.angle.radian90(c.x,c.y,p.x,p.y);return{thickness:n,distance:o,rad:a,radWide:g,rect:r,leftTop:c,rightTop:u,rightBottom:d,leftBottom:p}},wannaClip:function(){return this.style.width>1},drawLine:function(t,e,i){if(this.wannaClip()){var s=i&&i.length>1?i.length:0;if(s){s-=i.length%2;var n=e.leftTop.x,r=e.leftTop.y,a=0;t.beginPath();for(var o=0;o<e.distance;o+=a){a=0;for(var h=0;h<s;h+=2){var l=i[h],c=i[h+1],u=AbGraphics.rotate.pointByDistance(e.rad,l),d=AbGraphics.rotate.pointByDistance(e.radWide,e.thickness);t.moveTo(this.round(n),this.round(r)),t.lineTo(this.round(n+u.x),this.round(r+u.y)),t.lineTo(this.round(n+u.x+d.x),this.round(r+u.y+d.y)),t.lineTo(this.round(n+d.x),this.round(r+d.y)),t.lineTo(this.round(n),this.round(r)),u=AbGraphics.rotate.pointByDistance(e.rad,l+c),n+=u.x,r+=u.y,a+=l+c}}t.fill(),t.closePath()}else t.beginPath(),t.moveTo(this.round(e.leftTop.x),this.round(e.leftTop.y)),t.lineTo(this.round(e.rightTop.x),this.round(e.rightTop.y)),t.lineTo(this.round(e.rightBottom.x),this.round(e.rightBottom.y)),t.lineTo(this.round(e.leftBottom.x),this.round(e.leftBottom.y)),t.lineTo(this.round(e.leftTop.x),this.round(e.leftTop.y)),t.fill(),t.closePath()}else i&&i.length&&t.setLineDash(i),t.beginPath(),t.moveTo(Math.round(e.rect.x1),Math.round(e.rect.y1)),t.lineTo(Math.round(e.rect.x2),Math.round(e.rect.y2)),t.stroke(),t.closePath()},draw:function(t,e,i){var s=e?e.scale.x:1,n=e?e.scale.y:1;t.save();var r=this.x1*s,a=this.y1*n,o=this.x2*s,h=this.y2*n,l=this.style.width*s,c=this.headSize()*s,u=this.tailSize()*s;l<1&&(l=1);var d=AbGraphics.distance(r,a,o,h),p=o-r>>1,g=h-a>>1;t.translate(r+p,a+g);var f=r+p,m=a+g,b=AbGraphics.angle.radian90(r,a,o,h),y=null,v=null,x=null,w=r,A=a,k=o,C=h;if(this.style.dots&&(x=AbGraphics.canvas.makeDash(this.style.dots),x&&x.length))for(var P=x.length,S=0;S<P;S++)x[S]=x[S]*s;var I={x1:w-f,y1:A-m,x2:k-f,y2:C-m},T=2,M=this.corners(I.x1,I.y1,I.x2,I.y2,l+T);if(this.wannaClip()){t.save(),t.beginPath();var $=[],E=this.clipHeadArrow(t,{lineRect:I,lineCorners:M,distance:d,style:this.style.head.style,size:c+l,lineWidth:l,rad:b,x:k-f,y:C-m}),z=this.clipTailArrow(t,{lineRect:I,lineCorners:M,distance:d,style:this.style.tail.style,size:u+l,lineWidth:l,rad:b,x:w-f,y:A-m});Array.prototype.push.apply($,E),Array.prototype.push.apply($,z);for(var S=0;S<$.length;S++)0==S?t.moveTo(this.round($[S].x),this.round($[S].y)):t.lineTo(this.round($[S].x),this.round($[S].y));t.clip()}var O=this.corners(I.x1,I.y1,I.x2,I.y2,l);t.fillStyle=this.style.color,t.strokeStyle=this.style.color,this.drawLine(t,O,x),this.wannaClip()&&t.restore(),t.fillStyle=this.style.color,t.strokeStyle=this.style.color,t.beginPath(),y=this.drawHeadArrow(t,{distance:d,style:this.style.head.style,size:c+l,lineWidth:l,rad:b,x:k-f,y:C-m}),t.fill(),t.closePath(),t.beginPath(),v=this.drawTailArrow(t,{distance:d,style:this.style.tail.style,size:u+l,lineWidth:l,rad:b,x:w-f,y:A-m}),t.fill(),t.closePath(),AbShapeTool.endDraw(this,t)}},AbShapePen.prototype={constructor:AbShapePen,styleDesc:function(){return{descs:[{name:"width",text:"두께",style:"select",type:"number",values:"lineWidth"},{name:"color",text:"색상",style:"color",notset:!1}]}},prepare:function(){for(var t=this.points.length,e=0;e<t;e++){var i=this.points[e];this.minPointX=0==e||i.x<this.minPointX?i.x:this.minPointX,this.minPointY=0==e||i.y<this.minPointY?i.y:this.minPointY,this.maxPointX=0==e||i.x>this.maxPointX?i.x:this.maxPointX,this.maxPointY=0==e||i.y>this.maxPointY?i.y:this.maxPointY}this.minPointX+=this.x,this.minPointY+=this.y,this.maxPointX+=this.x,this.maxPointY+=this.y},reset:function(){this.points.splice(0,this.points.length),this.minPointX=this.minPointY=this.maxPointX=this.maxPointY=0},serialize:function(){var t=new AbShapeSerializer;t.add("name",this.name),t.add("type",this.type),t.add("shapeType",this.shapeType),t.add("shapeStyle",this.shapeStyle),t.add("token",this.token),t.add("angle",this.angle),t.add("x",Math.round(this.x)),t.add("y",Math.round(this.y)),t.add("width",Math.round(this.width)),t.add("height",Math.round(this.height));var e=t.addGroup("style");return t.add(e,"color",this.style.color),t.add(e,"width",this.style.width),t.add("points",this.points),t.serialize()},notify:function(t){},addPoints:function(t){for(var e=t.length,i=0;i<e;i++)this.addPoint(t[i].x,t[i].y);this.endPoint()},addPoint:function(t,e){var i=this.points.length;this.minPointX=0==i||t<this.minPointX?t:this.minPointX,this.minPointY=0==i||e<this.minPointY?e:this.minPointY,this.maxPointX=0==i||t>this.maxPointX?t:this.maxPointX,this.maxPointY=0==i||e>this.maxPointY?e:this.maxPointY,this.points.push({x:t,y:e}),this.x=this.minPointX,this.y=this.minPointY,this.width=this.maxPointX-this.x,this.height=this.maxPointY-this.y},endPoint:function(){for(var t=this.points.length,e=0;e<t;e++){var i=this.points[e];i.x-=this.minPointX,i.y-=this.minPointY}},setAngle:function(t){this.angle=t},move:function(t,e,i){i===!0?(this.x+=t,this.y+=e):(this.x=t,this.y=e)},hasPointSize:function(){return this.minPointX&&this.minPointY&&this.maxPointX&&this.maxPointY},hasSize:function(){return this.x&&this.y&&this.width&&this.height},rect:function(){if(4!=arguments.length)return{x1:this.x,y1:this.y,x2:this.x+this.width,y2:this.y+this.height};var t=AbGraphics.box.rect(arguments[0],arguments[1],arguments[2],arguments[3]);this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height},box:function(){return 4!=arguments.length?{x:this.x,y:this.y,width:this.width,height:this.height}:(this.x=arguments[0],this.y=arguments[1],this.width=arguments[2],this.height=arguments[3],void 0)},center:function(){return{x:this.x+(this.width>>1),y:this.y+(this.height>>1)}},drawPadding:function(){var t=(this.engine.selectionStyle(this.name),0),e=this.style.width||0;return t=e>0?e/2:0,t<0&&(t=0),{left:t,top:t,right:t,bottom:t}},padding:function(){var t=this.engine.selectionStyle(this.name),e=0;if("box"===t){var i=this.engine?this.engine.currentPage:null,s=i?i.scale.x:1,n=(i?i.scale.y:1,this.style.width||0);e=n>0?n/s/2:0,e<0&&(e=0)}return{left:e,top:e,right:e,bottom:e}},contains:function(t,e,i,s){var n=this.engine.selectionStyle(this.name),r=this.points.length;if("box"===n||arguments.length>=4||r<2)return this.indicator.contains.apply(this.indicator,arguments);var a=this.engine.currentPage,o=this.box(),h=this.padding();o=AbGraphics.box.inflate(o.x,o.y,o.width,o.height,h),o=a.toCanvasBox(o.x,o.y,o.width,o.height);var l=a.toCanvas(t,e);if(t=l.x,e=l.y,this.angle){var c=o.x+(o.width>>1),u=o.y+(o.height>>1),d=AbGraphics.angle.point(-this.angle,c,u,t,e);t=d.x,e=d.y}var p=a.scale.x,g=a.scale.y,d=AbGraphics.box.zoom(this.maxPointX-this.minPointX,this.maxPointY-this.minPointY,this.width,this.height);p*=d.ratioX,g*=d.ratioY;var f=o.x,m=o.y;v=3+(this.style.width||0);for(var r=this.points.length,b=null,y=0;y<r;y++){var x=this.points[y];if(b&&AbGraphics.contains.line(f+Math.round(b.x*p),m+Math.round(b.y*g),f+Math.round(x.x*p),m+Math.round(x.y*g),t,e,v))return!0;b=x}return!1},editable:function(t,e){return this.selected?this.indicator.editable(t,e):null},editPos:function(t){return this.indicator.editPos(t)},resize:function(t,e,i){return this.indicator.resize(t,e,i)},measure:function(){},drawStyle:function(t){t.strokeStyle=this.style.color,t.lineWidth=this.style.width,t.lineJoin="round",t.lineCap="round"},creationDraw:function(t,e,i){var s=e?e.scale.x:1,n=e?e.scale.y:1;this.drawStyle(t),t.beginPath();var r=this.points.length;if(1==r){e.toCanvas(this.points[0].x,this.points[0].y);t.fillStyle=this.style.color,t.arc(this.points[0].x*s,this.points[0].y*n,1,0,360),t.fill()}else{this.drawStyle(t);var a=e.toCanvas(i.prev.x,i.prev.y);e.toCanvas(i.end.x,i.end.y);t.moveTo(i.prev.x*s,i.prev.y*n,a.y),t.lineTo(i.end.x*s,i.end.y*n),t.stroke()}t.closePath()},draw:function(t,e,i){var s=e?e.scale.x:1,n=e?e.scale.y:1;if(i)t.save();else{AbShapeTool.beginRectDraw(this,t,e);var r=AbGraphics.box.zoom(this.maxPointX-this.minPointX,this.maxPointY-this.minPointY,this.width,this.height);s*=r.ratioX,n*=r.ratioY}this.drawStyle(t),t.beginPath();var a=this.points.length;if(1==a){var o=this.points[0];t.fillStyle=this.style.color,t.arc(o.x*s,o.y*n,1,0,360),t.fill()}else{for(var h=0;h<a;h++){var o=this.points[h];h>0?this.points[h-1]:null;0==h?t.moveTo(Math.round(o.x*s),Math.round(o.y*n)):t.lineTo(Math.round(o.x*s),Math.round(o.y*n))}t.stroke()}t.closePath(),AbShapeTool.endDraw(this,t)}},AbShapeStamp.prototype={constructor:AbShapeStamp,styleDesc:function(){return{descs:[{name:"color",text:"채우기색상",style:"color",notset:!1},{name:"text",text:"내용",style:"text",trim:!0,notempty:!0,size:10}]}},prepare:function(){},reset:function(){},serialize:function(){var t=new AbShapeSerializer;t.add("name",this.name),t.add("type",this.type),t.add("shapeType",this.shapeType),t.add("shapeStyle",this.shapeStyle),t.add("token",this.token),t.add("angle",this.angle),t.add("x",Math.round(this.x)),t.add("y",Math.round(this.y)),t.add("width",Math.round(this.width)),t.add("height",Math.round(this.height));var e=t.addGroup("style");return t.add(e,"color",this.style.color),t.add(e,"text",this.style.text),t.serialize()},notify:function(t){},setAngle:function(t){this.angle=t},move:function(t,e,i){i===!0?(this.x+=t,this.y+=e):(this.x=t,this.y=e)},rect:function(){if(4!=arguments.length)return{x1:this.x,y1:this.y,x2:this.x+this.width,y2:this.y+this.height};var t=AbGraphics.box.rect(arguments[0],arguments[1],arguments[2],arguments[3]);this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height},box:function(){return 4!=arguments.length?{x:this.x,y:this.y,width:this.width,height:this.height}:(this.x=arguments[0],this.y=arguments[1],this.width=arguments[2],this.height=arguments[3],void 0)},center:function(){return{x:this.x+(this.width>>1),y:this.y+(this.height>>1)}},minimum:function(){return{width:10,height:10}},padding:function(){return{left:0,top:0,right:0,bottom:0}},contains:function(t,e,i,s){return this.indicator.contains.apply(this.indicator,arguments)},editable:function(t,e){return this.selected?this.indicator.editable(t,e):null},editPos:function(t){return this.indicator.editPos(t)},resize:function(t,e,i){return this.indicator.resize(t,e,i)},measure:function(){},validLineDistance:function(){return this.style.stroke&&this.style.stroke.width?this.style.stroke.width:1},measureText:function(t,e){var i=this.extra.fontSize;return t.font=this.extra.fontWeight+" "+i+"px "+this.extra.font,t.textBaseline="alphabetic",{width:t.measureText(e).width,height:i*this.extra.lineHeight}},drawStamp:function(t,e,i,s,n){var r=this.style.text;t.save();var a=this.extra.borderWidth,o=a/2,h=this.textPadding.left,l=this.textPadding.right,c=this.textPadding.top,u=this.textPadding.bottom,d=o+h,p=o+c,g=a+(h+l),f=a+(c+u),m=this.measureText(t,r),b=m.width,y=m.height,v=AbGraphics.box.zoom(b+g,y+f,s,n),x=v.ratioX,w=v.ratioY,A=this.extra.fontSize,k=this.extra.lineHeight,C=this.extra.fontSizeFraction,y=A*k;t.translate(e,i),t.scale(x,w),t.lineWidth=a,t.strokeRect(o,o,s/x-a,n/w-a),t.translate(d,p);var P=0,S=0;S+=y,S-=y*C,t.translate(P,S),t.fillText(r,0,0),t.restore()},draw:function(t,e,i){var s=e?e.scale.x:1;AbShapeTool.beginRectDraw(this,t,e),t.fillStyle=this.style.color,t.strokeStyle=this.style.color,t.scale(s,s),this.drawStamp(t,0,0,this.width,this.height),AbShapeTool.endDraw(this,t)}},AbShapeHighlightPen.prototype={constructor:AbShapeHighlightPen,styleDesc:function(){return{descs:[{name:"width",text:"폭",style:"text",type:"number",range:{start:3,end:20}},{name:"height",text:"높이",style:"text",type:"number",range:{start:3,end:40}},{name:"alpha",text:"투명도",style:"text",type:"number",unit:"%",range:{start:0,end:100}},{name:"color",text:"색상",style:"color",notset:!1}]}},prepare:function(){this.path.splice(0,this.path.length);var t=this.style.width>>1,e=this.style.height>>1,i=this.points.length,s=null;if(1==i){var n=this.points[0];this.addSinglePath(this.path,n.x,n.y,t,e),this.minPointX=this.maxPointX=n.x,this.minPointY=this.maxPointY=n.y}else for(var r=0;r<i;r++){var n=this.points[r];this.minPointX=0==r||n.x<this.minPointX?n.x:this.minPointX,this.minPointY=0==r||n.y<this.minPointY?n.y:this.minPointY,this.maxPointX=0==r||n.x>this.maxPointX?n.x:this.maxPointX,this.maxPointY=0==r||n.y>this.maxPointY?n.y:this.maxPointY,s&&this.addPath(this.path,s.x,s.y,n.x,n.y,t,e),s=n}this.minPointX+=this.x,this.minPointY+=this.y,this.maxPointX+=this.x,this.maxPointY+=this.y},reset:function(){this.path.splice(0,this.path.length),this.points.splice(0,this.points.length),this.minPointX=this.minPointY=this.maxPointX=this.maxPointY=0},serialize:function(){var t=new AbShapeSerializer;t.add("name",this.name),t.add("type",this.type),t.add("shapeType",this.shapeType),t.add("shapeStyle",this.shapeStyle),t.add("token",this.token),t.add("angle",this.angle),t.add("x",Math.round(this.x)),t.add("y",Math.round(this.y)),t.add("width",Math.round(this.width)),t.add("height",Math.round(this.height));var e=t.addGroup("style");return t.add(e,"color",this.style.color),t.add(e,"width",this.style.width),t.add(e,"height",this.style.height),t.add(e,"alpha",this.style.alpha),t.add("points",this.points),t.serialize()},notify:function(t){"styled"==t&&this.prepare()},addPoints:function(t){for(var e=t.length,i=0;i<e;i++)this.addPoint(t[i]);this.endPoint()},addPoint:function(t,e){var i=this.points.length;this.minPointX=0==i||t<this.minPointX?t:this.minPointX,this.minPointY=0==i||e<this.minPointY?e:this.minPointY,this.maxPointX=0==i||t>this.maxPointX?t:this.maxPointX,this.maxPointY=0==i||e>this.maxPointY?e:this.maxPointY,this.points.push({x:t,y:e});var s=this.style.width>>1,n=this.style.height>>1;this.x=this.minPointX-s,this.y=this.minPointY-n,this.width=this.maxPointX+s-this.x,this.height=this.maxPointY+n-this.y},endPoint:function(){var t=this.style.width>>1,e=this.style.height>>1,i=this.points.length,s=null;if(1==i){var n=this.points[0];n.x-=this.minPointX,n.y-=this.minPointY,this.addSinglePath(this.path,n.x,n.y,t,e)}else for(var r=0;r<i;r++){var n=this.points[r];n.x-=this.minPointX,n.y-=this.minPointY,s&&this.addPath(this.path,s.x,s.y,n.x,n.y,t,e),s=n}},setAngle:function(t){this.angle=t},move:function(t,e,i){i===!0?(this.x+=t,this.y+=e):(this.x=t,this.y=e)},hasPointSize:function(){return this.minPointX&&this.minPointY&&this.maxPointX&&this.maxPointY},hasSize:function(){return this.x&&this.y&&this.width&&this.height},rect:function(){if(4!=arguments.length)return{x1:this.x,y1:this.y,x2:this.x+this.width,y2:this.y+this.height};var t=AbGraphics.box.rect(arguments[0],arguments[1],arguments[2],arguments[3]);this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height},box:function(){return 4!=arguments.length?{x:this.x,y:this.y,width:this.width,height:this.height}:(this.x=arguments[0],this.y=arguments[1],this.width=arguments[2],this.height=arguments[3],void 0)},center:function(){return{x:this.x+(this.width>>1),y:this.y+(this.height>>1)}},creationMinimum:function(){return{width:0,height:0}},minimum:function(){var t=this.style.width>>1,e=this.style.height>>1;return{width:.1*(this.maxPointX+t-(this.minPointX-t)),height:.1*(this.maxPointY+e-(this.minPointY-e))}},padding:function(){return{left:0,top:0,right:0,bottom:0}},contains:function(t,e,i){var s=this.engine.selectionStyle(this.name);if("box"===s||arguments.length>=4)return this.indicator.contains.apply(this.indicator,arguments);var n=this.style.width>>1,r=this.style.height>>1,a=this.engine.currentPage,o=a.scale.x,h=a.scale.y,l=0,c=0,u=!1,d=AbGraphics.box.zoom(this.maxPointX+n-(this.minPointX-n),this.maxPointY+r-(this.minPointY-r),this.width,this.height);1==d.ratioX&&1==d.ratioY||(l=n*o,c=r*h,l=l*d.ratioX-l,c=c*d.ratioY-c,u=AbShapeHighlightPen.CORRECT_WEIGHT);var p=this.box(),g=this.padding();p=AbGraphics.box.inflate(p.x,p.y,p.width,p.height,g),p=a.toCanvasBox(p.x,p.y,p.width,p.height);var f=a.toCanvas(t,e);if(t=f.x,e=f.y,this.angle){var m=p.x+(p.width>>1),b=p.y+(p.height>>1),y=AbGraphics.angle.point(-this.angle,m,b,t,e);t=y.x,e=y.y}t=Math.round(t),e=Math.round(e);for(var v=0,x=0,f=a.toCanvas(this.x+n,this.y+r),w=Math.round(f.x)+l,A=Math.round(f.y)+c,k=[],C=this.path.length,P=0;P<C;P++){var S=this.path[P];if(u&&(v="+"==S.horiz?-l:l,x="+"==S.vert?-c:c),S.move){if(k.length>0&&AbGraphics.contains.polygon(k,t,e))return!0;k.splice(0,k.length),S={x:S.x*d.ratioX*o+v,y:S.y*d.ratioY*h+x},S.x=w+Math.round(S.x),S.y=A+Math.round(S.y),k.push(S)}else S={x:S.x*d.ratioX*o+v,y:S.y*d.ratioY*h+x},S.x=w+Math.round(S.x),S.y=A+Math.round(S.y),k.push(S)}return k.length>0&&AbGraphics.contains.polygon(k,t,e)},editable:function(t,e){return this.selected?this.indicator.editable(t,e):null},editPos:function(t){return this.indicator.editPos(t)},resize:function(t,e,i){return this.indicator.resize(t,e,i)},measure:function(){},drawStyle:function(t){t.fillStyle=this.style.color,t.lineJoin="round",t.globalAlpha=this.style.alpha},addSinglePath:function(t,e,i,s,n){this.path.push({x:e-s,y:i-n,move:!0,horiz:"-",vert:"-"}),this.path.push({x:e+s,y:i-n,horiz:"+",vert:"-"}),this.path.push({x:e+s,y:i+n,horiz:"+",vert:"+"}),this.path.push({x:e-s,y:i+n,horiz:"-",vert:"+"})},addPath:function(t,e,i,s,n,r,a){var o=s-e,h=n-i;o>0&&h<0?(t.push({x:e-r,y:i-a,move:!0,horiz:"-",vert:"-"}),t.push({x:s-r,y:n-a,horiz:"-",vert:"-"}),t.push({x:s+r,y:n-a,horiz:"+",vert:"-"}),t.push({x:s+r,y:n+a,horiz:"+",vert:"+"}),t.push({x:e+r,y:i+a,horiz:"+",vert:"+"}),t.push({x:e-r,y:i+a,horiz:"-",vert:"+"}),t.push({x:e-r,y:i-a,horiz:"-",vert:"-"})):o>0&&0==h?(t.push({x:e-r,y:i-a,move:!0,horiz:"-",vert:"-"}),t.push({x:s+r,y:n-a,horiz:"+",vert:"-"}),t.push({x:s+r,y:n+a,horiz:"+",vert:"+"}),t.push({x:e-r,y:i+a,horiz:"-",vert:"+"}),t.push({x:e-r,y:i-a,horiz:"-",vert:"-"})):o>0&&h>0?(t.push({x:e-r,y:i-a,move:!0,horiz:"-",vert:"-"}),t.push({x:e+r,y:i-a,horiz:"+",vert:"-"}),t.push({x:s+r,y:n-a,horiz:"+",vert:"-"}),t.push({x:s+r,y:n+a,horiz:"+",vert:"+"}),t.push({x:s-r,y:n+a,horiz:"-",vert:"+"}),t.push({x:e-r,y:i+a,horiz:"-",vert:"+"}),t.push({x:e-r,y:i-a,horiz:"-",vert:"-"})):0==o&&h>0?(t.push({x:e-r,y:i-a,move:!0,horiz:"-",vert:"-"}),t.push({x:e+r,y:i-a,horiz:"+",vert:"-"}),t.push({x:s+r,y:n+a,horiz:"+",vert:"+"}),t.push({x:s-r,y:n+a,horiz:"-",vert:"+"}),t.push({x:e-r,y:i-a,horiz:"-",vert:"-"})):o<0&&h>0?(t.push({x:e-r,y:i-a,move:!0,horiz:"-",vert:"-"}),t.push({x:e+r,y:i-a,horiz:"+",vert:"-"}),t.push({x:e+r,y:i+a,horiz:"+",vert:"+"}),t.push({x:s+r,y:n+a,horiz:"+",vert:"+"}),t.push({x:s-r,y:n+a,horiz:"-",vert:"+"}),t.push({x:s-r,y:n-a,horiz:"-",vert:"-"}),t.push({x:e-r,y:i-a,horiz:"-",vert:"-"})):o<0&&0==h?(t.push({x:e+r,y:i-a,move:!0,horiz:"+",vert:"-"}),t.push({x:e+r,y:i+a,horiz:"+",vert:"+"}),t.push({x:s-r,y:n+a,horiz:"-",vert:"+"}),t.push({x:s-r,y:n-a,horiz:"-",vert:"-"}),t.push({x:e+r,y:i-a,horiz:"+",vert:"-"})):o<0&&h<0?(t.push({x:e+r,y:i-a,move:!0,horiz:"+",vert:"-"}),t.push({x:e+r,y:i+a,horiz:"+",vert:"+"}),t.push({x:e-r,y:i+a,horiz:"-",vert:"+"}),t.push({x:s-r,y:n+a,horiz:"-",vert:"+"}),t.push({x:s-r,y:n-a,horiz:"-",vert:"-"}),t.push({x:s+r,y:n-a,horiz:"+",vert:"-"}),t.push({x:e+r,y:i-a,horiz:"+",vert:"-"})):0==o&&h<0&&(t.push({x:e+r,y:i-a,move:!0,horiz:"+",vert:"-"}),t.push({x:s+r,y:n+a,horiz:"+",vert:"+"}),t.push({x:s-r,y:n+a,horiz:"-",vert:"+"}),t.push({x:e-r,y:i-a,horiz:"-",vert:"-"}),t.push({x:e+r,y:i-a,horiz:"+",vert:"-"}))},CORRECT_WEIGHT:!1,draw:function(t,e,i){var s=e?e.scale.x:1,n=e?e.scale.y:1,r=this.style.width>>1,a=this.style.height>>1,o=0,h=0,l=!1;if(!i){t.save();var c=this.minPointX-r,u=this.minPointY-a,d=this.maxPointX+r,p=this.maxPointY+a,g=AbGraphics.box.zoom(d-c,p-u,this.width,this.height);1==g.ratioX&&1==g.ratioY||(o=r*s,h=a*n,o=o*g.ratioX-o,h=h*g.ratioY-h,l=AbShapeHighlightPen.prototype.CORRECT_WEIGHT);var f=this.box();f=AbGraphics.box.inflate(f.x,f.y,f.width,f.height,-r,-a),f.x=f.x*s,f.y=f.y*n,f.width*=s,f.height*=n;var m=f.width>>1,b=f.height>>1;this.angle?(t.translate(f.x+m,f.y+b),t.rotate(AbGraphics.angle.deg2rad(this.angle)),t.translate(-m,-b)):t.translate(f.x,f.y),t.translate(o,h),s*=g.ratioX,n*=g.ratioY}this.drawStyle(t),t.beginPath();var y=null,v=0,x=null,w=i;if(w){y=[],v=this.points.length;for(var A=0;A<v;A++){var k=this.points[A];x&&this.addPath(y,x.x,x.y,k.x,k.y,r,a),x=k}}else y=this.path;v=y.length,x=null;for(var C=0,P=0,A=0;A<v;A++){var k=y[A];l&&(C="+"==k.horiz?-o:o,P="+"==k.vert?-h:h),k.move?t.moveTo(Math.round(k.x*s+C),Math.round(k.y*n+P)):t.lineTo(Math.round(k.x*s+C),Math.round(k.y*n+P)),x=k}t.fill(),t.closePath(),i||AbShapeTool.endDraw(this,t)}},AbPage.prototype={constructor:AbPage,STATUS_TABLE:["ready","loading","loaded","error"],READY:0,LOADING:1,LOADED:2,ERROR:3,dispose:function(){this.source&&AbCommon.isFunction(this.source.dispose)&&this.source.dispose(),this.loader=null,this.source=null;for(var t=this.shapes.length,e=0;e<t;e++)AbCommon.isFunction(this.shapes[e].dispose)&&this.shapes[e].dispose();this.shapes.splice(0,this.shapes.length)},isLoading:function(){return this.status==AbPage.prototype.LOADING},isError:function(){return this.status==AbPage.prototype.ERROR},editable:function(){return this.status==AbPage.prototype.LOADED},statusText:function(){return AbPage.prototype.STATUS_TABLE[this.status]},hasImageInfo:function(){return this.source&&this.source.info&&this.source.info.data},hasShapes:function(){return this.shapes.length>0},isReadyImage:function(){return!this.error&&!this.source.hasImage()&&this.source.imgInfo.url},infoFrom:function(){return this.source&&this.source.info?this.source.info.from:null},info:function(){return this.hasImageInfo()?this.source.info.data:null},exif:function(){return this.hasImageInfo()&&this.source.info.data?this.source.info.data.exif:null},decoder:function(){return this.source&&this.source.info?this.source.info.decoder:null},sourceSize:function(){return this.source},image:function(t){return this.source instanceof AbImage?this.source.hasImage()?this.source.imageElement():this.source.hasThumbnail()?t&&t.origin===!0?this.source.originThumbnailElement():this.source.thumbnailElement():null:this.source},thumbnail:function(){return this.source instanceof AbImage&&this.source.hasThumbnail()?this.source.thumbnailElement():null},originThumbnail:function(){return this.source instanceof AbImage&&this.source.hasThumbnail()?this.source.originThumbnailElement():null},changeImage:function(t){return this.source instanceof AbImage?this.source.changeImage(t).then(function(t){this.width=t.width,this.height=t.height}.bind(this)).catch(function(t){}):new Promise(function(t,e){t()})},transformed:function(){return 0!=this.x||0!=this.y||this.scaled()},scaled:function(){return 1!=this.scale.x||1!=this.scale.y},toCanvas:function(t,e){return{x:t*this.scale.x+this.x,y:e*this.scale.y+this.y}},fromCanvas:function(t,e){return{x:(t-this.x)/this.scale.x,y:(e-this.y)/this.scale.y}},toCanvasBox:function(){var t=null;if(1==arguments.length?t=arguments[0]:4==arguments.length&&(t={x:arguments[0],y:arguments[1],width:arguments[2],height:arguments[3]}),t){var e=this.toCanvas(t.x,t.y),i=this.toCanvas(t.x+t.width,t.y+t.height);return{x:e.x,y:e.y,width:i.x-e.x,height:i.y-e.y}}},fromCanvasBox:function(){var t=null;if(1==arguments.length?t=arguments[0]:4==arguments.length&&(t={x:arguments[0],y:arguments[1],width:arguments[2],height:arguments[3]}),t){var e=this.fromCanvas(t.x,t.y),i=this.fromCanvas(t.x+t.width,t.y+t.height);return{x:e.x,y:e.y,width:i.x-e.x,height:i.y-e.y}}},toCanvasRect:function(){var t=null;if(1==arguments.length?t=arguments[0]:4==arguments.length&&(t={x1:arguments[0],y1:arguments[1],x2:arguments[2],y2:arguments[3]}),t){var e=this.toCanvas(t.x1,t.y1),i=this.toCanvas(t.x2,t.y2);return{x1:e.x,y1:e.y,x2:i.x,y2:i.y}}},fromCanvasRect:function(){var t=null;if(1==arguments.length?t=arguments[0]:4==arguments.length&&(t={x1:arguments[0],y1:arguments[1],x2:arguments[2],y2:arguments[3]}),t){var e=this.fromCanvas(t.x1,t.y1),i=this.fromCanvas(t.x2,t.y2);return{x1:e.x,y1:e.y,x2:i.x,y2:i.y}}},drawShapes:function(t,e){var i=!0,s={};e&&AbCommon.isBool(e.indicator)&&(i=e.indicator),e&&e.showingShapeTypeMap&&(s=e.showingShapeTypeMap);for(var n=this.shapes.length,r=[],a=null,o={selected:!1,focused:!1},h=0;h<n;h++){var l=this.shapes[h];s&&s[l.type]===!1||(l.focused?a=l:l.selected&&r.push(l),i===!1&&(o.selected=l.selected,o.focused=l.focused,l.selected=!1,l.focused=!1),l.draw(t,this),i===!1&&(l.selected=o.selected,l.focused=o.focused))}if(r.length&&i)for(var h=r.length-1;h>=0;h--)r[h].indicator.draw(t);a&&i&&a.indicator.draw(t)},drawOrigin:function(t,e){var i=1,s={};e&&AbCommon.isNumber(e.scale)&&(i=e.scale),e&&e.showingShapeTypeMap&&(s=e.showingShapeTypeMap);var n=this.scale.x,r=this.scale.y;this.scale.x=this.scale.y=i,this.drawShapes(t,{indicator:!1,showingShapeTypeMap:e?e.showingShapeTypeMap:null}),this.scale.x=n,this.scale.y=r;
}},AbPageCollection.prototype={constructor:AbPageCollection,clear:function(t){if(t===!0)for(var e=this.source.length-1;e>=0;e--){var i=this.source[e];AbCommon.isFunction(i.dispose)&&i.dispose()}for(var s in this.map)delete this.map[s];this.source.splice(0,this.source.length)},length:function(){return this.source.length},numShapes:function(){for(var t={shapes:0,pages:0},e=0,i=this.source.length-1;i>=0;i--)e=this.source[i].shapes.length,e>0&&(t.shapes+=e,t.pages++);return t},set:function(t,e){this.source[t]=e},get:function(t){return AbCommon.isString(t)&&(t=parseInt(t)),this.source[t]},getById:function(t){return this.map[t]},uuid:function(){for(var t=AbCommon.uuid();this.map[t];)t=AbCommon.uuid();return t},indexOf:function(){if(!arguments.length)return-1;var t=arguments[0],e=this.source.length;if(AbCommon.isString(t)){for(var i=0;i<e;i++)if(this.source[i].uid==t)return i}else for(var i=0;i<e;i++)if(this.source[i]==t)return i;return-1},remove:function(){for(var t=arguments.length,e=0;e<t;e++){var i=this.source.splice(arguments[e],1);delete this.map[i.uid]}},removeById:function(t){for(var e=arguments.length,i=0;i<e;i++){var s=this.map[arguments[0]],n=this.indexOf(s);this.source.splice(n,1),delete this.map[s.uid]}},push:function(){for(var t=arguments.length,e=0;e<t;e++){var i=arguments[e];this.source.push(i),this.map[i.uid]=i}},pop:function(){var t=this.source.pop();return t&&delete this.map[t.uid],t},splice:function(){for(var t=Array.prototype.splice.apply(this.source,arguments),e=t.length,i=0;i<e;i++)delete this.map[t[i].uid];if(arguments.length>2){e=arguments.length;for(var i=2;i<e;i++){var s=arguments[i];this.map[s.uid]=s}}},slice:function(){return Array.prototype.slice.apply(this.source,arguments)},shift:function(){var t=Array.prototype.shift.apply(this.source,arguments);return t&&delete this.map[t.uid],t},unshift:function(){Array.prototype.unshift.apply(this.source,arguments);for(var t=arguments.length,e=0;e<t;e++){var i=arguments[e];this.map[i.uid]=i}}},AbClipboard.prototype={constructor:AbClipboard,clear:function(){this.datas.splice(0,this.datas.length)},copy:function(t,e,i){this.clear();for(var s=i.length,n=0;n<s;n++){var r=i[n],a=r.serialize();this.datas.push({type:"shape",data:a})}},cut:function(t,e,i){this.copy(t,e,i),t.deleteShapes()},paste:function(t,e,i){AbCommon.isFunction(i)||(i=function(){});var s=this.datas.length;if(s){t.unselect(!1),t.history.begin("shape","add",t);for(var e=t.currentPage,n=0,r=0;r<s;r++){var a=this.datas[r];"shape"==a.type&&n++}for(var o=0,r=0;r<s;r++){var a=this.datas[r];if("shape"==a.type){var h=AbCommon.deserializeShape(a.data);t.createShape(h.name,h,function(s,r){s.prepare(),this.move(t,e,s),e.shapes.push(s),s.engine=t,s.measure(),t.selectShape(s),o++,o>=n&&(t.history.end(t),t.render(),t.modified(),i())}.bind(this))}}n||(t.history.end(t),t.render(),t.modified(),i())}else i()},PASTE_STEP:20,move:function(t,e,i){for(var s=i.box(),n=this.PASTE_STEP;this.hasShape(t,e,s.x,s.y);)s.x+=n,s.y+=n;i.move(s.x,s.y)},hasShape:function(t,e,i,s){for(var n=e.shapes.length,r=0;r<n;r++){var a=e.shapes[r],o=a.box();if(Math.round(o.x)==i&&Math.round(o.y)==s)return!0}return!1}},AbHistoryAddShapeState.prototype={constructor:AbHistoryAddShapeState,begin:function(t){var e=t.currentPage;this.pageIndex=t.currentPageIndex,this.start=e.shapes.length},end:function(t){var e=t.pages.get(this.pageIndex),i=null;return i=this.start>=0?e.shapes.slice(this.start):e.shapes.slice(),!!i.length&&void(this.shapes=AbCommon.indexArrayOf(e.shapes,i,!0))},undo:function(t){var e=t.pages.get(this.pageIndex);if(this.shapes.length){t.selectPage(this.pageIndex);for(var i=t.unselect(!1),s=this.shapes.length,n=s-1;n>=0;n--)e.shapes.splice(this.shapes[n].index,1);(s>0||i)&&(t.render(),t.modified())}},redo:function(t){var e=t.pages.get(this.pageIndex);t.selectPage(this.pageIndex);for(var i=t.unselect(!1),s=this.shapes.length,n=0;n<s;n++){var r=this.shapes[n];e.shapes.splice(r.index,0,r.source),t.selectShape(r.source)}(s>0||i)&&(t.render(),t.modified())},dispose:function(){this.shapes.splice(0,this.shapes.length)}},AbHistoryUpdateShapeState.prototype={constructor:AbHistoryUpdateShapeState,begin:function(t,e,i){if(!t.selectedShapes.length)return!1;this.props=e,this.editPoint=i,this.pageIndex=t.currentPageIndex;for(var s=t.currentPage,n=AbCommon.indexArrayOf(s.shapes,t.selectedShapes,!0),r=n.length,a=0;a<r;a++){var o=n[a],h=AbCommon.copyProp(o.source,{},this.props);this.un.push({index:o.index,prop:h})}},end:function(t){if(!t.selectedShapes.length)return!1;for(var e=t.pages.get(this.pageIndex),i=AbCommon.indexArrayOf(e.shapes,t.selectedShapes,!0),s=i.length,n=0;n<s;n++){var r=i[n],a=AbCommon.copyProp(r.source,{},this.props);this.re.push({index:r.index,prop:a})}for(var o=!1,n=0;n<s;n++){var h=this.un[n].prop,l=this.re[n].prop;if(!AbCommon.equals(h,l)){o=!0;break}}return o},undo:function(t){var e=t.pages.get(this.pageIndex);t.selectPage(this.pageIndex);for(var i=t.unselect(!1),s=this.un.length,n=0;n<s;n++){var r=this.un[n],a=e.shapes[r.index];$.extend(a,r.prop,!0),t.selectShape(a)}(s>0||i)&&(t.render(),t.modified())},redo:function(t){var e=t.pages.get(this.pageIndex);t.selectPage(this.pageIndex);for(var i=t.unselect(!1),s=this.re.length,n=0;n<s;n++){var r=this.re[n],a=e.shapes[r.index];$.extend(a,r.prop,!0),t.selectShape(a)}(s>0||i)&&(t.render(),t.modified())},dispose:function(){this.props&&this.props.splice(0,this.props.length),this.un.splice(0,this.un.length),this.re.splice(0,this.re.length)}},AbHistoryRemoveShapeState.prototype={constructor:AbHistoryRemoveShapeState,begin:function(t,e){var i=t.currentPage;return e||(e=t.selectedShapes),!!e.length&&(this.pageIndex=t.currentPageIndex,void(this.shapes=AbCommon.indexArrayOf(i.shapes,e,!0)))},end:function(t){if(!this.shapes.length)return!1},undo:function(t){var e=t.pages.get(this.pageIndex);t.selectPage(this.pageIndex);for(var i=t.unselect(!1),s=this.shapes.length,n=0;n<s;n++){var r=this.shapes[n];e.shapes.splice(r.index,0,r.source),t.selectShape(r.source)}(s>0||i)&&(t.render(),t.modified())},redo:function(t){var e=t.pages.get(this.pageIndex);if(this.shapes.length){t.selectPage(this.pageIndex);for(var i=t.unselect(!1),s=this.shapes.length,n=s-1;n>=0;n--)e.shapes.splice(this.shapes[n].index,1);(s>0||i)&&(t.render(),t.modified())}},dispose:function(){this.shapes.splice(0,this.shapes.length)}},AbHistoryRemoveAllShapeState.prototype={constructor:AbHistoryRemoveAllShapeState,begin:function(t){for(var e=t.pages.length(),i=0;i<e;i++){var s=t.pages.get(i);if(s.shapes.length){var n=s.shapes.slice(0);this.pages.push({index:i,source:n}),this.numAllShapes+=n.length}}},end:function(t){if(!this.numAllShapes)return!1},undo:function(t){for(var e=(t.unselect(!1),this.pages.length),i=-1,s=0;s<e;s++){var n=this.pages[s],r=t.pages.get(n.index);Array.prototype.push.apply(r.shapes,n.source),i=n.index}i>=0&&(i==t.currentPageIndex?t.render():t.selectPage(i),t.modified("all"))},redo:function(t){for(var e=this.pages.length,i=-1,s=0;s<e;s++){var n=this.pages[s],r=t.pages.get(n.index);r.shapes.splice(0,r.shapes.length),i=n.index}i>=0&&(i==t.currentPageIndex?t.render():t.selectPage(i),t.modified("all"))},dispose:function(){this.pages.splice(0,this.pages.length)}},AbHistoryRemoveRangeShapeState.prototype={constructor:AbHistoryRemoveRangeShapeState,begin:function(t,e){for(var i=e.length,s=0;s<i;s++){var n=e[s];if(n.shapes.length){var r=n.shapes.slice(0),a=t.pages.indexOf(n.uid);this.pageShapes.push({index:a,source:r}),this.pages.push(a),this.numShapes+=r.length}}},end:function(t){if(!this.numShapes)return!1},undo:function(t){for(var e=(t.unselect(!1),this.pageShapes.length),i=-1,s=0;s<e;s++){var n=this.pageShapes[s],r=t.pages.get(n.index);Array.prototype.push.apply(r.shapes,n.source),i=n.index}i>=0&&(i==t.currentPageIndex?t.render():t.selectPage(i),t.modified(this.pages))},redo:function(t){for(var e=this.pageShapes.length,i=-1,s=0;s<e;s++){var n=this.pageShapes[s],r=t.pages.get(n.index);r.shapes.splice(0,r.shapes.length),i=n.index}i>=0&&(i==t.currentPageIndex?t.render():t.selectPage(i),t.modified(this.pages))},dispose:function(){this.pageShapes.splice(0,this.pageShapes.length),this.pages.splice(0,this.pages.length)}},AbHistoryZIndexShapeState.prototype={constructor:AbHistoryZIndexShapeState,begin:function(t,e){if(!t.selectedShapes.length)return!1;this.moveCmd=e,this.direction="top"===e||"up"===e?1:-1,this.pageIndex=t.currentPageIndex;for(var i=t.currentPage,s=i.shapes.length-1;s>=0;s--)i.shapes[s].selected&&this.un.unshift(s)},end:function(t){if(!t.selectedShapes.length)return!1;for(var e=t.pages.get(this.pageIndex),i=e.shapes.length-1;i>=0;i--)e.shapes[i].selected&&this.re.unshift(i);if(!this.un.length||!this.re.length||this.un.length!=this.re.length)return!1;for(var s=!1,i=0;i<len;i++){var n=this.un[i],r=this.re[i];if(n!=r){s=!0;break}}return s},undo:function(t){var e=t.pages.get(this.pageIndex);t.selectPage(this.pageIndex);for(var i=t.unselect(!1),s=[],n=this.re.length-1;n>=0;n--){var r=this.re[n],a=e.shapes.splice(r,1);s.unshift(a[0])}for(var o=this.un.length,n=0;n<o;n++){var r=this.un[n];e.shapes.splice(r,0,s[n])}(o>0||i)&&(t.render(),t.modified())},redo:function(t){var e=t.pages.get(this.pageIndex);t.selectPage(this.pageIndex);for(var i=t.unselect(!1),s=[],n=this.un.length-1;n>=0;n--){var r=this.un[n],a=e.shapes.splice(r,1);s.unshift(a[0])}for(var o=this.re.length,n=0;n<o;n++){var r=this.re[n];e.shapes.splice(r,0,s[n])}(o>0||i)&&(t.render(),t.modified())},dispose:function(){this.un.splice(0,this.un.length),this.re.splice(0,this.re.length)}},AbHistoryAddPageState.prototype={constructor:AbHistoryAddPageState,begin:function(t){this.pageIndex=t.currentPageIndex,this.start=t.pages.length()},end:function(t){var e=null;return e=this.start>=0?t.pages.slice(this.start):t.pages.slice(),!!e.length&&void(this.pages=AbCommon.indexArrayOf(t.pages.source,e,!0))},undo:function(t){if(this.pages.length){var e=-1,i=this.pages.length;if(i){for(var s=i-1;s>=0;s--){var n=this.pages[s];e=n.index,t.pages.splice(n.index,1)}e>=t.pages.length()&&(e=t.pages.length()-1),t.historySync("page","add","undo",this.pages,function(){e>=0?t.selectPage(e,!0):t.selectPage(t.pages.length()-1,!0)}.bind(this)),0==t.pages.length()&&t.render()}}},redo:function(t){if(this.pages.length){for(var e=this.pages.length,i=0;i<e;i++){var s=this.pages[i];t.pages.splice(s.index,0,s.source)}e&&t.historySync("page","add","redo",this.pages,function(){t.selectPage(this.pages[e-1].index,!0)}.bind(this)),(e>0||mod)&&t.render()}},dispose:function(){this.pages.splice(0,this.pages.length)}},AbHistoryUpdatePageState.prototype={constructor:AbHistoryUpdatePageState,begin:function(t,e,i,s){this.props=e,this.setter=i,this.pageIndex=t.currentPageIndex,this.un=AbCommon.copyProp(t.currentPage,{},this.props),this.unToken=s},end:function(t,e){var i=t.pages.get(this.pageIndex);return this.re=AbCommon.copyProp(i,{},this.props),this.reToken=e,!AbCommon.equals(this.un,this.re)},undo:function(t){var e=t.pages.get(this.pageIndex);t.selectPage(this.pageIndex),AbCommon.isFunction(this.setter)?this.setter.call(t,this.un,this.re,this.unToken,this.reToken):($.extend(e,this.un,!0),t.render()),t.historySync("page","update","undo",this.pageIndex),t.modified()},redo:function(t){var e=t.pages.get(this.pageIndex);t.selectPage(this.pageIndex),AbCommon.isFunction(this.setter)?this.setter.call(t,this.re,this.un,this.reToken,this.unToken):($.extend(e,this.re,!0),t.render()),t.historySync("page","update","redo",this.pageIndex),t.modified()},dispose:function(){this.props&&this.props.splice(0,this.props.length),this.un=null,this.re=null,this.setter=null}},AbHistoryRemovePageState.prototype={constructor:AbHistoryRemovePageState,begin:function(t,e){if(this.pageIndex=t.currentPageIndex,e||(e=[t.currentPageIndex]),!e.length)return!1;for(var i=e.length,s=0;s<i;s++)this.pages.push({index:e[s],source:t.pages.get(e[s])})},end:function(t){if(!this.pages.length)return!1},undo:function(t){if(this.pages.length){var e=this.pages.length;if(e>0){for(var i=0;i<e;i++){var s=this.pages[i];t.pages.splice(s.index,0,s.source),t.pageInserted(s.index)}t.historySync("page","remove","undo",this.pages,function(){t.selectPage(this.pages[e-1].index,!0)}.bind(this))}}},redo:function(t){if(this.pages.length){var e=t.currentPageIndex,i=this.pages.length;if(i){for(var s=i-1;s>=0;s--){var n=this.pages[s];t.pages.splice(n.index,1),t.pageRemoved(n.index)}e>=t.pages.length()&&(e=t.pages.length()-1),t.historySync("page","remove","redo",this.pages,function(){e>=0?t.selectPage(e,!0):t.selectPage(t.pages.length()-1,!0)}.bind(this)),0==t.pages.length()&&t.render()}}},dispose:function(){this.pages.splice(0,this.pages.length)}},AbHistory.prototype={constructor:AbHistory,STATES_TABLE:{shape:{add:new AbHistoryAddShapeState,update:new AbHistoryUpdateShapeState,remove:new AbHistoryRemoveShapeState,all:new AbHistoryRemoveAllShapeState,range:new AbHistoryRemoveRangeShapeState,zindex:new AbHistoryZIndexShapeState},page:{add:new AbHistoryAddPageState,update:new AbHistoryUpdatePageState,remove:new AbHistoryRemovePageState}},get:function(t,e){var i=AbHistory.prototype.STATES_TABLE[t];return i?i[e]:null},lock:function(){this.locked=!0},unlock:function(){this.locked=!1},canUndo:function(){var t=this.queue.length&&this.index>-1;if(arguments.length){var e=arguments[0];return t&&this.queue[this.index].type==e}return t},canRedo:function(){var t=this.queue.length&&this.index+1<this.queue.length;if(arguments.length){var e=arguments[0];return t&&this.queue[this.index].type==e}return t},beginState:function(t){if(!this.locked&&AbCommon.isHistoryState(t)){this.temp=AbCommon.clone(t);var e=AbCommon.copyArray(arguments,1);this.temp.begin.apply(this.temp,e)}},begin:function(){if(!this.locked){if(this.cancel(),!(arguments.length>=2&&AbCommon.isString(arguments[0])&&AbCommon.isString(arguments[1])))return this.beginState.apply(this,arguments);var t=this.get(arguments[0],arguments[1]);if(t){var e=AbCommon.copyArray(arguments,2);e.splice(0,0,t),this.beginState.apply(this,e)}}},end:function(){if(null!=this.temp){if(this.temp.end.apply(this.temp,arguments)===!1)return void this.cancel();this.releasePost(this.index),this.queue.length>=this.queueSize&&(this.queue[0].dispose(),this.queue.splice(0,1)),this.queue.push(this.temp),this.temp=null,this.index=this.queue.length-1,this.logAllTree()}},cancel:function(){null!=this.temp&&(this.temp.dispose(),this.temp=null)},ENABLE_LOG:!1,logAllTree:function(){if(this.ENABLE_LOG){for(var t="[HISTORY]",e=0;e<this.queue.length;e++){var i=this.queue[e];t+="["+i.type+"::"+i.cmd+"]"}console.log(t)}},logTree:function(){if(this.ENABLE_LOG){for(var t="\t[DO]["+this.index+"]",e=0;e<=this.index;e++){var i=this.queue[e];t+="["+i.type+"::"+i.cmd+"]"}console.log(t)}},undo:function(t){if(this.canUndo()){t.history.lock();var e=this.queue[this.index];e.undo.apply(e,arguments),this.index--,t.history.unlock(),this.logTree()}},redo:function(t){if(this.canRedo()){t.history.lock(),this.index<0&&this.queue.length?this.index=0:this.index++;var e=this.queue[this.index];e.redo.apply(e,arguments),t.history.unlock(),this.logTree()}},clear:function(){this.queue.splice(0,this.queue.length),this.index=-1},releasePost:function(t){if(this.queue.length){for(var e=this.queue.length,i=0,s=t+1;s<e;s++){var n=this.queue[s];n.dispose(),i++}this.queue.splice(t+1,i)}}},AbImage.prototype={constructor:AbImage,dispose:function(){this.info=null,this.imgInfo.url=null,this.imgInfo.element=null,this.thumbInfo.url=null,this.thumbInfo.element=null,this.thumbInfo.originElement=null},existSize:function(){return this.width&&this.height},hasImage:function(){return this.imgInfo.loaded},hasThumbnail:function(){return this.thumbInfo.loaded},imageUrl:function(){return this.imgInfo.url},thumbnailUrl:function(){return this.thumbInfo.url},getImage:function(t,e){return t.loaded?new Promise(function(e,i){e({image:t.element,loaded:!1})}):AbCommon.loadImage(t.url).then(function(i){return t.loaded=!0,t.element=i,new Promise(function(i,s){e?AbCommon.loadImage(t.url).then(function(e){t.originElement=e,i({image:t.element,loaded:!0})}).catch(function(t){s(t)}):i({image:t.element,loaded:!0})})})},imageElement:function(){return this.imgInfo.element},thumbnailElement:function(){return this.thumbInfo.element},originThumbnailElement:function(){return this.thumbInfo.originElement},image:function(){return this.getImage(this.imgInfo).then(function(t){this.width=t.image.width,this.height=t.image.height;var e=this.existSize();return new Promise(function(i,s){e?setTimeout(i.bind(null,t.image),0):setTimeout(s.bind(null,new Error("It is not an image file")),0)})}.bind(this))},thumbnail:function(){return this.getImage(this.thumbInfo,!0)},changeImage:function(t){var e=this.imgInfo,i=e.loaded;return e.loaded=!1,e.url=t,i?this.image():new Promise(function(t,i){setTimeout(function(){t(e.element)},0)})},generateThumbnail:function(){var t=0,e=0,i=null;if(3==arguments.length?(t=arguments[0],e=arguments[1],i=arguments[3]):2==arguments.length?(t=arguments[0],e=arguments[1]):i=arguments[0],!(i||t&&e))throw"invalid usage!!";return this.image().then(function(s){i?(t||e)&&i.resizeLimit(t,e):i=new AbThumbnailGenerator({limit:{width:t,height:e}}),i.resize(this.width,this.height);var n=this.info?this.info.decoder:null,r=i.generate(s,n);return this.setThumbnailData(r)}.bind(this))},setThumbnailData:function(t){if(this.thumbInfo.loaded){var e=this.thumbInfo.element;return e.src=t,new Promise(function(t,i){setTimeout(t.bind(null,{element:e,data:e.src}),0)})}var e=AbCommon.createImage();e.src=t;var i=AbCommon.createImage();return i.src=t,this.thumbInfo.loaded=!0,this.thumbInfo.element=e,this.thumbInfo.url=t,this.thumbInfo.originElement=i,new Promise(function(t,i){setTimeout(t.bind(null,{element:e,data:e.src}),0)})}},AbThumbnailGenerator.prototype={constructor:AbThumbnailGenerator,MAX_WIDTH:120,MAX_HEIGHT:120,width:function(){return this.context.canvas.width},height:function(){return this.context.canvas.height},size:function(){return{width:this.context.canvas.width,height:this.context.canvas.height}},calcRatio:function(){var t=AbGraphics.box.zoom(this.source.width,this.source.height,this.limit.width,this.limit.height);this.ratio=t.ratio},resizeLimit:function(t,e){this.limit.width=t,this.limit.height=e,this.calcRatio()},resize:function(t,e){this.source.width=t,this.source.height=e,this.calcRatio(),this.context.canvas.width=Math.round(t*this.ratio),this.context.canvas.height=Math.round(e*this.ratio)},draw:function(t){var e=this.context,i=e.canvas.width,s=e.canvas.height;e.drawImage(t,0,0,i,s)},toImage:function(t){return AbGraphics.canvas.toImage(this.context,t)},generate:function(t,e){return this.draw(t),this.toImage(e)}},AbViewerEngineObservers.prototype={constructor:AbViewerEngineObservers,add:function(t,e){(AbCommon.isFunction(e)||e&&AbCommon.isFunction(e.engineNotify))&&(t&&"all"!=t?this.listeners[t]?this.listeners[t].push(e):this.listeners[t]=[e]:this.all.push(e))},remove:function(t,e){if(AbCommon.isFunction(e)||e&&AbCommon.isFunction(e.engineNotify)){var i=null;if(t&&"all"!=t?this.listeners[t]&&(i=this.listeners[t]):i=this.all,i)for(var s=(i.length,i.length-1);s>=0;s--)if(i[s]==e)return void i.splice(s,1)}},clear:function(t){this.listeners[t]&&this.listeners[t].splice(0,this.listeners[t].length)},reset:function(){for(var t in this.listeners)this.listeners[t].splice(0,this.listeners[t].length),delete this.listeners[t];this.all.splice(0,this.all.length)},notify:function(t,e,i){this.listeners[t]||this.all.length?setTimeout(function(){var s=this.listeners[t];if(this.all.length)if(s){var n=[];Array.prototype.push.apply(n,s),Array.prototype.push.apply(n,this.all),s=n}else this.all.length&&(s=this.all);for(var r=s?s.length:0,a=0;a<r;a++)AbCommon.isFunction(s[a])?s[a](this.engine,e):s[a].engineNotify(this.engine,t,e);AbCommon.isFunction(i)&&i(!0)}.bind(this),0):AbCommon.isFunction(i)&&i(!1)}},AbViewerEngineAnimateStates.prototype={constructor:AbViewerEngineAnimateStates,animated:function(){return arguments.length?this.$states[arguments[0]]:this.$animated},begin:function(t){this.$stack.push(this.$animated),this.$animated=!0,this.$states[t]=!0,this.engine.notifyObservers("animate",t)},end:function(t){if(this.$states[t]===!0){this.$states[t]=!1;var e=this.$stack.pop();this.$animated=e,this.engine.notifyObservers("animated",t)}}},AbViewerEngineSelection.prototype={constructor:AbViewerEngineSelection,dragged:function(){return this.canvas.end.x-this.canvas.start.x!=0||this.canvas.end.y-this.canvas.start.y!=0},swap:function(){return AbGraphics.rect(this.start.x,this.start.y,this.end.x,this.end.y)},box:function(){return AbGraphics.box.rect(this.start.x,this.start.y,this.end.x,this.end.y)},drawed:null,reset:function(){this.target&&this.engine.notifyObservers("cancel","shape.create"),this.mode=null,this.target=null,this.edit=null,this.editTarget=null,this.clickTarget=null}},AbViewerEngineTextBox.prototype={constructor:AbViewerEngineTextBox,attr:function(){return this.e.attr.apply(this.e,arguments)},prop:function(){return this.e.prop.apply(this.e,arguments)},on:function(){return this.e.on.apply(this.e,arguments)},off:function(){return this.e.off.apply(this.e,arguments)},css:function(){return this.e.css.apply(this.e,arguments)},val:function(){return this.e.val.apply(this.e,arguments)},box:function(t,e,i,s){var n=this.engine.currentPage,r=n.toCanvas(t,e),a=this.engine.canvas2screen(r);t=a.x,e=a.y;var o=parseFloat(this.e.attr("s-angle")),h="";if(o&&(h+="rotate("+o+"deg) "),n.scaled()){var l=i/2,c=i*n.scale.x/2,u=s/2,d=s*n.scale.y/2;t-=l-c,e-=u-d,h+="scale("+n.scale.x+","+n.scale.y+") "}this.e.css("transform",h),this.e.css("-webkit-transform",h),this.e.css("-moz-transform",h),this.e.css("left",t),this.e.css("top",e),this.e.css("width",i),this.e.css("height",s)},show:function(t,e,i,s,n){n||(n=0);var r=this.engine.currentPage,a=r.toCanvas(t,e),o=this.engine.canvas2screen(a);t=o.x,e=o.y,this.e.attr("s-w",i),this.e.attr("s-h",s),this.e.attr("s-angle",n);var h="";if(n&&(h+="rotate("+n+"deg) "),r.scaled()){var l=i/2,c=i*r.scale.x/2,u=s/2,d=s*r.scale.y/2;t-=l-c,e-=u-d,h+="scale("+r.scale.x+","+r.scale.y+") "}this.e.css("transform",h),this.e.css("-webkit-transform",h),this.e.css("-moz-transform",h),2==arguments.length||3==arguments.length?(this.e.css("left",t),this.e.css("top",e)):arguments.length>=4&&(this.e.css("left",t),this.e.css("top",e),this.e.css("width",i),this.e.css("height",s)),this.e.css({zIndex:0,visibility:"visible"});var p=this.e.get(0);if(p.select(),p.setSelectionRange)p.setSelectionRange(0,0);else if(p.createTextRange){var g=p.createTextRange();g.moveStart("character",startIndex),g.moveEnd("character",endIndex),g.select()}},hide:function(){this.e.blur(),this.e.css({zIndex:-1,visibility:"hidden"})},generate:function(){this.e=$('<textarea placeholder="내용을 입력하세요" wrap="soft" spellcheck="false"></textarea>'),this.e.css("line-height","1.2"),this.e.css("border","0 none white"),this.e.css("padding","0"),this.e.css("outline","none"),this.e.css("IME-MODE","active"),this.e.css("overflow","hidden"),this.e.css("resize","none"),this.e.css("position","absolute"),this.e.css("visibility","hidden"),this.e.css("z-index","-1"),this.e.css("-webkit-user-drag","none"),this.e.css("-webkit-font-smoothing","antialiased"),this.e.css("-moz-osx-font-smoothing","grayscale"),this.e.keydown(this,function(t){t.stopPropagation(),t.stopImmediatePropagation()})}},AbViewerEngine.prototype={constructor:AbViewerEngine,NONE:0,DIR_HORIZ:1,DIR_VERT:2,MIN_SCALE:.1,MAX_SCALE:5,SCALE_STEP:.07,SCALE_ANI_STEP:.4,SCALE_ANI_EASING:"easeOutExpo",SCALE_ANI_DURATION:300,ROTATE_ANI_EASING:"easeOutExpo",ROTATE_ANI_DURATION:400,SHAPE_TABLE:{textbox:new AbShapeTextBox,rectangle:new AbShapeRectangle,pen:new AbShapePen,highlightpen:new AbShapeHighlightPen,ellipse:new AbShapeEllipse,arrow:new AbShapeArrow,line:new AbShapeLine,checker:new AbShapeImage({name:"checker",source:AbIcons.CHECKER}),stamp:new AbShapeStamp},install:function(t){if(AbCommon.isFunction(t)||(t=function(){}),this.panel.length){this.status="preparing";var e=AbCommon.getBounds(this.panel.get(0)),i=$('<canvas width="'+e.width+'" height="'+e.height+'"/>');i.css("touch-action","none"),i.css("user-select","none"),i.css("-webkit-user-drag","none"),i.css("-webkit-tap-highlight-color","rgba(0, 0, 0, 0);"),i.css("outline","none"),i.attr("tabindex","1"),i.focus(function(t){this.textbox.hide()}.bind(this)),i.on("contextmenu",function(t){return t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),t.originalEvent&&t.originalEvent.hasOwnProperty("returnValue")&&(t.originalEvent.returnValue=!1),!1}),this.panel.append(i);var s=i.get(0);this.viewContext=s.getContext("2d");var i=$('<canvas width="'+e.width+'" height="'+e.height+'"/>');this.context=i.get(0).getContext("2d"),this.textbox.generate(),this.panel.append(this.textbox.e),this.prepare(),this.status="prepared"}var n=[];if(this.SHAPE_TABLE)for(var r in this.SHAPE_TABLE){var a=this.SHAPE_TABLE[r];AbCommon.needPreloading(a)&&n.push(a)}if(n.length)for(var o=0,h=n.length;n.length;){var a=n.shift();a.preload(function(){o++,o>=h&&t()})}else t()},dispose:function(){this.selection.engine=null,this.animateStates.engine=null,this.clearPages(),this.textbox.engine=null,this.textbox.e=null},observe:function(t,e){this.observers.add(t,e)},stopObserve:function(t,e){this.observers.remove(t,e)},notifyObservers:function(t,e,i){this.observers?this.observers.notify(t,e,i):AbCommon.isFunction(i)&&i(!1)},notifySelectionShapes:function(t){for(var e=this.selectedShapes.length,i=0;i<e;i++)this.selectedShapes[i].notify.apply(this.selectedShapes[i],arguments)},notifyShapes:function(t){for(var e=this.currentPage.shapes.length,i=0;i<e;i++)this.currentPage.shapes[i].notify.apply(this.currentPage.shapes[i],arguments)},waterMarkNotify:function(t,e,i){switch(e){case"render":this.context&&this.currentPage&&this.render()}},shapeObject:function(t){return AbCommon.isString(t)?AbViewerEngine.prototype.SHAPE_TABLE[t]:AbCommon.isShape(t)?t:null},createShape:function(){if(arguments.length){var t=function(){},e=arguments.length,i=arguments[0];e>1&&AbCommon.isFunction(arguments[e-1])&&(t=arguments[e-1],e--);var s=AbViewerEngine.prototype.SHAPE_TABLE[i];if(!s)return void t(null);if(s=AbCommon.cloneShape(s),e>1)for(var n=1;n<e;n++)AbCommon.shapeProp(s,arguments[n]);AbCommon.needPreloading(s)?s.preload(function(e,i){switch(e){case"error":t(s,new Error(i));break;default:t(s)}}):t(s)}},config:function(t){function e(t,e){for(var i=t,s=e.split("."),n=0,r=s.length-1,a=s[s.length-1];n<r;){if(i=i[s[n]],!i)return null;n++}return{config:i,leap:a}}var i=e(this.$config,t);return i?i.config[i.leap]:null},selectionStyle:function(t){var e=this.$config,i="path",s=["all"];return e&&e.shape&&e.shape.selection&&(e.shape.selection.style&&(i=e.shape.selection.style),e.shape.selection.target&&$.isArray(e.shape.selection.target)&&(s=e.shape.selection.target)),$.inArray("all",s)>=0||$.inArray(t,s)>=0?i:"path"},isVisibleShapeType:function(t){if(!this.showingShapes)return!1;var e=!0;return t&&this.showingShapeTypeMap[t]===!1&&(e=!1),e},showShapes:function(){if(arguments.length)if(AbCommon.isBool(arguments[0]))this.showingShapes=arguments[0],this.render(),this.notifyObservers("show",{type:"all",show:this.showingShapes});else if(AbCommon.isString(arguments[0])){var t=$.trim(arguments[0]);if(!(arguments.length>=2&&AbCommon.isBool(arguments[1])))return this.showingShapeTypeMap[t];this.showingShapeTypeMap[t]=arguments[1],this.render(),this.notifyObservers("show",{type:t,show:this.showingShapeTypeMap[t]})}return this.showingShapes},showShapeTypeMap:function(){return this.showingShapeTypeMap},editable:function(){return this.pages.length()>0&&this.currentPage&&!this.currentPage.error&&this.maniplatable()},maniplatable:function(){return this.enabled&&!this.animateStates.animated()},modified:function(t){this.notifyObservers("modified",t)},exec:function(t,e){e||(e=0),setTimeout(t.bind(this),e)},execCommand:function(t,e){if(this.maniplatable()){var i=function(){var t=arguments.callee.cmd;switch(t){case"undo":this.undo();break;case"redo":this.redo();break;case"copy":this.copy();break;case"paste":this.paste();break;case"cut":this.cut();break;case"delete":this.deleteShapes();break;case"selectAll":this.selectAll();break;case"z-index":this.zIndex(e)}};i.cmd=t,this.exec(i)}},keyEvent:function(t){var e=!1,i=t.data.currentPage,s="edit"==t.data.engineMode;t.data.maniplatable();switch(t.type){case"keydown":s&&(!i||t.shiftKey||t.altKey||t.ctrlKey||32!=t.keyCode||(t.data.listening=t.keyCode,t.data.mouseTriggered&&t.stopPropagation(),t.data.mouseTriggered=!1),!t.ctrlKey||"A"!=t.key&&"a"!=t.key?!t.ctrlKey||"Z"!=t.key&&"z"!=t.key?!t.ctrlKey||"Y"!=t.key&&"y"!=t.key?!t.ctrlKey||"C"!=t.key&&"c"!=t.key?!t.ctrlKey||"V"!=t.key&&"v"!=t.key?!t.ctrlKey||"X"!=t.key&&"x"!=t.key?46==t.which?t.data.execCommand("delete"):116==t.which:t.data.execCommand("cut"):t.data.execCommand("paste"):t.data.execCommand("copy"):t.data.execCommand("redo"):t.data.execCommand("undo"):(t.data.execCommand("selectAll"),e=!0));break;case"keyup":s&&(!i||t.shiftKey||t.altKey||t.ctrlKey||32!=t.keyCode||(t.data.listening=!1,t.data.mouseTriggered=!1,e=!0))}return!e||(t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),t.originalEvent&&t.originalEvent.hasOwnProperty("returnValue")&&(t.originalEvent.returnValue=!1),!1)},mouseEvent:function(t){if(t.data.currentPage&&t.data.maniplatable()){var e=3==t.which;e||(t.target==t.data.viewContext||t.target==t.data.viewContext.canvas?t.data.mouse(!0,t.type,t):t.data.mouse(!1,t.type,t))}},resizeEvent:function(t){t.data.exec(function(){this.resize()})},canvasBlurEvent:function(t){t.data.exec(function(){this.selection.reset()})},attachEvents:function(){var t=$(document),e=$(window),i=$(this.viewContext.canvas);t.bind("mousemove",this,this.mouseEvent),t.bind("mousedown",this,this.mouseEvent),t.bind("mouseup",this,this.mouseEvent),t.bind("click",this,this.mouseEvent),t.bind("mousewheel",this,this.mouseEvent),t.bind("wheel",this,this.mouseEvent),e.bind("keydown",this,this.keyEvent),e.bind("keyup",this,this.keyEvent),e.bind("resize",this,this.resizeEvent),i.bind("blur",this,this.canvasBlurEvent)},detachEvents:function(){var t=$(document),e=$(window),i=$(this.viewContext.canvas);t.unbind("mousemove",this,this.mouseEvent),t.unbind("mousedown",this,this.mouseEvent),t.unbind("mouseup",this,this.mouseEvent),t.unbind("click",this,this.mouseEvent),t.unbind("mousewheel",this,this.mouseEvent),t.unbind("wheel",this,this.mouseEvent),e.unbind("keydown",this,this.keyEvent),e.unbind("keyup",this,this.keyEvent),e.unbind("resize",this,this.resizeEvent),i.unbind("blur",this,this.canvasBlurEvent)},screen2canvas:function(){var t=0,e=0;1==arguments.length?(t=arguments[0].x,e=arguments[0].y):(t=arguments[0],e=arguments[1]);var i=(AbCommon.getBounds(this.viewContext.canvas),$(this.viewContext.canvas).position()),s=AbCommon.scrolledParents($(this.viewContext.canvas));return{x:t-i.left-s.x-this.margin.left,y:e-i.top-s.y-this.margin.top}},canvas2screen:function(){var t=0,e=0;1==arguments.length?(t=arguments[0].x,e=arguments[0].y):(t=arguments[0],e=arguments[1]);var i=(AbCommon.getBounds(this.viewContext.canvas),$(this.viewContext.canvas).position()),s=AbCommon.scrolledParents($(this.viewContext.canvas));return{x:t+i.left+s.x+this.margin.left,y:e+i.top+s.y+this.margin.top}},event:function(t){var e=(!!t&&t.ctrlKey,!!t&&t.shiftKey,!!t&&t.altKey,2==(t&&t.originalEvent?t.originalEvent.location:1),AbCommon.getBounds(this.viewContext.canvas)),i=AbCommon.scrolledParents($(this.viewContext.canvas)),s={x:t.pageX-e.left-i.x-this.margin.left,y:t.pageY-e.top-i.y-this.margin.top};return{x:s.x,y:s.y,ctrlKey:!!t&&t.ctrlKey,shiftKey:!!t&&t.shiftKey,altKey:!!t&&t.altKey,button:1==t.which?"left":2==t.which?"middle":3==t.which?"right":null}},mouse:function(){if(arguments.length&&this.enabled){var t=arguments[0]===!0,e=arguments[1],i=arguments[2];if(t){var s=this.event(i),n=s.x,r=s.y;if(this.currentPage){var a=this.currentPage.fromCanvas(n,r);n=a.x,r=a.y}var o={arg:s,x:n,y:r,additional:s.shiftKey,
fixed:s.ctrlKey,pageMove:!1};switch("edit"==this.engineMode&&this.listening!==!1&&(this.mouseTriggered=!0,o.pageMove=!0),e){case"mousemove":switch(o.fixed?(this.selection.direction==this.NONE&&(this.selection.direction=this.analysisMouseDirection(this.selection.prev.x,this.selection.prev.y,n,r)),this.selection.direction==this.DIR_HORIZ?(o.y=r=this.selection.start.y,o.arg.y=s.y=this.selection.canvas.start.y):this.selection.direction==this.DIR_VERT&&(o.x=n=this.selection.start.x,o.arg.x=s.x=this.selection.canvas.start.x),this.selection.direction&&this.notifyObservers("mouse.direction",this.selection.direction)):this.selection.direction&&(this.selection.direction=this.NONE,this.notifyObservers("mouse.direction",this.selection.direction)),this.selection.end.x=n,this.selection.end.y=r,this.selection.canvas.end.x=s.x,this.selection.canvas.end.y=s.y,this.engineMode){case"edit":this.editMouseMoveEvent(i,o);break;case"view":this.viewMouseMoveEvent(i,o)}this.selection.prev.x=n,this.selection.prev.y=r,this.selection.canvas.prev.x=s.x,this.selection.canvas.prev.y=s.y;break;case"mousedown":switch(this.selection.prev.x=this.selection.start.x=this.selection.end.x=n,this.selection.prev.y=this.selection.start.y=this.selection.end.y=r,this.selection.canvas.prev.x=this.selection.canvas.start.x=this.selection.canvas.end.x=s.x,this.selection.canvas.prev.y=this.selection.canvas.start.y=this.selection.canvas.end.y=s.y,this.engineMode){case"edit":this.editMouseDownEvent(i,o);break;case"view":this.viewMouseDownEvent(i,o)}break;case"mouseup":switch(this.engineMode){case"edit":this.editMouseUpEvent(i,o);break;case"view":this.viewMouseUpEvent(i,o)}break;case"click":switch(this.engineMode){case"edit":this.editMouseClickEvent(i,o);break;case"view":this.viewMouseClickEvent(i,o)}break;case"mousewheel":case"wheel":return this.mouseWheelEvent(i)}}else{arguments.length>=2?arguments[1]:null;switch(e){case"mousemove":break;case"mousedown":break;case"mouseup":switch(this.engineMode){case"edit":this.editMouseUpEvent(i);break;case"view":this.viewMouseUpEvent(i)}}}}},editMouseMoveEvent:function(t,e){switch(this.selection.mode){case"page-move":this.move(e.arg.x-this.selection.canvas.prev.x,e.arg.y-this.selection.canvas.prev.y,!0),this.notifyObservers("page","move");break;case"selection":this.restoreSelection(),this.drawSelection();break;case"creation":var i=this.shapeObject(this.selection.target);AbCommon.wannaCollectPoints(i)&&i.addPoint(this.selection.end.x,this.selection.end.y),AbCommon.supportCreationDraw(i)||this.restoreSelection(),AbCommon.hasCreationStyleShape(i)&&"click"==i.creationStyle()||this.drawCreation();break;case"move":for(var s=e.x-this.selection.prev.x,n=e.y-this.selection.prev.y,r=this.selectedShapes.length,a=0;a<r;a++){var o=this.selectedShapes[a];o.move(s,n,!0)}this.render();break;case"resize":this.resizeSelection(e.x,e.y);break;default:this.editNormalMouseOperation(t,e)}},editNormalMouseOperation:function(t,e){for(var i=null,s=null,n=e.x,r=e.y,a=this.selectedShapes.length-1;a>=0;a--){var o=this.selectedShapes[a];if(null!=(i=o.editable(n,r,this.viewContext))){s=o;break}}if(!i)for(var a=this.selectedShapes.length-1;a>=0;a--){var o=this.selectedShapes[a];if(o.contains(n,r,this.viewContext)){s=o;break}}if(i?(this.selection.edit=i,this.selection.editTarget=s):(this.selection.edit=null,this.selection.editTarget=null),"pointer"!=this.cursor())if(i){var h=AbGraphics.cursor(i,s.angle);this.cursor(h)}else if(s)this.cursor("move");else{var h=this.cursor();h&&"default"!=h&&this.cursor("default")}},editMouseDownEvent:function(t,e){if(e.pageMove){var i=this.testContentView();i.inCanvas||(this.selection.mode="page-move")}if(!this.selection.mode){var s=this.shapeObject(this.selection.target);if(this.selection.editTarget&&this.selection.edit)this.selection.mode="resize";else if(s)this.unselect(!1),this.selection.mode="creation",AbCommon.wannaCollectPoints(s)&&s.addPoint(this.selection.end.x,this.selection.end.y),this.runtime=!0;else{var n=null;if(!this.selection.mode&&(n=this.getShape(e.x,e.y)))if(n.selected){if(e.additional)return this.unselectShape(n),void this.render();this.focusShape(n),this.selection.mode="move",this.render()}else e.additional||this.unselect(!1),this.selectShape(n),this.selection.mode="move",this.render();this.selection.mode||(this.selection.mode="selection",this.runtime=!0)}switch(this.selection.mode){case"resize":this.history.begin("shape","update",this,["angle","x","y","width","height","x1","y1","x2","y2","textWidth","textHeight","text"],this.selection.edit);break;case"move":this.history.begin("shape","update",this,["angle","x","y","x1","y1","x2","y2"])}}},editMouseUpEvent:function(t,e){switch(e||(e={}),this.selection.mode){case"page-move":this.selection.reset(),this.notifyObservers("page","moved");break;case"selection":this.restoreSelection(),this.selection.reset(),this.select({additional:e.additional}),this.runtime=!1,this.notifyObservers("selection","end");break;case"creation":this.runtime=!1;var i=this.shapeObject(this.selection.target);if(AbCommon.wannaCollectPoints(i)&&i.endPoint(),AbCommon.isString(this.selection.target)){var s=i;i=AbCommon.cloneShape(i),s.reset()}var n=this.selection.start.x,r=this.selection.start.y,a=this.selection.end.x,o=this.selection.end.y;if((!AbCommon.hasCreationStyleShape(i)||"click"!=i.creationStyle())&&(AbCommon.hasCreationMinimum(i)||AbCommon.hasMinimum(i))){var h=AbCommon.hasCreationMinimum(i)?i.creationMinimum():i.minimum(),l=!1;h.width>Math.abs(a-n)&&(a=a<n?n-h.width:n+h.width,l=!0),h.height>Math.abs(o-r)&&(o=o<r?r-h.height:r+h.height,l=!0),l&&i.rect(n,r,a,o)}this.history.begin("shape","add",this),this.currentPage.shapes.push(i),this.selectShape(i),i.engine=this,i.notify("created",n,r,a,o),i.measure(),i.notify("measured"),this.history.end(this),this.selection.reset(),this.render(),this.notifyObservers("shape","created"),this.modified();break;case"resize":this.notifySelectionShapes("resized"),this.history.end(this),this.selection.reset(),this.render(),this.notifyObservers("shape","resized"),this.modified();break;case"move":var c=this.focusedShape;if(this.selection.dragged())this.notifySelectionShapes("moved"),this.history.end(this),this.notifyObservers("shape","moved"),this.modified();else{if(this.history.cancel(),e.additional||this.unselect({unfocusOnly:!0}),this.selectedShapes.length&&this.notifyObservers("shape","click"),1==this.selectedShapes.length&&c&&AbCommon.isSupportInlineEditShape(c)&&c.testInlineEdit(this.viewContext,this.selection.end.x,this.selection.end.y))return this.selection.reset(),this.selection.mode="inline",void(this.selection.clickTarget=c);this.selection.reset(),this.selection.clickTarget=c}default:if(t.target&&!this.selection.mode&&this.selection.target){var u=$(t.target);if("creation"===u.attr("ve-type"))return}this.cancelAnyClick&&this.selection.reset()}},editMouseClickEvent:function(t,e){switch(this.selection.mode){case"inline":this.exec(function(){this.selection.clickTarget&&this.selection.clickTarget.inlineEdit(this),this.selection.reset(),this.notifyObservers("shape","inline")})}},viewMouseMoveEvent:function(t,e){switch(this.selection.mode){case"page-move":this.move(e.arg.x-this.selection.canvas.prev.x,e.arg.y-this.selection.canvas.prev.y,!0),this.notifyObservers("page","move")}},viewMouseDownEvent:function(t,e){if(!this.selection.mode){var i=this.testContentView();i.inCanvas||(this.selection.mode="page-move")}},viewMouseUpEvent:function(t,e){switch(this.selection.mode){case"page-move":this.selection.reset(),this.notifyObservers("page","moved")}},viewMouseClickEvent:function(t,e){},analysisMouseDirection:function(t,e,i,s){var n=Math.abs(i-t),r=Math.abs(s-e);return n||r?n>=r?this.DIR_HORIZ:this.DIR_VERT:this.NONE},prevScaleStep:1,mouseWheelEvent:function(t){this.textbox.hide();var e=this.event(t),i=AbCommon.wheel.normalize(t.originalEvent),s=this.currentPage,n=t.shiftKey,r=n?this.SCALE_ANI_STEP:this.SCALE_STEP,a=this.prevScaleStep;a=i.spinY<0?1+r:1-r;var o=s.scale.x*a;return o<this.MIN_SCALE?o=this.MIN_SCALE:o>this.MAX_SCALE&&(o=this.MAX_SCALE),this.scale(o,e.x,e.y,null,n,this.SCALE_ANI_DURATION)===!1?this.prevScaleStep*=a:this.prevScaleStep=1,t.preventDefault(),t.stopPropagation(),!1},mode:function(){if(this.currentPage&&this.maniplatable()&&arguments.length){var t=(arguments[0]||"").toLowerCase();t&&this.engineMode!=t&&(this.engineMode=t,this.unselect(!1),this.prepare(),this.render(),this.notifyObservers("mode",t))}return this.engineMode},prepare:function(){if(this.currentPage&&this.maniplatable())switch(this.engineMode){case"edit":this.cursor("default");break;case"view":this.cursor("pointer")}},focus:function(){this.viewContext.canvas&&this.viewContext.canvas.focus()},cursor:function(t){return arguments.length?void this.exec(function(){var e=this.panel;e.css("cursor",t)}):this.panel.css("cursor")},resize:function(){var t=this.runtime;this.runtime=!0;var e=this.panel.width(),i=this.panel.height();if(!(e<=0||i<=0)){var s=$('<canvas width="'+e+'" height="'+i+'"/>'),n=s.get(0).getContext("2d");n.drawImage(this.context.canvas,0,0);var r=$(this.context.canvas);r.css({width:e,height:i}),this.context.canvas.width=e,this.context.canvas.height=i,this.imagePositioning(e,i),this.render(!1);var a=$(this.viewContext.canvas);a.css({width:e,height:i}),this.viewContext.canvas.width=e,this.viewContext.canvas.height=i,this.viewContext.drawImage(n.canvas,0,0),this.paint(),this.runtime=t,this.notifyObservers("resize")}},testContentView:function(t){var e=this.context.canvas,i=this.currentPage,s=1,n=1;arguments.length?s=n=t:(s=i.scale.x,n=i.scale.y);var r=i.width*s,a=i.height*n,o=e.width,h=e.height;o-=this.margin.horiz(),h-=this.margin.vert();var l=this.screen2canvas(o>>1,h>>1),c=o>=r,u=h>=a,d=c&&u;return{canvas:{width:o,height:h},center:l,contents:{width:r,height:a},inCanvas:d,horizInCanvas:c,vertInCanvas:u}},rotate:function(t,e,i,s){if(AbCommon.isBool(s)||(s=!0),!this.currentPage)return 0;if(2==arguments.length){if(!this.maniplatable())return;if(t||(t=1),e||(e=1),t=parseInt(t),e=parseInt(e),1!=t&&t!=-1)throw"Invalid direction";if(e<0||e>3)throw"Invalid direction";this.animateStates.begin("rotate"),e=parseInt(t)*(90*parseInt(e));var n=this.currentPage.angle,r=n+e,a=this.currentPage,o=(a.image(),a.sourceSize()),h=AbGraphics.angle.point(r,0,0,o.width,o.height),l=this.calcImagePosition(null,null,Math.round(Math.abs(h.x)),Math.round(Math.abs(h.y)));this.history.begin("page","update",this,["angle","width","height","x","y","scale"],function(t,e,i,s){t.scale&&(a.scale.x=t.scale.x,a.scale.y=t.scale.y),i&&i.fited&&(a.fitTo=i.to),this.rotatePage(t.angle,!1)},{fited:l&&l.fited,to:l&&l.to}),this.exec(function(){AbCommon.tween({caller:this,start:0,end:1,easing:this.ROTATE_ANI_EASING,duration:this.ROTATE_ANI_DURATION,animating:s&&this.enableAnimate,proc:function(t,i,s){if(l&&l.fited){i.end-t;a.scale.x=l.scale+(l.ratio-l.scale)*t,a.scale.y=l.scale+(l.ratio-l.scale)*t}this.rotatePage(n+e*t,!1,!1),l&&l.fited?this.center(l.canvas.width,l.canvas.height):this.center(),this.render()},ended:function(t){this.rotatePage(r,!1),this.history.end(this),this.animateStates.end("rotate"),"function"==typeof i&&this.exec(i),this.notifyObservers("rotate",{from:n,to:r}),this.modified()}})})}return this.currentPage.angle},rotatePage:function(t,e,i){1==arguments.length&&(e=!0),AbCommon.isBool(i)||(i=!0);var s=this.currentPage,n=0;if(n=e?t:t-s.angle,0!=n){var r=s.angle;s.angle=AbGraphics.angle.increase(s.angle,n);var a=(s.image(),s.sourceSize()),o=a.width,h=a.height,l=AbGraphics.angle.point(s.angle,0,0,o,h);s.width=Math.round(Math.abs(l.x)),s.height=Math.round(Math.abs(l.y));for(var c=AbGraphics.angle.correctDisplayCoordinate(r,o,h,!1),u=AbGraphics.angle.correctDisplayCoordinate(s.angle,o,h,!1),d=s.shapes.length,p=0;p<d;p++){var g=s.shapes[p];if("line"==g.shapeStyle){var f=AbGraphics.angle.rect(-r,0,0,g.x1+c.x,g.y1+c.y,g.x2+c.x,g.y2+c.y);f=AbGraphics.angle.rect(s.angle,0,0,f.x1,f.y1,f.x2,f.y2),g.rect(f.x1-u.x,f.y1-u.y,f.x2-u.x,f.y2-u.y)}else{var m=g.center(),b=AbGraphics.angle.point(-r,0,0,m.x+c.x,m.y+c.y),y=AbGraphics.angle.point(-r,0,0,g.x+c.x,g.y+c.y);b=AbGraphics.angle.point(s.angle,0,0,b.x,b.y),y=AbGraphics.angle.point(s.angle,0,0,y.x,y.y),y=AbGraphics.angle.point(-n,b.x,b.y,y.x,y.y),g.box(y.x-u.x,y.y-u.y,g.width,g.height),g.setAngle(AbGraphics.angle.increase(g.angle,n))}}i&&(this.imagePositioning(),this.render())}},scale:function(t,e,i,s,n,r){if(AbCommon.isBool(n)||(n=!0),AbCommon.isNumber(r)||(r=400),!this.currentPage)return 1;if(arguments.length){this.currentPage.fitTo=null,this.notifyObservers("fit",null);var a=this.doScale(t,e,i,s,n,r);if(a==-2)return!1;this.notifyObservers("scale",t)}return this.currentPage.scale.x},doScale:function(t,e,i,s,n,r,a){if(AbCommon.isBool(n)||(n=!0),AbCommon.isNumber(r)||(r=400),AbCommon.isBool(a)||(a=!0),!this.currentPage)return-1;if(!this.maniplatable())return-2;t<this.MIN_SCALE&&(t=this.MIN_SCALE);var o=this.currentPage;if(t==o.scale.x)return 0;var h=this.testContentView(),l=this.testContentView(t);if(AbCommon.isNumber(e)||(e=h.center.x),AbCommon.isNumber(i)||(i=h.center.y),this.animateStates.begin("scale"),h.inCanvas||l.inCanvas)AbCommon.tween({caller:this,start:o.scale.x,end:t,easing:this.SCALE_ANI_EASING,duration:r,animating:n&&this.enableAnimate,proc:function(t,e){o.scale.x=t,o.scale.y=t,this.center(h.canvas.width,h.canvas.height),a&&this.render()},ended:function(t){o.scale.x=t.end,o.scale.y=t.end,this.center(h.canvas.width,h.canvas.height),a&&this.render(),this.animateStates.end("scale"),"function"==typeof s&&this.exec(s)}});else{var c=h.horizInCanvas?h.center.x:e,u=h.vertInCanvas?h.center.y:i,d=o.fromCanvas(c,u);AbCommon.tween({caller:this,start:o.scale.x,end:t,duration:r,animating:n&&this.enableAnimate,proc:function(t,e){o.scale.x=t,o.scale.y=t;var i=o.toCanvas(d.x,d.y);this.move(-(i.x-c),-(i.y-u),!0,!1),this.render()},ended:function(t){o.scale.x=t.end,o.scale.y=t.end;var e=o.toCanvas(d.x,d.y);this.move(-(e.x-c),-(e.y-u),!0,!1),this.render(),this.animateStates.end("scale"),"function"==typeof s&&this.exec(s)}})}return 1},calcImagePosition:function(t,e,i,s){var n=this.currentPage;if(!n)return null;var r=!1,a=null,o=null,h=this.context.canvas,l=AbCommon.isNumber(t)?t:h.width,c=AbCommon.isNumber(e)?e:h.height;switch(AbCommon.isNumber(i)||(i=n.width),AbCommon.isNumber(s)||(s=n.height),l-=this.margin.horiz(),c-=this.margin.vert(),n.fitTo){case"in":a=i,o=s,r=!0;break;case"horiz":a=i,o=0,r=!0;break;case"vert":o=s,a=0,r=!0}var u=null,d=1;if(r){var p=AbGraphics.box.zoom(a,o,l,c);d=p.ratio,u=this.calcCenter(l,c)}else u=this.calcCenter();return{fited:r,to:n.fitTo,scale:n.scale.x,ratio:d,canvas:{width:l,height:c},origin:{width:i,height:s},page:{x:n.x,y:n.y,width:a,height:o},destPage:{x:u?u.x:n.x,y:u?u.y:n.y,width:a*d,height:o*d}}},imagePositioning:function(t,e,i){var s=this.currentPage;if(s&&!s.error){i||(i={});var n=i.animate===!0,r=i.callback,a=this.calcImagePosition(t,e);this.animateStates.begin("fit"),AbCommon.tween({caller:this,start:0,end:1,easing:i.easing||this.SCALE_ANI_EASING,duration:i.duration||this.SCALE_ANI_DURATION,animating:n&&this.enableAnimate,proc:function(t,e){a.fited?(s.scale.x=a.scale+(a.ratio-a.scale)*t,s.scale.y=a.scale+(a.ratio-a.scale)*t,this.center(a.canvas.width,a.canvas.height)):(s.x=(a.destPage.x-a.page.x)*t,s.y=(a.destPage.y-a.page.y)*t),this.render()},ended:function(t){a.fited?(s.scale.x=a.ratio,s.scale.y=a.ratio,this.center(a.canvas.width,a.canvas.height)):this.center(),this.animateStates.end("fit"),"function"==typeof r&&this.exec(r)}})}},fit:function(t){return arguments.length&&this.currentPage&&(this.currentPage.fitTo=t,this.imagePositioning(null,null,{animate:!0,callback:function(){this.render(),this.notifyObservers("fit",this.currentPage.fitTo)}})),this.currentPage?this.currentPage.fitTo:null},calcCenter:function(t,e){if(this.currentPage){arguments.length||(t=this.context.canvas.width,e=this.context.canvas.height,t-=this.margin.horiz(),e-=this.margin.vert());var i=this.currentPage,s=(i.image(),i.sourceSize()),n=s.width*i.scale.x,r=s.height*i.scale.y,a=i.x,o=i.y;if(i.angle){var h=AbGraphics.angle.bounds(i.angle,0,0,n,r);n=h.width,r=h.height}var l=0;return AbCommon.isNumber(t)&&(l=t>>1,a=Math.round(l-(n>>1))),AbCommon.isNumber(e)&&(l=e>>1,o=Math.round(l-(r>>1))),{x:a,y:o}}},center:function(t,e){var i=this.calcCenter.apply(this,arguments);if(i){var s=this.currentPage;s.x=i.x,s.y=i.y}},move:function(t,e,i,s){if(this.currentPage){AbCommon.isBool(s)||(s=!0);var n=this.currentPage,r=n.x,a=n.y,o=this.context.canvas,h=o.width,l=o.height;h-=this.margin.horiz(),l-=this.margin.vert();var c=n.width*n.scale.x,u=n.height*n.scale.y,d=n.x,p=n.y;i?(d+=t,p+=e):(d=t,p=e);var g=c>h,f=u>l;g?d>0?d=0:d+c<h&&(d=h-c):d=(h>>1)-(c>>1),f?p>0?p=0:p+u<l&&(p=l-u):p=(l>>1)-(u>>1),n.x=d,n.y=p,!s||r==n.x&&a==n.y||this.render()}},copy:function(){this.currentPage&&this.maniplatable()&&(this.clipboard.copy(this,this.currentPage,this.selectedShapes),this.notifyObservers("clipboard","copy"))},cut:function(){this.currentPage&&this.maniplatable()&&(this.clipboard.cut(this,this.currentPage,this.selectedShapes),this.notifyObservers("clipboard","cut"))},paste:function(t){this.currentPage&&this.maniplatable()&&this.clipboard.paste(this,this.currentPage,function(){this.notifyObservers("clipboard","paste"),AbCommon.isFunction(t)&&t()}.bind(this))},undo:function(){this.maniplatable()&&this.history.canUndo()&&(this.notifyObservers("history","undoing"),this.history.undo(this),this.notifyObservers("history","undo"))},redo:function(){this.maniplatable()&&this.history.canRedo()&&(this.notifyObservers("history","redoing"),this.history.redo(this),this.notifyObservers("history","redo"))},getShape:function(t,e){for(var i=this.currentPage.shapes.length-1;i>=0;i--){var s=this.currentPage.shapes[i];if(this.isVisibleShapeType(s.type)&&s.contains(t,e,this.viewContext))return s}return null},deleteShapes:function(t){if(this.currentPage&&this.maniplatable()){arguments.length||(t=!0),this.history.begin("shape","remove",this);for(var e=this.currentPage,i=e.shapes.length-1;i>=0;i--){var s=e.shapes[i];s.selected&&e.shapes.splice(i,1)}this.selectedShapes.splice(0,this.selectedShapes.length),this.focusedShape=!1,this.history.end(this),t&&this.render(),this.notifyObservers("shape","delete"),this.modified()}},focusShape:function(t){this.focusedShape&&(this.focusedShape.focused=!1),t.focused=!0,t.selected=!0,this.focusedShape=t},selectShape:function(t){this.focusShape(t),this.selectedShapes.push(t)},unselectShape:function(t){var e=t.focused,i=this.getIndexOfSelection(t);i>=0&&this.selectedShapes.splice(i,1),t.selected=!1,t.focused=!1,e&&(this.focusedShape=null,this.selectedShapes.length&&this.focusShape(this.selectedShapes[this.selectedShapes.length-1]))},getIndexOfSelection:function(t){for(var e=this.selectedShapes.length-1;e>=0;e--)if(this.selectedShapes[e]==t)return e;return-1},getContainsSelection:function(t,e){for(var i=this.selectedShapes.length,s=0;s<i;s++){var n=this.selectedShapes[s];if(n.contains(t,e,this.viewContext))return n}return null},resizableShape:function(t){return"line"!=t.shapeStyle},resizeSelection:function(t,e,i){AbCommon.isBool(i)||(i=!0);var s=this.currentPage,n=this.selectedShapes.length,r=this.selection.editTarget.editPos(this.selection.edit),a=this.selection.editTarget.resize(this.selection.edit,t,e),o=this.resizableShape(this.selection.editTarget);if(a)for(var h={x:a.x-r.x,y:a.y-r.y},l=0;l<n;l++){var c=this.selectedShapes[l];if(c!=this.selection.editTarget)if("A"==this.selection.edit)c.setAngle(AbGraphics.angle.increase(c.angle,a));else if(o&&this.resizableShape(c)){var u=c.editPos(this.selection.edit),d=c.center();d=s.toCanvas(d.x,d.y);var p=AbGraphics.angle.point(c.angle,d.x,d.y,u.x+h.x,u.y+h.y);p=s.fromCanvas(p.x,p.y),c.resize(this.selection.edit,p.x,p.y)}}i&&this.render()},select:function(t){if(this.currentPage&&this.maniplatable()){var e=!0,i=null;AbCommon.isBool(t)?(i={},e=t):arguments.length?(i=t||{},AbCommon.isBool(i.rendering)&&(e=i.rendering)):i={},i.additional||this.selectedShapes.splice(0,this.selectedShapes.length);var s=this.selectedShapes.length,n=null;if(this.selection.dragged()){i.additional||(this.focusedShape=null);for(var r=this.selection.box(),a=this.currentPage.shapes.length-1;a>=0;a--){var o=this.currentPage.shapes[a];this.isVisibleShapeType(o.type)&&(o.contains(r.x,r.y,r.width,r.height,this.viewContext)?(o.selected=!0,this.selectedShapes.push(o),i.additional||(n?o.focused=!1:(n=o,o.focused=!0,this.focusedShape=o))):i.additional||(o.selected=!1,o.focused=!1))}}else{var h=this.selection.end.x,l=this.selection.end.y;i.additional||(this.focusedShape=null);for(var a=this.currentPage.shapes.length-1;a>=0;a--){var o=this.currentPage.shapes[a];this.isVisibleShapeType(o.type)&&(!n&&o.contains(h,l,this.viewContext)?(o.selected=!0,this.selectedShapes.push(o),i.additional||(o.focused=!0,this.focusedShape=o),n=o):i.additional||(o.selected=!1,o.focused=!1))}}e&&this.render();var c=this.selectedShapes.length;c-s>0&&this.notifyObservers("shape","select")}},unselect:function(t){if(!this.currentPage||!this.maniplatable())return!1;var e=this.selectedShapes.length>0,i=!0,s=null;AbCommon.isBool(t)?(s={},i=t):arguments.length?(s=t||{},AbCommon.isBool(s.rendering)&&(i=s.rendering)):s={},this.selectedShapes.splice(0,this.selectedShapes.length),s.unfocusOnly?this.selectedShapes.push(this.focusedShape):this.focusedShape=null;for(var n=this.currentPage.shapes.length-1;n>=0;n--){var r=this.currentPage.shapes[n];s.unfocusOnly===!0&&r==this.focusedShape||(r.selected=!1,r.focused=!1)}return i&&this.render(),e&&this.notifyObservers("shape","unselect"),e},unselectUnfocus:function(){if(this.currentPage&&this.maniplatable()){AbCommon.isBool(rendering)||(rendering=!0),this.selectedShapes.splice(0,this.selectedShapes.length),this.focusedShape=null;for(var t=this.currentPage.shapes.length-1;t>=0;t--){var e=this.currentPage.shapes[t];e.selected=!1,e.focused=!1}rendering&&this.render()}},selectAll:function(t){if(this.currentPage&&this.maniplatable()){AbCommon.isBool(t)||(t=!0),this.selectedShapes.splice(0,this.selectedShapes.length),this.focusedShape=null;for(var e=this.currentPage.shapes.length-1;e>=0;e--){var i=this.currentPage.shapes[e];this.isVisibleShapeType(i.type)&&(i.selected=!0,i.focused=!1,this.selectedShapes.push(i),0==e&&(i.focused=!0,this.focusedShape=i))}t&&this.render(),this.selectedShapes.length&&this.notifyObservers("shape","selectAll")}},historySync:function(t,e,i,s,n){this.notifyObservers("history.sync",{topic:t,cmd:e,docmd:i,data:s},n)},pageInserted:function(t){this.currentPageIndex>=0&&this.currentPageIndex>=t&&this.currentPageIndex++},pageRemoved:function(t){this.currentPageIndex>=0&&this.currentPageIndex>=t&&this.currentPageIndex--},clearPages:function(){this.selectedShapes.splice(0,this.selectedShapes.length),this.focusedShape=null,this.pages.clear(!0),this.currentPage=null,this.currentPageIndex=-1},removePages:function(t,e){if(this.maniplatable()&&t&&$.isArray(t)){AbCommon.isBool(e)||(e=!0);var i=this.currentPageIndex,s=!1;e&&this.history.begin("page","remove",this,t),t.sort(function(t,e){return t-e});for(var n=[],r=t.length-1;r>=0;r--){var a=t[r];a==i&&(s=!0);var o=this.pages.splice(a,1);n.push({index:a,page:o})}return e&&this.history.end(this),this.notifyObservers("page.remove",n),s&&(this.pages.length()?(this.currentPage=null,this.currentPageIndex=-1,i>=this.pages.length()&&(i=this.pages.length()-1),this.selectPage(i)):this.unselectPage()),n}},removePageRange:function(t,e,i){for(var s=[],n=this.pages.length()-1,r=t;r<=e;r++)r>=0&&r<=n&&s.push(r);s.length&&this.removePages(s,i)},removePage:function(t){this.currentPage&&this.removePages([this.currentPageIndex],t)},addPage:function(t,i,s){if(t&&this.maniplatable()&&t instanceof AbPage){if(AbCommon.isBool(i)||(i=!0),AbCommon.isBool(s)||(s=!0),s&&this.history.begin("page","add",this),this.pages.push(t),i===!0&&(this.currentPageIndex=this.pages.length()-1,this.currentPage=t,t.shapes.length))for(var n=t.shapes.length,r=0;r<n;r++){var a=t.shapes[r];a.engine=this,e.measure()}s&&this.history.end(this),this.notifyObservers("page","add")}},selectable:function(t){return AbCommon.isNumber(t)||(t=parseInt(t)),t>=0&&t<this.pages.length()},selectPage:function(){if(arguments.length&&this.maniplatable()){var t=arguments[0],e=arguments[1]===!0;if(this.pages.length()<1)this.currentPage=null,this.currentPageIndex=-1;else if(AbCommon.isNumber(t)||(t=parseInt(t)),this.selectable(t)){var i=e||this.currentPageIndex!=t;if(i){var s=this.pages.get(t);if(s.error||s.editable()){if(this.currentPageIndex=t,this.currentPage=s,this.focusedShape=null,this.selectedShapes.splice(0,this.selectedShapes.length),this.currentPage.shapes.length)for(var n=this.currentPage.shapes.length,r=0;r<n;r++){var a=this.currentPage.shapes[r];a.selected&&this.selectedShapes.push(a),a.focused&&(this.focusedShape=a)}this.imagePositioning(),this.render()}else this.notifyObservers("request.select",t)}this.enableNotifySelectPage===!0&&this.notifyObservers("page","select")}}return this.currentPage},unselectPage:function(t){AbCommon.isBool(t)||(t=!0),this.currentPage=null,this.currentPageIndex=-1,t&&this.render(),this.notifyObservers("page","unselect")},refresh:function(){this.currentPage&&(this.imagePositioning(),this.render())},removeAllPageShapes:function(t){t||(t={});var e=t.history;AbCommon.isBool(e)||(e=!0),this.exec(function(){e&&this.history.begin("shape","all",this);for(var i=[],s=this.pages.length()-1;s>=0;s--){var n=this.pages.get(s),r=n.shapes;r.length&&(r.splice(0,r.length),i.unshift({index:s,page:n}))}e&&this.history.end(this),this.render(),this.notifyObservers("shape","all.remove"),this.modified(),AbCommon.isFunction(t.end)&&t.end(i)})},removeRangePageShapes:function(t,e){e||(e={});var i=e.history;AbCommon.isBool(i)||(i=!0),this.exec(function(){i&&this.history.begin("shape","range",this,t);for(var s=[],n=t.length-1;n>=0;n--){var r=t[n],a=r.shapes;a.length&&(a.splice(0,a.length),s.unshift({index:n,page:r}))}i&&this.history.end(this),this.render(),this.notifyObservers("shape","range.remove"),this.modified(),AbCommon.isFunction(e.end)&&e.end(s)})},addShape:function(){if(arguments.length&&this.currentPage){var t=arguments[0],e=this.shapeObject(t);if(e){var i=!1,s=null;if(arguments.length>=2?AbCommon.isBool(arguments[1])?(i=arguments[1],s={}):(s=arguments[1]||{},i=s.creation||!1):s={},AbCommon.isString(t)&&(i=!0),i)this.maniplatable()&&(this.selection.target=t);else{var n=this.currentPage;this.history.begin("shape","add",this),n.shapes.push(e),this.history.end(this),e.engine=this,e.measure(),this.notifyObservers("shape.add",e)}}}},restoreSelection:function(){if(this.selection.drawed){var t=this.viewContext;t.save();var e=this.selection.drawed;e.x+=this.margin.left,e.y+=this.margin.top;var i=t.globalAlpha;t.globalAlpha=1;var s=(this.currentPage,this.selection.style&&this.selection.style.stroke?this.selection.style.stroke.width:1),n=AbGraphics.box.inflate(e.x,e.y,e.width,e.height,s);this.paintRect(n.x,n.y,n.width,n.height),this.selection.drawed=null,t.globalAlpha=i,t.restore()}},drawSelection:function(){var t=this.viewContext,e=this.selection.box(),i=this.currentPage;e=i.toCanvasBox(e),t.save(),t.translate(this.margin.left,this.margin.top),this.selection.style.color&&(t.fillStyle=this.selection.style.color,t.fillRect(e.x,e.y,e.width,e.height)),this.selection.style.stroke&&(t.strokeStyle=this.selection.style.stroke.color,t.lineWidth=this.selection.style.stroke.width,t.strokeRect(e.x,e.y,e.width,e.height)),t.restore(),this.selection.drawed=e},drawCreation:function(){var t=this.currentPage,e=this.viewContext;e.save();var i=t.toCanvas(0,0);e.translate(i.x,i.y),e.translate(this.margin.left,this.margin.top);var s=this.shapeObject(this.selection.target),n=AbCommon.supportCreationDraw(s);if(n?s.creationDraw(e,t,this.selection):(s.hasOwnProperty("creationAlpha")&&(e.globalAlpha=s.creationAlpha),s.hasOwnProperty("creationSize")&&"auto"===s.creationSize||s.rect(this.selection.start.x,this.selection.start.y,this.selection.end.x,this.selection.end.y),s.draw(e,t,!0)),s&&AbCommon.supportRestoreMinimumSize(s)){var r=s.restoreMinimumSize();r.width*=t.scale.x,r.height*=t.scale.y;var a=t.toCanvasBox(s.box());this.selection.drawed=AbGraphics.box.inflate(a.x,a.y,a.width,a.height,r.width,r.height)}else this.selection.drawed=t.toCanvasBox(s.box());e.restore()},drawError:function(){var t=(this.currentPage,this.viewContext);t.save(),t.restore()},renderThumbnail:function(t,e){if(arguments.length<=1&&(e=this.currentPage),AbCommon.isNumber(e)){if(e<0||e>=this.pages.length())return;e=this.pages.get(e)}if(!e.error){var i=e.image();t.resize(e.width,e.height);var s=t.context;s.clearRect(0,0,s.canvas.width,s.canvas.height);var i=e.originThumbnail();if(i||(i=e.image()),i){var n=this.currentPage;this.currentPage=e;var r=e.sourceSize(),a=Math.round(r.width*t.ratio),o=Math.round(r.height*t.ratio);if(s.save(),e.angle){var h=AbGraphics.angle.correctDisplayCoordinate(e.angle,a,o);s.rotate(AbGraphics.angle.deg2rad(e.angle)),s.translate(-h.x,-h.y),s.drawImage(i,0,0,a,o)}else s.drawImage(i,0,0,a,o);s.restore(),this.isVisibleShapeType()&&e.drawOrigin(s,{scale:t.ratio,showingShapeTypeMap:this.showingShapeTypeMap}),this.currentPage=n}}},renderImage:function(t,e,i,s){if(arguments.length<=1&&(e=this.currentPage),arguments.length<=2&&(i=this.showingShapes),arguments.length<=3&&(s=this.showingShapeTypeMap),AbCommon.isNumber(e)){if(e<0||e>=this.pages.length())return;e=this.pages.get(e)}if(!e.error){var n=e.width,r=e.height;if(!e.editable()){var a=e.sourceSize();n=a.width,r=a.height}t.canvas.width=n,t.canvas.height=r,t.clearRect(0,0,t.canvas.width,t.canvas.height);var o=e.image();if(o){var h=this.currentPage;this.currentPage=e;var a=e.sourceSize(),l=a.width,c=a.height;if(t.save(),e.angle){var u=AbGraphics.angle.correctDisplayCoordinate(e.angle,l,c);t.rotate(AbGraphics.angle.deg2rad(e.angle)),t.translate(-u.x,-u.y),t.drawImage(o,0,0)}else t.drawImage(o,0,0);t.restore(),this.drawableWaterMark()&&this.waterMark.draw(t,1,n,r),i&&e.drawOrigin(t,{showingShapeTypeMap:s}),this.currentPage=h}}},drawableWaterMark:function(){return this.waterMark&&this.waterMark.drawable()},render:function(t,e){this.context&&(arguments.length||(t=!0),AbCommon.isBool(e)||(e=!1),this.exec(function(){var i=this.context,s=this.currentPage;if(s&&!s.error){var n=this.runtime;this.runtime=!0,i.save(),this.clearCanvas(i),i.translate(s.x,s.y),i.translate(this.margin.left,this.margin.top);var r=s.image({origin:!0});if(r){var a=s.angle,o=0,h=0,l=s.sourceSize(),c=l.width*s.scale.x,u=l.height*s.scale.y,d=s.width,p=s.height;if(i.save(),a){var g=AbGraphics.angle.bounds(a,0,0,l.width,l.height);d=g.width,p=g.height;var f=AbGraphics.angle.correctDisplayCoordinate(a,c,u);i.translate(o,h),i.rotate(AbGraphics.angle.deg2rad(a)),i.translate(-f.x,-f.y),i.drawImage(r,0,0,c,u)}else i.drawImage(r,0,0,c,u);i.restore()}this.drawableWaterMark()&&this.waterMark.draw(i,s.scale.x,{source:{width:l.width*s.scale.x,height:l.height*s.scale.x},view:{width:d*s.scale.x,height:p*s.scale.y}}),this.isVisibleShapeType()&&s.drawShapes(i,{showingShapeTypeMap:this.showingShapeTypeMap}),i.restore(),this.runtime=n}else this.clearCanvas(i);t&&this.paint(e)}))},clearCanvas:function(t){this.style.color?(t.fillStyle=this.style.color,t.fillRect(0,0,t.canvas.width,t.canvas.height)):t.clearRect(0,0,t.canvas.width,t.canvas.height)},paintRect:function(t,e,i,s){if(t<0&&(i-=t,t=0),e<0&&(s-=e,e=0),!(i<=0||s<=0)){var n=this.viewContext;this.style.color||n.clearRect(t,e,i,s),n.drawImage(this.context.canvas,t,e,i,s,t,e,i,s)}},paint:function(t){if(AbCommon.isBool(t)||(t=!1),t||this.animateStates.$engine!==!0){var e=this.runtime;t&&(this.runtime=!0);var i=this.viewContext;this.style.color||this.clearCanvas(i),i.drawImage(this.context.canvas,0,0),t&&(this.runtime=e)}},animate:function(){var t=AbCommon.requestAnimFrame();if("function"==typeof t){this.animateStates.$engine=!0,this.notifyObservers("animate.engine",!0);var e=function(i){var s=arguments.callee.self;if(!s.runtime){var n=s.viewContext;
s.clearCanvas(n),n.drawImage(s.context.canvas,0,0)}this.ani=t(e)};e.self=this,this.ani=t(e)}},stop:function(){var t=AbCommon.cancelAnimFrame();this.ani&&t(this.ani),this.animateStates.$engine=!1,this.notifyObservers("animate.engine",!1)},toBlob:function(t){return AbGraphics.canvas.toBlob(this.context)},zIndex:function(t){if(this.currentPage&&this.maniplatable()&&(this.selectedShapes.length||this.focusedShape)){switch(t){case"top":case"up":case"down":case"bottom":break;default:return}var e=this.currentPage;if(this.history.begin("shape","zindex",this,t),"top"==t||"bottom"==t){for(var i=[],s=e.shapes.length-1;s>=0;s--)if(e.shapes[s].selected){var n=e.shapes.splice(s,1);n.length&&i.unshift(n[0])}"top"==t?Array.prototype.push.apply(e.shapes,i):Array.prototype.unshift.apply(e.shapes,i)}else if("up"==t||"down"==t){for(var i=[],s=e.shapes.length-1;s>=0;s--)e.shapes[s].selected&&i.unshift(s);if("up"==t)for(var s=i.length;s>=0;s--){var r=i[s];if(r+1==e.shapes.length)break;var a=e.shapes[r+1];e.shapes[r+1]=e.shapes[r],e.shapes[r]=a}else for(var o=i.length,s=0;s<o;s++){var r=i[s];if(0==r)break;var a=e.shapes[r-1];e.shapes[r-1]=e.shapes[r],e.shapes[r]=a}}this.history.end(this),this.exec(function(){this.render()})}}},AbToolbar.prototype={constructor:AbToolbar,observe:function(t){this.observers.push(t)},stopObserve:function(t){var e=this.observers.indexOf(t);e>=0&&this.observers.splice(e,1)},notifyObservers:function(t,e,i){setTimeout(function(){for(var s=this.observers.length,n=0;n<s;n++){var r=this.observers[n];"function"==typeof r?r(this,t,e,i):"function"==typeof r.toolbarNotify&&r.toolbarNotify(this,t,e,i)}}.bind(this),0)},groupObserve:function(t){this.groupObservers.push(t)},stopGroupObserve:function(t){var e=this.groupObservers.indexOf(t);e>=0&&this.groupObservers.splice(e,1)},notifyGroupObservers:function(t,e){setTimeout(function(){for(var i=this.groupObservers.length,s=0;s<i;s++){var n=this.groupObservers[s];"function"==typeof n?n(this,t,e):"function"==typeof n.toolbarGroupNotify&&n.toolbarGroupNotify(this,t,e)}}.bind(this),0)},prepare:function(){for(var t=this.e.find("[tb-type]"),e=t.length,i=0;i<e;i++){var s=t.get(i),n=$(s),r=n.attr("tb-topic"),a=n.attr("tb-type"),o=n.attr("tb-group"),h=n.attr("tb-hover");if(r){h&&n.find("img.tb-btn").length&&(this.imageHoverTopics.push(r),n.mouseover(this.mouseoverHandler),n.mouseout(this.mouseoutHandler)),this.topics[r]=n;var l="checked"===n.attr("tb-status");if(this.topicGroups[o]){var c=this.topicGroups[o];l&&(c.selected=n),c.topics.push(n)}else this.topicGroups[o]={selected:l?n:null,topics:[n]};switch(this.topicTypes[a]?this.topicTypes[a].push(n):this.topicTypes[a]=[n],a){case"text":n.keydown(this.keydownHandler),n.keyup(this.keyupHandler),n.change(this.inputChangeHandler);break;case"select":n.change(this.changeHandler);break;default:n.click(this.clickHandler)}}}},mouseOver:function(t){for(var e=t.find("img.tb-btn"),i=e.length,s=0;s<i;s++){var n=$(e.get(s));n.attr("tb-origin")||n.attr("tb-origin",n.attr("src")),n.attr("src",t.attr("tb-hover"))}},mouseOut:function(t){for(var e=t.find("img.tb-btn"),i=e.length,s=0;s<i;s++){var n=$(e.get(s));n.attr("tb-origin")&&n.attr("src",n.attr("tb-origin"))}},click:function(t,e,i){AbCommon.isBool(i)||(i=!0);var s=this.topics[t],t=s.attr("tb-topic"),n=this.toolbarType(s);if("radio"==n){var r=s.attr("tb-group"),a=(s.attr("tb-status"),this.topicGroups[r]),o="checked"===s.attr("tb-status");if(e!=o){null!=a.selected&&a.selected.attr("tb-topic")==t;o?(this.uncheckedGroup(r),i===!0&&(this.notifyObservers(t,!1,s),this.notifyGroupObservers(r,!1))):(null!=a.selected?(a.selected.attr("tb-status",null),a.selected=null):i===!0&&this.notifyGroupObservers(r,!0),s.attr("tb-status","checked"),a.selected=s,i===!0&&this.notifyObservers(t,!0,s))}}else if("check"==n){var o="checked"===s.attr("tb-status");o!=e&&(s.attr("tb-status",e?"checked":null),i===!0&&this.notifyObservers(t,e,s))}else i===!0&&this.notifyObservers(t,null,s)},change:function(t,e,i){this.notifyObservers(t,e,i?i:null)},uncheckedGroup:function(t){for(var e=this.topicGroups[t],i=e.topics.length,s=0;s<i;s++)e.topics[s].attr("tb-status","");e.selected=null},toolbarType:function(t){var e=t?t.attr("tb-type"):null;if("radio"==e){var i=t.attr("tb-group");i&&this.topicGroups[i]||(e="check")}return e},setTopic:function(t){var e=t.attr("tb-type");if("radio"==e){var i=t.attr("tb-group");i&&this.topicGroups[i]||(e="check")}return e},set:function(t,e,i){AbCommon.isBool(i)||(i=!0);var s=this.topics[t],n=this.toolbarType(s);switch(n){case"radio":case"check":this.click(t,e,i);break;case"label":s.text(e),i&&this.notifyObservers(t,e,null);break;case"text":s.val(e),s.attr("tb-origin-value",e),i&&this.notifyObservers(t,e,null);break;case"select":if(s.length&&(s.val(e),e&&e.indexOf("%")>=0&&s.get(0).selectedIndex==-1)){var r=s.children(":first");r.text(e),s.get(0).selectedIndex=0}}},get:function(t){var e=this.topics[t],i=this.toolbarType(e);switch(i){case"radio":case"check":return"checked"===e.attr("tb-status");case"label":return e.text();case"text":case"select":return e.val()}return null},forEach:function(t){if(AbCommon.isFunction(t))for(var e in this.topics){var i=this.get(e);t(e,i)}},enableTopic:function(t,e){function i(t,e){if(t&&t.length){var i=t.get(0),s=i.tagName.toLowerCase();"input"==s||"select"==s||"textarea"==s?t.attr("disabled",!e):t.attr("tb-enabled",e?"enabled":"disabled")}}if($.isArray(t))for(var s=t.length,n=0;n<s;n++)i(this.topics[t[n]],e);else i(this.topics[t],e)}},AbImageListView.prototype={constructor:AbImageListView,observe:function(t){this.observers.push(t)},stopObserve:function(t){var e=this.observers.indexOf(t);e>=0&&this.observers.splice(e,1)},notifyObservers:function(t,e,i){this.exec(function(){for(var s=this.observers.length,n=0;n<s;n++){var r=this.observers[n];"function"==typeof r?r(this,t,e,i):"function"==typeof r.listViewNotify&&r.listViewNotify(this,t,e,i)}})},exec:function(t,e){e||(e=0),setTimeout(t.bind(this),e)},notify:function(t,e,i){switch(this.bookmark?this.notifyRelative(t,e,i):this.notifyAbsolute(t,e,i),e){case"page.select":this.enabled()&&this.select(i);break;case"collection.changed":if(this.enabled()){AbCommon.isSetted(i)||(i=!0);var s=!!AbCommon.isBool(i)&&i,n=this.length();if(n){var r=this.selectedIndex;(r<0||r>=n)&&(this.selectedIndex=r=0);var a=this.children[r];a&&s&&this.selecting.auto&&this.notifyObservers("select",a.attr("lt-uid"))}else s&&this.selecting.auto&&this.notifyObservers("unselect")}break;case"modified":var o=this.map[i.uid];if(o){this.topic(o,"image").attr("src",i.data);var h=this.pages.getById(i.uid);h&&(h.hasShapes()?this.topic(o,"annotation").show():this.topic(o,"annotation").hide())}}},notifyRelative:function(t,e,i){var s=0,n=null,r=null;switch(e){case"bookmark.add":this.pager.totalCount(this.length()),this.updateViewSize(),r=this.pages.getById(i),s=this.insertListItem(r),this.update(this.selectedIndex>=0?"current":"first"),this.topic(this.children[s],"bookmark").prop("checked",!0),r.status==AbPage.prototype.LOADED&&this.listItemImage(i);break;case"bookmark.remove":this.removeListItem(i);this.pager.totalCount(this.length()),this.updateViewSize(),this.update(this.selectedIndex>=0?"current":"first"),this.enabled()&&0==this.length()&&this.notifyObservers("unselect");break;case"page.loaded":u=i.page.uid,n=this.map[u],n&&"loaded"!==n.attr("lt-status")&&this.listItemImage(u);break;case"page.remove":this.removeBookmarks();break;case"page.remove.list":var a=[],o=this.selectedIndex,h=o,l=!1;this.unselect();for(var c=i.pages.length-1;c>=0;c--){var u=i.pages[c].uid,d=this.pages.indexOf(u);d<0||(a.push(d),delete this.map[u],this.pages.removeById(u))}a.sort(function(t,e){return t-e});for(var c=a.length-1;c>=0;c--){var d=a[c];o>=0&&(o==d?(l=!0,o=h):o>d&&o--),this.children.splice(d,1)}o>=this.children.length&&(o=this.children.length-1),this.selectedIndex=o,this.pager.totalCount(this.children.length),this.updateViewSize(),this.update(this.selectedIndex>=0?"current":"first"),this.enabled()&&0==this.length()&&this.notifyObservers("unselect");break;case"history.sync":switch(i.topic){case"page":switch(i.cmd){case"add":switch(i.docmd){case"undo":for(var c=i.data.length-1;c>=0;c--){var p=i.data[c],u=p.source.uid;n=this.map[u],n&&(s=this.pages.indexOf(u),this.children.splice(s,1),delete this.map[u])}this.pager.totalCount(this.length()),this.updateViewSize(),this.pager.prepare(),this.reload("current"),this.notifyObservers("history.sync.end",i);break;case"redo":}break;case"remove":switch(i.docmd){case"undo":break;case"redo":for(var c=i.data.length-1;c>=0;c--){var p=i.data[c],u=p.source.uid;n=this.map[u],n&&(s=this.pages.indexOf(u),this.children.splice(s,1),delete this.map[u])}this.pager.totalCount(this.length()),this.updateViewSize(),this.pager.prepare(),this.reload("current"),this.notifyObservers("history.sync.end",i)}}}}},pageLoadCount:0,notifyAbsolute:function(t,e,i){var s=0,n=null,r=null;switch(e){case"pages":this.pager.totalCount(this.length()),this.updateViewSize(),this.update(this.selectedIndex>=0?"current":"first"),this.enabled()&&0==this.length()&&this.notifyObservers("unselect");break;case"page.add":this.insertListItem(i.page);break;case"page.loading":this.map[i].attr("lt-status","loading");break;case"page.loaded":r=i.page.uid,s=i.index,this.listItemImage(s),n=this.map[r],n.attr("lt-status","loaded"),i.hasOwnProperty("select")&&i.select&&this.selecting.auto&&this.notifyObservers("select",n.attr("lt-uid"));break;case"page.error":this.map[i].attr("lt-status","error");break;case"bookmark.add":this.topic(this.map[i],"bookmark").prop("checked",!0);break;case"bookmark.remove":this.topic(this.map[i],"bookmark").prop("checked",!1);break;case"bookmark.remove.list":for(var a=i.length-1;a>=0;a--){var o=this.map[i[a]],h=this.topic(o,"bookmark");h.prop("checked",!1)}break;case"page.remove":this.removeList();break;case"page.remove.list":var l=i.pages,c=this.selectedIndex;this.unselect();for(var a=l.length-1;a>=0;a--){var u=l[a];s=u.index,c>=0&&c>=u.index&&c--,n=this.children.splice(s,1),n.length&&(r=n[0].attr("lt-uid"),u.uid=r)}c>=this.children.length&&(c=this.children.length-1),this.pager.totalCount(this.children.length),this.updateViewSize(),this.update(c>=0?c:"first"),this.enabled()&&0==this.length()&&this.notifyObservers("unselect");break;case"history.sync":switch(i.topic){case"page":switch(i.cmd){case"add":switch(i.docmd){case"undo":this.unselect();for(var a=i.data.length-1;a>=0;a--){var u=i.data[a],r=u.source.uid;this.children.splice(u.index,1),delete this.map[r]}this.pager.totalCount(this.length()),this.updateViewSize(),this.pager.prepare(),this.reload("nothing"),this.notifyObservers("history.sync.end",i);break;case"redo":this.unselect();for(var d=i.data.length,a=0;a<d;a++){var u=i.data[a];this.insertListItem(u.source,u.index),this.listItemImage(u.index)}this.pager.totalCount(this.length()),this.updateViewSize(),this.pager.prepare(),this.reload("nothing"),this.notifyObservers("history.sync.end",i)}break;case"remove":switch(i.docmd){case"undo":this.unselect();for(var d=i.data.length,a=0;a<d;a++){var u=i.data[a];this.insertListItem(u.source,u.index),this.listItemImage(u.index)}this.pager.totalCount(this.length()),this.updateViewSize(),this.pager.prepare(),this.reload("nothing"),this.notifyObservers("history.sync.end",i);break;case"redo":this.unselect();for(var a=i.data.length-1;a>=0;a--){var u=i.data[a],r=u.source.uid;this.children.splice(u.index,1),delete this.map[r]}this.pager.totalCount(this.length()),this.updateViewSize(),this.pager.prepare(),this.reload("nothing"),this.notifyObservers("history.sync.end",i)}}}}},scrollIntoElement:function(t){var e=this.listContainer.scrollTop(),i=e+t.position().top,s=i+t.height(),n=e+this.listContainer.height();(n<s||e>i)&&this.listContainer.scrollTop(s-this.listContainer.height())},topic:function(t,e){return t.find('[lt-topic="'+e+'"]')},length:function(){return this.pages.length()},startIndex:function(){return this.pager.startRow()},inPage:function(t){return this.pager.startRow()<=t&&t<this.pager.startRow()+this.pager.lineCount()},checkedAll:function(){return this.eCheckAll.is(":checked")},loadable:function(t){return t.status!=AbPage.prototype.LOADED&&t.loader},enabled:function(){return!this.e.hasClass("hide")},selected:function(t){return this.map[t].hasClass("selected")},removeBookmarks:function(){for(var t=[],e=this.renderedChildren.length,i=0;i<e;i++){var s=this.renderedChildren[i],n=this.topic(s,"check");if(n.is(":checked")){var r=s.index()+this.startIndex();t.push(r)}}if(t.length){var a=this.selectedIndex;this.unselect();for(var o=[],i=t.length-1;i>=0;i--){var h=t[i];a>=0&&a>=h&&a--;var l=this.children.splice(h,1);if(l.length){var c=l[0].attr("lt-uid");o.push(c)}}a>=this.children.length&&(a=this.children.length-1),this.pager.totalCount(this.children.length),this.updateViewSize(),this.update(a>=0?a:"first"),this.enabled()&&0==this.length()&&this.notifyObservers("unselect"),this.notifyObservers("bookmark.remove.list",o)}},selectedPages:function(){for(var t=[],e=this.renderedChildren.length,i=0;i<e;i++){var s=this.renderedChildren[i],n=this.topic(s,"check");if(n.is(":checked")){var r=s.index()+this.startIndex();t.push({index:r})}}if(!t.length)return t;for(var i=t.length-1;i>=0;i--){var a=t[i],o=a.index,h=this.children[o];if(h){var l=h.attr("lt-uid");a.uid=l}}return t},removeList:function(){var t=this.selectedPages();this.notifyObservers("page.remove.list",{pages:t})},removeListItem:function(t){var e=(this.map[t],-1),i=this.renderedMap[t];if(i){e=i.index()+this.startIndex(),i.detach();var s=$.inArray(i,this.renderedChildren);s>=0&&(this.renderedChildren.splice(s,1),this.renderedChecks.splice(s,1)),delete this.renderedMap[t]}else e=this.pages.indexOf(t);if(this.children.splice(e,1),delete this.map[t],this.selectedIndex>=0)if(e==this.selectedIndex){var n=this.children.length;if(e>=n)return this.selectedIndex=n-1,!0}else e<this.selectedIndex&&this.selectedIndex--;return!1},toggleAll:function(t){for(var e=this.renderedChecks.length,i=0;i<e;i++){var s=this.renderedChecks[i];s.prop("checked",t)}},changeView:function(t){"all"===t&&(t=-1),AbCommon.isNumber(t)||(t=parseInt(t)),isNaN(t)&&(t=0),this.viewSize=t,this.updateViewSize(),this.update()},canPrev:function(){var t=this.selectedIndex;return!(t<=0)},canNext:function(){var t=this.selectedIndex;return!(t<0||t+1>=this.length())},canGo:function(t){return t>=0&&t<this.length()},prev:function(){if(this.canPrev()){var t=this.selectedIndex;t--;var e=this.children[t],i=e.attr("lt-uid"),s=!0;s?this.selecting.auto&&this.notifyObservers("select",i):this.paging(this.pager.page()-1,"last")}},next:function(){if(this.canNext()){var t=this.selectedIndex;t++;var e=this.children[t],i=e.attr("lt-uid"),s=!0;s?this.selecting.auto&&this.notifyObservers("select",i):this.paging(this.pager.page()+1,"first")}},go:function(t){if(!this.canGo(t))return!1;this.children[t];if(this.inPage(t)){if(this.selectedIndex!=t){var e=this.children[t],i=e.attr("lt-uid"),s=!0;s?this.selecting.auto&&this.notifyObservers("select",i):this.reload(t)}}else{var n=this.pager.pageFromIndex(t);this.paging(n,t)}return!0},unselect:function(){this.selectedIndex>=0&&this.children[this.selectedIndex].removeClass("selected"),this.selectedIndex=-1},select:function(t){if(this.selecting.auto){var e=-1;e=AbCommon.isString(t)?this.pages.indexOf(t):t,this.selectedIndex!=e&&this.unselect();var i=this.pager.pageFromIndex(e);if(this.paging(i,"nothing"),e>=0){var s=this.children[e];s.addClass("selected"),this.scrollIntoElement(s)}this.selectedIndex=e,this.notifyObservers("selected",this.selectedIndex)}},reload:function(t){this.renderPageList(this.pager.page(),t)},paging:function(t,e){this.pager.page()!=t&&this.renderPageList(t,e)},clear:function(){this.clearRendered();for(var t in this.map)delete this.map[t];this.children.splice(0,this.children.length)},clearRendered:function(t){AbCommon.isBool(t)||(t=!0),t&&this.unselect();for(var e=this.renderedChildren.length,i=0;i<e;i++)this.renderedChildren[i].detach();for(var s in this.renderedMap)delete this.renderedMap[s];this.renderedChecks.splice(0,this.renderedChecks.length),this.renderedChildren.splice(0,this.renderedChildren.length)},createPager:function(){return new AbGridPager({template:{pageGapTemplate:""}})},updateViewSize:function(){this.pager.lineCount(this.viewSize<0?this.pager.totalCount():this.viewSize)},updatePageNavigation:function(){var t=this.pager.generate(function(t,e){switch(t){case"block.first":return'<a lt-topic="link" lt-page="'+e+'" class="block first"></a>';case"block.last":return'<a lt-topic="link" lt-page="'+e+'" class="block last"></a>';case"block.prev":return'<a lt-topic="link" lt-page="'+e+'" class="block prev"></a>';case"block.next":return'<a lt-topic="link" lt-page="'+e+'" class="block next"></a>';case"page.current":return'<li class="curpage"><a>'+e+"</a></li>";case"page":return'<li><a lt-topic="link" lt-page="'+e+'" class="page">'+e+"</a></li>";case"navigation":return e.total<=0?"":e.html.first+e.html.prev+'<ol class="pages">'+e.html.pages+"</ol>"+e.html.next+e.html.last}});this.ePagingArea.html(t)},update:function(t){AbCommon.isSetted(t)||(t="first");var e="nothing"!==t;"current"===t&&(t=this.selectedIndex),this.pager.reset(),this.pager.prepare(),this.pager.calculate(),this.renderList({select:{unselecting:"nothing"!==t,auto:e,relative:!1,criterion:t}}),this.updatePageNavigation()},renderPageList:function(t,e){AbCommon.isSetted(e)||(e="first");var i="nothing"!==e;"current"===e&&(e=this.selectedIndex),this.pager.page(t),this.pager.calculate(),this.renderList({select:{unselecting:"nothing"!==e,auto:i,relative:!1,criterion:e}}),this.updatePageNavigation()},renderList:function(t){t||(t={});var e=t.select||{},i=!e.hasOwnProperty("unselecting")||e.unselecting,s=!e.hasOwnProperty("auto")||e.auto,n=!e.hasOwnProperty("relative")||e.relative,r=e.hasOwnProperty("criterion")?e.criterion:"first",a=-1;i||(a=this.selectedIndex),this.clearRendered(i);var o=this.startIndex(),h=o+this.pager.lineCount();h>this.children.length&&(h=this.children.length);for(var l=this.checkedAll(),c=this.enabled(),u=0,d=0,p=o,g=0;p<h;p++,g++){var f=this.children[p],m=this.pages.getById(f.attr("lt-uid"));if(!m)return;var b=!1;if(s&&a<0&&c&&("first"===r&&0==g||"last"===r&&p+1==h||n&&r===g||!n&&r==p)&&(b=!0),this.loadable(m)){var y={index:p,page:m};b&&this.selecting.auto&&(y.select=!0),d++,this.notifyObservers("request.load",y)}else b&&this.selecting.auto&&this.notifyObservers("select",m.uid);var v=this.topic(f,"no");v.text(p+1+""),v=this.topic(f,"check"),v.prop("checked",l),this.renderedChecks.push(v),this.renderedChildren.push(f),this.renderedMap[m.uid]=f,this.listContainer.append(f),u++}this.notifyObservers("renderlist",{visible:u,loading:d})},insertListItem:function(t,e){var i=this.children.length,s=this.template.children(":eq(0)").clone(),n=t.thumbnail();return n&&this.topic(s,"image").attr("src",n.src),s.attr("lt-uid",t.uid),s.attr("lt-status",t.statusText()),this.topic(s,"no").text(i+1+""),this.topic(s,"check").val(t.uid),this.topic(s,"bookmark").bind("click",this.checkBookmarkHandler),s.bind("click",this.clickHandler),s.bind("dblclick",this.dblClickHandler),AbCommon.isNumber(e)?(i=e,this.children.splice(i,0,s)):this.children.push(s),this.map[t.uid]=s,i},listItemImage:function(t){var e=null,i=null,s="",n="";AbCommon.isNumber(t)?(e=this.children[t],i=this.pages.get(t)):(e=this.map[t],i=this.pages.getById(t));var r=i.info();r&&(s=r.name,n=r.text),null!=n&&void 0!=n||(n=s),null!=n&&void 0!=n||(n=""),this.topic(e,"text").text(n),e.attr("lt-status",i.statusText());var a=i.thumbnail();a&&this.topic(e,"image").attr("src",a.src),i.hasShapes()?this.topic(e,"annotation").show():this.topic(e,"annotation").hide(),i.hasImageInfo()?this.topic(e,"info").bind("click",this.checkInfoHandler):this.topic(e,"info").remove()}};var AbImageLoader={multiImages:[],docs:[],executePath:"js/works/",executeMin:!1,URLS:{CONVERTER:"api/doc"},workerPath:function(t){return this.executePath+t+(this.executeMin?".min.js":".js")},load:function(t){var e=null;AbCommon.isFileData(t)?e=this.test(t.name,t.type):AbCommon.isString(t)&&(t={name:t,type:"",size:0},e=this.test(t.name,t.type));var i=this.makeResultInfoByFileData,s=e?e.kind:null,n=null;switch(s){case"doc":return this.docs.push({decoder:e,data:t}),null;case"tif":return null;case"j2k":return null;case"def":if(AbCommon.supportWebWorker()){var r=this.workerPath("work.def");n=function(){var t=arguments.callee.data,e=arguments.callee.decoder;return new Promise(function(s,n){var a=new Worker(r);a.onerror=function(t){setTimeout(n.bind(null,t),0),a.terminate()},a.onmessage=function(t){a.terminate(),i(t.data.data,{exif:"read"}).then(function(i){setTimeout(s.bind(null,{from:"local",decoder:e,image:t.data.image,info:i}),0)}).catch(function(t){setTimeout(n.bind(null,t),0)})},a.postMessage(t)})},n.data=t,n.decoder=e}else n=function(){var t=arguments.callee.data,e=arguments.callee.decoder;return new Promise(function(s,n){var r=new FileReader;r.onload=function(r){i(t,{exif:"read"}).then(function(t){setTimeout(s.bind(null,{from:"local",decoder:e,image:r.target.result,info:t}),0)}).catch(function(t){setTimeout(n.bind(null,t),0)})},r.onerror=function(t){r.abort(),setTimeout(n.bind(null,t),0)},r.readAsDataURL(t)})},n.data=t,n.decoder=e;return n}return n=function(){arguments.callee.data;return new Promise(function(t,e){setTimeout(e.bind(null,new Error("Not support file format")),0)})},n.data=t,n},makeResultInfoByFileData:function(t,e){var i={name:t.name,text:t.name,type:t.type,origin:t,exif:null};return e&&"read"===e.exif?new Promise(function(e,s){try{AbVendor.exif("file",t,function(t,s){i.exif=AbExifMetaReader.read(t),e(i)})}catch(t){s(t)}}):Promise.resolve(i)},test:function(t,e){if(!t)return null;if(t=t.toLowerCase(),t.match(".jp2$|.j2x$|.j2k$|.j2c$"))return{kind:"j2k",render:"jpeg"};if(t.match(".doc$|.docx$|.xls$|.xlsx$|.ppt$|.pptx$|.hwp$|.pdf$"))return{kind:"doc",render:"jpeg"};if("image/tiff"===e)return{kind:"tif",render:"jpeg"};if("image/svg+xml"===e)return{kind:"svg",render:"png"};switch(e){case"image/jpeg":case"image/bmp":return{kind:"def",render:"jpeg"};case"image/png":case"image/apng":case"image/gif":return{kind:"def",render:"png"}}return null},analysis:function(t){for(var e=t.length,i={doc:0,img:0,etc:0},s=0;s<e;s++){var n=t[s],r=this.test(n.name,n.type),a=r?r.kind:null;switch(a){case"doc":i.doc++;break;case"def":case"j2k":case"tif":case"svg":i.img++;break;default:i.etc++}}return i},needExternalProcess:function(){return this.multiImages.length>0||this.docs.length>0},doExternalProcess:function(t){t||(t={});var e=this.docs.length+this.multiImages.length;AbCommon.isFunction(t.begin)&&t.begin(e);var i=0,s=function(){i++,AbCommon.isFunction(t.next)&&t.next(e,i),i>=e&&AbCommon.isFunction(t.end)&&t.end(e)};this.$doMultiImageProcess(e,t,s),this.$doRemoteProcess(e,t,s)},$doMultiImageProcess:function(t,e,i){this.multiImages.splice(0,this.multiImages.length)},$doRemoteProcess:function(t,e,i){var s=$("#doc-forms"),n=0,r=function(){var t=arguments.length.siz;n++,n==t&&s.empty()};r.siz=this.docs.length;for(var a=this.makeResultInfoByFileData,o=this.URLS.CONVERTER,h=this.docs.length,l=0;l<h;l++){var c=this.docs[l];if("doc"===c.decoder.kind){var u=function(t){var n=arguments.callee.data,h=arguments.callee.decoder,l=t.target.result,c=l.substr(l.indexOf(",")+1),u='<form enctype="multipart/form-data"><input type="hidden" name="name"/><input type="hidden" name="content"/></form>',d=$(u);d.find('[name="name"]').val(n.name),d.find('[name="content"]').val(c),s.append(d);try{var p=function(t,s,n,o){var h=arguments.callee.data,l=arguments.callee.decoder;o.remove(),r(),AbCommon.isFunction(e.getList)&&a(h).then(function(i){e.getList(t,{from:"doc",preset:i,decoder:l})}).catch(function(t){console.log(t)}),AbCommon.isFunction(i)&&i()};p.data=n,p.decoder=h,AbCommon.ajaxSubmit(d,{title:"문서 변환",url:o,success:p,error:function(t,e){e.remove(),r(),console.log(t),AbCommon.isFunction(i)&&i()}})}catch(t){r()}};u.data=c.data,u.decoder=c.decoder;var d=function(t){p.abort(),AbCommon.isFunction(e.error)&&e.error(t),AbCommon.isFunction(i)&&i()},p=new FileReader;p.onload=u,p.onerror=d,p.readAsDataURL(c.data)}}this.docs.splice(0,this.docs.length)}},AbImageTransferProcessHelper=function(t){if(t||(t={}),!t.viewer)throw new Error("[IMAGE-TRANSFER] AbImageViewer is not set");this.viewer=t.viewer,this.images=this.viewer.images,this.bookmarks=this.viewer.bookmarks,this.selector=t.selector,this.printShapes=!AbCommon.isBool(t.printShapes)||t.printShapes,this.printShapeTypeMap=t.printShapeTypeMap,this.parallels=AbCommon.isNumber(t.parallels)?t.parallels:6,this.errorImageExit=t.errorImageExit||!1,this.handlers={chain:AbCommon.isFunction(t.chain)?t.chain:function(t,e,i){return Promise.resolve(!0)},prepare:AbCommon.isFunction(t.prepare)?t.prepare:function(t){return Promise.resolve(!0)},submit:AbCommon.isFunction(t.submit)?t.submit:function(t,e,i){return Promise.resolve(!0)},completed:AbCommon.isFunction(t.completed)?t.completed:function(t){return Promise.resolve(!0)},total:AbCommon.isFunction(t.total)?t.total:function(t,e){return e.pageInfos.length*e.imgInfos.length}};var e=t.urls||{};this.urls={alloc:e.alloc,modify:e.modify,remove:e.remove,completed:e.completed};var i=t.msgs||{};this.msgs={empty:i.empty||"전송할 이미지가 없습니다",errorImage:i.errorImage||"#{IDX}번 이미지는 전송할 수 없습니다",readyException:i.readyException||"이미지 전송 준비 중 오류가 발생했습니다"},this.requestID=t.id,this.prog={view:null,bar:null},this.work="regist",this.transferID=null,this.index=0,this.length=0,this.endCount=0,this.ignoreProcess=!1,this.data=null};AbImageTransferProcessHelper.prototype={constructor:AbImageTransferProcessHelper,NEXT_DELAY:10,dispose:function(){this.viewer=null,this.images=null},isFormController:function(t){return t&&t.form&&AbCommon.isFunction(t.reset)&&AbCommon.isFunction(t.record)},loader:function(){return this.$loader||(this.$loader=$(this.selector)),this.$loader},show:function(){var t=this.loader();t.show()},hide:function(){var t=this.loader();t.hide()},status:function(t){var e=this.loader();e.attr("pl-topic",t);var i=e.find(".pl-"+t),s=i.find(".bar");s.length&&s.css("width","0%"),this.prog.view=i,this.prog.bar=s},progress:function(t,e){var i=t/e*100;this.prog.bar.css("width",i.toFixed(1)+"%")},collect:function(t){for(var e=this.viewer,i=(this.images,this.bookmarks),s=this.handlers,n=this.printShapes===!0,r=t.length,a=[],o=[],h=[],l={},c=null,u=-1,d=[],p=0;p<r;p++){var g=t[p];if(g.isError()){if(this.errorImageExit===!0)return o.splice(0,o.length),this.msgs.errorImage.replace(/#{IDX}/g,""+p)}else{var f=0;g.editable()||(f|=1),(g.angle||e.drawableWaterMark()||g.hasShapes()&&n)&&(f|=2),u=i.indexOf(g.uid),c=null,u>=0&&(c={index:u,vindex:u},d.push({bookmark:c,page:g})),l[g.uid]=h.length,h.push({width:f?0:g.source.width,height:f?0:g.source.height,url:f?null:g.source.imgInfo.url});var m={type:f,index:p,page:g,bookmark:c};f&&o.push(m),a.push(m)}}d.sort(function(t,e){return t.bookmark.index-e.bookmark.index});for(var b=d.length,p=0;p<b;p++){var y=d[p];y.bookmark.vindex=p}this.data={length:o.length,pageInfos:o,imgInfos:h,source:a,map:l};var v=s.total(this,this.data);return this.data.total=v,null},prepare:function(){var t=this.handlers,e=this.urls.alloc,i=this.urls.modify,s=this,n=this.msgs,r=null,a=this.requestID;return this.transferID=null,this.work="regist",this.requestID?i&&(this.transferID=this.requestID,this.work="modify",r=new Promise(function(t,e){AbCommon.ajax({title:"수정 준비 작업",url:i,data:{id:a,pages:s.length},success:function(e){t(!0)},error:function(t){AbMsgBox.error(n.readyException),e(t)}})})):e&&(r=new Promise(function(t,i){AbCommon.ajax({title:"아이디 할당",url:e,data:{pages:s.length},success:function(e){s.transferID=e.key,t(!0)},error:function(t){AbMsgBox.error(n.readyException),i(t)}})})),r||(r=Promise.resolve(!0)),r.then(function(){return t.prepare(this)}.bind(this))},render:function(t){var e=this.viewer,i=e.engine,s=(this.images,this.handlers),n=this.printShapes===!0,r=this.printShapeTypeMap,a=this.data,o=a.source[t],h={index:t,pageInfo:o,imgInfo:a.imgInfos[a.map[o.page.uid]]},l=null;return l=AbCommon.flag(o.type,1)?e.loadPage(o,!0):Promise.resolve(),l.then(function(t){if(!o.page.isError()&&o.page.isReadyImage())return o.page.source.image()}).then(function(t){if(!o.page.isError()&&AbCommon.flag(o.type,2)){var e=o.page.decoder(),s=AbGraphics.canvas.createContext();i.renderImage(s,o.page,n,r);var a=AbGraphics.canvas.toImage(s,e);try{h.imgInfo.width=o.page.source.width,h.imgInfo.height=o.page.source.height,h.imgInfo.url=a}catch(t){throw console.log(t),t}}}).then(function(t){return s.chain(this,h,a)}.bind(this))},isError:function(t){var e=this.data,i=e.source[t];return i.page.isError()},submit:function(t){var e=this.data,i=e.source[t],s={index:t,pageInfo:i,imgInfo:e.imgInfos[e.map[i.page.uid]]},n=this.handlers;return n.submit(this,s,e)},completed:function(){var t=this.urls.completed,e=this.transferID,i=null;return i=t?new Promise(function(i,s){AbCommon.ajax({url:t,data:{id:e},logFail:!0,nomsg:!0,success:function(){i(!0)},error:function(t){s(t)}})}):Promise.resolve(!0),i.then(function(){var t=this.handlers;return t.completed(this)}.bind(this))},remove:function(){var t=this.urls.remove,e=this.transferID;t&&e&&AbCommon.ajax({url:t,data:{id:e},logFail:!0,nomsg:!0})},send:function(t){var e=this.viewer,i=(e.engine,this.images,this.handlers,this),s=this.parallels;return this.status("ready"),this.show(),new Promise(function(e,n){var r=function(){var t=this.index;this.length<=this.index||(this.index++,this.ignoreProcess||(this.progress(this.index,this.length),this.render(t).then(function(){return!this.isError(t)&&this.submit(t)}.bind(this)).then(function(){this.endCount++,this.length<=this.endCount?this.completed().then(function(){e(!0)}).catch(function(t){n(t)}):this.length>this.endCount&&setTimeout(r,AbImageTransferProcessHelper.prototype.NEXT_DELAY)}.bind(this)).catch(function(t){this.ignoreProcess=!0,n(t)}.bind(this))))}.bind(i),a=i.collect(t);a&&n(new Error(a));var o=i.data.source.length;o||n(new Error(i.msgs.empty)),i.length=o,i.index=0,i.endCount=0,i.ignoreProcess=!1,i.prepare().then(function(){i.status("proc");for(var t=0;t<s;t++)setTimeout(r,0)})}).then(function(){return Promise.resolve(!0)}.bind(this)).catch(function(t){throw this.remove(),t}.bind(this))}};var AbImageInfoRenderer={render:function(t){var e=t.infoFrom(),i=t.info(),s=this["render$"+e];return AbCommon.isFunction(s)?s.bind(this)(t,i):null},orientationDesc:function(t){var e="";switch(t){case 1:e="Normal";break;case 2:e="Mirror horizontal";break;case 3:e="Rotate 180";break;case 4:e="Mirror vertical";break;case 5:e="Mirror horizontal and rotate 270 CW";break;case 6:e="Rotate 90 CW ";break;case 7:e="Mirror horizontal and rotate 90 CW";break;case 8:e="Rotate 270 CW";break;default:e="Unknown"}return e+" ("+t+")"},resolutionUnitDesc:function(t){var e="";switch(t){case 1:e="None";break;case 2:e="Inches";break;case 3:e="cm";break;default:e="Unknown"}return e+" ("+t+")"},resolutionUnit:function(t){var e="";switch(t){case 2:e="DPI";break;case 3:e="DPCM";break;default:e=""}return e},dateFormat:function(t){if(!t)return t;var e=t.substr(0,4),i=t.substr(4,2),s=t.substr(6,2),n=e+"-"+i+"-"+s;if(t.length>8){var r=t.substr(8,2),a=t.substr(10,2),o=t.substr(12,2);n+=" "+r+":"+a+":"+o}return n},cm2inch:function(t){return t/2.54},inch2cm:function(t){return 2.54*t},renderExif:function(t){var e="";if(t&&t.exif){var i=t.exif;e+='<tr class="title"><th colspan="2">EXIF 정보</th></tr>';var s="";if(i.hasOwnProperty("resolutionUnit")&&(s=this.resolutionUnit(i.resolutionUnit),s&&(s=" "+s)),i.hasOwnProperty("make")&&(e+="<tr><th>제조사</th><td>"+AbCommon.escape(i.make)+"</td></tr>"),i.hasOwnProperty("model")&&(e+="<tr><th>모델</th><td>"+AbCommon.escape(i.model)+"</td></tr>"),i.hasOwnProperty("software")&&(e+="<tr><th>소프트웨어</th><td>"+AbCommon.escape(i.software)+"</td></tr>"),i.hasOwnProperty("datetime")&&(e+="<tr><th>촬영일시</th><td>"+this.dateFormat(i.datetime)+"</td></tr>"),i.hasOwnProperty("orientation")&&(e+="<tr><th>사진방향</th><td>"+this.orientationDesc(i.orientation)+"</td></tr>"),
i.hasOwnProperty("xdimension")&&i.hasOwnProperty("ydimension")&&(e+="<tr><th>이미지 크기</th><td>"+i.xdimension+"x"+i.ydimension+"</td></tr>"),i.hasOwnProperty("xresolution")&&(e+="<tr><th>가로 해상도</th><td>"+i.xresolution+s+"</td></tr>"),i.hasOwnProperty("yresolution")&&(e+="<tr><th>세로 해상도</th><td>"+i.yresolution+s+"</td></tr>"),i.hasOwnProperty("resolutionUnit")&&(e+="<tr><th>해상도 단위</th><td>"+this.resolutionUnitDesc(i.resolutionUnit)+"</td></tr>"),i.gps){var n=i.gps;if(e+="<tr><th>위도</th><td>"+AbExifMetaReader.gpsText(n.lat)+(n.latRef?" "+n.latRef:"")+"</td></tr>",e+="<tr><th>경도</th><td>"+AbExifMetaReader.gpsText(n.lng)+(n.lngRef?" "+n.lngRef:"")+"</td></tr>",n.alt){var r=Math.round(n.alt);1===n.altRef&&(r="해수면 밑 "+r),e+="<tr><th>고도</th><td>"+r+"m</td></tr>"}}}return e},render$local:function(t,e){var i=AbCommon.isSetted(e.originName),s=i?e:e.origin;if(!s)return null;var n="<table>";return s.originName&&(n+="<tr><th>원본명</th><td>"+AbCommon.escape(s.originName)+"</td></tr>"),s.originPages>1&&(n+="<tr><th>원본의 이미지 수</th><td>"+s.originPages+"</td></tr>",n+="<tr><th>원본의 이미지 인덱스</th><td>"+s.originIndex+"</td></tr>"),i&&(n+="<tr><td>&nbsp;</td></tr>",n+='<tr class="title"><th colspan="2">이미지 정보</th></tr>'),n+="<tr><th>이름</th><td>"+AbCommon.escape(s.name)+"</td></tr>",s.type&&(n+="<tr><th>타입</th><td>"+AbCommon.escape(s.type)+"</td></tr>"),n+=this.renderExif(e),n+="</table>",{title:"로컬 이미지 정보",html:n}},render$doc:function(t,e){var i=e;if(!i)return null;var s="<table>";return i.originName&&(s+="<tr><th>문서명</th><td>"+AbCommon.escape(i.originName)+"</td></tr>"),i.originPages>1&&(s+="<tr><th>문서의 페이지 수</th><td>"+i.originPages+"</td></tr>",s+="<tr><th>문서의 페이지 인덱스</th><td>"+i.originIndex+"</td></tr>"),s+="<tr><td>&nbsp;</td></tr>",s+='<tr class="title"><th colspan="2">이미지 정보</th></tr>',i.name&&(s+="<tr><th>이름</th><td>"+AbCommon.escape(i.name)+"</td></tr>"),i.type&&(s+="<tr><th>타입</th><td>"+AbCommon.escape(i.type)+"</td></tr>"),s+=this.renderExif(e),s+="</table>",{title:"문서 정보",html:s}},render$server:function(t,e){var i=e;if(!i)return null;var s="<table>";return i.originName&&(s+="<tr><th>원본명</th><td>"+AbCommon.escape(i.originName)+"</td></tr>"),i.originPages>1&&(s+="<tr><th>원본의 이미지 수</th><td>"+i.originPages+"</td></tr>",s+="<tr><th>원본의 이미지 인덱스</th><td>"+i.originIndex+"</td></tr>"),i.name&&(s+="<tr><th>이름</th><td>"+AbCommon.escape(i.name)+"</td></tr>"),i.type&&(s+="<tr><th>타입</th><td>"+AbCommon.escape(i.type)+"</td></tr>"),s+=this.renderExif(e),s+="</table>",{title:"서버 이미지 정보",html:s}}};AbImageViewer.prototype={constructor:AbImageViewer,SPLIT_DATA_SIZE:30720,PARALLELS:3,URLS:{CONFIG:"api/config",PERMISSION:"api/permission",OPEN:"api/images",SAVE:{ALLOC:"api/alloc",MODIFY:"api/modify-prepare",IMAGE:"api/save-image",REMOVE:"api/remove",COMPLETED:"api/save-completed"},PRINT:{ALLOC:"api/print-support/alloc",IMAGE:"api/print-support/save",REMOVE:"api/print-support/remove",DOWNLOAD:"print-support/img"}},IMAGE_TYPES:["image","image-source","image-result","thumb"],config:function(t){function e(t,e){for(var i=t,s=e.split("."),n=0,r=s.length-1,a=s[s.length-1];n<r;){if(i=i[s[n]],!i)return null;n++}return{config:i,leap:a}}var i=e(this.$config,t);return i?i.config[i.leap]:null},permission:function(t){return!this.$permission||!AbCommon.isFunction(this.$permission.check)||this.$permission.check(t)},install:function(){var t=function(t,e){try{this.colorPicker=new AbColorPicker,this.stylerWindow=new AbShapeStyler({selector:this.stylerWindowSelector+" .abstyler",colorPicker:this.colorPicker}),this.styler=new AbShapeStyler({colorPicker:this.colorPicker}),this.styler.observe(this),this.toolbar=new AbToolbar,this.toolbar.observe(this),this.toolbar.groupObserve(this),this.imageListView=new AbImageListView({name:"pages",pages:this.images,selector:"#thumbnails"}),this.imageListView.observe(this),this.observe(this.imageListView),this.bookmarkListView=new AbImageListView({name:"bookmarks",pages:this.bookmarks,bookmark:!0,selector:"#bookmarks"}),this.bookmarkListView.observe(this),this.observe(this.bookmarkListView),this.popupImageListView=new AbImageListView({name:"pages",pages:this.images,selector:"#thumbnails-popup",selecting:{method:"readonly"===this.listPopupStyle?"dblclick":"click|dblclick",auto:"readonly"!==this.listPopupStyle},token:"popup",pageCount:10}),this.popupImageListView.observe(this),this.observe(this.popupImageListView),this.popupBookmarkListView=new AbImageListView({name:"bookmarks",pages:this.bookmarks,bookmark:!0,selector:"#bookmarks-popup",selecting:{method:"readonly"===this.listPopupStyle?"dblclick":"click|dblclick",auto:"readonly"!==this.listPopupStyle},token:"popup",pageCount:10}),this.popupBookmarkListView.observe(this),this.observe(this.popupBookmarkListView),this.updateListType(),this.engine.install(function(){this.engine.observe("all",this),this.sync(),this.engine.attachEvents(),this.animatingEngine&&this.engine.animate(),t(!0)}.bind(this))}catch(t){e(t)}}.bind(this);return new Promise(t).then(function(){return!0}.bind(this))},updateListType:function(){var t=this.imageListView,e=this.bookmarkListView;switch(this.$showListViewPopup&&(t=this.popupImageListView,e=this.popupBookmarkListView),this.listType){case"pages":this.listView=t;break;case"bookmarks":this.listView=e}},createMaskingShape:function(t){var e=AbViewerEngine.prototype.SHAPE_TABLE[t],i=AbCommon.cloneShape(e);return $.extend(i,{name:"masking."+t,type:"masking",style:{color:"black"},styleDesc:function(){return{descs:[{name:"color",text:"채우기색상",style:"color",alpha:!1,notset:!1}]}}}),i},observe:function(t){this.observers.push(t)},stopObserve:function(t){var e=this.observers.indexOf(t);e>=0&&this.observers.splice(e,1)},notifyObservers:function(t,e,i){setTimeout(function(){for(var s=this.observers.length,n=0;n<s;n++){var r=this.observers[n];"function"==typeof r?r(this,t,e,i):"function"==typeof r.notify&&r.notify(this,t,e,i)}}.bind(this),0)},drawableWaterMark:function(){return this.waterMark&&this.waterMark.drawable()},updatePagesNotifyObservers:function(){this.notifyObservers("pages",this.images.length()),this.toolbar.set("page.total",this.listView.pages.length(),!1)},sync:function(){var t=null;this.toolbar.forEach(function(e,i){switch(e){case"mode":t=i,this.engine.engineMode=i?"edit":"view",this.showEditControls(i);break;case"fit.horiz":case"fit.vert":case"fit.in":this.engine.fitTo=e.replace("fit.","")}}.bind(this)),null===t&&(this.engine.engineMode=this.defaultMode,this.showEditControls("edit"===this.defaultMode)),this.enableToolbarTopics()},enableToolbarTopics:function(){var t=["file.save.image","file.save.annotation","send.server","page.print","print","zoom.in","zoom.out","zindex.front","zindex.forward","zindex.backward","zindex.back","fit.horiz","fit.vert","fit.in","page.rotate.ccw","page.rotate.cw","page.rotate.180","mode","show.shapes","show.annotation","show.masking","clear.shapes","page.scale","annotation.cursor","annotation.rectangle","annotation.ellipse","annotation.line","annotation.arrow","annotation.pen","annotation.highlightpen","annotation.textbox","annotation.checker","annotation.stamp","masking.rectangle","masking.ellipse"],e=(this.engine.currentPage,this.engine.currentPage&&this.engine.editable());this.toolbar.enableTopic(t,e);var i=["page.prev","page.next","page.no","page.remove"];e=this.engine.pages.length()>0,this.toolbar.enableTopic(i,e)},waterMarkNotify:function(t,e,i){switch(e){case"error":this.exec(function(){AbMsgBox.error("[WATERMARK] "+i)})}},toolbarNotify:function(t,e,i){if(this.permission(e))switch(e){case"file.open":this.openLocalFile();break;case"file.save.image":this.saveToLocalImage();break;case"file.save.annotation":this.saveToLocalText();break;case"send.server":this.sendToServer();break;case"page.remove":this.removePage();break;case"page.print":this.printPage();break;case"print":this.printAllPages();break;case"zoom.in":this.zoom("in");break;case"zoom.out":this.zoom("out");break;case"zindex.front":this.engine.execCommand("z-index","top");break;case"zindex.forward":this.engine.execCommand("z-index","up");break;case"zindex.backward":this.engine.execCommand("z-index","down");break;case"zindex.back":this.engine.execCommand("z-index","bottom");break;case"fit.horiz":case"fit.vert":case"fit.in":this.engine.fit(e.replace("fit.",""));break;case"page.rotate.ccw":this.engine.rotate(AbRotate.CCW,AbRotate.DEG_90);break;case"page.rotate.cw":this.engine.rotate(AbRotate.CW,AbRotate.DEG_90);break;case"page.rotate.180":this.engine.rotate(AbRotate.CW,AbRotate.DEG_180);break;case"mode":this.engine.mode(i?"edit":"view"),this.showEditControls(i);break;case"show.shapes":this.engine.showShapes(i);break;case"show.annotation":this.engine.showShapes("annotation",i);break;case"show.masking":this.engine.showShapes("masking",i);break;case"clear.shapes":this.clearShapes();break;case"page.prev":this.prevPage();break;case"page.next":this.nextPage();break;case"page.no":this.page(i);break;case"page.scale":switch(i){case"fit.in":case"fit.horiz":case"fit.vert":this.engine.fit(i.replace("fit.",""));break;default:if(i.indexOf("%")>=0){var s=parseFloat(i.replace("%",""));this.engine.scale(s/100)}}break;case"pages":case"bookmarks":this.toggleListView(e);break;case"annotation.cursor":break;case"annotation.rectangle":case"annotation.ellipse":case"annotation.line":case"annotation.arrow":case"annotation.pen":case"annotation.highlightpen":case"annotation.textbox":case"annotation.checker":case"annotation.stamp":this.addShape(e.replace("annotation.","")).then(function(e){"cancel"===e&&t.set("annotation.cursor",!0)});break;case"masking.rectangle":case"masking.ellipse":this.addShape(e).then(function(e){"cancel"===e&&t.set("annotation.cursor",!0)});break;case"thumb-popup.open":this.showListViewPopup(!0);break;case"thumb-popup.pages":case"thumb-popup.bookmarks":"readonly"===this.listPopupStyle?this.toggleListView(e,!1):this.toggleListView(e);break;case"thumb-popup.close":this.showListViewPopup(!1)}},toolbarGroupNotify:function(t,e,i){switch(e){case"left":this.showimageListView(i);break;case"draw":t.set("annotation.cursor",!0)}},listViewNotify:function(t,e,i){var s=null,n=-1;switch(e){case"info":var s=this.images.getById(i),r=AbImageInfoRenderer.render(s);r&&AbMsgBox.open({title:r.title,textHtml:r.html});break;case"request.load":this.loadPage(i);break;case"renderlist":this.trigger("renderlist",{name:t.name,token:t.token,visible:i.visible,loading:i.loading});break;case"click":s=this.images.getById(i.uid),n=this.images.indexOf(s),this.trigger("click",{name:t.name,token:t.token,index:n,uid:i.uid,status:i.status});break;case"select":s=this.images.getById(i),n=this.images.indexOf(s),this.trigger("select",{name:t.name,token:t.token,index:n,uid:i}),this.engine.selectPage(n);break;case"dblclick":if("popup"===t.token)if("readonly"===this.listPopupStyle){this.showListViewPopup(!1);var a=this.images;s=a.getById(i),n=a.indexOf(s),this.exec(function(){this.engine.selectPage(n)})}else this.showListViewPopup(!1);break;case"selected":this.toolbar.set("page.no",i+1,!1);break;case"unselect":this.engine.unselectPage(),this.toolbar.set("page.no",0,!1);break;case"bookmark.add":s=this.images.getById(i),this.bookmarks.push(s),this.notifyObservers(e,i);break;case"bookmark.remove":this.bookmarks.removeById(i),this.notifyObservers(e,i),t.bookmark&&this.toolbar.set("page.total",t.pages.length());break;case"bookmark.remove.list":for(var o=i.length-1;o>=0;o--)this.bookmarks.removeById(i[o]);this.toolbar.set("page.no",this.listView.selectedIndex+1,!1),this.toolbar.set("page.total",this.listView.pages.length(),!1),this.bookmarks.length()||this.engine.unselectPage(),this.notifyObservers(e,i);break;case"page.remove.list":for(var h=i.pages.length,l=[],o=0;o<h;o++){var c=i.pages[o];l.push(c.index)}this.engine.removePages(l),this.toolbar.set("page.no",this.listView.selectedIndex+1,!1),this.toolbar.set("page.total",this.images.length(),!1),this.notifyObservers(e,i);break;case"history.sync.end":this.toolbar.set("page.no",this.listView.selectedIndex+1,!1),this.toolbar.set("page.total",this.listView.pages.length(),!1)}},engineNotify:function(t,e,i){if("request.select"==e)return void this.listView.go(i);if("shape"==e&&"created"===i){var s=this.config("shape.addUI");"toolbar"===s&&(this.engine.cancelAnyClick=!0)}if("shape"==e)switch(i){case"created":case"click":case"select":case"selectAll":case"moved":this.engine.focusedShape&&this.styler.set(this.engine.focusedShape);break;case"delete":this.engine.selectedShapes.length||this.styler.clear()}else if("selection"==e)switch(i){case"end":this.engine.selectedShapes.length||this.styler.clear()}else if("clipboard"==e)switch(i){case"paste":this.engine.focusedShape&&this.styler.set(this.engine.focusedShape)}switch(("shape"==e&&"created"==i||"cancel"==e&&"shape.create"==i)&&this.toolbar.set("annotation.cursor",!0),e){case"scale":this.toolbar.set("fit.horiz",!1,!1),this.toolbar.set("fit.vert",!1,!1),this.toolbar.set("fit.in",!1,!1),this.toolbar.set("page.scale",Math.round(100*i)+"%",!1);break;case"fit":"horiz"==i&&this.toolbar.set("fit.horiz",!0,!1),"vert"==i&&this.toolbar.set("fit.vert",!0,!1),"in"==i&&this.toolbar.set("fit.in",!0,!1),this.toolbar.set("page.scale","fit."+i,!1);break;case"page":if("select"==i){var n=this.engine.currentPage;n&&n.isReadyImage()&&this.exec(function(){n.source.image().then(function(){this.engine.refresh()}.bind(this))})}if("add"==i||"select"==i){var r=this.engine.fit();r?(this.toolbar.set("page.scale","fit."+r,!1),this.toolbar.set("fit."+r,!0,!1)):(this.toolbar.set("page.scale",Math.round(100*this.engine.scale())+"%",!1),this.toolbar.set("fit.horiz",!1,!1),this.toolbar.set("fit.vert",!1,!1),this.toolbar.set("fit.in",!1,!1))}"select"==i&&this.engine.currentPage&&(this.notifyObservers("page.select",this.engine.currentPage.uid),this.engine.focusedShape?this.styler.set(this.engine.focusedShape):this.engine.selectedShapes.length||this.styler.clear()),this.enableToolbarTopics();break;case"history":"undoing"!=i&&"redoing"!=i||this.toggleListView("pages",!1);break;case"history.sync":this.toggleListView("pages",!1),this.notifyObservers(e,i);break;case"modified":var a=100;if(i&&("all"===i||$.isArray(i)))for(var o="all"===i,h=o?this.images.source:i,l=0;l<h.length;l++){var n=h[l];if(AbCommon.isNumber(n)&&(n=this.images.get(n)),n.source){var c=function(){var t=arguments.callee.self,e=arguments.callee.page;t.renderThumbnail(e)};c.page=n,c.self=this,setTimeout(c,a)}}else this.exec(function(){var t=this.engine.currentPage;t&&this.renderThumbnail(t)},a)}},styleNotify:function(t,e,i,s){var n=i.changed,r=this.config("shape.addUI");"toolbar"===r&&this.engine.selection.target||(n?(s.measure(),s.notify("styled"),this.history.end(this.engine),this.engine.render(),this.engine.modified()):this.history.begin("shape","update",this.engine,["style"]))},exec:function(t,e){e||(e=0),setTimeout(t.bind(this),e)},execCommand:function(t,e){this.engine.execCommand(t,e)},toggleListView:function(t,e){if(this.listType!=t){AbCommon.isBool(e)||(e=!0);var i=t,s=!1;0==t.indexOf("thumb-popup.")&&(s=!0,t=t.replace("thumb-popup.",""));switch(t){case"pages":$(this.imageListView.selector).removeClass("hide"),$(this.popupImageListView.selector).removeClass("hide"),$(this.bookmarkListView.selector).addClass("hide"),$(this.popupBookmarkListView.selector).addClass("hide"),this.listType=t,this.updateListType(),this.notifyObservers("collection.changed",e),this.toolbar.set(i,!0,!1),this.toolbar.set("page.no",this.listView.selectedIndex+1,!1),this.toolbar.set("page.total",this.listView.pages.length(),!1),s?this.toolbar.set("pages",!0,!1):this.toolbar.set("thumb-popup.pages",!0,!1);break;case"bookmarks":$(this.imageListView.selector).addClass("hide"),$(this.popupImageListView.selector).addClass("hide"),$(this.bookmarkListView.selector).removeClass("hide"),$(this.popupBookmarkListView.selector).removeClass("hide"),this.listType=t,this.updateListType(),this.notifyObservers("collection.changed",e),this.toolbar.set(i,!0,!1),this.toolbar.set("page.no",this.listView.selectedIndex+1,!1),this.toolbar.set("page.total",this.listView.pages.length(),!1),s?this.toolbar.set("bookmarks",!0,!1):this.toolbar.set("thumb-popup.bookmarks",!0,!1)}}},showimageListView:function(t){var e=$(".abv-thumbnails-closable");t?e.removeClass("abv-hide-thumbnails"):e.addClass("abv-hide-thumbnails"),this.resize()},showEditControls:function(t){var e=$(".abv-view");t?e.addClass("abv_show_view_tools"):e.removeClass("abv_show_view_tools"),this.resize()},showListViewPopup:function(t){this.$showListViewPopup=t,this.updateListType();var e=$("#thumbnails-popup-layer");t?e.removeClass("abv-hide-thumbnails-popup-layer"):e.addClass("abv-hide-thumbnails-popup-layer")},resize:function(){this.exec(function(){this.engine.resize()},0)},render:function(){this.engine.render()},defaultShapeStyles:{},addShape:function(t){var e=this.config("shape.addUI"),i="window"===e,s="toolbar"===e;return i?this.shapeStyleWindow(t).then(function(e){return"cancel"===e.result?e.result:new Promise(function(e,i){this.engine.exec(function(){this.addShape(t),e("ok")})}.bind(this))}.bind(this)).catch(function(t){AbMsgBox.error(t+"")}):new Promise(function(e,i){var n=this;this.engine.exec(function(){this.addShape(t),s&&(this.cancelAnyClick=!1,n.styler.set(this.shapeObject(t))),e("ok")})}.bind(this))},shapeStyleWindow:function(t){if(!this.engine.editable())return Promise.resolve({result:"cancel"});var e=this.engine.shapeObject(t);if(!e)return Promise.reject(new Error("Unknown shape string"));if(!AbCommon.hasShapeStyle(e))return Promise.resolve({result:"ok"});this.defaultShapeStyles[t]||(this.defaultShapeStyles[t]=AbCommon.clone(e.style));var i=$(this.stylerWindowSelector),s=i.find("[abs-cmd]"),n=this,r=this.defaultShapeStyles[t];return new Promise(function(t,a){var o=function(a){var h=$(this),l=h.attr("abs-cmd");"ok"==l||"cancel"==l?(n.stylerWindow.clear(),s.unbind("click",o),i.hide(),n.styler.unlock(),t({result:l,style:e.style})):"reset"==l&&(AbCommon.copyProp(r,e.style),n.stylerWindow.set(e))};n.styler.lock(),s.bind("click",o),i.show(),n.stylerWindow.set(e)})},clear:function(){this.engine.clearPages()},add:function(t,e){var i=!(!e||!AbCommon.isBool(e.history))&&e.history,s=e&&AbCommon.isNumber(e.angle)?e.angle:0,n=new AbPage({uid:this.images.uuid(),status:AbPage.prototype.READY,loader:t,angle:s}),r=this.engine.pages.length();this.engine.addPage(n,!1,i);var a={page:n,index:r};return this.notifyObservers("page.add",a),a},creatingShapes:function(t,e){var i=this.engine;return e?promise=new Promise(function(s,n){var r=i.currentPage;try{e=AbCommon.removeXmlHeader(e);for(var a=AbCommon.deserializePageShapes(e),o=a.length,h=0,l=0;l<o;l++){var c=a[l];i.currentPage=t,i.createShape(c.name,c,function(e,n){e.prepare(),t.shapes.push(e),e.engine=i,e.measure(),h++,h>=o&&(i.currentPage=r,s(o))})}}catch(t){i.currentPage=r,n(t)}}):promise=Promise.resolve(0),promise},loadPage:function(t,e){if(t.page.isLoading())return!1;t.page.status=AbPage.prototype.LOADING,this.notifyObservers("page.loading",t.page.uid);this.engine;return t.page.loader().then(function(e){return this.creatingShapes(t.page,e.shapes).then(function(){return e})}.bind(this)).then(function(e){return this.setImage(t,e.image,e.info,e.from,e.decoder)}.bind(this)).catch(function(e){t.page.status=AbPage.prototype.ERROR,t.page.error=e,console.log(e),this.notifyObservers("page.error",t.page.uid)}.bind(this))},setImage:function(t,e,i,s,n){var r="jpeg";n&&(r=AbCommon.isString(n)?n:n.hasOwnProperty("render")&&AbCommon.isString(n.render)?n.render:"png");var a={from:s,data:i,decoder:r},o={info:a},h=!1;AbCommon.isString(e)?o.image=e:e&&(e.image||e.thumbnail)&&(e.image||(e.image=e.thumbnail),e.width&&e.height&&(o.width=e.width,o.height=e.height),e.image&&e.width&&e.height&&e.thumbnail&&(h=!0),e.image&&(o.image=e.image),e.thumbnail&&(o.thumbnail=e.thumbnail));var l=new AbImage(o),c=(t.index,t.page),u=h?l.thumbnail():l.image(),d=this.engine,p=this.thumbnailGenerator;return u.then(function(t){if(!l.hasThumbnail())return l.thumbInfo.url?l.thumbnail():l.generateThumbnail(this.thumbnailGenerator)}.bind(this)).then(function(t){if(c.width=l.width,c.height=l.height,c.source=l,c.angle){var e=AbGraphics.angle.point(c.angle,0,0,c.width,c.height);c.width=Math.round(Math.abs(e.x)),c.height=Math.round(Math.abs(e.y))}c.error=null,c.status=AbPage.prototype.LOADED;if(c.shapes.length||c.angle){d.renderThumbnail(p,c);var i=p.toImage(r);return c.source.setThumbnailData(i)}return Promise.resolve()}.bind(this)).then(function(e){this.notifyObservers("page.loaded",t)}.bind(this)).catch(function(t){console.log(t),c.status=AbPage.prototype.ERROR,c.error=t,this.notifyObservers("page.error",c.uid)}.bind(this))},addImages:function(t,e){e||(e={}),e.from||(e.from="server");var i=[];return new Promise(function(s,n){if(!$.isArray(t)){if(!AbCommon.isSetted(t))return void s(i);t=[t]}return t.length?void this.exec(function(){for(var n=t.length,r=0;r<n;r++){var a=t[r],o=function(){var t=arguments.callee.row;arguments.callee.index;return new Promise(function(i,s){var n={},r=$.extend({},e.preset);t.info&&(r=$.extend(r,t.info));var a=e.decoder;AbCommon.isString(t)?n.image=t:(AbCommon.isString(t.image)&&(n.image=t.image),AbCommon.isString(t.thumbnail)&&(n.thumbnail=t.thumbnail),AbCommon.isNumber(t.width)&&AbCommon.isNumber(t.height)&&t.width>0&&t.height>0&&(n.width=t.width,n.height=t.height),AbCommon.isNumber(t.angle)&&(n.angle=t.angle),t.decoder&&(a=t.decoder));var o={from:e.from,decoder:a,image:n,info:r};t.shapes&&(o.shapes=t.shapes),i(o)})};o.row=a,o.index=r;var h=this.add(o,{angle:a.angle});i.push(h)}this.exec(function(){this.updatePagesNotifyObservers(),s(i)})}):void s(i)}.bind(this))},changeImage:function(t,e,i){i||(i={});var s=!AbCommon.isBool(i.removePrevShapes)||i.removePrevShapes,n=this,a=this.images,o=this.engine,h=this.thumbnailGenerator;return new Promise(function(i,l){if(t<0||t>=a.length())return AbMsgBox.error("잘못된 호출입니다 (index)"),void l(new Error("잘못된 호출입니다 (index)"));if(!e)return AbMsgBox.error("잘못된 호출입니다 (imageData)"),void l(new Error("잘못된 호출입니다 (imageData)"));if(!e.image)return AbMsgBox.error("잘못된 호출입니다 (imageData.image)"),void l(new Error("잘못된 호출입니다 (imageData.image)"));var c=a.get(t);if(c.error)return AbMsgBox.error("이미지 로드를 재시도 하세요"),void l(new Error("이미지 로드를 재시도 하세요"));var u=e.decoder;c.changeImage(e.image).then(function(t){return s&&c.shapes.splice(0,c.shapes.length),this.creatingShapes(c,e.shapes)}.bind(n)).then(function(){o.renderThumbnail(h,c);var e=h.toImage(u);return c.source.setThumbnailData(e),this.engine.currentPageIndex==t&&this.engine.refresh(),this.notifyObservers("modified",{uid:c.uid,data:e}),r}.bind(n)).then(function(){i()}).catch(function(t){AbMsgBox.error(t),l(t)})})},openLocalFile:function(){var t=window.File&&window.FileReader&&window.FileList&&window.Blob;if(!t)return void alert("File API 지원안함");var e=$("#fileopen");e.length&&e.remove(),e=$('<input id="fileopen" type="file" multiple="multiple" style="display: none;"/>'),$(document.body).append(e),e.change(function(t){var i=t.currentTarget.files;if(!i||!i.length)return void e.remove();this.toggleListView("pages",!1);for(var s=i.length,n=0;n<s;n++){var r=i[n],a=AbImageLoader.load(r);a&&this.add(a,{history:!0})}if(this.updatePagesNotifyObservers(),e.remove(),AbImageLoader.needExternalProcess()){var o=$("#file-loading");o.attr("pl-topic","loading");var h=o.find(".bar");h.css("width","0%"),AbImageLoader.doExternalProcess({total:0,index:0,self:this,begin:function(t){this.total=t,this.index=0,o.show()},next:function(t,e){this.index++;var i=this.index/this.total*100;h.css("width",i.toFixed(1)+"%")},end:function(t){this.self.updatePagesNotifyObservers(),this.self.exec(function(){o.hide()})},error:function(t){},get:function(t,e){this.self.add(t,!0)},beginMulti:function(t){},endMulti:function(t){},getList:function(t,e){this.self.addImages(t,e)}})}}.bind(this)),e.click()},supportFileSaver:function(){var t=!1;try{t=!!new Blob}catch(t){return console.log(t),!1}return t},saveToLocalImage:function(){if(!this.supportFileSaver())return void AbMsgBox.info("이 브라우저는 파일 저장을 지원하지 않습니다");var t=this.config("image.local-save-limit"),e=this.engine.currentPageIndex,i=this.collectSelectedOrAllPages({start:e,end:e});if(i.pages.length){if(t&&t>0&&i.pages.length>t)return void AbMsgBox.warningHtml("최대 "+t+"까지만 다운로드 할 수 있습니다.<br/>이미지를 "+t+"개 이하로 선택하세요.");var s="";s="single"==i.type?"선택한 이미지를 어떤 형식으로 저장하시겠습니까?":"선택한 이미지(들)를 어떤 형식으로 저장하시겠습니까?",AbMsgBox.show(s,null,{png:"PNG 형식",jpg:"JPG 형식"}).then(function(t){if("png"==t||"jpg"==t){for(var e=this,s=[],n=i.pages.length,r=0;r<n;r++){var a=i.pages[r],o=this.images.indexOf(a.uid),h=function(t,e){var i=arguments.callee.type,s=arguments.callee.page,n=arguments.callee.index,r=arguments.callee.self,a=function(){var a=AbGraphics.canvas.createContext(s.width,s.height);r.engine.renderImage(a,s),AbGraphics.canvas.toBlob(a,"jpg"==i?"image/jpeg":null).then(function(e){AbVendor.save(e,"image_"+(n+1)+"."+i),t(n)}).catch(function(t){e(t)})};s.isReadyImage()?s.source.image().then(function(){a()}).catch(function(t){console.log(t),e(t)}):a()};h.type=t,h.page=a,h.index=o,h.self=e,s.push(new Promise(h))}AbCommon.sequencePromiseAll(s,null,{term:{progress:10,promise:10}}).then(function(){e.notifyObservers("file.save.image")}).catch(function(t){console.log(t),AbMsgBox.error(t)})}}.bind(this))}},saveToLocalText:function(){var t=this.config("shape.save")||"all",e=this.config("shape.local-save-limit"),i={text:"주석/마스킹",value:"all"};"masking"===t&&(i.text="마스킹",i.value=t);var s=this.collectSelectedOrAllPages(),n=0,r=0,a=null,o=!1;if("all"==s.type){var h=this.images.numShapes();r=h.shapes,n=h.pages,a="모든 이미지의 "+i.text+" 정보를 저장하시겠습니까",o=!0}else{for(var l=0,c=s.pages.length-1;c>=0;c--)l=s.pages[c].shapes.length,l>0&&(r+=l,n++);a="선택한 이미지(들)의 "+i.text+" 정보를 저장하시겠습니까"}if(r)return e&&e>0&&n>e?void AbMsgBox.warningHtml("최대 "+e+"까지만 다운로드 할 수 있습니다.<br/>도형이 있는 이미지를 "+e+"개 이하로 선택하세요."):void AbMsgBox.confirm(a).then(function(t){if("ok"==t){for(var e=this,n=[],r=s.pages.length,a=0;a<r;a++){var o=s.pages[a];if(o.shapes.length){var h=this.images.indexOf(o.uid),l=function(t,e){var i=arguments.callee.target,s=arguments.callee.page,n=arguments.callee.index,r=(arguments.callee.self,[AbCommon.xmlHeader()]);r.push('<page index="'+n+'">');for(var a=s.shapes.length,o=0;o<a;o++){var h=s.shapes[o];"masking"===i.value&&"masking"!==h.type||r.push(h.serialize())}r.push("</page>");var l=new Blob(r,{type:"text/plain;charset=utf-8"});saveAs(l,"image_"+(n+1)+"_shapes.xml"),t(n)};l.target=i,l.page=o,l.index=h,l.self=e,n.push(new Promise(l))}}AbCommon.sequencePromiseAll(n,null,{term:{progress:10,promise:10}}).then(function(){e.notifyObservers("file.save.annotation")}).catch(function(t){console.log(t),AbMsgBox.error(t)})}}.bind(this))},sendToServer:function(){var t=this.config("image.save")||"all",e=null;"current"===t&&(e={current:!0});var i=this.collectSelectedOrAllPages(e),s=null,n=!1;"all"==i.type?(s="모든 이미지를 서버로 전송하시겠습니까?",n=!0):s="single"==i.type?"선택한 이미지를 서버로 전송하시겠습니까?":"선택한 이미지들을 서버로 전송하시겠습니까?",i.pages.length&&(s+="<br/><br/>※ 오류 이미지는 전송되지 않습니다.",this._requestParam?AbMsgBox.showHtml(s,null,{regist:"신규등록",modify:"수    정"}).then(function(t){"regist"!==t&&"modify"!==t||this.exec(function(){this.submitImages(i.pages,t)},300)}.bind(this)):AbMsgBox.confirmHtml(s).then(function(t){"ok"==t&&this.exec(function(){this.submitImages(i.pages)},300)}.bind(this)))},submitImages:function(t,e){AbCommon.isSetted(e)||(e="auto");var i=null;"modify"!==e&&"auto"!==e||(i=this._requestParam);var s=new AbImageTransferProcessHelper({viewer:this,selector:"#server-saving",parallels:this.PARALLELS,id:i,urls:{alloc:this.URLS.SAVE.ALLOC,modify:this.URLS.SAVE.MODIFY,remove:this.URLS.SAVE.REMOVE,completed:this.URLS.SAVE.COMPLETED},submit:function(t,e,i){return this.submitProcess(t,e,i)}.bind(this)});s.send(t).then(function(t){s.hide(),s.dispose(),AbMsgBox.success("이미지들을 전송했습니다")}).catch(function(t){s.hide(),s.remove(),s.dispose(),console.log(t),AbMsgBox.error(t)}).then(function(){$("#save-forms").empty()})},submitProcess:function(t,e,i){var s=this.IMAGE_TYPES,n=s.length,r=AbCommon.formController("#save-forms","modify,id,index,type,info"),a="modify"===t.work,o=t.transferID;r.modify.val(a);for(var h=e.index,l=e.pageInfo,c=e.imgInfo,u=[],d=0;d<n;d++){var p=s[d];u.push({index:h,type:p,info:l,page:l.page,abimg:l.page.source})}u.push({index:h,type:"end",info:l,page:l.page,abimg:l.page.source});var g=0,f=u.length,m=this,b=10;return new Promise(function(t,e){var i=function(){var s=null,n=null,a=null,h=null,l=null;try{s=u[g];var d=[],p=s.page.decoder();p||(p=null);var y=null;switch(s.type){case"image":if(y=Promise.resolve(),h=s.abimg.imageElement(),d.splice(0,d.length),s.page.shapes.length){d.push(AbCommon.xmlHeader()),d.push('<page index="'+s.index+'">');for(var v=s.page.shapes.length,x=0;x<v;x++){var w=s.page.shapes[x];d.push(w.serialize())}d.push("</page>")}n=JSON.stringify({angle:s.page.angle,width:h.width,height:h.height,shapes:d.length?d.join(""):null,decoder:p,info:s.page.info()});break;case"image-source":h=s.abimg.imageElement(),y=AbCommon.loadImageAsDataURL(h.src).then(function(t){a=AbCommon.dataUrlContent(t)});break;case"image-result":y=AbCommon.loadImageAsDataURL(c.url).then(function(t){a=AbCommon.dataUrlContent(t)});break;case"thumb":h=s.abimg.originThumbnailElement(),n=JSON.stringify({width:h.width,height:h.height}),y=AbCommon.loadImageAsDataURL(h.src).then(function(t){a=AbCommon.dataUrlContent(t)});break;case"thumb2":y=Promise.resolve(),h=s.abimg.originThumbnailElement(),l=AbGraphics.canvas.renderImage(h,p),n=JSON.stringify({width:h.width,height:h.height}),a=l.substr(l.indexOf(",")+1);break;case"end":y=Promise.resolve(),n=JSON.stringify(s.info.bookmark)}y.then(function(h){m.submitContent(r,o,s.index,s.type,n,a,function(){try{g+1>=f?(r.dispose(),t(!0)):(g++,setTimeout(i,b))}catch(t){r.dispose(),e(t)}},function(t){r.dispose(),e(t)})}).catch(function(t){r.dispose(),e(t)})}catch(t){r.dispose(),e(t)}};setTimeout(i,0)})},submitContent:function(t,e,i,s,n,r,a,o,h){var l=this.URLS.SAVE.IMAGE,c=this.SPLIT_DATA_SIZE;t.id.val(e),t.index.val(i),t.type.val(s),t.info.val(n),r?AbCommon.submitPartialContent({url:l,content:r,splitSize:c,formController:t,success:function(){AbCommon.isFunction(a)&&a()},error:function(t){AbCommon.isFunction(o)&&o(t)}}):AbCommon.ajaxSubmit(t.form,{url:l,logFail:!0,nomsg:!0,success:function(t,e,i,s){AbCommon.isFunction(a)&&a()},error:function(t,e){AbCommon.isFunction(o)&&o(t)}})},removePage:function(){this.listView&&this.notifyObservers("page.remove")},page:function(t){return this.listView?(arguments.length&&(AbCommon.isNumber(t)||(t=parseInt(t)),this.listView.go(t-1)||this.toolbar.set("page.no",this.listView.selectedIndex+1,!1)),this.listView.pager.page()):-1},prevPage:function(){this.listView&&this.listView.canPrev()&&this.listView.prev()},nextPage:function(){this.listView&&this.listView.canNext()&&this.listView.next()},selectedPages:function(t){var e=this.listView;switch(t){case"pages":e=this.imageListView;break;case"bookmarks":e=this.bookmarkListView}for(var i=e.selectedPages(),s=[],n=i.length-1;n>=0;n--)if(i[n].uid){var r=this.images.getById(i[n].uid);r&&s.unshift(r)}return s},collectSelectedOrAllPages:function(t){if(t&&t.current===!0)return this.engine.currentPage?{type:"single",pages:[this.engine.currentPage]}:null;var e=this.selectedPages();if(e.length)return{type:"range",pages:e};var i=0,s=this.images.length()-1,n="all";t&&(AbCommon.isNumber(t.start)||AbCommon.isNumber(t.end))&&(AbCommon.isNumber(t.start)&&(i=t.start),AbCommon.isNumber(t.end)&&(s=t.end),n=(i>=0||s>=0)&&i===s?"single":"range");for(var r=i;r>=0&&r<=s;r++){var a=this.images.get(r);e.push(a)}return{type:n,pages:e}},printPage:function(){if(this.engine.currentPage){var t=this.engine.currentPage.uid,e=this.images.indexOf(t);if(!(e<0)){var i=this.images.get(e);this.exec(function(){this.print([i]),this.notifyObservers("page.print")},200)}}},printAllPages:function(){var t=this.collectSelectedOrAllPages(),e=t.pages.length;e>40?AbMsgBox.confirmHtml("인쇄하는 데 오래 걸릴 수 있습니다.<br/>계속 진행하시겠습니까?").then(function(e){
"ok"==e&&this.exec(function(){this.print(t.pages),this.notifyObservers("print")},300)}.bind(this)):this.exec(function(){this.print(t.pages),this.notifyObservers("print")},200)},getPrintFrameDoc:function(){var t=$("#print-frame"),e=AbCommon.contentDocument(t);return e?{frame:t,document:e}:(AbMsgBox.error("인쇄 프레임에 접근할 수 없습니다"),null)},print:function(t){var e=this.getPrintFrameDoc();if(e){var i=new AbImageTransferProcessHelper({viewer:this,selector:"#print-loading",parallels:this.PARALLELS,printShapes:this.engine.showShapes(),printShapeTypeMap:this.engine.showShapeTypeMap(),errorImageExit:!0,urls:{alloc:this.URLS.PRINT.ALLOC,modify:this.URLS.PRINT.MODIFY,remove:this.URLS.PRINT.REMOVE},msgs:{empty:"인쇄할 이미지가 없습니다",errorImage:"#{IDX}번 이미지는 인쇄할 수 없습니다",readyException:"인쇄 이미지 전송 준비 중 오류가 발생했습니다"},prepare:function(t){for(var e=0;e<t.length;e++)t.outputImageUrls.push(null)},chain:function(t,e,i){var s=null;if(e.pageInfo&&!e.pageInfo.page.isError()){if(e.pageInfo&&e.pageInfo.page.angle){var n=e.pageInfo.page,r=AbGraphics.angle.point(n.angle,0,0,e.imgInfo.width,e.imgInfo.height);e.imgInfo.width=Math.round(Math.abs(r.x)),e.imgInfo.height=Math.round(Math.abs(r.y))}s=AbPrint.isLandscapeImage(e.imgInfo)?AbCommon.loadImage(e.imgInfo.url).then(function(t){var i=AbPrint.landscape(t),s=e.imgInfo.width;return e.imgInfo.width=e.imgInfo.height,e.imgInfo.height=s,e.imgInfo.url=i,i}):Promise.resolve(e.imgInfo.url)}else s=Promise.resolve(!1);return s}.bind(this),submit:function(t,e,i){return this.submitPrintSupport(t,e,i)}.bind(this)});i.outputImageUrls=[],i.send(t).then(function(t){$("#print-support-forms").empty()}).then(function(){i.status("build");try{i.outputImageUrls.length&&this.buildPrintSupport(i)}catch(t){throw t}}.bind(this)).catch(function(t){i.hide(),console.log(t),AbMsgBox.error(t)}).then(function(){i.dispose()})}},submitPrintSupport:function(t,e,i){var s=AbCommon.formController("#print-support-forms","id,index"),n=this.URLS.PRINT.IMAGE,r=this.URLS.PRINT.DOWNLOAD,a=this.SPLIT_DATA_SIZE,o=t.transferID,h=e.imgInfo.url;return AbCommon.isDataUrl(h)?(h=AbCommon.dataUrlContent(h),s.id.val(o),s.index.val(e.index),new Promise(function(i,o){AbCommon.submitPartialContent({url:n,content:h,splitSize:a,formController:s,success:function(n){s.dispose(),t.outputImageUrls[e.index]=r+n.text,i(!0)},error:function(t){s.dispose(),o(t)}})})):(t.outputImageUrls[e.index]=h,Promise.resolve(!0))},buildPrintSupport:function(t){var e=this.getPrintFrameDoc();if(e){var i=t.transferID,s=t.outputImageUrls,n=[];n.push("<!doctype html>"),n.push('<html lang="en">'),n.push("<head>"),n.push('<meta charset="UTF-8">'),n.push("<title>이미지 뷰어 인쇄 지원</title>"),n.push('<style type="text/css" media="print">'),n.push("body,html{width:100%;height:100%; margin: 0;}"),n.push("#print,.print,.print>div{width:100%;height:100%}"),n.push("@page{size:A4 portrait!important;orientation:portrait}"),n.push("#loading{display:none}"),n.push(".print{position:relative;margin:0;padding:0;text-align:center;"),n.push("page-break-after:always;"),n.push("}"),n.push("img{position:absolute;top:0;bottom:0;left:0;right:0;margin:auto;max-width:100%!important;max-height:100%!important}"),n.push("</style>"),n.push("<script>"),n.push("function loadedPage(){"),n.push("loadImages(function(){"),n.push("parent.AbImageViewer$$doPrint();"),n.push("setTimeout(endPrint, 500);"),n.push("});"),n.push("}"),n.push("function loadImage(index, url, callback){"),n.push("var img = new Image();"),n.push("img.onload = function(e){"),n.push("setTimeout(callback.bind(null, true, index, this), 0);"),n.push("};"),n.push("img.onerror = function(e){"),n.push("setTimeout(callback.bind(null, false, index, new Error('[PRINT-IMAGE]['+index+'] It is not an image file')), 0);"),n.push("};"),n.push("img.src = url;"),n.push("}"),n.push("function endPrint(){"),n.push("setTimeout(function(){"),n.push("console.log('[PRINT] clear printed data...');"),n.push("document.body.innerHTML='';"),n.push("parent.AbImageViewer$$endPrint('"+i+"');"),n.push(" }, 500);"),n.push("}"),n.push("function loadImages(callback){"),n.push("var called = 0, total = "+s.length+";"),n.push(""),n.push("var func = function(success, index, r){"),n.push("called++;"),n.push("if (success === true){"),n.push('var cover = document.getElementById("PIMG_" + index)'),n.push("cover.appendChild(r);"),n.push("}else{"),n.push("console.log(r);"),n.push("}"),n.push("if (called >= total)"),n.push("callback();"),n.push("}"),n.push("");for(var r=0;r<s.length;r++){var a=s[r];n.push("loadImage("+r+', "'+a+'", func);')}n.push("}"),n.push("</script>"),n.push("</head>"),n.push('<body onload="loadedPage();" '),n.push(">");var o=[];o.push(n.join("\n")),o.push(AbPrint.generateCoverHtml(s,"PIMG_",'<div id="print">',"</div>")),o.push("</body>"),o.push("</html>"),e.document.open(),e.document.write(o.join("")),e.document.close(),console.log("[PRINT] OK!!")}},clearShapes:function(){var t=this.collectSelectedOrAllPages(),e=0,i=null,s=!1;if("all"==t.type)e=this.images.numShapes().shapes,i="모든 이미지의 주석/마스킹을 삭제하시겠습니까?",s=!0;else{for(var n=t.pages.length-1;n>=0;n--)e+=t.pages[n].shapes.length;i="선택한 이미지의 주석/마스킹을 삭제하시겠습니까?"}e&&AbMsgBox.confirm(i,null,"warn").then(function(e){var i=function(t){if(t)for(var e=0;e<t.length;e++){var i=t[e];i.page.editable()&&this.renderThumbnail(i.page)}}.bind(this);"ok"==e&&(s?this.engine.removeAllPageShapes({end:i}):this.engine.removeRangePageShapes(t.pages,{end:i}))}.bind(this))},renderThumbnail:function(t){this.engine.renderThumbnail(this.thumbnailGenerator,t);var e=t.decoder(),i=this.thumbnailGenerator.toImage(e);t.source.setThumbnailData(i),this.notifyObservers("modified",{uid:t.uid,data:i})},ZOOM_STEP:.3,zoom:function(t){var e=this.engine.scale(),i=0;"in"==t?i=1+this.ZOOM_STEP:"out"==t&&(i=1-this.ZOOM_STEP),i&&(e*=i,e<AbViewerEngine.prototype.MIN_SCALE?e=AbViewerEngine.prototype.MIN_SCALE:e>AbViewerEngine.prototype.MAX_SCALE&&(e=AbViewerEngine.prototype.MAX_SCALE),e!=this.engine.scale()&&this.engine.scale(e))},addBookmark:function(){var t=Array.prototype.slice.call(arguments);return new Promise(function(e,i){this.exec(function(){for(var i=t.length,s=0;s<i;s++){var n=t[s],r=this.images.get(n);r&&(this.bookmarks.push(r),this.notifyObservers("bookmark.add",r.uid),r.status==AbPage.prototype.LOADED&&this.bookmarkListView.notify("page.loaded",{index:n,page:r}))}e(i)})}.bind(this))},openImages:function(t){var e=AbLoading.get({text:"이미지들을 불러오는 중입니다..."});e.show();var i=this;return new Promise(function(s,n){AbCommon.ajax({caller:i,title:"이미지 열기",url:i.URLS.OPEN,data:{id:t},success:function(n){i._requestParam=t;var r=null,a=n&&n.images&&$.isArray(n.images)?n.images:[],o=n&&n.bookmarks&&$.isArray(n.bookmarks)?n.bookmarks:[];r=a.length?i.addImages(a):Promise.resolve(0),r.then(function(t){if(t&&t.length&&o.length)for(var i=o.length,n=0;n<i;n++){var r=t[o[n]];this.bookmarks.push(r.page),this.notifyObservers("bookmark.add",r.page.uid),r.page.status==AbPage.prototype.LOADED&&this.bookmarkListView.notify("page.loaded",r)}e.hide(),s()}.bind(this))},error:function(t){e.hide(),n(t)}})})},attachEvent:function(t,e){if(!AbCommon.isFunction(e))throw new Error("listener is not function");this.listeners[t]?this.listeners[t].push(e):this.listeners[t]=[e]},detachEvent:function(t,e){if(!AbCommon.isFunction(e))throw new Error("listener is not function");if(this.listeners[t])for(var i=this.listeners[t],s=i.length-1;s>=0;s--)i[s]==e&&i.splice(s,1)},trigger:function(t,e){var i=[];if(this.listeners["*"]&&Array.prototype.push.apply(i,this.listeners["*"]),this.listeners[t]&&Array.prototype.push.apply(i,this.listeners[t]),i.length)for(var s=i.length,n=0;n<s;n++){var r=i[n];r(t,e)}}};var AbPrint={transform:function(t,e){t.css("-webkit-transform",e),t.css("-moz-transform",e),t.css("-ms-transform",e),t.css("-o-transform",e),t.css("transform",e),t.css("-webkit-transform-origin: top left;"),t.css("-moz-transform-origin: top left;"),t.css("-ms-transform-origin: top left;"),t.css("-o-transform-origin: top left;"),t.css("transform-origin: top left;")},isLandscapeImage:function(t){return t.width>t.height},landscape:function(t){var e=AbGraphics.canvas.createContext(t.height,t.width),i=AbGraphics.angle.increase(0,-90),s=t.width,n=t.height,r=AbGraphics.angle.correctDisplayCoordinate(i,s,n);return e.clearRect(0,0,e.canvas.width,e.canvas.height),e.rotate(AbGraphics.angle.deg2rad(i)),e.translate(-r.x,-r.y),e.drawImage(t,0,0),AbGraphics.canvas.toImage(e)},item:function(t,e,i){var s=$('<div class="print portrait"/>');t.append(s);var n=AbCommon.isString(e)?e:e.image||e.source;return n instanceof AbImage?n=n.imgInfo.url:AbCommon.isString(n)||(n=n.src),AbCommon.loadImage(n).then(function(t){if(i&&"auto"===i.orientation&&t.width>t.height){var e=AbPrint.landscape(t);return AbCommon.loadImage(e)}return t}).then(function(t){var e=$("<img/>");e.attr("src",t.src);var i=$("<div/>");return i.append(e),s.append(i),s})},generate:function(t,e,i){i||(i={});var s=i.term||{};s.hasOwnProperty("resolve")||(s.resolve=100),i.hasOwnProperty("orientation")||(i.orientation="auto"),e instanceof AbPageCollection?e=e.source:$.isArray(e)||(e=[e]);for(var n=[],r=e.length,a=0;a<r;a++){var o=e[a],h=AbPrint.item(t,o,i);n.push(h)}return AbCommon.promiseAll(n,i.progress,i)},generateHtml:function(t,e,i){var s=[];e&&s.push(e);for(var n=t.length,r=0;r<n;r++){var a=t[r];s.push('<div class="print portrait">'),s.push("<div>"),s.push('<img src="'+a+'"/>'),s.push("</div>"),s.push("</div>")}return i&&s.push(i),s.join("")},generateCoverHtml:function(t,e,i,s){var n=[];i&&n.push(i);for(var r=t.length,a=0;a<r;a++){t[a];n.push('<div class="print portrait">'),n.push('<div id="'+(e?e+a:""+a)+'">'),n.push("</div>"),n.push("</div>")}return s&&n.push(s),n.join("")}};AbWaterMark.prototype={constructor:AbWaterMark,DEFAULT_RATIO:.5,observe:function(t){this.observers.push(t)},stopObserve:function(t){var e=this.observers.indexOf(t);e>=0&&this.observers.splice(e,1)},notifyObservers:function(t,e,i){this.exec(function(){for(var s=this.observers.length,n=0;n<s;n++){var r=this.observers[n];"function"==typeof r?r(this,t,e,i):"function"==typeof r.waterMarkNotify&&r.waterMarkNotify(this,t,e,i)}})},exec:function(t,e){e||(e=0),setTimeout(t.bind(this),e)},$styling:function(t,e){var i="box"==t?this.$style.box:"stroke"==t?this.$style.box.stroke:this.$style.text,s=null;if(3==arguments.length){if(s=arguments[2],AbCommon.isString(s))return $.inArray(s,e)>=0?null:i[s];for(var n in s)s.hasOwnProperty(n)&&$.inArray(n,e)<0&&(i[n]=s[n])}else if(4==arguments.length){s=arguments[2];var r=arguments[3];i[s]=r}},textStyle:function(){return 1==arguments.length?this.$styling("text",[],arguments[0]):2==arguments.length?this.$styling("text",[],arguments[0],arguments[1]):void 0},ratio:function(t){return arguments.length&&(this.$ratio=AbCommon.isNumber(t)?t:AbWaterMark.prototype.DEFAULT_RATIO),this.$ratio},angle:function(t){return arguments.length&&(this.$angle=AbGraphics.angle.increase(this.$angle,t)),this.$angle},alpha:function(t){return arguments.length&&(this.$alpha=t),this.$alpha},position:function(t){return arguments.length&&(this.$position=t),this.$position},margin:function(){return 1==arguments.length?this.$margin=arguments[0]:4==arguments.length&&(this.$margin.top=arguments[0],this.$margin.right=arguments[1],this.$margin.bottom=arguments[2],this.$margin.left=arguments[3]),this.$margin},source:function(){return this.$source},type:function(){return this.$type},status:function(){return this.$status},render:function(){this.notifyObservers("render")},error:function(t){console.log("[WATERMARK] "+t),this.notifyObservers("error",t)},text:function(t){this.$source=t,this.$type="text",this.$status="loaded",this.render()},image:function(t){return this.$source=null,this.$type="image",this.$status="loading",new Promise(function(e,i){t instanceof AbImage?t.image().then(function(t){this.$source=t,this.$status="loaded",this.render(),e()}.bind(this)).catch(function(t){this.error(t)}.bind(this)):t instanceof Image?(this.$source=t,this.$status="loaded",this.render(),e()):AbCommon.isString(t)?AbCommon.loadImage(t).then(function(t){this.$source=t,this.$status="loaded",this.render(),e()}.bind(this)).catch(function(t){this.error(t)}.bind(this)):(this.$status="loaded",this.render(),e())}.bind(this))},drawable:function(){return this.$source&&"loaded"==this.$status},measure:function(t,e){for(var i=e.replace(/\r/g,"").split("\n"),s=i.length,n=[],r=0,a=0,o=AbCss.pixel(this.$style.text.size),h=o*this.$style.text.lineHeight,l=0;l<s;l++){var c=i[l],u=t.measureText(c);txtWidth=Math.round(u.width),n.push(txtWidth),(0==l||r<txtWidth)&&(r=txtWidth),a+=h}return{lines:i,width:r,height:a,lineWidths:n,lineHeight:h}},setFontSyle:function(t){var e=this.$style.text,i="";e.italic&&(i+="italic "),e.bold&&(i+="700 "),e.size&&(i+=e.size+" "),e.font&&(i+=e.font+" "),t.lineWidth=1,t.font=$.trim(i),t.textBaseline="top"},draw:function(t,e,i){var s=!1;if(3==arguments.length?s=i&&i.source&&i.view&&i.source.width&&i.source.height&&i.view.width&&i.view.height:4==arguments.length&&(s=i&&AbCommon.isNumber(i)&&AbCommon.isNumber(arguments[3]),s&&(i={source:{width:i,height:arguments[3]},view:{width:i,height:arguments[3]}})),s&&this.drawable()){AbCommon.isSetted(e)||(e=1),t.save(),t.globalAlpha=this.$alpha;var n=null,r=0,a=0,o=null,h=null;if("text"===this.$type?(this.setFontSyle(t),n=this.measure(t,this.$source),r=n.width*e,a=n.height*e):"image"===this.$type&&(r=this.$source.width*e,a=this.$source.height*e),this.$angle&&(h=AbGraphics.angle.bounds(this.$angle,0,0,r,a)),this.$ratio>0){"text"===this.$type;var l=null;l=null!=h?AbGraphics.box.zoom(h.width,h.height,i.source.width*this.$ratio,i.source.height*this.$ratio):AbGraphics.box.zoom(r,a,i.source.width*this.$ratio,i.source.height*this.$ratio),o=l,r*=l.ratio,a*=l.ratio}var c=0,u=0,d=this.$position.split(" ");switch(d[0]){case"left":c=this.$margin.left;break;case"center":c=i.view.width-r>>1;break;case"right":c=width-r-this.$margin.right}switch(d[1]){case"top":u=this.$margin.top;break;case"middle":u=i.view.height-a>>1;break;case"bottom":u=height-a-this.$margin.bottom}if(this.$angle){var p=c+(r>>1),g=u+(a>>1);t.translate(p,g),t.rotate(AbGraphics.angle.deg2rad(this.$angle)),t.translate(-p,-g)}if("text"===this.$type){var l=e*o.ratio;t.scale(l,l),c/=l,u/=l,t.fillStyle=this.$style.text.color;for(var f=n.lines.length,m=0;m<f;m++)t.fillText(n.lines[m],c,u+m*n.lineHeight)}else"image"===this.$type&&t.drawImage(this.$source,c,u,r,a);t.restore()}}};var AbNoop={url:"api/noop",interval:6e4,exec:function(){var t=function(){$.ajax({type:"POST",url:AbNoop.url,data:null,async:!0,timeout:1e6,success:function(t){console.log("[NOOP] ok !!!")},error:function(t,e,i){console.log("[NOOP] error !!!")}})};setInterval(t,AbNoop.interval)}};