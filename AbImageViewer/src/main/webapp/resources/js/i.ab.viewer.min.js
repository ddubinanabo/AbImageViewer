var iAbViewerFrame={frames:{},reset:function(){for(var e in this.frames)this.frames.hasOwnProperty(e)&&delete this.frames[e]},prepare:function(){for(var e=$("iframe[ab-topic]"),t=e.length,n=0;n<t;n++){var i=e[n],r=$(i),s=r.attr("ab-topic");s||(s="main"),this.frames[s]=r}},uuid:function(){for(var e=[],t="0123456789abcde",n=0;n<36;n++)e[n]=t.substr(Math.floor(16*Math.random()),1);e[14]="4",e[19]=t.substr(3&e[19]|8,1),e[8]=e[13]=e[18]=e[23]="-";var i=e.join("");return i},regist:function(e,t){t||(t="main");var n=$(e);n&&n.length&&(this.frames[t]=n)},release:function(e){e||(e="main"),delete this.frames[e]},get:function(e){return e||(e="main"),this.frames[e]},getContentWindow:function(e){e||(e="main");var t=this.frames[e];return t&&t.length?t.get(0).contentWindow:null},send:function(e,t){var n=this.getContentWindow(e);n&&n.postMessage(t,"*")},sendReturn:function(e,t){var n=t?t:window.parent;n&&n.postMessage(e,"*")},receiveCommands:function(){$(window).on("message",this,function(e){setTimeout(function(){var t=e.originalEvent.source,n=e.originalEvent.data,i=n.key;if("call"===n.type)switch(n.command){case"view":iAbViewer.view(n.args.directoryPath,n.args.combinedDisplayText,n.args.options).then(function(){this.sendReturn({key:i,type:"return",command:"view",success:!0},t)}.bind(this)).catch(function(e){this.sendReturn({key:i,command:"view",success:!1,message:e?e.message:""},t)}.bind(this));break;case"viewMain":iAbViewer.viewMain(n.args.index,n.args.imagePath,n.args.annotationPath,n.args.options).then(function(){this.sendReturn({key:i,type:"return",returnCommand:"viewMain",success:!0},t)}.bind(this)).catch(function(e){this.sendReturn({key:i,type:"return",command:"viewMain",success:!1,message:e?e.message:""},t)}.bind(this))}else"event"===n.type&&this.trigger(n.name,n.data)}.bind(e.data),0)}),iAbViewer.attachRegistListener(function(e,t){iAbViewer.attachEvent("*",function(e,t){this.sendReturn({type:"event",name:e,data:t})}.bind(this))}.bind(this))},exec:function(e,t){var n=this.uuid(),i=this;return new Promise(function(r,s){var a=function(e){var t=(e.originalEvent.source,e.originalEvent.data),i=t.key;"return"===t.type&&i==n&&($(window).unbind("message",a),t.success?r(t.result):s(new Error(t.message)))};$(window).bind("message",a),e.key=n,i.send(t,e)})},view:function(e,t){return this.exec({type:"call",command:"view",args:{directoryPath:e,combinedDisplayText:t}})},viewMain:function(e,t,n,i){return this.exec({type:"call",command:"viewMain",args:{index:e,imagePath:t,annotationPath:n,options:i}})},listeners:{},attachEvent:function(e,t){if("function"!=typeof t)throw new Error("listener is not function");this.listeners[e]?this.listeners[e].push(t):this.listeners[e]=[t]},detachEvent:function(e,t){if("function"!=typeof t)throw new Error("listener is not function");if(this.listeners[e])for(var n=this.listeners[e],i=n.length-1;i>=0;i--)n[i]==t&&n.splice(i,1)},trigger:function(e,t){var n=[];if(this.listeners["*"]&&Array.prototype.push.apply(n,this.listeners["*"]),this.listeners[e]&&Array.prototype.push.apply(n,this.listeners[e]),n.length)for(var i=n.length,r=0;r<i;r++){var s=n[r];s(e,t)}}};$(function(){iAbViewerFrame.prepare(),iAbViewerFrame.receiveCommands()});var iAbViewer={URLS:{FOLDER:"api/ext/folder",FILE:"api/ext/file"},viewers:{},registListeners:[],regist:function(e,t){t||(t="main"),this.viewers[t]=e,this.registed(t,e)},release:function(e){e||(e="main"),delete this.viewers[e]},get:function(e){return e||(e="main"),this.viewers[e]},attachRegistListener:function(e){if("function"!=typeof e)throw new Error("listener is not function");this.registListeners.push(e)},detachRegistListener:function(e){if("function"!=typeof e)throw new Error("listener is not function");for(var t=this.registListeners.length-1;t>0;t--)this.registListeners[t]==e&&this.registListeners.splice(t,1)},registed:function(e,t){if(this.registListeners.length)for(var n=this.registListeners.length,i=0;i<n;i++)this.registListeners[i](e,t)},view:function(e,t,n){n||(n={}),n.errorMessage||(n.errorMessage="원격 이미지 정보(들)를 조회하는 데 실패했습니다");var i=this;return new Promise(function(r,s){AbCommon.ajax({url:i.URLS.FOLDER,data:{q:e,t:t},success:function(e){this.get(n.name).addImages(e).then(function(){AbCommon.isFunction(n.resolve)&&n.resolve(),r()}).catch(function(e){AbCommon.isFunction(n.reject)&&n.reject(e),s(e)})}.bind(i),error:function(e,t,i){var r=new Error(n.errorMessage);AbCommon.isFunction(n.reject)&&n.reject(r),s(r)}})}).then(function(){})},viewMain:function(e,t,n,i){i||(i={}),i.errorMessage||(i.errorMessage="원격 이미지 정보(들)를 조회하는 데 실패했습니다");var r=this;return new Promise(function(s,a){AbCommon.ajax({url:r.URLS.FILE,data:{q:t,a:n},success:function(t){t?this.get(i.name).changeImage(e,t,i).then(function(){AbCommon.isFunction(i.resolve)&&i.resolve(),s()}).catch(function(e){a(e)}):(AbCommon.isFunction(i.resolve)&&i.resolve(),s())}.bind(r),error:function(e,t,n){var r=new Error(i.errorMessage);AbCommon.isFunction(i.reject)&&i.reject(r),a(r)}})}).then(function(){})},attachEvent:function(e,t){var n=this.get();n&&n.attachEvent(e,t)},detachEvent:function(e,t){var n=this.get();n&&n.detachEvent(e,t)}};